=== public/.htaccess ===
RewriteEngine On
RewriteBase /

# ✅ Allow guest access to public views (without requiring authentication)
RewriteRule ^(home|auth/login|vehicles|auth/register)$ views/$1.php [L]

# ✅ Prevent direct access to backend directories
RewriteRule ^(App/Controllers|App/Services|config|vendor|logs) - [F,L]

# ✅ Ensure static assets load properly
RewriteCond %{REQUEST_URI} ^/(css|js|images|views|uploads|assets)/(.*)$
RewriteCond %{DOCUMENT_ROOT}/public/%1/%2 -f
RewriteRule ^(css|js|images|views|uploads|assets)/(.*)$ /public/$1/$2 [L]

# Removed API-specific rewrite to let fallback handle API routes
# RewriteCond %{REQUEST_URI} ^/api/ [NC]
# RewriteRule ^api/(.*)$ index.php?route=api/$1 [QSA,L]

# ✅ Prevent direct access to api.php
RewriteRule ^api.php - [F,L]

# ✅ Ensure requests without a file extension are forwarded correctly
RewriteCond %{REQUEST_URI} !\.(css|js|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot|ico|pdf|json)$ [NC]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# ✅ Forward all remaining requests to FastRoute in index.php
RewriteRule ^ index.php [QSA,L]
=== public/css/tailwind.css ===
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Custom color adjustments */
:root {
  --primary: #3b82f6; /* blue-500 */
  --primary-dark: #2563eb; /* blue-600 */
  --primary-light: #60a5fa; /* blue-400 */
  --secondary: #10b981; /* emerald-500 */
  --accent: #8b5cf6; /* violet-500 */
  --danger: #ef4444; /* red-500 */
  --warning: #f59e0b; /* amber-500 */
  --success: #10b981; /* emerald-500 */
  --info: #3b82f6; /* blue-500 */
}

/* Base styles */
@layer base {
  html {
    scroll-behavior: smooth;
  }
  
  body {
    @apply bg-gray-100 text-gray-800 font-sans;
  }
  
  h1, h2, h3, h4, h5, h6 {
    @apply font-medium;
  }
  
  /* Polish typography adjustments */
  /* Support for special Polish characters */
  @font-face {
    font-family: 'Inter';
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: url('../fonts/inter-var.woff2') format('woff2');
    unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
  }
}

/* Component styles */
@layer components {
  /* Card components */
  .card {
    @apply bg-white rounded-lg shadow-md p-6;
  }

  .stats-card {
    @apply bg-white rounded-lg shadow-md p-6 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg;
  }

  /* Button styles */
  .btn {
    @apply px-4 py-2 rounded-md font-medium transition-colors duration-200;
  }

  .btn-primary {
    @apply bg-blue-600 hover:bg-blue-700 text-white;
  }

  .btn-secondary {
    @apply bg-green-600 hover:bg-green-700 text-white;
  }

  .btn-danger {
    @apply bg-red-600 hover:bg-red-700 text-white;
  }

  .btn-outline {
    @apply border border-gray-300 hover:bg-gray-50 text-gray-700;
  }

  /* Form elements */
  .form-input {
    @apply bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5;
  }

  .form-select {
    @apply bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5;
  }

  .form-checkbox {
    @apply rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50;
  }

  .form-label {
    @apply block text-sm font-medium text-gray-700 mb-1;
  }

  /* Badge styles */
  .badge {
    @apply px-2 inline-flex text-xs leading-5 font-semibold rounded-full;
  }

  .badge-success {
    @apply bg-green-100 text-green-800;
  }

  .badge-warning {
    @apply bg-yellow-100 text-yellow-800;
  }

  .badge-danger {
    @apply bg-red-100 text-red-800;
  }

  .badge-info {
    @apply bg-blue-100 text-blue-800;
  }

  /* Table styles */
  .table-container {
    @apply overflow-x-auto;
  }

  .table {
    @apply min-w-full divide-y divide-gray-200;
  }

  .table-header {
    @apply px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
  }

  .table-cell {
    @apply px-6 py-4 whitespace-nowrap text-sm text-gray-500;
  }
  
  /* Status indicators for various booking states */
  .status-active {
    @apply bg-blue-100 text-blue-800;
  }
  
  .status-completed {
    @apply bg-green-100 text-green-800;
  }
  
  .status-pending {
    @apply bg-yellow-100 text-yellow-800;
  }
  
  .status-canceled {
    @apply bg-red-100 text-red-800;
  }
}

/* Alpine.js transitions & animations */
@layer utilities {
  /* Alpine.js transitions */
  .transition-fade-enter {
    opacity: 0;
  }
  
  .transition-fade-enter-active {
    transition: opacity 0.3s ease;
  }
  
  .transition-fade-enter-to {
    opacity: 1;
  }
  
  .transition-fade-leave {
    opacity: 1;
  }
  
  .transition-fade-leave-active {
    transition: opacity 0.3s ease;
  }
  
  .transition-fade-leave-to {
    opacity: 0;
  }
  
  /* Modal transitions */
  .transition-modal-enter {
    opacity: 0;
    transform: scale(0.95);
  }
  
  .transition-modal-enter-active {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  
  .transition-modal-enter-to {
    opacity: 1;
    transform: scale(1);
  }
  
  .transition-modal-leave {
    opacity: 1;
    transform: scale(1);
  }
  
  .transition-modal-leave-active {
    transition: opacity 0.2s ease, transform 0.2s ease;
  }
  
  .transition-modal-leave-to {
    opacity: 0;
    transform: scale(0.95);
  }
  
  /* Hide elements with Alpine.js [x-cloak] directive */
  [x-cloak] { 
    display: none !important; 
  }
  
  /* HTMX loading indicators */
  .htmx-indicator {
    display: none;
  }
  
  .htmx-request .htmx-indicator {
    display: flex;
  }
  
  .htmx-request.htmx-indicator {
    display: flex;
  }
  
  /* Common loading spinner */
  .spinner {
    @apply animate-spin rounded-full border-2 border-gray-200;
  }
  
  .spinner-border-t {
    @apply border-t-blue-500;
  }
  
  /* Responsive utilities */
  .mobile-only {
    @apply block md:hidden;
  }
  
  .desktop-only {
    @apply hidden md:block;
  }
  
  /* Custom responsive grid for dashboard panels */
  .dashboard-grid {
    @apply grid gap-6;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  }
  
  /* Polish-specific font adjustments */
  .polish-quotes {
    quotes: "„" """;
  }
  
  /* Settings form highlighting */
  .settings-form:has(.is-changed) .settings-save {
    @apply flex;
  }
  
  .settings-form .settings-save {
    @apply hidden;
  }
}

/* Responsive breakpoint visualizer (development only) */
.breakpoint-debug {
  @apply fixed bottom-0 right-0 p-2 m-2 bg-white border border-gray-300 rounded shadow-md z-50;
}

.breakpoint-debug::after {
  @apply font-mono text-xs bg-blue-500 text-white px-2 py-1 rounded;
  content: 'xs';
}

@screen sm {
  .breakpoint-debug::after {
    content: 'sm';
  }
}

@screen md {
  .breakpoint-debug::after {
    content: 'md';
  }
}

@screen lg {
  .breakpoint-debug::after {
    content: 'lg';
  }
}

@screen xl {
  .breakpoint-debug::after {
    content: 'xl';
  }
}

@screen 2xl {
  .breakpoint-debug::after {
    content: '2xl';
  }
}

/* Print styles */
@media print {
  .no-print {
    display: none !important;
  }
  
  .print-only {
    display: block !important;
  }
  
  body {
    @apply bg-white text-black;
  }
  
  .card, .stats-card {
    @apply shadow-none border border-gray-300;
  }
}
=== public/css/overrides.css ===
/* Ogólne nadpisania stylów dla aplikacji Wynajem Samochodów */

/* Przyciski */
.btn {
  padding: 0.5rem 1rem;
  background-color: #4f46e5;
  color: white;
  border-radius: 0.25rem;
  transition-duration: 200ms;
}
.btn:hover {
  background-color: #4338ca;
}
.btn:focus {
  outline: none;
  box-shadow: 0 0 0 2px #818cf8, 0 0 0 4px #f3f4f6;
}

.btn-secondary {
  padding: 0.5rem 1rem;
  background-color: #e5e7eb;
  color: #1f2937;
  border-radius: 0.25rem;
  transition-duration: 200ms;
}
.btn-secondary:hover {
  background-color: #d1d5db;
}

.btn-danger {
  padding: 0.5rem 1rem;
  background-color: #dc2626;
  color: white;
  border-radius: 0.25rem;
  transition-duration: 200ms;
}
.btn-danger:hover {
  background-color: #b91c1c;
}

/* Formularze */
.form-control {
  display: block;
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}
.form-control:focus {
  outline: none;
  border-color: #6366f1;
  box-shadow: 0 0 0 1px #6366f1;
}

.form-label {
  display: block;
  margin-bottom: 0.25rem;
  font-size: 0.875rem;
  font-weight: 500;
  color: #374151;
}

/* Powiadomienia */
.alert {
  padding: 1rem;
  margin-bottom: 1rem;
  border-radius: 0.25rem;
}

.alert-success {
  background-color: #dcfce7;
  color: #166534;
  border: 1px solid #bbf7d0;
}

.alert-danger {
  background-color: #fee2e2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

.alert-info {
  background-color: #dbeafe;
  color: #1e40af;
  border: 1px solid #bfdbfe;
}

.alert-warning {
  background-color: #fef9c3;
  color: #854d0e;
  border: 1px solid #fef08a;
}

/* Karty samochodów */
.car-card {
  background-color: white;
  border-radius: 0.5rem;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  overflow: hidden;
  transition: box-shadow 300ms;
}
.car-card:hover {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.car-image {
  width: 100%;
  height: 12rem;
  object-fit: cover;
}

.car-details {
  padding: 1rem;
}

/* Specjalne style dla elementów animowanych z Alpine.js */
[x-cloak] {
  display: none !important;
}

/* Style dla komunikatów ładowania podczas używania HTMX */
.htmx-indicator {
  opacity: 0;
  transition: opacity 500ms;
}
.htmx-request .htmx-indicator, 
.htmx-request.htmx-indicator {
  opacity: 1;
}

/* Komunikaty systemowe */
.komunikat-niedostepny {
  font-style: italic;
  color: #6b7280;
  text-align: center;
  padding-top: 1rem;
  padding-bottom: 1rem;
}

/* Responsywne dostosowania dla urządzeń mobilnych */
@media (max-width: 768px) {
  .ukryj-mobile {
    display: none;
  }
}
=== public/tailwind.config.js ===
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    // PHP views
    '../**/*.php',
    './views/**/*.php',
    './views/**/*.html',
    // JavaScript files
    './js/**/*.js',
  ],
  darkMode: 'class',
  theme: {
    extend: {
      colors: {
        // Main palette from CSS variables
        primary: {
          DEFAULT: '#3b82f6', // blue-500
          light: '#60a5fa',   // blue-400
          dark: '#2563eb',    // blue-600
        },
        secondary: {
          DEFAULT: '#10b981', // emerald-500
          light: '#34d399',   // emerald-400
          dark: '#059669',    // emerald-600
        },
        accent: {
          DEFAULT: '#8b5cf6', // violet-500
          light: '#a78bfa',   // violet-400
          dark: '#7c3aed',    // violet-600
        },
        danger: {
          DEFAULT: '#ef4444', // red-500
          light: '#f87171',   // red-400
          dark: '#dc2626',    // red-600
        },
        warning: {
          DEFAULT: '#f59e0b', // amber-500
          light: '#fbbf24',   // amber-400
          dark: '#d97706',    // amber-600
        },
        success: {
          DEFAULT: '#10b981', // emerald-500
          light: '#34d399',   // emerald-400
          dark: '#059669',    // emerald-600
        },
        info: {
          DEFAULT: '#3b82f6', // blue-500
          light: '#60a5fa',   // blue-400
          dark: '#2563eb',    // blue-600
        },
        // Extend default colors to ensure consistency
        blue: {
          50: '#eff6ff',
          100: '#dbeafe',
          200: '#bfdbfe',
          300: '#93c5fd',
          400: '#60a5fa',
          500: '#3b82f6',
          600: '#2563eb',
          700: '#1d4ed8',
          800: '#1e40af',
          900: '#1e3a8a',
          950: '#172554',
        },
      },
      fontFamily: {
        sans: [
          'Inter',
          'system-ui',
          '-apple-system',
          'BlinkMacSystemFont',
          '"Segoe UI"',
          'Roboto',
          '"Helvetica Neue"',
          'Arial',
          '"Noto Sans"',
          'sans-serif',
          '"Apple Color Emoji"',
          '"Segoe UI Emoji"',
          '"Segoe UI Symbol"',
          '"Noto Color Emoji"',
        ],
      },
      typography: (theme) => ({
        DEFAULT: {
          css: {
            color: theme('colors.gray.800'),
            maxWidth: '65ch',
            '[class~="lead"]': {
              color: theme('colors.gray.700'),
            },
            a: {
              color: theme('colors.primary.DEFAULT'),
              textDecoration: 'none',
              '&:hover': {
                textDecoration: 'underline',
              },
            },
            // Polish quotation marks
            'blockquote p:first-of-type::before': { content: '"„"' },
            'blockquote p:last-of-type::after': { content: '"""' },
            // Support for Polish special characters in headings
            h1: {
              fontWeight: '600',
              letterSpacing: '-0.025em',
            },
            h2: {
              fontWeight: '600',
              letterSpacing: '-0.025em',
            },
            h3: {
              fontWeight: '600',
            },
          },
        },
      }),
      boxShadow: {
        card: '0 2px 4px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.08)',
        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
      },
      borderRadius: {
        'card': '0.5rem',
      },
      animation: {
        'fade-in': 'fadeIn 0.3s ease-in-out',
        'slide-in': 'slideIn 0.3s ease-in-out',
        'slide-up': 'slideUp 0.3s ease-in-out',
        'slide-down': 'slideDown 0.3s ease-in-out',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        slideIn: {
          '0%': { transform: 'translateX(-10px)', opacity: '0' },
          '100%': { transform: 'translateX(0)', opacity: '1' },
        },
        slideUp: {
          '0%': { transform: 'translateY(10px)', opacity: '0' },
          '100%': { transform: 'translateY(0)', opacity: '1' },
        },
        slideDown: {
          '0%': { transform: 'translateY(-10px)', opacity: '0' },
          '100%': { transform: 'translateY(0)', opacity: '1' },
        },
      },
      spacing: {
        '72': '18rem',
        '80': '20rem',
        '96': '24rem',
      },
    },
    // Define responsive breakpoints
    screens: {
      'sm': '640px',   // Small devices
      'md': '768px',   // Medium devices
      'lg': '1024px',  // Large devices
      'xl': '1280px',  // Extra large devices
      '2xl': '1536px', // 2 Extra large devices
    },
  },
  variants: {
    extend: {
      opacity: ['disabled'],
      cursor: ['disabled'],
      backgroundColor: ['active', 'disabled'],
      textColor: ['active', 'disabled'],
      borderColor: ['active', 'focus', 'disabled'],
      ringColor: ['active', 'hover', 'focus'],
      ringWidth: ['active', 'hover', 'focus'],
      ringOffsetWidth: ['active', 'hover', 'focus'],
    },
  },
  plugins: [
    require('@tailwindcss/typography'),
    require('@tailwindcss/forms')({
      strategy: 'class',
    }),
    require('@tailwindcss/aspect-ratio'),
    require('@tailwindcss/line-clamp'),
    
    // Custom plugin for CarFuse specific utilities
    function({ addUtilities, theme }) {
      const newUtilities = {
        '.text-shadow': {
          textShadow: '0px 1px 2px rgba(0, 0, 0, 0.1)',
        },
        '.text-shadow-md': {
          textShadow: '0px 2px 4px rgba(0, 0, 0, 0.1)',
        },
        '.text-shadow-none': {
          textShadow: 'none',
        },
        // Transitions for Polish UI
        '.transition-smooth': {
          transition: 'all 0.3s ease-in-out',
        },
        // Status indicators for CarFuse
        '.status-badge': {
          padding: '0.25rem 0.75rem',
          borderRadius: '9999px',
          fontSize: '0.75rem',
          fontWeight: '600',
          display: 'inline-flex',
          alignItems: 'center',
        },
      };
      addUtilities(newUtilities);
    },
  ],
  // JIT mode configuration
  mode: 'jit',
  // Future options
  future: {
    hoverOnlyWhenSupported: true,
    respectDefaultRingColorOpacity: true,
    disableColorOpacityUtilitiesByDefault: false,
    purgeLayersByDefault: true,
  },
};
=== public/views/admin/dashboard.php ===
<?php
/**
 * Admin Dashboard - Panel Administratora
 * Main dashboard view for CarFuse administrators
 */

// Ensure the user is authenticated and has admin privileges
if (!isset($_SESSION['user_id']) || $_SESSION['user_role'] !== 'admin') {
    header('Location: /auth/login');
    exit;
}

?>
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarFuse - Panel Administratora</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.4"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom styles -->
    <style>
        [x-cloak] { display: none !important; }
        .stats-card:hover { transform: translateY(-5px); }
        .stats-card { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<?php include BASE_PATH . '/public/views/layouts/header.php'; ?>

<div class="container mx-auto px-4 py-8" x-data="adminDashboard()">
    <!-- Dashboard Header -->
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <div class="flex flex-wrap items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Witamy w Panelu Administratora 🚗</h1>
                <p class="text-gray-600">Zarządzaj pojazdami, rezerwacjami i użytkownikami w jednym miejscu.</p>
            </div>
            <div class="mt-4 md:mt-0">
                <div class="flex space-x-2">
                    <button @click="refreshDashboardData()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i> Odśwież dane
                    </button>
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" 
                                class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md flex items-center">
                            <i class="fas fa-cog mr-2"></i> Opcje
                            <i class="fas fa-chevron-down ml-2" :class="{'fa-chevron-up': open}"></i>
                        </button>
                        <div x-show="open" 
                             x-transition 
                             x-cloak 
                             @click.away="open = false"
                             class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
                            <a href="/admin/reports" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-chart-line mr-2"></i> Raporty
                            </a>
                            <a href="/admin/settings" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-sliders-h mr-2"></i> Ustawienia
                            </a>
                            <a href="/admin/audit-logs" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-clipboard-list mr-2"></i> Logi audytu
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Stats -->
    <div class="mb-6" x-cloak>
        <div class="flex flex-wrap -mx-3">
            <!-- Users Stats -->
            <div class="w-full md:w-1/2 lg:w-1/4 px-3 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6 stats-card">
                    <div class="flex justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-semibold">Wszyscy Użytkownicy</p>
                            <h3 class="text-2xl font-bold text-gray-800" x-text="metrics.total_users">
                                <?= $metrics['total_users'] ?? 0 ?>
                            </h3>
                        </div>
                        <div class="bg-blue-100 rounded-full h-12 w-12 flex items-center justify-center">
                            <i class="fas fa-users text-blue-500 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 text-xs font-medium">
                        <span class="text-green-500" x-show="metrics.active_users_growth > 0">
                            <i class="fas fa-arrow-up mr-1"></i><span x-text="metrics.active_users_growth + '%'"></span>
                        </span>
                        <span class="text-red-500" x-show="metrics.active_users_growth < 0">
                            <i class="fas fa-arrow-down mr-1"></i><span x-text="Math.abs(metrics.active_users_growth) + '%'"></span>
                        </span>
                        <span class="text-gray-500">od zeszłego miesiąca</span>
                    </div>
                </div>
            </div>

            <!-- Bookings Stats -->
            <div class="w-full md:w-1/2 lg:w-1/4 px-3 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6 stats-card">
                    <div class="flex justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-semibold">Wszystkie Rezerwacje</p>
                            <h3 class="text-2xl font-bold text-gray-800" x-text="metrics.total_bookings">
                                <?= $metrics['total_bookings'] ?? 0 ?>
                            </h3>
                        </div>
                        <div class="bg-green-100 rounded-full h-12 w-12 flex items-center justify-center">
                            <i class="fas fa-calendar-check text-green-500 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-between text-xs font-medium">
                        <span class="text-gray-500">
                            <span class="font-semibold text-green-600" x-text="metrics.completed_bookings">
                                <?= $metrics['completed_bookings'] ?? 0 ?>
                            </span> ukończonych
                        </span>
                        <span class="text-gray-500">
                            <span class="font-semibold text-red-600" x-text="metrics.canceled_bookings">
                                <?= $metrics['canceled_bookings'] ?? 0 ?>
                            </span> anulowanych
                        </span>
                    </div>
                </div>
            </div>

            <!-- Revenue Stats -->
            <div class="w-full md:w-1/2 lg:w-1/4 px-3 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6 stats-card">
                    <div class="flex justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-semibold">Przychód</p>
                            <h3 class="text-2xl font-bold text-gray-800" x-text="formatCurrency(metrics.net_revenue)">
                                <?= number_format(($metrics['net_revenue'] ?? 0), 2, ',', ' ') ?> zł
                            </h3>
                        </div>
                        <div class="bg-yellow-100 rounded-full h-12 w-12 flex items-center justify-center">
                            <i class="fas fa-money-bill-wave text-yellow-500 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 text-xs font-medium">
                        <span class="text-green-500" x-show="metrics.revenue_growth > 0">
                            <i class="fas fa-arrow-up mr-1"></i><span x-text="metrics.revenue_growth + '%'"></span>
                        </span>
                        <span class="text-red-500" x-show="metrics.revenue_growth < 0">
                            <i class="fas fa-arrow-down mr-1"></i><span x-text="Math.abs(metrics.revenue_growth) + '%'"></span>
                        </span>
                        <span class="text-gray-500">od zeszłego miesiąca</span>
                    </div>
                </div>
            </div>

            <!-- Activity Stats -->
            <div class="w-full md:w-1/2 lg:w-1/4 px-3 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6 stats-card">
                    <div class="flex justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-semibold">Aktywni Użytkownicy</p>
                            <h3 class="text-2xl font-bold text-gray-800" x-text="metrics.active_users">
                                <?= $metrics['active_users'] ?? 0 ?>
                            </h3>
                        </div>
                        <div class="bg-purple-100 rounded-full h-12 w-12 flex items-center justify-center">
                            <i class="fas fa-user-clock text-purple-500 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-purple-500 h-2.5 rounded-full" 
                                 :style="`width: ${calculateActivePercentage()}%`"
                                 style="width: <?= ($metrics['total_users'] > 0) ? ($metrics['active_users'] / $metrics['total_users'] * 100) : 0 ?>%">
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            <span x-text="calculateActivePercentage() + '%'">
                                <?= ($metrics['total_users'] > 0) ? round(($metrics['active_users'] / $metrics['total_users'] * 100), 1) : 0 ?>%
                            </span> wszystkich użytkowników
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Bookings & Activity -->
    <div class="flex flex-wrap -mx-3">
        <!-- Recent Bookings -->
        <div class="w-full lg:w-2/3 px-3 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-gray-800">Ostatnie Rezerwacje</h2>
                    <button 
                        hx-get="/admin/api/recent-bookings" 
                        hx-trigger="click" 
                        hx-target="#recent-bookings-table" 
                        hx-swap="innerHTML"
                        class="text-sm font-medium text-blue-600 hover:text-blue-800 flex items-center">
                        <i class="fas fa-sync-alt mr-1"></i> Odśwież
                    </button>
                </div>
                <div id="recent-bookings-table" class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Użytkownik</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pojazd</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data od</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Akcje</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <?php foreach ($recentBookings as $booking): ?>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">#<?= $booking->id ?></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-700">
                                            <?= substr($booking->user->name ?? 'U', 0, 1) ?>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900"><?= $booking->user->name ?? 'Nieznany' ?></div>
                                            <div class="text-sm text-gray-500"><?= $booking->user->email ?? 'email@nieznany.pl' ?></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><?= $booking->vehicle_name ?? 'Nieznany pojazd' ?></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><?= (new DateTime($booking->start_date))->format('d.m.Y H:i') ?></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <?php
                                    $statusClass = '';
                                    switch ($booking->status) {
                                        case 'completed':
                                            $statusClass = 'bg-green-100 text-green-800';
                                            $statusText = 'Ukończona';
                                            break;
                                        case 'canceled':
                                            $statusClass = 'bg-red-100 text-red-800';
                                            $statusText = 'Anulowana';
                                            break;
                                        case 'pending':
                                            $statusClass = 'bg-yellow-100 text-yellow-800';
                                            $statusText = 'Oczekująca';
                                            break;
                                        default:
                                            $statusClass = 'bg-blue-100 text-blue-800';
                                            $statusText = 'Aktywna';
                                    }
                                    ?>
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <?= $statusClass ?>">
                                        <?= $statusText ?>
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <a href="/admin/bookings/<?= $booking->id ?>" class="text-blue-600 hover:text-blue-900 mr-3">
                                        <i class="fas fa-eye"></i> Szczegóły
                                    </a>
                                </td>
                            </tr>
                            <?php endforeach; ?>
                            <?php if (empty($recentBookings)): ?>
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">Brak rezerwacji do wyświetlenia</td>
                            </tr>
                            <?php endif; ?>
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-center">
                    <a href="/admin/bookings" class="inline-block text-sm font-medium text-blue-600 hover:text-blue-800">
                        Zobacz wszystkie rezerwacje <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions & Activity Log -->
        <div class="w-full lg:w-1/3 px-3 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-lg font-bold text-gray-800 mb-4">Szybkie Akcje</h2>
                <div class="space-y-3">
                    <a href="/admin/users/new" class="flex items-center p-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                        <div class="bg-blue-100 rounded-full h-10 w-10 flex items-center justify-center">
                            <i class="fas fa-user-plus text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-900">Dodaj użytkownika</p>
                            <p class="text-xs text-gray-500">Utwórz nowe konto użytkownika</p>
                        </div>
                    </a>
                    <a href="/admin/vehicles/new" class="flex items-center p-3 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                        <div class="bg-green-100 rounded-full h-10 w-10 flex items-center justify-center">
                            <i class="fas fa-car text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-900">Dodaj pojazd</p>
                            <p class="text-xs text-gray-500">Dodaj nowy samochód do floty</p>
                        </div>
                    </a>
                    <a href="/admin/reports/generate" class="flex items-center p-3 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
                        <div class="bg-purple-100 rounded-full h-10 w-10 flex items-center justify-center">
                            <i class="fas fa-chart-bar text-purple-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-900">Generuj raport</p>
                            <p class="text-xs text-gray-500">Utwórz nowy raport</p>
                        </div>
                    </a>
                    <a href="/admin/settings" class="flex items-center p-3 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition-colors">
                        <div class="bg-yellow-100 rounded-full h-10 w-10 flex items-center justify-center">
                            <i class="fas fa-cog text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-900">Ustawienia</p>
                            <p class="text-xs text-gray-500">Zarządzaj ustawieniami systemu</p>
                        </div>
                    </a>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800">Aktywność Systemu</h2>
                    <button 
                        hx-get="/admin/api/recent-activity" 
                        hx-trigger="click" 
                        hx-target="#activity-log" 
                        hx-swap="innerHTML"
                        class="text-sm font-medium text-blue-600 hover:text-blue-800">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div id="activity-log" class="space-y-4">
                    <!-- Activity items will be loaded via HTMX -->
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center">
                                <i class="fas fa-user-edit text-blue-600"></i>
                            </div>
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm text-gray-800">Zaktualizowano profil użytkownika <span class="font-semibold">#342</span></p>
                            <p class="text-xs text-gray-500">przed 2 godz. przez <span class="font-medium">Jan Kowalski</span></p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="h-8 w-8 rounded-full bg-green-100 flex items-center justify-center">
                                <i class="fas fa-car text-green-600"></i>
                            </div>
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm text-gray-800">Dodano nowy pojazd <span class="font-semibold">BMW X5</span></p>
                            <p class="text-xs text-gray-500">dzisiaj, 10:45 przez <span class="font-medium">Administrator</span></p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="h-8 w-8 rounded-full bg-red-100 flex items-center justify-center">
                                <i class="fas fa-exclamation-circle text-red-600"></i>
                            </div>
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm text-gray-800">Anulowano rezerwację <span class="font-semibold">#89</span></p>
                            <p class="text-xs text-gray-500">wczoraj przez <span class="font-medium">System</span></p>
                        </div>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <a href="/admin/activity" class="inline-block text-sm font-medium text-blue-600 hover:text-blue-800">
                        Zobacz pełną historię <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function adminDashboard() {
        return {
            metrics: {
                total_users: <?= $metrics['total_users'] ?? 0 ?>,
                active_users: <?= $metrics['active_users'] ?? 0 ?>,
                total_bookings: <?= $metrics['total_bookings'] ?? 0 ?>,
                completed_bookings: <?= $metrics['completed_bookings'] ?? 0 ?>,
                canceled_bookings: <?= $metrics['canceled_bookings'] ?? 0 ?>,
                net_revenue: <?= $metrics['net_revenue'] ?? 0 ?>,
                active_users_growth: 5.2,
                revenue_growth: 3.8
            },
            
            refreshDashboardData() {
                // Show loading indicator
                const button = event.currentTarget;
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Odświeżanie...';
                button.disabled = true;
                
                // Fetch updated metrics via AJAX
                fetch('/admin/api/dashboard-data')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            this.metrics = {
                                ...data.data.metrics,
                                active_users_growth: 5.2, // Przykładowe dane, w rzeczywistości powinny być zwracane przez API
                                revenue_growth: 3.8
                            };
                        }
                        // Reset button
                        button.innerHTML = originalHTML;
                        button.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error refreshing dashboard data:', error);
                        button.innerHTML = originalHTML;
                        button.disabled = false;
                    });
            },
            
            formatCurrency(value) {
                return new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN' }).format(value);
            },
            
            calculateActivePercentage() {
                if (this.metrics.total_users === 0) return 0;
                return Math.round((this.metrics.active_users / this.metrics.total_users) * 100 * 10) / 10;
            }
        };
    }
</script>

</body>
</html>
=== public/views/admin/users.php ===
<?php
/**
 * Admin User Management Page
 * Unified user management interface for CarFuse administrators
 */

// Ensure user is authenticated and has admin privileges
if (!isset($_SESSION['user_id']) || $_SESSION['user_role'] !== 'admin') {
    header('Location: /auth/login');
    exit;
}
?>

<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarFuse - Zarządzanie Użytkownikami</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.4"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom styles -->
    <style>
        [x-cloak] { display: none !important; }
        .fade-enter { opacity: 0; }
        .fade-enter-active { transition: opacity 0.3s ease; }
        .fade-enter-to { opacity: 1; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<?php include BASE_PATH . '/public/views/layouts/header.php'; ?>

<div class="container mx-auto px-4 py-8" x-data="userManagement()" x-init="init()">
    <!-- Page Header -->
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <div class="flex flex-wrap items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Zarządzanie Użytkownikami</h1>
                <p class="text-gray-600">Przeglądaj, dodawaj i zarządzaj użytkownikami systemu.</p>
            </div>
            <div class="mt-4 md:mt-0">
                <button @click="openNewUserModal()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center">
                    <i class="fas fa-user-plus mr-2"></i> Dodaj Użytkownika
                </button>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
            <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-4">
                <!-- Role Filter -->
                <div>
                    <label for="role-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtruj po roli:</label>
                    <select id="role-filter" 
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                            @change="filterRole = $event.target.value; currentPage = 1; loadUsers()">
                        <option value="all" selected>Wszystkie role</option>
                        <option value="user">Użytkownicy</option>
                        <option value="admin">Administratorzy</option>
                        <option value="manager">Menedżerowie</option>
                    </select>
                </div>
                
                <!-- Status Filter -->
                <div>
                    <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtruj po statusie:</label>
                    <select id="status-filter" 
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                            @change="filterStatus = $event.target.value; currentPage = 1; loadUsers()">
                        <option value="all" selected>Wszystkie statusy</option>
                        <option value="active">Aktywni</option>
                        <option value="inactive">Nieaktywni</option>
                    </select>
                </div>
            </div>
            
            <!-- Search -->
            <div class="relative w-full md:w-64">
                <label for="user-search" class="block text-sm font-medium text-gray-700 mb-1">Szukaj:</label>
                <div class="relative">
                    <input type="text" id="user-search" 
                           class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5"
                           placeholder="Szukaj użytkownika..."
                           x-model="searchQuery"
                           @keyup.enter="currentPage = 1; loadUsers()">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <button @click="currentPage = 1; loadUsers()" 
                            class="absolute inset-y-0 right-0 flex items-center pr-3 text-blue-600 hover:text-blue-800">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Users List -->
    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <div class="p-4 border-b border-gray-200 font-medium text-gray-700 flex justify-between items-center">
            <span>Lista Użytkowników</span>
            <div class="flex items-center">
                <span x-show="loading" class="inline-block animate-spin text-blue-500 mr-2">
                    <i class="fas fa-spinner"></i>
                </span>
                <button @click="reloadUserList()" 
                        class="text-sm font-medium text-blue-600 hover:text-blue-800 flex items-center">
                    <i class="fas fa-sync-alt mr-1"></i> Odśwież
                </button>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ID
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Użytkownik
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Rola
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Data rejestracji
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Akcje
                        </th>
                    </tr>
                </thead>
                <tbody id="users-container" 
                       hx-get="/admin/api/users" 
                       hx-trigger="load" 
                       hx-vals="js:{page: 1, role: filterRole, status: filterStatus, search: searchQuery}"
                       hx-indicator="#users-loading">
                    <!-- Users will be loaded here via HTMX -->
                    <tr id="users-loading">
                        <td colspan="6" class="px-6 py-8 text-center">
                            <div class="flex justify-center">
                                <svg class="animate-spin h-8 w-8 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                            <p class="mt-2 text-gray-500">Ładowanie użytkowników...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Empty State -->
        <div id="no-users-message" class="hidden py-12 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">Brak użytkowników</h3>
            <p class="mt-1 text-sm text-gray-500">Nie znaleziono użytkowników pasujących do kryteriów wyszukiwania.</p>
        </div>
        
        <!-- Pagination -->
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    Pokazuję <span class="font-medium" x-text="startItem">1</span>-<span class="font-medium" x-text="endItem">10</span> z 
                    <span class="font-medium" x-text="totalItems">100</span> użytkowników
                </div>
                <div class="flex space-x-2">
                    <button @click="prevPage()" 
                            :disabled="currentPage === 1"
                            :class="{'opacity-50 cursor-not-allowed': currentPage === 1}"
                            class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        <i class="fas fa-chevron-left mr-2"></i> Poprzednia
                    </button>
                    <button @click="nextPage()" 
                            :disabled="currentPage === totalPages"
                            :class="{'opacity-50 cursor-not-allowed': currentPage === totalPages}"
                            class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Następna <i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New User Modal -->
    <div x-show="showNewUserModal" 
         class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         x-cloak>
        <div class="bg-white rounded-lg max-w-lg w-full mx-auto overflow-hidden shadow-xl transform transition-all"
             @click.away="showNewUserModal = false"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800">Dodaj Nowego Użytkownika</h3>
                <button @click="showNewUserModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="new-user-form" @submit.prevent="createUser()">
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Imię:</label>
                            <input type="text" id="name" name="name" required
                                   class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                   x-model="newUser.name">
                        </div>
                        <div>
                            <label for="surname" class="block text-sm font-medium text-gray-700 mb-1">Nazwisko:</label>
                            <input type="text" id="surname" name="surname" required
                                   class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                   x-model="newUser.surname">
                        </div>
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                        <input type="email" id="email" name="email" required
                               class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                               x-model="newUser.email">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Hasło:</label>
                        <div class="relative">
                            <input :type="showPassword ? 'text' : 'password'" id="password" name="password" required
                                   class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                   minlength="8"
                                   x-model="newUser.password">
                            <button type="button" @click="showPassword = !showPassword" class="absolute inset-y-0 right-0 flex items-center pr-3">
                                <i :class="showPassword ? 'fas fa-eye-slash' : 'fas fa-eye'" class="text-gray-400"></i>
                            </button>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Minimum 8 znaków.</p>
                    </div>
                    <div>
                        <label for="role" class="block text-sm font-medium text-gray-700 mb-1">Rola:</label>
                        <select id="role" name="role" required
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                x-model="newUser.role">
                            <option value="user">Użytkownik</option>
                            <option value="admin">Administrator</option>
                            <option value="manager">Menedżer</option>
                        </select>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end">
                    <button type="button" @click="showNewUserModal = false" class="mr-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Anuluj
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" 
                            :disabled="isSubmitting"
                            :class="{'opacity-75 cursor-wait': isSubmitting}">
                        <span x-show="!isSubmitting">Dodaj Użytkownika</span>
                        <span x-show="isSubmitting" class="flex items-center">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Przetwarzanie...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div x-show="showEditModal" 
         class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         x-cloak>
        <div class="bg-white rounded-lg max-w-lg w-full mx-auto overflow-hidden shadow-xl transform transition-all"
             @click.away="showEditModal = false">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800">Edytuj Użytkownika</h3>
                <button @click="showEditModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="edit-user-form" @submit.prevent="updateUser()">
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ID:</label>
                            <input type="text" readonly
                                   class="bg-gray-100 border border-gray-300 text-gray-600 text-sm rounded-lg block w-full p-2.5"
                                   x-model="editingUser.id">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                            <input type="email" readonly
                                   class="bg-gray-100 border border-gray-300 text-gray-600 text-sm rounded-lg block w-full p-2.5"
                                   x-model="editingUser.email">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-name" class="block text-sm font-medium text-gray-700 mb-1">Imię:</label>
                            <input type="text" id="edit-name" name="name" required
                                   class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                   x-model="editingUser.name">
                        </div>
                        <div>
                            <label for="edit-surname" class="block text-sm font-medium text-gray-700 mb-1">Nazwisko:</label>
                            <input type="text" id="edit-surname" name="surname" required
                                   class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                   x-model="editingUser.surname">
                        </div>
                    </div>
                    <div>
                        <label for="edit-role" class="block text-sm font-medium text-gray-700 mb-1">Rola:</label>
                        <select id="edit-role" name="role" required
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                x-model="editingUser.role">
                            <option value="user">Użytkownik</option>
                            <option value="admin">Administrator</option>
                            <option value="manager">Menedżer</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-status" class="block text-sm font-medium text-gray-700 mb-1">Status:</label>
                        <select id="edit-status" name="status" required
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                x-model="editingUser.active">
                            <option :value="true">Aktywny</option>
                            <option :value="false">Nieaktywny</option>
                        </select>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end">
                    <button type="button" @click="showEditModal = false" class="mr-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Anuluj
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Zapisz Zmiany
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteModal" 
         class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         x-cloak>
        <div class="bg-white rounded-lg max-w-md w-full mx-auto overflow-hidden shadow-xl transform transition-all"
             @click.away="showDeleteModal = false">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800">Potwierdź Usunięcie</h3>
                <button @click="showDeleteModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="flex items-center justify-center mb-4 text-red-500">
                    <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </div>
                <p class="text-gray-700 text-center mb-4">Czy na pewno chcesz usunąć tego użytkownika?</p>
                <p class="text-gray-700 text-center font-semibold mb-6" x-text="`${deletingUser.name} ${deletingUser.surname} (${deletingUser.email})`"></p>
                <div class="text-sm text-gray-500 bg-gray-50 p-4 rounded-md mb-4">
                    <p><i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i> Tej operacji nie można cofnąć.</p>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end">
                <button type="button" @click="showDeleteModal = false" class="mr-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    Anuluj
                </button>
                <button type="button" 
                        @click="confirmDelete()" 
                        class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                        :disabled="isDeleting"
                        :class="{'opacity-75 cursor-wait': isDeleting}">
                    <span x-show="!isDeleting">Usuń Użytkownika</span>
                    <span x-show="isDeleting" class="flex items-center">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Usuwanie...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Template for HTMX user row responses -->
<template id="user-row-template">
  <tr class="booking-item">
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
      #{{id}}
    </td>
    <td class="px-6 py-4 whitespace-nowrap">
      <div class="flex items-center">
        <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-700">
          {{initials}}
        </div>
        <div class="ml-4">
          <div class="text-sm font-medium text-gray-900">{{name}} {{surname}}</div>
          <div class="text-sm text-gray-500">{{email}}</div>
        </div>
      </div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap" id="user-role-{{id}}">
      <div class="inline-flex items-center">
        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {{roleColorClass}}">
          {{roleLabel}}
        </span>
        <div class="relative ml-2" x-data="{ roleDropdownOpen: false }">
          <button @click="roleDropdownOpen = !roleDropdownOpen" 
                  type="button" 
                  class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-edit text-xs"></i>
          </button>
          <div x-show="roleDropdownOpen" 
               @click.away="roleDropdownOpen = false"
               class="origin-top-right absolute right-0 mt-2 w-36 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-20">
            <div class="py-1">
              <a href="#" @click.prevent="updateUserRole({{id}}, 'user'); roleDropdownOpen = false" 
                 class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                 Użytkownik
              </a>
              <a href="#" @click.prevent="updateUserRole({{id}}, 'manager'); roleDropdownOpen = false" 
                 class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                 Menedżer
              </a>
              <a href="#" @click.prevent="updateUserRole({{id}}, 'admin'); roleDropdownOpen = false" 
                 class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                 Administrator
              </a>
            </div>
          </div>
        </div>
      </div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap" id="user-status-{{id}}">
      <div class="inline-flex items-center">
        <button @click="toggleUserStatus({{id}}, {{active}})" 
                class="relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 {{statusBgClass}}">
          <span class="{{active ? 'translate-x-5' : 'translate-x-0'}} inline-block h-5 w-5 rounded-full bg-white shadow transform transition ease-in-out duration-200"></span>
        </button>
        <span class="ml-2 text-sm {{statusTextClass}}">{{statusLabel}}</span>
      </div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
      {{created_at}}
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
      <button @click="openEditModal({{id}})" class="text-blue-600 hover:text-blue-900 mr-3">
        <i class="fas fa-edit"></i> Edytuj
      </button>
      <button @click="openDeleteModal({{id}}, '{{name}}', '{{surname}}', '{{email}}')" class="text-red-600 hover:text-red-900">
        <i class="fas fa-trash-alt"></i> Usuń
      </button>
    </td>
  </tr>
</template>

</body>
</html>
=== public/views/admin/templates/user-row.php ===
<tr class="user-item">
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
        #{{id}}
    </td>
    <td class="px-6 py-4 whitespace-nowrap">
        <div class="flex items-center">
            <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-700">
                {{initials}}
            </div>
            <div class="ml-4">
                <div class="text-sm font-medium text-gray-900">{{name}} {{surname}}</div>
                <div class="text-sm text-gray-500">{{email}}</div>
            </div>
        </div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap" id="user-role-{{id}}">
        <div class="inline-flex items-center">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {{roleColorClass}}">
                {{roleLabel}}
            </span>
            <div class="relative ml-2" x-data="{ roleDropdownOpen: false }">
                <button @click="roleDropdownOpen = !roleDropdownOpen" 
                        type="button" 
                        class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-edit text-xs"></i>
                </button>
                <div x-show="roleDropdownOpen" 
                     @click.away="roleDropdownOpen = false"
                     class="origin-top-right absolute right-0 mt-2 w-36 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-20">
                    <div class="py-1">
                        <a href="#" @click.prevent="updateUserRole({{id}}, 'user'); roleDropdownOpen = false" 
                           class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                           Użytkownik
                        </a>
                        <a href="#" @click.prevent="updateUserRole({{id}}, 'manager'); roleDropdownOpen = false" 
                           class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                           Menedżer
                        </a>
                        <a href="#" @click.prevent="updateUserRole({{id}}, 'admin'); roleDropdownOpen = false" 
                           class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                           Administrator
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap" id="user-status-{{id}}">
        <div class="inline-flex items-center">
            <button @click="toggleUserStatus({{id}}, {{active}})" 
                    class="relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 {{statusBgClass}}">
                <span class="{{active ? 'translate-x-5' : 'translate-x-0'}} inline-block h-5 w-5 rounded-full bg-white shadow transform transition ease-in-out duration-200"></span>
            </button>
            <span class="ml-2 text-sm {{statusTextClass}}">{{statusLabel}}</span>
        </div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
        {{created_at}}
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
        <button @click="openEditModal({{id}})" class="text-blue-600 hover:text-blue-900 mr-3">
            <i class="fas fa-edit"></i> Edytuj
        </button>
        <button @click="openDeleteModal({{id}}, '{{name}}', '{{surname}}', '{{email}}')" class="text-red-600 hover:text-red-900">
            <i class="fas fa-trash-alt"></i> Usuń
        </button>
    </td>
</tr>
=== public/views/admin/reports.php ===
<?php
// Ensure admin access
if (!isset($_SESSION['user_id']) || $_SESSION['user_role'] !== 'admin') {
    header('Location: /auth/login');
    exit();
}
$pageTitle = "CarFuse - Raporty Systemowe";
$metaDescription = "Panel generowania raportów systemowych CarFuse - twórz i zarządzaj raportami.";
?>
<div class="container mx-auto px-4 py-8">
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Raporty Systemowe 📊</h1>
        <p class="text-gray-600">
            Generuj, przeglądaj i pobieraj raporty dotyczące działania systemu.
        </p>
    </div>

    <!-- Alpine.js data for form validation -->
    <div x-data="reportForm()" class="bg-white rounded-lg shadow-md p-6">
        <form hx-post="/admin/reports/generate"
              hx-indicator="#loadingIndicator"
              hx-target="#reportResult"
              @submit="validateForm($event)"
              class="space-y-4">

            <!-- Typ raportu -->
            <div>
                <label for="report_type" class="block text-sm font-medium text-gray-700 mb-1">Typ raportu</label>
                <select id="report_type" name="report_type" x-model="reportType"
                        class="form-select w-full">
                    <option value="">Wybierz typ raportu</option>
                    <option value="bookings">Raport rezerwacji</option>
                    <option value="users">Raport użytkowników</option>
                    <option value="revenue">Raport przychodów</option>
                </select>
                <p class="text-red-500 text-sm" x-show="errors.reportType">
                    <span x-text="errors.reportType"></span>
                </p>
            </div>

            <!-- Zakres dat -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Data początkowa</label>
                    <input type="date" id="start-date" name="date_range[start]" x-model="startDate"
                           class="form-input w-full" />
                    <p class="text-red-500 text-sm" x-show="errors.startDate">
                        <span x-text="errors.startDate"></span>
                    </p>
                </div>
                <div>
                    <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">Data końcowa</label>
                    <input type="date" id="end-date" name="date_range[end]" x-model="endDate"
                           class="form-input w-full" />
                    <p class="text-red-500 text-sm" x-show="errors.endDate">
                        <span x-text="errors.endDate"></span>
                    </p>
                </div>
            </div>

            <!-- Format eksportu -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Format eksportu</label>
                <div class="flex space-x-4">
                    <label class="cursor-pointer flex flex-col items-center">
                        <input type="radio" name="format" value="pdf" x-model="format" class="hidden" />
                        <i class="fas fa-file-pdf text-2xl mb-1"
                           :class="format === 'pdf' ? 'text-red-500' : 'text-gray-400'"></i>
                        <span :class="format === 'pdf' ? 'font-bold' : ''">PDF</span>
                    </label>
                    <label class="cursor-pointer flex flex-col items-center">
                        <input type="radio" name="format" value="csv" x-model="format" class="hidden" />
                        <i class="fas fa-file-csv text-2xl mb-1"
                           :class="format === 'csv' ? 'text-green-500' : 'text-gray-400'"></i>
                        <span :class="format === 'csv' ? 'font-bold' : ''">CSV</span>
                    </label>
                    <label class="cursor-pointer flex flex-col items-center">
                        <input type="radio" name="format" value="excel" x-model="format" class="hidden" />
                        <i class="fas fa-file-excel text-2xl mb-1"
                           :class="format === 'excel' ? 'text-blue-500' : 'text-gray-400'"></i>
                        <span :class="format === 'excel' ? 'font-bold' : ''">Excel</span>
                    </label>
                </div>
                <p class="text-red-500 text-sm" x-show="errors.format">
                    <span x-text="errors.format"></span>
                </p>
            </div>

            <!-- Submit -->
            <div class="flex items-center space-x-2">
                <div id="loadingIndicator" class="htmx-indicator hidden">
                    <i class="fas fa-spinner fa-spin"></i> Generowanie...
                </div>
                <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Generuj Raport
                </button>
            </div>
        </form>

        <!-- Wynik raportu -->
        <div id="reportResult" class="mt-4"></div>
    </div>

    <!-- Sekcja poprzednich raportów -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <h2 class="text-lg font-bold mb-3">Poprzednie Raporty</h2>
        <div id="recent-reports" hx-get="/admin/reports/recent" hx-trigger="load">
            <!-- Wyświetlanie poprzednich raportów po załadowaniu -->
            <div class="animate-pulse">
                <div class="h-6 bg-gray-200 mb-2 rounded"></div>
                <div class="h-6 bg-gray-200 mb-2 rounded"></div>
            </div>
        </div>
    </div>
</div>

<script>
function reportForm() {
    return {
        reportType: '',
        startDate: '',
        endDate: '',
        format: '',
        errors: {},
        validateForm(e) {
            this.errors = {};
            if (!this.reportType) {
                this.errors.reportType = 'Wybierz typ raportu.';
            }
            if (!this.startDate) {
                this.errors.startDate = 'Wybierz datę początkową.';
            }
            if (!this.endDate) {
                this.errors.endDate = 'Wybierz datę końcową.';
            }
            if (!this.format) {
                this.errors.format = 'Wybierz format eksportu.';
            }
            if (Object.keys(this.errors).length) {
                e.preventDefault();
            }
        }
    };
}
</script>
=== public/views/admin/settings.php ===
<?php
/**
 * Admin Settings Page
 * Unified settings management interface for CarFuse administrators
 */

// Ensure user is authenticated and has admin privileges
if (!isset($_SESSION['user_id']) || $_SESSION['user_role'] !== 'admin') {
    header('Location: /auth/login');
    exit;
}
?>

<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarFuse - Ustawienia Systemu</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.4"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom styles -->
    <style>
        [x-cloak] { display: none !important; }
        .fade-enter { opacity: 0; }
        .fade-enter-active { transition: opacity 0.3s ease; }
        .fade-enter-to { opacity: 1; }
        .settings-form:has(.is-changed) .settings-save { display: flex; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<?php include BASE_PATH . '/public/views/layouts/header.php'; ?>

<div class="container mx-auto px-4 py-8" x-data="settingsManagement()">
    <!-- Page Header -->
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <div class="flex flex-wrap items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Ustawienia Systemu</h1>
                <p class="text-gray-600">Zarządzaj konfiguracją systemu CarFuse</p>
            </div>
            <div class="mt-4 md:mt-0">
                <button @click="saveAllSettings()" 
                        class="settings-save hidden items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md" 
                        :class="{'opacity-50 cursor-wait': isSaving}">
                    <span x-show="!isSaving"><i class="fas fa-save mr-2"></i> Zapisz wszystkie zmiany</span>
                    <span x-show="isSaving" class="flex items-center">
                        <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Zapisywanie...
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Tabs -->
    <div class="bg-white shadow-md rounded-lg overflow-hidden mb-6">
        <div class="border-b border-gray-200">
            <nav class="flex flex-wrap -mb-px">
                <button @click="activeTab = 'general'" :class="{'border-blue-500 text-blue-600': activeTab === 'general'}" class="mr-2 py-4 px-4 font-medium text-sm border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700 whitespace-nowrap">
                    <i class="fas fa-cog mr-1"></i> Ogólne
                </button>
                <button @click="activeTab = 'booking'" :class="{'border-blue-500 text-blue-600': activeTab === 'booking'}" class="mr-2 py-4 px-4 font-medium text-sm border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700 whitespace-nowrap">
                    <i class="fas fa-calendar-alt mr-1"></i> Rezerwacje
                </button>
                <button @click="activeTab = 'notifications'" :class="{'border-blue-500 text-blue-600': activeTab === 'notifications'}" class="mr-2 py-4 px-4 font-medium text-sm border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700 whitespace-nowrap">
                    <i class="fas fa-bell mr-1"></i> Powiadomienia
                </button>
                <button @click="activeTab = 'security'" :class="{'border-blue-500 text-blue-600': activeTab === 'security'}" class="mr-2 py-4 px-4 font-medium text-sm border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700 whitespace-nowrap">
                    <i class="fas fa-shield-alt mr-1"></i> Bezpieczeństwo
                </button>
                <button @click="activeTab = 'integrations'" :class="{'border-blue-500 text-blue-600': activeTab === 'integrations'}" class="py-4 px-4 font-medium text-sm border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700 whitespace-nowrap">
                    <i class="fas fa-plug mr-1"></i> Integracje
                </button>
            </nav>
        </div>

        <!-- General Settings Tab -->
        <div x-show="activeTab === 'general'" class="p-6 settings-form" x-cloak>
            <h2 class="text-lg font-medium text-gray-800 mb-4">Ustawienia Ogólne</h2>
            
            <div class="space-y-6">
                <!-- Company Info -->
                <div class="bg-gray-50 p-4 rounded-md">
                    <h3 class="font-medium text-gray-700 mb-3">Informacje o firmie</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="company_name" class="block text-sm font-medium text-gray-700 mb-1">Nazwa firmy</label>
                                <input type="text" id="company_name" name="company_name" 
                                       class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                       x-model="settings.company_name"
                                       @change="markAsChanged">
                            </div>
                            <div>
                                <label for="company_address" class="block text-sm font-medium text-gray-700 mb-1">Adres</label>
                                <input type="text" id="company_address" name="company_address" 
                                       class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" 
                                       x-model="settings.company_address"
                                       @change="markAsChanged">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="vat_id" class="block text-sm font-medium text-gray-700 mb-1">NIP</label>
                                <input type="text" id="vat_id" name="vat_id" 
                                       class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                       x-model="settings.vat_id"
                                       @change="markAsChanged">
                            </div>
                            <div>
                                <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-1">Telefon kontaktowy</label>
                                <input type="tel" id="phone_number" name="phone_number" 
                                       class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" 
                                       x-model="settings.phone_number"
                                       @change="markAsChanged">
                            </div>
                        </div>
                        
                        <div>
                            <label for="email_contact" class="block text-sm font-medium text-gray-700 mb-1">Email kontaktowy</label>
                            <input type="email" id="email_contact" name="email_contact" 
                                   class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                   x-model="settings.email_contact"
                                   @change="markAsChanged">
                        </div>
                    </div>
                </div>
                
                <!-- System Settings -->
                <div class="bg-gray-50 p-4 rounded-md">
                    <h3 class="font-medium text-gray-700 mb-3">Ustawienia systemowe</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="site_title" class="block text-sm font-medium text-gray-700 mb-1">Tytuł strony</label>
                            <input type="text" id="site_title" name="site_title" 
                                   class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                   x-model="settings.site_title"
                                   @change="markAsChanged">
                        </div>
                        
                        <div>
                            <label for="meta_description" class="block text-sm font-medium text-gray-700 mb-1">Opis strony (meta)</label>
                            <textarea id="meta_description" name="meta_description" rows="2"
                                      class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                      x-model="settings.meta_description"
                                      @change="markAsChanged"></textarea>
                        </div>
                    </div>
                </div>  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            </div>          <div>
        </div>                  <label for="default_language" class="block text-sm font-medium text-gray-700 mb-1">Domyślny język</label>
                                <select id="default_language" name="default_language" 
        <!-- Booking Settings Tab -->   class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
        <!-- ...existing code... -->booking'" class="p-6 settings-form" x-cloak>    x-model="settings.default_language"
            <h2 class="text-lg font-medium text-gray-800 mb-4">Ustawienia Rezerwacji</h2>                                        @change="markAsChanged">
        <!-- Notifications Settings Tab -->
        <div x-show="activeTab === 'notifications'" class="p-6 settings-form" x-cloak>
            <h2 class="text-lg font-medium text-gray-800 mb-4">Ustawienia Powiadomień</h2>
            -50 p-4 rounded-md"> <option value="fr">Francuski</option>
            <div class="space-y-6">0 mb-3">Opcje rezerwacji</h3>
                <!-- Email Notifications -->
                <div class="bg-gray-50 p-4 rounded-md">
                    <h3 class="font-medium text-gray-700 mb-3">Powiadomienia email</h3></label>
                    <div class="space-y-4">(godziny)</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">in_rental_period" name="min_rental_period" min="1"rder border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                            <div>ite border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"ttings.timezone"
                                <label for="smtp_host" class="block text-sm font-medium text-gray-700 mb-1">SMTP Host</label>                 x-model="settings.min_rental_period"                  @change="markAsChanged">
                                <input type="text" id="smtp_host" name="smtp_host"                       @change="markAsChanged">                    <option value="Europe/Warsaw">Europa/Warszawa</option>
                                       class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"dyn</option>
                                       x-model="settings.smtp_host"
                                       @change="markAsChanged">alny okres wynajmu (dni)</label>
                            </div>od" name="max_rental_period" min="1"
                            <div>der-blue-500 block w-full p-2.5"
                                <label for="smtp_port" class="block text-sm font-medium text-gray-700 mb-1">Port SMTP</label>.max_rental_period"
                                <input type="number" id="smtp_port" name="smtp_port" min="1" max="65535"kAsChanged">
                                       class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"      </div>  <div>
                                       x-model="settings.smtp_port"      </div>          <label class="flex items-center">
                                       @change="markAsChanged">                            <input type="checkbox" 
                            </div>                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">                                       class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                        </div>del="settings.maintenance_mode"
                        el for="advance_booking_limit" class="block text-sm font-medium text-gray-700 mb-1">Limit rezerwacji z wyprzedzeniem (dni)</label>   @change="markAsChanged">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">                                <input type="number" id="advance_booking_limit" name="advance_booking_limit" min="1"                                <span class="ml-2 text-sm text-gray-700">Tryb konserwacji</span>
                            <div>ss="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                <label for="smtp_username" class="block text-sm font-medium text-gray-700 mb-1">Nazwa użytkownika SMTP</label>   x-model="settings.advance_booking_limit"="text-xs text-gray-500 mt-1">Gdy włączony, strona będzie niedostępna dla zwykłych użytkowników.</p>
                                <input type="text" id="smtp_username" name="smtp_username"                             @change="markAsChanged">              </div>
                                       class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"                      </div>              </div>
                                       x-model="settings.smtp_username"                     <div>         </div>
                                       @change="markAsChanged">                         <label for="buffer_time" class="block text-sm font-medium text-gray-700 mb-1">Czas buforowy między rezerwacjami (godziny)</label>
                            </div>                                <input type="number" id="buffer_time" name="buffer_time" min="0" step="0.5"                <!-- Currency Settings -->

</html></body></div>    </div>        <!-- ...existing code... -->        <!-- Integrations Settings Tab -->        <!-- ...existing code... -->        <!-- Security Settings Tab -->        </div>            </div>                </div>                    </button>                        </span>                            Zapisywanie...                            </svg>                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">                        <span x-show="isSaving" class="flex items-center">                        <span x-show="!isSaving">Zapisz ustawienia powiadomień</span>                            :class="{'opacity-75 cursor-wait': isSaving}">                            :disabled="isSaving"                            class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"                            @click="saveTabSettings('notifications')"                    <button type="button"                 <div class="flex justify-end">                                </div>                    </div>                        </div>                            </div>                                </select>                                    <option value="messagebird">MessageBird</option>                                    <option value="smsapi">SMSAPI</option>                                    <option value="twilio">Twilio</option>                                       @change="markAsChanged">                                       x-model="settings.sms_provider"                                       class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"                                <select id="sms_provider" name="sms_provider"                                <label for="sms_provider" class="block text-sm font-medium text-gray-700 mb-1">Dostawca SMS</label>                            <div class="mt-4">                                                        </div>                                </div>                                           @change="markAsChanged">                                           x-model="settings.sms_sender_id"                                           class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"                                    <input type="text" id="sms_sender_id" name="sms_sender_id"                                    <label for="sms_sender_id" class="block text-sm font-medium text-gray-700 mb-1">ID nadawcy SMS</label>                                <div>                                </div>                                           @change="markAsChanged">                                           x-model="settings.sms_api_key"                                           class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"                                    <input type="password" id="sms_api_key" name="sms_api_key"                                    <label for="sms_api_key" class="block text-sm font-medium text-gray-700 mb-1">Klucz API SMS</label>                                <div>                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">                        <div x-show="settings.enable_sms_notifications">                                                </div>                            </label>                                <span class="ml-2 text-sm text-gray-700">Włącz powiadomienia SMS</span>                                       @change="markAsChanged">                                       x-model="settings.enable_sms_notifications"                                       class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"                                <input type="checkbox"                             <label class="flex items-center">                        <div>                    <div class="space-y-4">                    <h3 class="font-medium text-gray-700 mb-3">Powiadomienia SMS</h3>                <div class="bg-gray-50 p-4 rounded-md">                <!-- SMS Notifications -->                                </div>                    </div>                        </div>                            </label>                                <span class="ml-2 text-sm text-gray-700">Specjalne oferty i promocje</span>                                       @change="markAsChanged">                                       x-model="settings.notify_special_offers"                                       class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"                                <input type="checkbox"                             <label class="flex items-center">                        <div>                                                </div>                            </label>                                <span class="ml-2 text-sm text-gray-700">Prośba o opinię</span>                                       @change="markAsChanged">                                       x-model="settings.notify_feedback_request"                                       class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"                                <input type="checkbox"                             <label class="flex items-center">                        <div>                                                </div>                            </label>                                <span class="ml-2 text-sm text-gray-700">Przypomnienie o zwrocie</span>                                       @change="markAsChanged">                                       x-model="settings.notify_return_reminder"                                       class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"                                <input type="checkbox"                             <label class="flex items-center">                        <div>                                                </div>                            </label>                                <span class="ml-2 text-sm text-gray-700">Przypomnienie o rezerwacji</span>                                       @change="markAsChanged">                                       x-model="settings.notify_booking_reminder"                                       class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"                                <input type="checkbox"                             <label class="flex items-center">                        <div>                                                </div>                            </label>                                <span class="ml-2 text-sm text-gray-700">Potwierdzenie rezerwacji</span>                                       @change="markAsChanged">                                       x-model="settings.notify_booking_confirmation"                                       class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"                                <input type="checkbox"                             <label class="flex items-center">                        <div>                    <div class="space-y-4">                    <h3 class="font-medium text-gray-700 mb-3">Typy powiadomień</h3>                <div class="bg-gray-50 p-4 rounded-md">                <!-- Notification Types -->                                </div>                    </div>                        </div>                            </select>                                <option value="tls">TLS</option>                                <option value="ssl">SSL</option>                                <option value="none">Brak</option>                                   @change="markAsChanged">                                   x-model="settings.email_encryption"                                   class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"                            <select id="email_encryption" name="email_encryption"                            <label for="email_encryption" class="block text-sm font-medium text-gray-700 mb-1">Szyfrowanie</label>                        <div>                                                </div>                                   @change="markAsChanged">                                   x-model="settings.email_sender"                                   class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"                            <input type="email" id="email_sender" name="email_sender"                            <label for="email_sender" class="block text-sm font-medium text-gray-700 mb-1">Email nadawcy</label>                        <div>                                                </div>                            </div>                                       @change="markAsChanged">                                       x-model="settings.smtp_password"                                       class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"                                <input type="password" id="smtp_password" name="smtp_password"                                <label for="smtp_password" class="block text-sm font-medium text-gray-700 mb-1">Hasło SMTP</label>                            <div>


</html></body></div>    </div>        <!-- ...existing code... -->

        <!-- Integrations Settings Tab -->        <!-- ...existing code... -->        <!-- Security Settings Tab -->        </div>


            </div>                </div>                           @change="markAsChanged">                           x-model="settings.sms_sender"                           class="bg-white border border-gray-300 text-sm rounded-lg p-2.5 w-full focus:ring-blue-500 focus:border-blue-500"




                    <input type="text" id="sms_sender" name="sms_sender"                    <label for="sms_sender" class="block text-sm font-medium text-gray-700 mb-1">Nazwa nadawcy SMS</label>


                    <h3 class="font-medium text-gray-700 mb-3">Powiadomienia SMS</h3>

                <div class="bg-gray-50 p-4 rounded-md">                                </div>                           @change="markAsChanged">                           x-model="settings.email_sender"                           class="bg-white border border-gray-300 text-sm rounded-lg p-2.5 w-full focus:ring-blue-500 focus:border-blue-500"                    <input type="email" id="email_sender" name="email_sender"                    <label for="email_sender" class="block text-sm font-medium text-gray-700 mb-1">Adres nadawcy</label>










                    <h3 class="font-medium text-gray-700 mb-3">Konfiguracja E-mail</h3>
                <div class="bg-gray-50 p-4 rounded-md">





            <div class="space-y-6">            <h2 class="text-lg font-medium text-gray-800 mb-4">Ustawienia Powiadomień</h2>
        <div x-show="activeTab === 'notifications'" class="p-6 settings-form" x-cloak>

        <!-- Notifications Settings Tab -->
        </div>            </div>                </div>                    </button>                        </span>                            Zapisywanie...                            </svg>




                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>








                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>

                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">


                        <span x-show="isSaving" class="flex items-center">

                        <span x-show="!isSaving">Zapisz ustawienia rezerwacji</span>




                            :class="{'opacity-75 cursor-wait': isSaving}">                            :disabled="isSaving"                            class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"




                            @click="saveTabSettings('booking')"                    <button type="button"                 <div class="flex justify-end">


                                </div>                    </div>                        </div>                            <p class="text-xs text-gray-500 mt-1">Klienci muszą zapłacić część ceny z góry, aby potwierdzić rezerwację.</p>






                            </label>                                <span class="ml-2 text-sm text-gray-700">Wymagaj płatności zaliczki</span>


                                       @change="markAsChanged">                                       x-model="settings.require_advance_payment"

                                       class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                                <input type="checkbox"                             <label class="flex items-center">
                        <div>                                                </div>                            <p class="text-xs text-gray-500 mt-1">Automatycznie dostosowuje ceny w zależności od popytu i sezonu.</p>




                            </label>                                <span class="ml-2 text-sm text-gray-700">Włącz dynamiczne ceny</span>

                                       @change="markAsChanged">                                       x-model="settings.enable_dynamic_pricing"                                       class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"

                                <input type="checkbox"                             <label class="flex items-center">                        <div>                                                </div>


                            </div>                                       @change="markAsChanged">                                       x-model="settings.late_return_fee"



                                       class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"                                <input type="number" id="late_return_fee" name="late_return_fee" min="0"


                                <label for="late_return_fee" class="block text-sm font-medium text-gray-700 mb-1">Opłata za późny zwrot (za godzinę)</label>                            <div>                            </div>                                       @change="markAsChanged">                                       x-model="settings.default_deposit"                                       class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"                                <input type="number" id="default_deposit" name="default_deposit" min="0"                                <label for="default_deposit" class="block text-sm font-medium text-gray-700 mb-1">Domyślna kaucja</label>                            <div>                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">                    <div class="space-y-4">                    <h3 class="font-medium text-gray-700 mb-3">Opcje cenowe</h3>                <div class="bg-gray-50 p-4 rounded-md">                <!-- Pricing Options -->                                </div>                    </div>                        </div>                            </div>                                       @change="markAsChanged">                                       x-model="settings.default_pickup_location"                                       class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"                                <input type="text" id="default_pickup_location" name="default_pickup_location"                                <label for="default_pickup_location" class="block text-sm font-medium text-gray-700 mb-1">Domyślna lokalizacja odbioru</label>                            <div>                            </div>                                </select>                                    <option value="custom">Niestandardowa</option>                                    <option value="strict">Rygorystyczna (zwrot 50% 7 dni przed odbiorem)</option>                                    <option value="moderate">Umiarkowana (pełny zwrot 72h przed odbiorem)</option>                                    <option value="flexible">Elastyczna (pełny zwrot 24h przed odbiorem)</option>                                       @change="markAsChanged">                                       x-model="settings.cancellation_policy"                                       class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"                                <select id="cancellation_policy" name="cancellation_policy"                                 <label for="cancellation_policy" class="block text-sm font-medium text-gray-700 mb-1">Polityka anulowania</label>                            <div>                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">                        </div>                            </div>                                       @change="markAsChanged">                                       x-model="settings.buffer_time"                                       class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"                <div class="bg-gray-50 p-4 rounded-md">
                    <h3 class="font-medium text-gray-700 mb-3">Waluta i płatności</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="currency" class="block text-sm font-medium text-gray-700 mb-1">Waluta</label>
                                <select id="currency" name="currency" 
                                        class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                        x-model="settings.currency"
                                        @change="markAsChanged">
                                    <option value="PLN">Złoty (PLN)</option>
                                    <option value="EUR">Euro (EUR)</option>
                                    <option value="USD">Dolar (USD)</option>
                                    <option value="GBP">Funt (GBP)</option>
                                </select>
                            </div>
                            <div>
                                <label for="tax_rate" class="block text-sm font-medium text-gray-700 mb-1">Stawka VAT (%)</label>
                                <input type="number" id="tax_rate" name="tax_rate" min="0" max="100" step="1"
                                       class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                       x-model="settings.tax_rate"
                                       @change="markAsChanged">
                            </div>
                        </div>
                        
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" 
                                       class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                                       x-model="settings.enable_online_payments"
                                       @change="markAsChanged">
                                <span class="ml-2 text-sm text-gray-700">Włącz płatności online</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button type="button" 
                            @click="saveTabSettings('general')"
                            class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                            :disabled="isSaving"
                            :class="{'opacity-75 cursor-wait': isSaving}">
                        <span x-show="!isSaving">Zapisz ustawienia ogólne</span>
                        <span x-show="isSaving" class="flex items-center">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Zapisywanie...
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Booking Settings Tab -->
        <!-- ...existing code... -->

        <!-- Notifications Settings Tab -->
        <div x-show="activeTab === 'notifications'" class="p-6 settings-form" x-cloak>
            <h2 class="text-lg font-medium text-gray-800 mb-4">Ustawienia Powiadomień</h2>
            <div class="space-y-6">
                <div class="bg-gray-50 p-4 rounded-md">
                    <h3 class="font-medium text-gray-700 mb-3">Konfiguracja E-mail</h3>
                    <label for="email_sender" class="block text-sm font-medium text-gray-700 mb-1">Adres nadawcy</label>
                    <input type="email" id="email_sender" name="email_sender"
                           class="bg-white border border-gray-300 text-sm rounded-lg p-2.5 w-full focus:ring-blue-500 focus:border-blue-500"
                           x-model="settings.email_sender"
                           @change="markAsChanged">
                </div>
                
                <div class="bg-gray-50 p-4 rounded-md">
                    <h3 class="font-medium text-gray-700 mb-3">Powiadomienia SMS</h3>
                    <label for="sms_sender" class="block text-sm font-medium text-gray-700 mb-1">Nazwa nadawcy SMS</label>
                    <input type="text" id="sms_sender" name="sms_sender"
                           class="bg-white border border-gray-300 text-sm rounded-lg p-2.5 w-full focus:ring-blue-500 focus:border-blue-500"
                           x-model="settings.sms_sender"
                           @change="markAsChanged">
                </div>
            </div>
        </div>

        <!-- Security Settings Tab -->
        <!-- ...existing code... -->

        <!-- Integrations Settings Tab -->
        <!-- ...existing code... -->
    </div>
</div>
</body>
</html>
=== public/views/layouts/header.php ===
<header x-data="{ openMenu: false }" class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
        <h1 class="text-2xl font-bold">Wypożyczalnia Samochodów</h1>
        <button @click="openMenu = !openMenu" class="md:hidden text-gray-700">
            Menu
        </button>
        <nav :class="{'hidden': !openMenu, 'block': openMenu}" class="space-x-4 md:flex">
            <a href="/dashboard" class="text-gray-700 hover:underline">Panel Główny</a>
            <a href="/bookings/user" class="text-gray-700 hover:underline">Moje Rezerwacje</a>
            <div class="relative" x-data="{ openLang: false }">
                <button @click="openLang = !openLang" class="text-gray-700 hover:underline">Język</button>
                <div x-show="openLang" @click.outside="openLang = false" class="absolute right-0 mt-2 w-32 bg-white border rounded shadow px-2">
                    <a href="#" class="block py-2 text-gray-700 hover:bg-gray-100">Polski</a>
                    <a href="#" class="block py-2 text-gray-700 hover:bg-gray-100">English</a>
                </div>
            </div>
            <a href="/user/account" class="text-gray-700 hover:underline">Moje Konto</a>
            <!-- ... ewentualnie miejsce na dynamiczne dane, np. "Witaj, <?= $username; ?>" ... -->
        </nav>
    </div>
</header>=== public/views/layouts/base.php ===
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= $pageTitle ?? 'CarFuse - Wypożyczalnia samochodów' ?></title>
    <meta name="description" content="<?= $metaDescription ?? 'CarFuse - nowoczesna wypożyczalnia samochodów online.' ?>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.4"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom styles -->
    <style>
        [x-cloak] { display: none !important; }
        .stats-card:hover { transform: translateY(-5px); }
        .stats-card { transition: all 0.3s ease; }
        <?= $extraStyles ?? '' ?>
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Header -->
    <?php include BASE_PATH . '/public/views/layouts/header.php'; ?>

    <!-- Main Content -->
    <main class="flex-grow">
        <?= $content ?? '' ?>
    </main>

    <!-- Footer -->
    <?php include BASE_PATH . '/public/views/layouts/footer.php'; ?>

    <!-- Custom scripts -->
    <?php if (isset($extraScripts)): ?>
        <?= $extraScripts ?>
    <?php endif; ?>
</body>
</html>
=== public/views/layouts/footer.php ===
<footer class="bg-white shadow mt-8" x-data="{}">
    <div class="max-w-7xl mx-auto px-4 py-3 text-center text-sm text-gray-500">
        &copy; <span x-text="new Date().getFullYear()"></span> Wynajem Samochodów. Prawa autorskie. Wszelkie prawa zastrzeżone.
    </div>
</footer>
=== public/views/layouts/header_alt.php ===
<?php
/*
|--------------------------------------------------------------------------
| Header - Dynamiczny Nagłówek dla Wszystkich Widoków
|--------------------------------------------------------------------------
| Plik przełącza się dynamicznie pomiędzy stroną główną, pulpitem użytkownika
| oraz pulpitem administratora. Wyświetla odpowiednie skróty i powitanie.
|
| Ścieżka: public/layouts/header.php
*/

if (!isset($_SESSION)) {
    session_start();
}

// Ensure the header is included only once
if (!empty($_SESSION['layout_loaded'])) {
    return;
}
$_SESSION['layout_loaded'] = true;

$isLoggedIn = isset($_SESSION['user_id']);
$isAdmin = isset($_SESSION['user_role']) && $_SESSION['user_role'] === 'admin';
$username = $isLoggedIn ? $_SESSION['username'] : "Gość";

// Pobranie losowego modelu auta z bazy, jeśli są dostępne
$availableCars = ["Toyota Corolla", "Ford Mustang", "BMW X5", "Audi A6", "Mercedes C-Class"];
$randomCar = $availableCars[array_rand($availableCars)];

// Lista powitań dynamicznych
$greetings = [
    "Hej, $username! $randomCar już czeka na przygodę! 🚗💨",
    "Witaj, $username! Może dziś przejażdżka $randomCar? 🌍",
    "$username, świat stoi przed Tobą otworem! $randomCar już grzeje silnik! 🏎️",
    "Gotowy na podróż, $username? $randomCar nie chce stać w miejscu! 📅",
    "$username, może czas na spontaniczny wypad? $randomCar jest gotowy! 🎒",
    "Nie czekaj, $username – $randomCar znika szybciej niż hot dogi na stacji! ⏳",
    "Witaj, $username! Może dziś coś sportowego? $randomCar czeka na rozgrzanie! 🏁",
    "Nie musisz mieć własnego auta, $username! $randomCar już czeka, by Ci służyć! 🚗",
    "Hej, $username! $randomCar to klucz do niezapomnianej podróży! 💰",
    "$username, weekend bez planu? $randomCar to zawsze dobry pomysł! 🏕️",
    "Dłuższy wyjazd? Krótki city-break? $randomCar nie pyta – jedzie! 🛣️",
    "Nie czekaj do ostatniej chwili, $username! $randomCar chce ruszać! 🔥",
    "Dziś dobry dzień na podróż, $username! $randomCar jest na to gotowy! 🏖️",
    "Niech nic Cię nie zatrzyma, $username! $randomCar tylko czeka na Twój ruch! 🚙",
    "$username, wiesz co robi różnicę? Wybór auta. Może $randomCar? 🏜️",
    "Każda podróż zaczyna się od decyzji – a $randomCar to świetny wybór! 🛤️",
    "Twój plan na dziś: rezerwacja, kluczyki, $randomCar i w drogę! 🚦",
    "$username, czas na nową trasę! $randomCar już gotowy do jazdy! 🚘",
    "Nie odkładaj marzeń na później, $username – wynajmij $randomCar i jedź! 🎯",
    "Najlepsze podróże zaczynają się od rezerwacji! Może $randomCar? 📌",
    "$randomCar mówi, że masz jeszcze czas na rezerwację… ale nie za długo! 🏁",
    "Masz misję, $username! Wsiadaj do $randomCar i ruszaj na wyprawę! 🎯",
    "Nie masz planów na weekend? $randomCar ma je za Ciebie! 🚀",
    "Czyżbyś szukał przygody, $username? $randomCar już pali się do jazdy! 🔥",
    "Twój dzień zapowiada się ciekawie, jeśli wsiądziesz do $randomCar! 🎉",
    "$username, za godzinę w mieście jest koncert. $randomCar to Twoja wejściówka! 🎶",
    "Niespodzianka! Twój $randomCar ma bagażnik pełen optymizmu! 📦😁",
    "$username, w $randomCar radio puszcza tylko najlepsze kawałki do jazdy! 🎧",
    "$randomCar mówi, że potrzebuje wakacji. Zawieź go gdzieś! 🌴",
];

$greeting = $isLoggedIn ? $greetings[array_rand($greetings)] : "Witaj w CarFuse! Wynajmij auto i ruszaj w drogę!";

// Include navbar
include_once BASE_PATH . '/public/views/layouts/navbar.php';
?>

<!-- Greeting Banner -->
<div class="bg-blue-50 py-3">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center text-blue-700 font-medium">
            <?= $greeting ?>
        </div>
    </div>
</div>=== public/views/layouts/alerts.php ===
<?php
/*
|--------------------------------------------------------------------------
| Alerts - Globalne Powiadomienia
|--------------------------------------------------------------------------
| Plik odpowiada za wyświetlanie globalnych alertów i powiadomień.
|
| Ścieżka: App/Views/layouts/alerts.php
*/
?>

<div id="alert-container"></div>
=== public/views/layouts/navbar.php ===
<?php
/**
 * Main Navigation Bar Component
 * Unified navigation for CarFuse application
 */

if (!isset($_SESSION)) {
    session_start();
}

$isLoggedIn = isset($_SESSION['user_id']);
$isAdmin = isset($_SESSION['user_role']) && $_SESSION['user_role'] === 'admin';
$username = $isLoggedIn ? $_SESSION['username'] : "Gość";
?>

<nav class="bg-white shadow-md" x-data="{ mobileMenuOpen: false, notificationsOpen: false, userMenuOpen: false }">
    <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex px-2 lg:px-0">
                <div class="flex-shrink-0 flex items-center">
                    <a href="/" class="flex items-center">
                        <span class="text-2xl font-bold text-blue-600">🚗 CarFuse</span>
                    </a>
                </div>
                
                <!-- Desktop Navigation Links -->
                <div class="hidden lg:ml-6 lg:flex lg:space-x-4">
                    <a href="/" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Strona Główna</a>
                    
                    <?php if ($isLoggedIn): ?>
                        <?php if ($isAdmin): ?>
                            <a href="/dashboard" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Panel Administratora</a>
                            <a href="/admin/vehicles" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Zarządzanie Pojazdami</a>
                            <a href="/admin/bookings" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Rezerwacje</a>
                            <a href="/admin/users" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Użytkownicy</a>
                        <?php else: ?>
                            <a href="/dashboard" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Panel Główny</a>
                            <a href="/bookings" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Moje Rezerwacje</a>
                            <a href="/vehicles" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Oferta Pojazdów</a>
                        <?php endif; ?>
                    <?php else: ?>
                        <a href="/vehicles" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Oferta Pojazdów</a>
                        <a href="/pricing" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Cennik</a>
                        <a href="/contact" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Kontakt</a>
                    <?php endif; ?>
                </div>
            </div>
            
            <!-- Right Side Navigation Items -->
            <div class="flex items-center lg:hidden">
                <!-- Mobile menu button -->
                <button @click="mobileMenuOpen = !mobileMenuOpen" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-700 hover:text-gray-900 hover:bg-gray-50 focus:outline-none" aria-expanded="false">
                    <span class="sr-only">Otwórz menu główne</span>
                    <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" x-show="!mobileMenuOpen"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" x-show="mobileMenuOpen"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Desktop Right Side Items -->
            <div class="hidden lg:ml-4 lg:flex lg:items-center">
                <?php if ($isLoggedIn): ?>
                    <!-- Notifications Dropdown -->
                    <div class="ml-4 relative flex-shrink-0" x-data="{ unreadCount: 0 }" x-init="
                        fetch('/user/notifications/unread-count').then(res => res.json()).then(data => {
                            if(data.status === 'success') unreadCount = data.data.count;
                        })
                    ">
                        <button @click="notificationsOpen = !notificationsOpen" class="relative p-1 rounded-full text-gray-600 hover:text-gray-900 focus:outline-none">
                            <span class="sr-only">Zobacz powiadomienia</span>
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            <span x-show="unreadCount > 0" 
                                class="absolute top-0 right-0 block h-5 w-5 rounded-full bg-red-500 text-xs text-white font-bold flex items-center justify-center transform -translate-y-1 translate-x-1" 
                                x-text="unreadCount"></span>
                        </button>
                        
                        <!-- Notifications Panel -->
                        <div x-show="notificationsOpen" 
                            @click.away="notificationsOpen = false" 
                            x-transition:enter="transition ease-out duration-100" 
                            x-transition:enter-start="transform opacity-0 scale-95" 
                            x-transition:enter-end="transform opacity-100 scale-100" 
                            x-transition:leave="transition ease-in duration-75" 
                            x-transition:leave-start="transform opacity-100 scale-100" 
                            x-transition:leave-end="transform opacity-0 scale-95" 
                            class="origin-top-right absolute right-0 mt-2 w-96 rounded-md shadow-lg z-50">
                            <div id="notifications-dropdown-container">
                                <?php include BASE_PATH . '/public/views/partials/notifications-list.php'; ?>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Dropdown -->
                    <div class="ml-4 relative flex-shrink-0">
                        <div>
                            <button @click="userMenuOpen = !userMenuOpen" type="button" class="rounded-full flex text-sm focus:outline-none items-center text-gray-700 hover:text-gray-900" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
                                <span class="sr-only">Otwórz menu użytkownika</span>
                                <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center mr-2">
                                    <span class="text-blue-700 font-medium"><?= substr($username, 0, 1) ?></span>
                                </div>
                                <span class="hidden md:block font-medium"><?= $username ?></span>
                                <svg class="ml-1 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- User Dropdown Menu -->
                        <div x-show="userMenuOpen" 
                            @click.away="userMenuOpen = false" 
                            x-transition:enter="transition ease-out duration-100" 
                            x-transition:enter-start="transform opacity-0 scale-95" 
                            x-transition:enter-end="transform opacity-100 scale-100" 
                            x-transition:leave="transition ease-in duration-75" 
                            x-transition:leave-start="transform opacity-100 scale-100" 
                            x-transition:leave-end="transform opacity-0 scale-95" 
                            class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50" 
                            role="menu" 
                            aria-orientation="vertical" 
                            aria-labelledby="user-menu-button" 
                            tabindex="-1">
                            
                            <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                <i class="fas fa-user mr-2"></i> Mój profil
                            </a>
                            
                            <?php if ($isAdmin): ?>
                            <a href="/admin/settings" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                <i class="fas fa-cog mr-2"></i> Ustawienia
                            </a>
                            <?php else: ?>
                            <a href="/settings" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                <i class="fas fa-cog mr-2"></i> Ustawienia
                            </a>
                            <?php endif; ?>
                            
                            <hr class="my-1">
                            
                            <a href="/logout" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100" role="menuitem">
                                <i class="fas fa-sign-out-alt mr-2"></i> Wyloguj się
                            </a>
                        </div>
                    </div>
                <?php else: ?>
                    <div class="flex items-center">
                        <a href="/auth/login" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none">
                            <i class="fas fa-sign-in-alt mr-2"></i> Zaloguj się
                        </a>
                        <a href="/auth/register" class="ml-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">
                            <i class="fas fa-user-plus mr-2"></i> Zarejestruj się
                        </a>
                    </div>
                <?php endif; ?>
            </div>
        </div>
    </div>

    <!-- Mobile menu -->
    <div x-show="mobileMenuOpen" 
         x-transition:enter="transition ease-out duration-200" 
         x-transition:enter-start="opacity-0 transform -translate-y-2" 
         x-transition:enter-end="opacity-100 transform translate-y-0" 
         x-transition:leave="transition ease-in duration-150" 
         x-transition:leave-start="opacity-100 transform translate-y-0" 
         x-transition:leave-end="opacity-0 transform -translate-y-2" 
         class="lg:hidden">
        <div class="pt-2 pb-3 space-y-1">
            <a href="/" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Strona Główna</a>
            
            <?php if ($isLoggedIn): ?>
                <?php if ($isAdmin): ?>
                    <a href="/dashboard" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Panel Administratora</a>
                    <a href="/admin/vehicles" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Zarządzanie Pojazdami</a>
                    <a href="/admin/bookings" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Rezerwacje</a>
                    <a href="/admin/users" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Użytkownicy</a>
                <?php else: ?>
                    <a href="/dashboard" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Panel Główny</a>
                    <a href="/bookings" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Moje Rezerwacje</a>
                    <a href="/vehicles" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Oferta Pojazdów</a>
                <?php endif; ?>
            <?php else: ?>
                <a href="/vehicles" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Oferta Pojazdów</a>
                <a href="/pricing" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Cennik</a>
                <a href="/contact" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">Kontakt</a>
            <?php endif; ?>
        </div>
        
        <?php if ($isLoggedIn): ?>
            <div class="pt-4 pb-3 border-t border-gray-200">
                <div class="flex items-center px-4">
                    <div class="flex-shrink-0">
                        <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                            <span class="text-blue-700 font-medium"><?= substr($username, 0, 1) ?></span>
                        </div>
                    </div>
                    <div class="ml-3">
                        <div class="text-base font-medium text-gray-800"><?= $username ?></div>
                        <div class="text-sm font-medium text-gray-500"><?= $_SESSION['user_email'] ?? '' ?></div>
                    </div>
                    <button class="ml-auto flex-shrink-0 p-1 rounded-full text-gray-600 hover:text-gray-900 focus:outline-none"
                        hx-get="/user/notifications" 
                        hx-target="#mobile-notifications-container"
                        hx-swap="innerHTML">
                        <span class="sr-only">Zobacz powiadomienia</span>
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                    </button>
                </div>
                
                <div id="mobile-notifications-container" class="mt-3 px-2 space-y-1">
                    <!-- Mobile notifications will be loaded here via HTMX -->
                </div>
                
                <div class="mt-3 space-y-1">
                    <a href="/profile" class="block px-4 py-2 text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">
                        <i class="fas fa-user mr-2"></i> Mój profil
                    </a>
                    
                    <?php if ($isAdmin): ?>
                    <a href="/admin/settings" class="block px-4 py-2 text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">
                        <i class="fas fa-cog mr-2"></i> Ustawienia
                    </a>
                    <?php else: ?>
                    <a href="/settings" class="block px-4 py-2 text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">
                        <i class="fas fa-cog mr-2"></i> Ustawienia
                    </a>
                    <?php endif; ?>
                    
                    <a href="/logout" class="block px-4 py-2 text-base font-medium text-red-600 hover:text-red-900 hover:bg-gray-50">
                        <i class="fas fa-sign-out-alt mr-2"></i> Wyloguj się
                    </a>
                </div>
            </div>
        <?php else: ?>
            <div class="pt-4 pb-3 border-t border-gray-200">
                <div class="space-y-1 px-3">
                    <a href="/auth/login" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">
                        <i class="fas fa-sign-in-alt mr-2"></i> Zaloguj się
                    </a>
                    <a href="/auth/register" class="block px-3 py-2 rounded-md text-base font-medium text-blue-600 hover:text-blue-900 hover:bg-gray-50">
                        <i class="fas fa-user-plus mr-2"></i> Zarejestruj się
                    </a>
                </div>
            </div>
        <?php endif; ?>
    </div>
</nav>
=== public/views/partials/booking-list-item.php ===
<div class="booking-item border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition-shadow mb-4" 
     x-data="bookingCard({
        id: <?= $booking->id ?>,
        status: '<?= $booking->status ?>'
     })">
    <div class="flex flex-wrap md:flex-nowrap">
        <!-- Vehicle Image -->
        <div class="w-full md:w-1/4">
            <img src="<?= htmlspecialchars($booking->vehicle_image ?? '/assets/images/cars/default.jpg') ?>" 
                 alt="<?= htmlspecialchars($booking->vehicle_name ?? 'Vehicle') ?>" 
                 class="w-full h-32 md:h-full object-cover">
        </div>
        
        <!-- Booking Details -->
        <div class="w-full md:w-3/4 p-4">
            <div class="flex flex-wrap justify-between items-start">
                <div>
                    <h3 class="text-lg font-medium text-gray-900"><?= htmlspecialchars($booking->vehicle_name ?? 'Pojazd') ?></h3>
                    <div class="flex items-center text-sm text-gray-600 mt-1">
                        <i class="fas fa-calendar mr-1"></i>
                        <?= (new DateTime($booking->start_date))->format('d.m.Y H:i') ?>
                        <i class="fas fa-arrow-right mx-2"></i>
                        <?= (new DateTime($booking->end_date))->format('d.m.Y H:i') ?>
                    </div>
                    <div class="flex items-center text-sm text-gray-600 mt-1">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        <?= htmlspecialchars($booking->pickup_location ?? 'Lokalizacja odbioru') ?>
                    </div>
                    
                    <button @click="toggleExpand()" class="mt-2 text-blue-600 text-sm flex items-center">
                        <span x-text="expanded ? 'Zwiń szczegóły' : 'Zobacz szczegóły'"></span>
                        <svg class="w-4 h-4 ml-1 transition-transform" :class="expanded ? 'transform rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Status Badge and Actions -->
                <div class="mt-2 md:mt-0">
                    <?php
                    $statusClass = '';
                    switch ($booking->status) {
                        case 'completed':
                            $statusClass = 'bg-green-100 text-green-800';
                            $statusText = 'Ukończona';
                            break;
                        case 'canceled':
                            $statusClass = 'bg-red-100 text-red-800';
                            $statusText = 'Anulowana';
                            break;
                        case 'pending':
                            $statusClass = 'bg-yellow-100 text-yellow-800';
                            $statusText = 'Oczekująca';
                            break;
                        default:
                            $statusClass = 'bg-blue-100 text-blue-800';
                            $statusText = 'Aktywna';
                    }
                    ?>
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <?= $statusClass ?>">
                        <?= $statusText ?>
                    </span>
                    
                    <div class="mt-3 flex space-x-2">
                        <a href="/bookings/<?= $booking->id ?>" class="text-blue-600 hover:text-blue-900 flex items-center text-sm">
                            <i class="fas fa-eye mr-1"></i> Szczegóły
                        </a>
                        
                        <?php if ($booking->status === 'active' || $booking->status === 'pending'): ?>
                        <button type="button" 
                                onclick="openModal('cancel', <?= $booking->id ?>)"
                                class="text-red-600 hover:text-red-900 flex items-center text-sm">
                            <i class="fas fa-times mr-1"></i> Anuluj
                        </button>
                        
                        <button type="button" 
                                onclick="openModal('reschedule', <?= $booking->id ?>)"
                                class="text-yellow-600 hover:text-yellow-900 flex items-center text-sm">
                            <i class="fas fa-calendar-alt mr-1"></i> Zmień termin
                        </button>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
            
            <!-- Expandable Details -->
            <div x-show="expanded" x-collapse x-cloak class="mt-4 pt-4 border-t border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-medium text-gray-700">Szczegóły rezerwacji</h4>
                        <ul class="mt-2 space-y-2 text-sm">
                            <li class="flex items-center">
                                <span class="font-medium w-40">ID rezerwacji:</span>
                                <span><?= $booking->id ?></span>
                            </li>
                            <li class="flex items-center">
                                <span class="font-medium w-40">Data rezerwacji:</span>
                                <span><?= (new DateTime($booking->created_at))->format('d.m.Y H:i') ?></span>
                            </li>
                            <li class="flex items-center">
                                <span class="font-medium w-40">Status płatności:</span>
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <?= $booking->payment_status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800' ?>">
                                    <?= $booking->payment_status === 'completed' ? 'Opłacona' : 'Oczekująca' ?>
                                </span>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-700">Informacje o pojeździe</h4>
                        <ul class="mt-2 space-y-2 text-sm">
                            <li class="flex items-center">
                                <span class="font-medium w-40">Model:</span>
                                <span><?= htmlspecialchars($booking->vehicle_name ?? 'Brak danych') ?></span>
                            </li>
                            <li class="flex items-center">
                                <span class="font-medium w-40">Numer rejestracyjny:</span>
                                <span><?= htmlspecialchars($booking->vehicle_registration ?? 'Brak danych') ?></span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <?php if ($booking->status === 'active' || $booking->status === 'pending'): ?>
                <div class="mt-4 pt-3 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">
                            <i class="fas fa-money-bill-wave mr-1"></i> Całkowity koszt:
                            <span class="font-semibold"><?= formatCurrency($booking->total_price ?? 0) ?></span>
                        </span>
                        
                        <?php if ($booking->status === 'pending' && $booking->payment_status !== 'completed'): ?>
                        <a href="/payments/<?= $booking->id ?>" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-sm">
                            <i class="fas fa-credit-card mr-1"></i> Zapłać teraz
                        </a>
                        <?php endif; ?>
                    </div>
                </div>
                <?php endif; ?>
                
                <!-- Booking Timeline -->
                <div class="mt-6">
                    <h4 class="font-medium text-gray-700">Historia rezerwacji</h4>
                    <div class="mt-2 relative">
                        <div class="absolute left-4 top-0 h-full w-0.5 bg-gray-200"></div>
                        
                        <?php if (!empty($booking->history)) : ?>
                            <?php foreach ($booking->history as $historyItem): ?>
                            <div class="relative flex items-start mb-4">
                                <div class="flex items-center justify-center h-8 w-8 rounded-full bg-white border-2 border-blue-500 z-10">
                                    <i class="fas fa-check text-blue-500 text-sm"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-900"><?= htmlspecialchars($historyItem->title) ?></p>
                                    <p class="text-xs text-gray-500"><?= (new DateTime($historyItem->date))->format('d.m.Y H:i') ?></p>
                                    <?php if (!empty($historyItem->description)): ?>
                                    <p class="text-sm text-gray-600 mt-1"><?= htmlspecialchars($historyItem->description) ?></p>
                                    <?php endif; ?>
                                </div>
                            </div>
                            <?php endforeach; ?>
                        <?php else: ?>
                            <p class="ml-10 text-sm text-gray-500">Brak historii dla tej rezerwacji</p>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
=== public/views/partials/payment-method-card.php ===
<?php
// Required variables: $method with payment method data
$isDefault = isset($method['is_default']) && $method['is_default'];

// Determine card icon based on type
$cardIcon = 'credit-card';
$bgColor = 'bg-white';
$brandName = '';

if ($method['type'] === 'credit_card') {
    // Determine card brand
    $brand = strtolower($method['card_brand'] ?? '');
    if (strpos($brand, 'visa') !== false) {
        $cardIcon = 'cc-visa';
        $bgColor = 'bg-blue-50';
        $brandName = 'Visa';
    } elseif (strpos($brand, 'mastercard') !== false) {
        $cardIcon = 'cc-mastercard';
        $bgColor = 'bg-yellow-50';
        $brandName = 'Mastercard';
    } else {
        $brandName = ucfirst($brand);
    }
} elseif ($method['type'] === 'bank_transfer') {
    $cardIcon = 'university';
    $bgColor = 'bg-green-50';
} elseif ($method['type'] === 'blik') {
    $cardIcon = 'mobile-alt';
    $bgColor = 'bg-purple-50';
}
?>

<div class="border rounded-lg shadow <?= $bgColor ?> p-4 relative">
    <?php if ($isDefault): ?>
    <div class="absolute top-0 right-0 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-bl-lg">
        Domyślna
    </div>
    <?php endif; ?>
    
    <div class="flex items-center mb-3">
        <div class="text-2xl text-gray-700 mr-3">
            <i class="fas fa-<?= $cardIcon ?>"></i>
        </div>
        <div>
            <?php if ($method['type'] === 'credit_card'): ?>
                <h4 class="font-semibold"><?= $brandName ?> •••• <?= htmlspecialchars($method['card_last4'] ?? '????') ?></h4>
                <p class="text-sm text-gray-500">Wygasa: <?= htmlspecialchars($method['expiry_date'] ?? 'MM/RR') ?></p>
            <?php elseif ($method['type'] === 'bank_transfer'): ?>
                <h4 class="font-semibold"><?= htmlspecialchars($method['bank_name'] ?? 'Przelew bankowy') ?></h4>
                <p class="text-sm text-gray-500">Konto: •••• <?= substr($method['account_number'] ?? '', -4) ?></p>
            <?php elseif ($method['type'] === 'blik'): ?>
                <h4 class="font-semibold">BLIK</h4>
                <p class="text-sm text-gray-500">Płatność kodem jednorazowym</p>
            <?php endif; ?>
        </div>
    </div>
    
    <div class="flex justify-end space-x-2">
        <button 
            onclick="paymentMethods().viewPaymentMethodDetails('<?= $method['id'] ?>')"
            class="text-blue-500 hover:text-blue-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
        </button>
        
        <?php if (!$isDefault): ?>
        <button 
            onclick="paymentMethods().setDefaultPaymentMethod('<?= $method['id'] ?>')"
            class="text-green-500 hover:text-green-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
        </button>
        <?php endif; ?>
        
        <button 
            onclick="paymentMethods().deletePaymentMethod('<?= $method['id'] ?>')"
            class="text-red-500 hover:text-red-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        </button>
    </div>
</div>
=== public/views/partials/modal.php ===
<?php
/**
 * Reusable Modal Component
 * 
 * Parameters:
 * @param string $id                 Unique identifier for the modal
 * @param string $title              Modal title
 * @param string $size               Modal size: 'sm', 'md', 'lg', 'xl' (default: 'md')
 * @param string $modalVar           Alpine.js variable controlling modal visibility (default: 'showModal')
 * @param string $primaryBtn         Primary button text (default: 'Zapisz')
 * @param string $secondaryBtn       Secondary button text (default: 'Anuluj')
 * @param string $dangerBtn          Danger button text if needed (default: 'Usuń')
 * @param string $primaryAction      JS code for primary button action
 * @param string $secondaryAction    JS code for secondary button action (default: close modal)
 * @param string $dangerAction       JS code for danger button action
 * @param bool $showPrimaryBtn       Whether to show primary button (default: true)
 * @param bool $showSecondaryBtn     Whether to show secondary button (default: true)
 * @param bool $showDangerBtn        Whether to show danger button (default: false)
 * @param bool $preventCloseOutside  Prevent closing when clicking outside (default: false)
 * @param string $htmxPrimaryTarget  HTMX target for primary action
 * @param string $htmxPrimarySwap    HTMX swap mode for primary action
 * @param string $htmxPrimaryUrl     HTMX URL for primary action
 * @param string $htmxPrimaryVals    HTMX values for primary action
 * @param string $contentUrl         URL to load content dynamically with HTMX
 */

// Default values
$id = $id ?? 'modal-' . uniqid();
$title = $title ?? 'Modal';
$size = $size ?? 'md';
$modalVar = $modalVar ?? 'showModal';
$primaryBtn = $primaryBtn ?? 'Zapisz';
$secondaryBtn = $secondaryBtn ?? 'Anuluj';
$dangerBtn = $dangerBtn ?? 'Usuń';
$primaryAction = $primaryAction ?? '';
$secondaryAction = $secondaryAction ?? "$modalVar = false";
$dangerAction = $dangerAction ?? '';
$showPrimaryBtn = $showPrimaryBtn ?? true;
$showSecondaryBtn = $showSecondaryBtn ?? true;
$showDangerBtn = $showDangerBtn ?? false;
$preventCloseOutside = $preventCloseOutside ?? false;
$htmxPrimaryTarget = $htmxPrimaryTarget ?? '';
$htmxPrimarySwap = $htmxPrimarySwap ?? 'innerHTML';
$htmxPrimaryUrl = $htmxPrimaryUrl ?? '';
$htmxPrimaryVals = $htmxPrimaryVals ?? '';
$contentUrl = $contentUrl ?? '';

// Size classes
$sizeClasses = [
    'sm' => 'sm:max-w-sm',
    'md' => 'sm:max-w-md',
    'lg' => 'sm:max-w-lg',
    'xl' => 'sm:max-w-xl',
    '2xl' => 'sm:max-w-2xl',
    'full' => 'sm:max-w-full sm:w-full'
];
$modalSizeClass = $sizeClasses[$size] ?? $sizeClasses['md'];
?>

<div x-show="<?= $modalVar ?>" 
     class="fixed inset-0 z-50 overflow-y-auto" 
     role="dialog"
     aria-modal="true"
     aria-labelledby="<?= $id ?>-title"
     x-cloak
     @keydown.escape.window="<?= $modalVar ?> = false">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div x-show="<?= $modalVar ?>" 
             x-transition:enter="ease-out duration-300" 
             x-transition:enter-start="opacity-0" 
             x-transition:enter-end="opacity-100" 
             x-transition:leave="ease-in duration-200" 
             x-transition:leave-start="opacity-100" 
             x-transition:leave-end="opacity-0" 
             class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" 
             aria-hidden="true"
             <?= !$preventCloseOutside ? '@click="' . $modalVar . ' = false"' : '' ?>>
        </div>

        <!-- Centering trick -->
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <!-- Modal panel -->
        <div x-show="<?= $modalVar ?>" 
             x-transition:enter="ease-out duration-300" 
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" 
             x-transition:leave="ease-in duration-200" 
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" 
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
             class="inline-block w-full px-4 pt-5 pb-4 overflow-hidden text-left align-bottom transition-all transform bg-white rounded-lg shadow-xl sm:my-8 sm:align-middle <?= $modalSizeClass ?> sm:p-6"
             <?= !$preventCloseOutside ? '@click.away="' . $modalVar . ' = false"' : '' ?>>
            
            <!-- Modal header -->
            <div class="flex items-center justify-between pb-3 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800" id="<?= $id ?>-title">
                    <?= $title ?>
                </h3>
                <button @click="<?= $modalVar ?> = false" type="button" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                    <span class="sr-only">Zamknij</span>
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Modal content -->
            <div class="mt-4" id="<?= $id ?>-content" <?= $contentUrl ? 'hx-get="' . $contentUrl . '" hx-trigger="load"' : '' ?>>
                <?php if (isset($content)): ?>
                    <?= $content ?>
                <?php else: ?>
                    <!-- Default placeholder content or slot for dynamically loaded content -->
                    <?php if (!$contentUrl): ?>
                        <p class="text-gray-600">Zawartość modalu</p>
                    <?php else: ?>
                        <div class="flex justify-center py-4">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                        </div>
                    <?php endif; ?>
                <?php endif; ?>
            </div>
            
            <!-- Modal footer with actions -->
            <div class="mt-5 sm:mt-6 flex flex-row-reverse gap-2 pt-3 border-t border-gray-200">
                <?php if ($showPrimaryBtn): ?>
                <button 
                    <?php if ($htmxPrimaryUrl): ?>
                        hx-<?= strpos($htmxPrimaryUrl, 'get:') === 0 ? 'get' : 'post' ?>="<?= str_replace(['get:', 'post:'], '', $htmxPrimaryUrl) ?>"
                        hx-target="<?= $htmxPrimaryTarget ?>"
                        hx-swap="<?= $htmxPrimarySwap ?>"
                        <?= $htmxPrimaryVals ? "hx-vals='$htmxPrimaryVals'" : "" ?>
                    <?php endif; ?>
                    @click="<?= $primaryAction ?>"
                    class="inline-flex justify-center px-4 py-2 ml-3 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <?= $primaryBtn ?>
                </button>
                <?php endif; ?>
                
                <?php if ($showDangerBtn): ?>
                <button 
                    @click="<?= $dangerAction ?>"
                    class="inline-flex justify-center px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    <?= $dangerBtn ?>
                </button>
                <?php endif; ?>
                
                <?php if ($showSecondaryBtn): ?>
                <button 
                    @click="<?= $secondaryAction ?>"
                    class="inline-flex justify-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <?= $secondaryBtn ?>
                </button>
                <?php endif; ?>
            </div>
        </div>
    </div>
</div>
=== public/views/partials/payment-details.php ===
<?php
// Required variables: $details with payment details
$statusClasses = [
    'completed' => 'bg-green-100 text-green-800',
    'pending' => 'bg-yellow-100 text-yellow-800',
    'failed' => 'bg-red-100 text-red-800',
    'refunded' => 'bg-purple-100 text-purple-800'
];

$typeLabels = [
    'payment' => 'Płatność',
    'refund' => 'Zwrot'
];

$statusLabels = [
    'completed' => 'Zakończona',
    'pending' => 'W trakcie',
    'failed' => 'Nieudana',
    'refunded' => 'Zwrócona'
];

$statusClass = $statusClasses[$details['status']] ?? 'bg-gray-100 text-gray-800';
$statusLabel = $statusLabels[$details['status']] ?? $details['status'];
$typeLabel = $typeLabels[$details['type']] ?? $details['type'];
?>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
        <h4 class="text-lg font-semibold mb-3">Informacje o płatności</h4>
        
        <div class="space-y-3">
            <div>
                <p class="text-sm text-gray-500">ID Transakcji</p>
                <p class="font-medium"><?= htmlspecialchars($details['transaction_id']) ?></p>
            </div>
            
            <div>
                <p class="text-sm text-gray-500">Data transakcji</p>
                <p class="font-medium"><?= formatPolishDate($details['created_at']) ?></p>
            </div>
            
            <div>
                <p class="text-sm text-gray-500">Typ</p>
                <p class="font-medium"><?= $typeLabel ?></p>
            </div>
            
            <div>
                <p class="text-sm text-gray-500">Kwota</p>
                <p class="font-medium"><?= formatCurrency($details['amount'], $details['currency'] ?? 'PLN') ?></p>
            </div>
            
            <div>
                <p class="text-sm text-gray-500">Status</p>
                <p class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <?= $statusClass ?>">
                    <?= $statusLabel ?>
                </p>
            </div>
        </div>
    </div>
    
    <div>
        <h4 class="text-lg font-semibold mb-3">Szczegóły zamówienia</h4>
        
        <div class="space-y-3">
            <?php if (isset($details['booking_id'])): ?>
            <div>
                <p class="text-sm text-gray-500">ID Rezerwacji</p>
                <p class="font-medium"><?= htmlspecialchars($details['booking_id']) ?></p>
            </div>
            <?php endif; ?>
            
            <?php if (isset($details['booking_details'])): ?>
            <div>
                <p class="text-sm text-gray-500">Szczegóły rezerwacji</p>
                <p class="font-medium"><?= htmlspecialchars($details['booking_details']) ?></p>
            </div>
            <?php endif; ?>
            
            <?php if (isset($details['payment_method'])): ?>
            <div>
                <p class="text-sm text-gray-500">Metoda płatności</p>
                <p class="font-medium">
                    <?php 
                    $method = $details['payment_method'];
                    if ($method['type'] === 'credit_card') {
                        echo htmlspecialchars($method['card_brand'] ?? 'Karta') . ' •••• ' . htmlspecialchars($method['card_last4'] ?? '????');
                    } elseif ($method['type'] === 'bank_transfer') {
                        echo 'Przelew bankowy';
                    } elseif ($method['type'] === 'blik') {
                        echo 'BLIK';
                    } else {
                        echo htmlspecialchars($method['type']);
                    }
                    ?>
                </p>
            </div>
            <?php endif; ?>
            
            <?php if (isset($details['gateway'])): ?>
            <div>
                <p class="text-sm text-gray-500">Bramka płatności</p>
                <p class="font-medium"><?= ucfirst(htmlspecialchars($details['gateway'])) ?></p>
            </div>
            <?php endif; ?>
        </div>
        
        <?php if ($details['status'] === 'completed' && $details['type'] === 'payment'): ?>
        <div class="mt-6">
            <button 
                onclick="downloadInvoice('<?= $details['id'] ?>')" 
                class="w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                </svg>
                Pobierz fakturę
            </button>
        </div>
        <?php endif; ?>
    </div>
    
    <?php if (isset($details['refund_details']) && !empty($details['refund_details'])): ?>
    <div class="col-span-1 md:col-span-2">
        <h4 class="text-lg font-semibold mb-3">Informacje o zwrocie</h4>
        
        <div class="space-y-3 bg-gray-50 p-4 rounded-lg">
            <div>
                <p class="text-sm text-gray-500">Data zwrotu</p>
                <p class="font-medium"><?= formatPolishDate($details['refund_details']['created_at']) ?></p>
            </div>
            
            <div>
                <p class="text-sm text-gray-500">Kwota zwrotu</p>
                <p class="font-medium"><?= formatCurrency($details['refund_details']['amount'], $details['currency'] ?? 'PLN') ?></p>
            </div>
            
            <div>
                <p class="text-sm text-gray-500">Powód zwrotu</p>
                <p class="font-medium"><?= htmlspecialchars($details['refund_details']['reason'] ?? 'Nie podano') ?></p>
            </div>
        </div>
    </div>
    <?php endif; ?>
</div>

<?php if (isset($details['additional_info']) && !empty($details['additional_info'])): ?>
<div class="mt-6 pt-6 border-t">
    <h4 class="text-lg font-semibold mb-3">Dodatkowe informacje</h4>
    <div class="text-gray-700">
        <?= nl2br(htmlspecialchars($details['additional_info'])) ?>
    </div>
</div>
<?php endif; ?>
=== public/views/partials/user-profile.php ===
<div class="bg-white rounded-lg shadow-md p-6" x-data="{ editing: false }">
    <!-- Profile header -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Dane Profilu</h2>
        <button 
            @click="editing = !editing" 
            class="px-4 py-2 rounded-md"
            :class="editing ? 'bg-gray-200 text-gray-600' : 'bg-blue-600 text-white hover:bg-blue-700'"
        >
            <span x-text="editing ? 'Anuluj' : 'Edytuj profil'"></span>
        </button>
    </div>

    <!-- View mode -->
    <div x-show="!editing" class="space-y-6">
        <div class="flex items-center space-x-6">
            <img src="<?= htmlspecialchars($profileData['avatar_url']) ?>" alt="Zdjęcie profilowe" class="w-24 h-24 rounded-full object-cover border-2 border-gray-200">
            <div>
                <h3 class="text-xl font-semibold"><?= htmlspecialchars($profileData['name']) ?></h3>
                <p class="text-gray-500">Dołączono: <?= $profileData['joined_date'] ?></p>
                <p class="text-gray-600 mt-1"><?= htmlspecialchars($profileData['email']) ?></p>
            </div>
        </div>

        <?php if(!empty($profileData['bio']) || !empty($profileData['location'])): ?>
        <div class="border-t pt-4 mt-4">
            <?php if(!empty($profileData['location'])): ?>
            <div class="flex items-center text-gray-600 mb-2">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                </svg>
                <span><?= htmlspecialchars($profileData['location']) ?></span>
            </div>
            <?php endif; ?>

            <?php if(!empty($profileData['bio'])): ?>
            <div class="text-gray-700 mt-2">
                <p><?= nl2br(htmlspecialchars($profileData['bio'])) ?></p>
            </div>
            <?php endif; ?>
        </div>
        <?php endif; ?>
    </div>

    <!-- Edit mode -->
    <div x-show="editing" x-cloak>
        <form 
            id="profile-form"
            hx-post="/user/update-profile" 
            hx-trigger="submit"
            hx-indicator="#form-indicator"
            hx-swap="outerHTML"
        >
            <div class="space-y-4">
                <!-- Avatar section -->
                <div class="flex items-center space-x-4">
                    <img src="<?= htmlspecialchars($profileData['avatar_url']) ?>" alt="Zdjęcie profilowe" class="w-20 h-20 rounded-full object-cover border-2 border-gray-200">
                    <div>
                        <label for="avatar_url" class="block text-sm font-medium text-gray-700 mb-1">URL Zdjęcia</label>
                        <input type="url" id="avatar_url" name="avatar_url" value="<?= htmlspecialchars($profileData['avatar_url']) ?>" 
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                    </div>
                </div>
                
                <!-- Name field -->
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Imię i nazwisko</label>
                    <input type="text" id="name" name="name" value="<?= htmlspecialchars($profileData['name']) ?>" required
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                </div>
                
                <!-- Location field -->
                <div>
                    <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Lokalizacja</label>
                    <input type="text" id="location" name="location" value="<?= htmlspecialchars($profileData['location']) ?>"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                </div>
                
                <!-- Bio field -->
                <div>
                    <label for="bio" class="block text-sm font-medium text-gray-700 mb-1">O mnie</label>
                    <textarea id="bio" name="bio" rows="4"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                    ><?= htmlspecialchars($profileData['bio']) ?></textarea>
                </div>
                
                <!-- Submit button -->
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" @click="editing = false" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                        Anuluj
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Zapisz zmiany
                    </button>
                </div>
            </div>
            
            <div id="form-indicator" class="htmx-indicator flex items-center justify-center py-4">
                <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="ml-2">Zapisywanie zmian...</span>
            </div>
        </form>
    </div>
</div>

<?php
/**
 * User profile partial for dashboard
 */
?>

<div class="flex items-center mb-4">
    <div class="w-16 h-16 rounded-full overflow-hidden mr-4 flex-shrink-0">
        <img src="<?= htmlspecialchars($profileData['avatar_url'] ?? '/assets/images/default-avatar.png') ?>" alt="Avatar użytkownika" class="w-full h-full object-cover">
    </div>
    <div>
        <h3 class="text-lg font-medium text-gray-800"><?= htmlspecialchars($profileData['name'] ?? 'Użytkownik') ?></h3>
        <p class="text-sm text-gray-500"><?= htmlspecialchars($profileData['email'] ?? '') ?></p>
    </div>
</div>

<div class="mb-4">
    <?php if (!empty($profileData['bio'])): ?>
        <p class="text-sm text-gray-600 mb-2"><?= htmlspecialchars($profileData['bio']) ?></p>
    <?php endif; ?>
    
    <?php if (!empty($profileData['location'])): ?>
        <div class="flex items-center text-sm text-gray-500 mb-1">
            <i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>
            <?= htmlspecialchars($profileData['location']) ?>
        </div>
    <?php endif; ?>
    
    <?php if (!empty($profileData['phone'])): ?>
        <div class="flex items-center text-sm text-gray-500 mb-1">
            <i class="fas fa-phone mr-2 text-gray-400"></i>
            <?= htmlspecialchars($profileData['phone']) ?>
        </div>
    <?php endif; ?>
    
    <div class="flex items-center text-sm text-gray-500">
        <i class="fas fa-calendar mr-2 text-gray-400"></i>
        Konto od: <?= htmlspecialchars($profileData['joined_date'] ?? '') ?>
    </div>
</div>

<div class="mt-4">
    <a href="/profile" class="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-800">
        <i class="fas fa-user-edit mr-1"></i> Zarządzaj profilem
    </a>
</div>

<style>
[x-cloak] { display: none !important; }
.htmx-indicator { display: none; }
.htmx-request .htmx-indicator { display: flex; }
.htmx-request.htmx-indicator { display: flex; }
</style>
=== public/views/partials/booking-log-item.php ===
<div class="booking-log-item py-2 border-b border-gray-200 last:border-0">
    <div class="flex items-start">
        <!-- Status Icon -->
        <div class="mr-3">
            <?php if ($log['action'] === 'booking_created'): ?>
                <span class="flex items-center justify-center h-8 w-8 rounded-full bg-green-100">
                    <svg class="h-5 w-5 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </span>
            <?php elseif ($log['action'] === 'booking_canceled'): ?>
                <span class="flex items-center justify-center h-8 w-8 rounded-full bg-red-100">
                    <svg class="h-5 w-5 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </span>
            <?php elseif ($log['action'] === 'booking_rescheduled'): ?>
                <span class="flex items-center justify-center h-8 w-8 rounded-full bg-yellow-100">
                    <svg class="h-5 w-5 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </span>
            <?php elseif ($log['action'] === 'booking_confirmed'): ?>
                <span class="flex items-center justify-center h-8 w-8 rounded-full bg-blue-100">
                    <svg class="h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </span>
            <?php else: ?>
                <span class="flex items-center justify-center h-8 w-8 rounded-full bg-gray-100">
                    <svg class="h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </span>
            <?php endif; ?>
        </div>
        
        <!-- Log Content -->
        <div class="flex-1">
            <div class="flex justify-between items-start">
                <p class="text-sm font-medium text-gray-900">
                    <?php 
                    $actionText = match($log['action']) {
                        'booking_created' => 'Rezerwacja utworzona',
                        'booking_canceled' => 'Rezerwacja anulowana',
                        'booking_rescheduled' => 'Zmiana terminu rezerwacji',
                        'booking_confirmed' => 'Rezerwacja potwierdzona',
                        'booking_viewed' => 'Podgląd rezerwacji',
                        'payment_processed' => 'Płatność zrealizowana',
                        'refund_processed' => 'Zwrot środków',
                        default => ucfirst(str_replace('_', ' ', $log['action']))
                    };
                    echo htmlspecialchars($actionText);
                    ?>
                </p>
                <span class="text-xs text-gray-500">
                    <?= date('d.m.Y H:i', strtotime($log['created_at'])) ?>
                </span>
            </div>
            <p class="text-sm text-gray-500 mt-1">
                <?= htmlspecialchars($log['description']) ?>
            </p>
            
            <?php if (!empty($log['metadata'])): ?>
                <?php if (is_string($log['metadata'])) {
                    $metadata = json_decode($log['metadata'], true) ?? [];
                } else {
                    $metadata = $log['metadata'];
                } ?>
                
                <?php if (!empty($metadata) && $log['action'] === 'booking_rescheduled'): ?>
                    <div class="mt-2 text-xs text-gray-500">
                        <div class="flex">
                            <span class="font-medium w-24">Nowa data odbioru:</span>
                            <span><?= date('d.m.Y H:i', strtotime($metadata['new_pickup'] ?? '')) ?></span>
                        </div>
                        <div class="flex mt-1">
                            <span class="font-medium w-24">Nowa data zwrotu:</span>
                            <span><?= date('d.m.Y H:i', strtotime($metadata['new_dropoff'] ?? '')) ?></span>
                        </div>
                    </div>
                <?php elseif (!empty($metadata) && $log['action'] === 'refund_processed'): ?>
                    <div class="mt-2 text-xs text-gray-500">
                        <div class="flex">
                            <span class="font-medium w-24">Kwota zwrotu:</span>
                            <span><?= number_format($metadata['refund_amount'] ?? 0, 2, ',', ' ') ?> zł</span>
                        </div>
                    </div>
                <?php endif; ?>
            <?php endif; ?>
        </div>
    </div>
</div>
=== public/views/partials/payment-method-details.php ===
<?php
// Required variables: $method with payment method details
$isDefault = isset($method['is_default']) && $method['is_default'];
$createdDate = isset($method['created_at']) ? formatPolishDate($method['created_at']) : 'Nieznana data';
?>

<div class="space-y-4">
    <?php if ($method['type'] === 'credit_card'): ?>
        <div>
            <p class="text-sm text-gray-500">Rodzaj karty</p>
            <p class="font-medium"><?= htmlspecialchars($method['card_brand'] ?? 'Karta kredytowa') ?></p>
        </div>
        
        <div>
            <p class="text-sm text-gray-500">Numer karty</p>
            <p class="font-medium">•••• •••• •••• <?= htmlspecialchars($method['card_last4'] ?? '????') ?></p>
        </div>
        
        <div>
            <p class="text-sm text-gray-500">Data ważności</p>
            <p class="font-medium"><?= htmlspecialchars($method['expiry_date'] ?? 'MM/RR') ?></p>
        </div>
        
        <div>
            <p class="text-sm text-gray-500">Posiadacz karty</p>
            <p class="font-medium"><?= htmlspecialchars($method['cardholder_name'] ?? 'Nie podano') ?></p>
        </div>
    <?php elseif ($method['type'] === 'bank_transfer'): ?>
        <div>
            <p class="text-sm text-gray-500">Nazwa banku</p>
            <p class="font-medium"><?= htmlspecialchars($method['bank_name'] ?? 'Nie podano') ?></p>
        </div>
        
        <div>
            <p class="text-sm text-gray-500">Numer konta</p>
            <p class="font-medium"><?= htmlspecialchars($method['account_number'] ?? 'Nie podano') ?></p>
        </div>
    <?php elseif ($method['type'] === 'blik'): ?>
        <div>
            <p class="text-sm text-gray-500">Metoda płatności</p>
            <p class="font-medium">BLIK</p>
        </div>
        
        <div>
            <p class="text-gray-600">
                Ta metoda umożliwia płatności jednorazowymi kodami BLIK generowanymi przy każdej transakcji.
            </p>
        </div>
    <?php endif; ?>
    
    <div>
        <p class="text-sm text-gray-500">Dodana</p>
        <p class="font-medium"><?= $createdDate ?></p>
    </div>
    
    <?php if ($isDefault): ?>
        <div class="bg-green-50 p-3 rounded-lg text-green-700">
            <p class="font-medium">Domyślna metoda płatności</p>
            <p class="text-sm">Ta metoda jest używana automatycznie podczas płatności</p>
        </div>
    <?php else: ?>
        <button 
            onclick="setDefaultPaymentMethod('<?= $method['id'] ?>')" 
            class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
            Ustaw jako domyślną
        </button>
    <?php endif; ?>
    
    <div class="border-t pt-4 flex justify-end">
        <button 
            onclick="deletePaymentMethod('<?= $method['id'] ?>')" 
            class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Usuń metodę płatności
        </button>
    </div>
</div>
=== public/views/partials/user-notifications.php ===
<?php if (empty($notifications)): ?>
<div class="text-center py-6">
    <div class="text-gray-400 text-4xl mb-3">
        <i class="fas fa-bell-slash"></i>
    </div>
    <p class="text-gray-500">Nie masz żadnych powiadomień</p>
</div>
<?php else: ?>
<div class="space-y-4" x-data="{
    markAsRead(id) {
        htmx.ajax('POST', '/notifications/mark-read', {
            values: { notification_id: id },
            target: '#notification-' + id,
            swap: 'outerHTML'
        });
    }
}">
    <?php foreach ($notifications as $notification): 
        $isUnread = !$notification->read_at;
        $notificationClass = $isUnread ? 'bg-blue-50 unread-notification' : '';
        $iconClass = 'fas fa-bell';
        $iconColorClass = 'text-blue-600';
        
        // Set appropriate icon and color based on notification type
        switch ($notification->type) {
            case 'booking_confirmation':
                $iconClass = 'fas fa-calendar-check';
                $iconColorClass = 'text-green-600';
                break;
            case 'booking_canceled':
                $iconClass = 'fas fa-calendar-times';
                $iconColorClass = 'text-red-600';
                break;
            case 'payment_received':
                $iconClass = 'fas fa-money-bill-wave';
                $iconColorClass = 'text-green-600';
                break;
            case 'system':
                $iconClass = 'fas fa-cog';
                $iconColorClass = 'text-gray-600';
                break;
        }
        
        // Format the notification date
        $createdAt = new DateTime($notification->created_at);
        $now = new DateTime();
        $interval = $createdAt->diff($now);
        
        if ($interval->d < 1) {
            if ($interval->h < 1) {
                $timeAgo = $interval->i . ' min temu';
            } else {
                $timeAgo = $interval->h . ' godz. temu';
            }
        } else {
            $timeAgo = $createdAt->format('d.m.Y H:i');
        }
    ?>
    <div id="notification-<?= $notification->id ?>" class="flex items-start p-3 rounded-lg <?= $notificationClass ?>">
        <div class="flex-shrink-0">
            <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center">
                <i class="<?= $iconClass ?> <?= $iconColorClass ?>"></i>
            </div>
        </div>
        <div class="ml-3 flex-1">
            <div class="flex justify-between items-start">
                <p class="text-sm text-gray-800 font-medium"><?= htmlspecialchars($notification->title) ?></p>
                <?php if ($isUnread): ?>
                <button @click="markAsRead(<?= $notification->id ?>)" class="text-xs text-blue-600 hover:text-blue-800">
                    <i class="fas fa-check"></i> Oznacz jako przeczytane
                </button>
                <?php endif; ?>
            </div>
            <p class="text-xs text-gray-500"><?= htmlspecialchars($notification->message) ?></p>
            <p class="text-xs text-gray-400 mt-1"><?= $timeAgo ?></p>
        </div>
    </div>
    <?php endforeach; ?>
</div>
<?php endif; ?>
=== public/views/partials/payment-item.php ===
<?php
// Required variables: $transaction with payment data
$statusClasses = [
    'completed' => 'bg-green-100 text-green-800',
    'pending' => 'bg-yellow-100 text-yellow-800',
    'failed' => 'bg-red-100 text-red-800',
    'refunded' => 'bg-purple-100 text-purple-800'
];

$typeLabels = [
    'payment' => 'Płatność',
    'refund' => 'Zwrot'
];

$statusLabels = [
    'completed' => 'Zakończona',
    'pending' => 'W trakcie',
    'failed' => 'Nieudana',
    'refunded' => 'Zwrócona'
];

$statusClass = $statusClasses[$transaction['status']] ?? 'bg-gray-100 text-gray-800';
?>

<tr class="border-b hover:bg-gray-50">
    <td class="px-4 py-3">
        <?= formatPolishDate($transaction['created_at']) ?>
    </td>
    <td class="px-4 py-3 font-medium">
        <?= htmlspecialchars($transaction['transaction_id']) ?>
    </td>
    <td class="px-4 py-3">
        <?= $typeLabels[$transaction['type']] ?? htmlspecialchars($transaction['type']) ?>
    </td>
    <td class="px-4 py-3 font-medium">
        <?= formatCurrency($transaction['amount'], $transaction['currency'] ?? 'PLN') ?>
    </td>
    <td class="px-4 py-3">
        <span class="px-2 py-1 rounded-full text-xs font-medium <?= $statusClass ?>">
            <?= $statusLabels[$transaction['status']] ?? htmlspecialchars($transaction['status']) ?>
        </span>
    </td>
    <td class="px-4 py-3">
        <div class="flex items-center space-x-2">
            <button onclick="showPaymentDetails('<?= $transaction['id'] ?>')" 
                    class="text-blue-500 hover:text-blue-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
            </button>
            
            <?php if ($transaction['status'] === 'completed'): ?>
            <button onclick="downloadInvoice('<?= $transaction['id'] ?>')" 
                    class="text-green-500 hover:text-green-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                </svg>
            </button>
            <?php endif; ?>
        </div>
    </td>
</tr>
=== public/views/partials/user-statistics.php ===
<div class="flex flex-wrap -mx-3">
    <!-- Total Bookings Stats -->
    <div class="w-full md:w-1/3 px-3 mb-6">
        <div class="bg-white rounded-lg shadow-md p-6 stats-card">
            <div class="flex justify-between">
                <div>
                    <p class="text-sm text-gray-500 font-semibold">Wszystkie rezerwacje</p>
                    <h3 class="text-2xl font-bold text-gray-800">
                        <?= $statistics['total_bookings'] ?? 0 ?>
                    </h3>
                </div>
                <div class="bg-blue-100 rounded-full h-12 w-12 flex items-center justify-center">
                    <i class="fas fa-calendar-check text-blue-500 text-xl"></i>
                </div>
            </div>
            <div class="mt-4 flex justify-between text-xs font-medium">
                <span class="text-gray-500">
                    <span class="font-semibold text-green-600">
                        <?= $statistics['completed_bookings'] ?? 0 ?>
                    </span> ukończonych
                </span>
                <span class="text-gray-500">
                    <span class="font-semibold text-blue-600">
                        <?= $statistics['active_bookings'] ?? 0 ?>
                    </span> aktywnych
                </span>
            </div>
        </div>
    </div>

    <!-- Revenue Stats -->
    <div class="w-full md:w-1/3 px-3 mb-6">
        <div class="bg-white rounded-lg shadow-md p-6 stats-card">
            <div class="flex justify-between">
                <div>
                    <p class="text-sm text-gray-500 font-semibold">Całkowite wydatki</p>
                    <h3 class="text-2xl font-bold text-gray-800">
                        <?= formatCurrency($statistics['total_payments'] ?? 0) ?>
                    </h3>
                </div>
                <div class="bg-green-100 rounded-full h-12 w-12 flex items-center justify-center">
                    <i class="fas fa-money-bill-wave text-green-500 text-xl"></i>
                </div>
            </div>
            <div class="mt-4 text-xs font-medium">
                <div class="flex items-center justify-between">
                    <span class="text-gray-500">Średnio za rezerwację</span>
                    <span class="font-semibold">
                        <?php
                            $avgPerBooking = 0;
                            if (($statistics['total_bookings'] ?? 0) > 0) {
                                $avgPerBooking = ($statistics['total_payments'] ?? 0) / $statistics['total_bookings'];
                            }
                            echo formatCurrency($avgPerBooking);
                        ?>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Stats -->
    <div class="w-full md:w-1/3 px-3 mb-6">
        <div class="bg-white rounded-lg shadow-md p-6 stats-card">
            <div class="flex justify-between">
                <div>
                    <p class="text-sm text-gray-500 font-semibold">Dni korzystania</p>
                    <h3 class="text-2xl font-bold text-gray-800">
                        <?= $statistics['total_rental_days'] ?? 0 ?>
                    </h3>
                </div>
                <div class="bg-purple-100 rounded-full h-12 w-12 flex items-center justify-center">
                    <i class="fas fa-clock text-purple-500 text-xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <div class="flex justify-between items-center text-xs">
                    <span class="text-gray-500">Najdłuższa rezerwacja</span>
                    <span class="font-semibold">
                        <?= $statistics['longest_rental'] ?? 0 ?> dni
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
=== public/views/partials/user-bookings.php ===
<div class="bg-white rounded-lg shadow-md p-6" 
     x-data="{ 
        currentPage: 0,
        perPage: 5,
        status: 'all',
        loading: false,
        hasMorePages: true
     }" x-init="loadBookings()">
    
    <!-- Header section -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">Moje Rezerwacje</h2>
            <p class="text-gray-500 text-sm mt-1">Zarządzaj swoimi rezerwacjami samochodów</p>
        </div>
        
        <div class="mt-4 md:mt-0">
            <a href="/booking/new" 
               class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition flex items-center">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Zarezerwuj samochód
            </a>
        </div>
    </div>
    
    <!-- Filter section -->
    <div class="flex flex-wrap gap-2 mb-5">
        <button @click="status = 'all'; currentPage = 0; loadBookings()"
                class="px-3 py-1.5 rounded-md text-sm transition"
                :class="status === 'all' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
            Wszystkie
        </button>
        <button @click="status = 'active'; currentPage = 0; loadBookings()"
                class="px-3 py-1.5 rounded-md text-sm transition"
                :class="status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
            Aktywne
        </button>
        <button @click="status = 'completed'; currentPage = 0; loadBookings()"
                class="px-3 py-1.5 rounded-md text-sm transition"
                :class="status === 'completed' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
            Zakończone
        </button>
        <button @click="status = 'canceled'; currentPage = 0; loadBookings()"
                class="px-3 py-1.5 rounded-md text-sm transition"
                :class="status === 'canceled' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
            Anulowane
        </button>
        <button @click="status = 'pending'; currentPage = 0; loadBookings()"
                class="px-3 py-1.5 rounded-md text-sm transition"
                :class="status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
            Oczekujące
        </button>
    </div>

    <!-- Booking list -->
    <div id="bookings-container"
         hx-get="/booking/list" 
         hx-trigger="load"
         hx-vals="js:{page: 0, per_page: 5, status: 'all'}"
         hx-indicator="#booking-spinner">
        <!-- Initial loading state -->
        <div class="flex justify-center py-8" id="booking-spinner">
            <svg class="animate-spin h-8 w-8 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
    </div>
    
    <!-- Load more button -->
    <div class="text-center mt-5" x-show="hasMorePages">
        <button @click="currentPage++; loadBookings(true)" 
                class="bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 px-4 rounded-md transition"
                x-bind:disabled="loading">
            <span x-show="!loading">Pokaż więcej rezerwacji</span>
            <span x-show="loading" class="flex items-center justify-center">
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-gray-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Ładowanie...
            </span>
        </button>
    </div>
    
    <!-- No bookings message -->
    <div id="no-bookings-message" class="hidden text-center py-10">
        <svg class="w-16 h-16 text-gray-300 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h3 class="text-lg font-medium text-gray-700 mt-4">Brak rezerwacji</h3>
        <p class="text-gray-500 mt-2">Nie masz jeszcze żadnych rezerwacji w tej kategorii.</p>
        <a href="/booking/new" class="inline-block mt-4 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition">
            Zarezerwuj swój pierwszy samochód
        </a>
    </div>
</div>

<script>
function loadBookings(append = false) {
    this.loading = true;
    
    const url = '/booking/list';
    const params = new URLSearchParams({
        page: this.currentPage,
        per_page: this.perPage,
        status: this.status
    });
    
    htmx.ajax('GET', `${url}?${params.toString()}`, {
        target: append ? '#bookings-container-append' : '#bookings-container',
        swap: append ? 'beforeend' : 'innerHTML',
        headers: {
            'HX-Request': 'true'
        }
    }).then(() => {
        this.loading = false;
        
        // Check if we have more pages
        const bookingsCount = document.querySelectorAll('#bookings-container .booking-item').length;
        if (bookingsCount < (this.currentPage + 1) * this.perPage) {
            this.hasMorePages = false;
        }
        
        // Show no bookings message if needed
        if (bookingsCount === 0 && this.currentPage === 0) {
            document.getElementById('no-bookings-message').classList.remove('hidden');
        } else {
            document.getElementById('no-bookings-message').classList.add('hidden');
        }
        
        // Create append container if needed
        if (append && !document.getElementById('bookings-container-append')) {
            const appendContainer = document.createElement('div');
            appendContainer.id = 'bookings-container-append';
            document.getElementById('bookings-container').appendChild(appendContainer);
        }
    });
}
</script>

<?php if (empty($bookings)): ?>
<script>document.getElementById('no-bookings-message').classList.remove('hidden');</script>
<?php else: ?>
<div class="space-y-4">
    <?php foreach ($bookings as $booking): ?>
    <div class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition-shadow">
        <div class="flex flex-wrap md:flex-nowrap">
            <!-- Vehicle Image -->
            <div class="w-full md:w-1/4">
                <img src="<?= htmlspecialchars($booking->vehicle_image ?? '/assets/images/cars/default.jpg') ?>" 
                     alt="<?= htmlspecialchars($booking->vehicle_name ?? 'Vehicle') ?>" 
                     class="w-full h-32 md:h-full object-cover">
            </div>
            
            <!-- Booking Details -->
            <div class="w-full md:w-3/4 p-4">
                <div class="flex flex-wrap justify-between items-start">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900"><?= htmlspecialchars($booking->vehicle_name ?? 'Pojazd') ?></h3>
                        <div class="flex items-center text-sm text-gray-600 mt-1">
                            <i class="fas fa-calendar mr-1"></i>
                            <?= (new DateTime($booking->start_date))->format('d.m.Y H:i') ?>
                            <i class="fas fa-arrow-right mx-2"></i>
                            <?= (new DateTime($booking->end_date))->format('d.m.Y H:i') ?>
                        </div>
                        <div class="flex items-center text-sm text-gray-600 mt-1">
                            <i class="fas fa-map-marker-alt mr-1"></i>
                            <?= htmlspecialchars($booking->pickup_location ?? 'Lokalizacja odbioru') ?>
                        </div>
                    </div>
                    
                    <!-- Status Badge and Actions -->
                    <div class="mt-2 md:mt-0">
                        <?php
                        $statusClass = '';
                        switch ($booking->status) {
                            case 'completed':
                                $statusClass = 'bg-green-100 text-green-800';
                                $statusText = 'Ukończona';
                                break;
                            case 'canceled':
                                $statusClass = 'bg-red-100 text-red-800';
                                $statusText = 'Anulowana';
                                break;
                            case 'pending':
                                $statusClass = 'bg-yellow-100 text-yellow-800';
                                $statusText = 'Oczekująca';
                                break;
                            default:
                                $statusClass = 'bg-blue-100 text-blue-800';
                                $statusText = 'Aktywna';
                        }
                        ?>
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <?= $statusClass ?>">
                            <?= $statusText ?>
                        </span>
                        
                        <div class="mt-3 flex space-x-2">
                            <a href="/bookings/<?= $booking->id ?>" class="text-blue-600 hover:text-blue-900 flex items-center text-sm">
                                <i class="fas fa-eye mr-1"></i> Szczegóły
                            </a>
                            
                            <?php if ($booking->status === 'active' || $booking->status === 'pending'): ?>
                            <a href="/bookings/<?= $booking->id ?>/cancel" class="text-red-600 hover:text-red-900 flex items-center text-sm">
                                <i class="fas fa-times mr-1"></i> Anuluj
                            </a>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
                
                <?php if ($booking->status === 'active' || $booking->status === 'pending'): ?>
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">
                            <i class="fas fa-money-bill-wave mr-1"></i> Całkowity koszt:
                            <span class="font-semibold"><?= formatCurrency($booking->total_price ?? 0) ?></span>
                        </span>
                        
                        <?php if ($booking->status === 'pending'): ?>
                        <a href="/payments/<?= $booking->id ?>" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-sm">
                            <i class="fas fa-credit-card mr-1"></i> Zapłać teraz
                        </a>
                        <?php endif; ?>
                    </div>
                </div>
                <?php endif; ?>
            </div>
        </div>
    </div>
    <?php endforeach; ?>
</div>
<?php endif; ?>
=== public/views/partials/payments.php ===
<div class="bg-white rounded-lg shadow-md p-6" 
     x-data="paymentSystem()">
    
    <!-- Header section -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">Płatności</h2>
            <p class="text-gray-500 text-sm mt-1">Historia Twoich transakcji</p>
        </div>
    </div>
    
    <!-- Filter section -->
    <div class="mb-6">
        <div class="flex flex-wrap gap-2 mb-4">
            <button @click="type = 'all'; currentPage = 1; fetchTransactions()"
                    class="px-3 py-1.5 rounded-md text-sm transition"
                    :class="type === 'all' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                Wszystkie transakcje
            </button>
            <button @click="type = 'payment'; currentPage = 1; fetchTransactions()"
                    class="px-3 py-1.5 rounded-md text-sm transition"
                    :class="type === 'payment' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                Płatności
            </button>
            <button @click="type = 'refund'; currentPage = 1; fetchTransactions()"
                    class="px-3 py-1.5 rounded-md text-sm transition"
                    :class="type === 'refund' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                Zwroty
            </button>
        </div>
        
        <div class="flex justify-between flex-wrap gap-3">
            <div class="flex items-center">
                <label for="sortBy" class="mr-2 text-sm font-medium text-gray-700">Sortuj wg:</label>
                <select id="sortBy" 
                        x-model="sortBy"
                        @change="currentPage = 1; fetchTransactions()"
                        class="rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-sm">
                    <option value="date">Data</option>
                    <option value="amount">Kwota</option>
                    <option value="status">Status</option>
                </select>
                <button @click="sortDir = sortDir === 'asc' ? 'desc' : 'asc'; fetchTransactions()" class="ml-2 p-1 rounded hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" :class="{'rotate-180': sortDir === 'desc'}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12" />
                    </svg>
                </button>
            </div>
            
            <div class="flex items-center">
                <label for="limit" class="mr-2 text-sm font-medium text-gray-700">Pokaż:</label>
                <select id="limit" 
                        x-model="limit"
                        @change="currentPage = 1; fetchTransactions()"
                        class="rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-sm">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Transactions list -->
    <div id="transactions-container" class="overflow-x-auto">
        <div class="min-w-full">
            <!-- Table header -->
            <div class="grid grid-cols-5 bg-gray-50 border-b border-gray-200 py-3 px-4 text-xs font-medium text-gray-500 uppercase tracking-wider">
                <div class="col-span-1">Data</div>
                <div class="col-span-1">Nr transakcji</div>
                <div class="col-span-1">Typ</div>
                <div class="col-span-1">Status</div>
                <div class="col-span-1 text-right">Kwota</div>
            </div>
            
            <!-- Loading indicator -->
            <div x-show="loading" class="text-center py-8">
                <svg class="animate-spin h-8 w-8 text-gray-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-500">Ładowanie transakcji...</p>
            </div>
            
            <!-- Transactions data loaded via HTMX -->
            <div id="transactions-list" 
                 hx-get="/payment/transactions" 
                 hx-trigger="load"
                 hx-vals="js:{page: currentPage, limit: limit, type: type, sort_by: sortBy, sort_dir: sortDir}"
                 hx-indicator=".htmx-indicator">
            </div>
            
            <!-- No transactions found message -->
            <div id="no-transactions" class="hidden text-center py-10">
                <svg class="w-16 h-16 text-gray-300 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h3 class="text-lg font-medium text-gray-700 mt-4">Brak transakcji</h3>
                <p class="text-gray-500 mt-2">Nie znaleziono żadnych transakcji spełniających wybrane kryteria.</p>
            </div>
        </div>
    </div>
    
    <!-- Pagination controls -->
    <div class="mt-6 flex justify-between items-center">
        <div class="text-sm text-gray-500">
            <span x-text="'Strona ' + currentPage"></span>
        </div>
        <div class="flex space-x-2">
            <button @click="if(currentPage > 1) { currentPage--; fetchTransactions(); }"
                    :disabled="currentPage <= 1"
                    :class="currentPage <= 1 ? 'opacity-50 cursor-not-allowed' : ''"
                    class="px-4 py-2 bg-gray-100 text-gray-800 rounded-md hover:bg-gray-200">
                <span class="sr-only">Poprzednia strona</span>
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
            </button>
            <button @click="currentPage++; fetchTransactions();"
                    class="px-4 py-2 bg-gray-100 text-gray-800 rounded-md hover:bg-gray-200">
                <span class="sr-only">Następna strona</span>
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Transaction Details Modal -->
    <div x-show="showDetails" 
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showDetails = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 sm:mt-0 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Szczegóły transakcji</h3>
                            <div class="mt-4 space-y-4" x-show="selectedTransaction">
                                <div class="border-b pb-3">
                                    <p class="text-sm font-medium text-gray-500">Numer transakcji</p>
                                    <p class="text-base" x-text="selectedTransaction?.id || '—'"></p>
                                </div>
                                <div class="border-b pb-3">
                                    <p class="text-sm font-medium text-gray-500">Data i godzina</p>
                                    <p class="text-base" x-text="selectedTransaction?.date || '—'"></p>
                                </div>
                                <div class="border-b pb-3">
                                    <p class="text-sm font-medium text-gray-500">Typ transakcji</p>
                                    <p class="text-base" 
                                       x-text="selectedTransaction?.type === 'payment' ? 'Płatność' : 
                                               selectedTransaction?.type === 'refund' ? 'Zwrot' : selectedTransaction?.type || '—'"></p>
                                </div>
                                <div class="border-b pb-3">
                                    <p class="text-sm font-medium text-gray-500">Status</p>
                                    <div class="flex items-center">
                                        <span x-show="selectedTransaction?.status === 'completed'" 
                                              class="bg-green-100 text-green-800 text-xs px-2 py-0.5 rounded-full">Ukończona</span>
                                        <span x-show="selectedTransaction?.status === 'pending'" 
                                              class="bg-yellow-100 text-yellow-800 text-xs px-2 py-0.5 rounded-full">Oczekująca</span>
                                        <span x-show="selectedTransaction?.status === 'failed'" 
                                              class="bg-red-100 text-red-800 text-xs px-2 py-0.5 rounded-full">Nieudana</span>
                                    </div>
                                </div>
                                <div class="border-b pb-3">
                                    <p class="text-sm font-medium text-gray-500">Kwota</p>
                                    <p class="text-base font-semibold" x-text="(selectedTransaction?.amount || 0).toFixed(2) + ' PLN'"></p>
                                </div>
                                <div class="border-b pb-3" x-show="selectedTransaction?.booking_id">
                                    <p class="text-sm font-medium text-gray-500">Rezerwacja</p>
                                    <p class="text-base">
                                        <a :href="'/booking/' + selectedTransaction?.booking_id" 
                                           class="text-blue-600 hover:underline"
                                           x-text="'#' + selectedTransaction?.booking_id"></a>
                                    </p>
                                </div>
                                <div class="border-b pb-3" x-show="selectedTransaction?.payment_method">
                                    <p class="text-sm font-medium text-gray-500">Metoda płatności</p>
                                    <p class="text-base" x-text="selectedTransaction?.payment_method || '—'"></p>
                                </div>
                                <div x-show="selectedTransaction?.notes">
                                    <p class="text-sm font-medium text-gray-500">Dodatkowe informacje</p>
                                    <p class="text-base" x-text="selectedTransaction?.notes || '—'"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" 
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm"
                            @click="showDetails = false">
                        Zamknij
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        [x-cloak] { display: none !important; }
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator { display: flex; }
        .htmx-request.htmx-indicator { display: flex; }
    </style>
</div>
=== public/views/partials/booking-table.php ===
<div class="booking-table-component" 
     x-data="{ 
        showRescheduleModal: false,
        currentBookingId: null,
        pickupDate: '',
        dropoffDate: '',
        showDetails: {}
     }">
     
    <!-- Booking table -->
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Nr
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Pojazd
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Data rozpoczęcia
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Data zakończenia
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Cena całkowita
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Akcje
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <?php if (empty($bookings)): ?>
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            <p class="text-base font-medium">Brak rezerwacji</p>
                            <p class="text-sm">Nie znaleziono żadnych rezerwacji spełniających kryteria wyszukiwania.</p>
                        </td>
                    </tr>
                <?php else: ?>
                    <?php foreach ($bookings as $booking): ?>
                        <tr class="hover:bg-gray-50">
                            <!-- Booking ID -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                #<?= htmlspecialchars($booking['id']) ?>
                            </td>
                            
                            <!-- Vehicle info -->
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <?php if (!empty($booking['vehicle_image'])): ?>
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <img class="h-10 w-10 rounded-full object-cover" src="<?= htmlspecialchars($booking['vehicle_image']) ?>" alt="<?= htmlspecialchars($booking['vehicle_name']) ?>">
                                        </div>
                                    <?php endif; ?>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">
                                            <?= htmlspecialchars($booking['vehicle_name'] ?? 'Niezdefiniowany pojazd') ?>
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            <?= htmlspecialchars($booking['vehicle_model'] ?? '') ?>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            
                            <!-- Start date -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900"><?= date('d.m.Y', strtotime($booking['pickup_date'])) ?></div>
                                <div class="text-sm text-gray-500"><?= date('H:i', strtotime($booking['pickup_date'])) ?></div>
                            </td>
                            
                            <!-- End date -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900"><?= date('d.m.Y', strtotime($booking['dropoff_date'])) ?></div>
                                <div class="text-sm text-gray-500"><?= date('H:i', strtotime($booking['dropoff_date'])) ?></div>
                            </td>
                            
                            <!-- Status -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <?php if ($booking['status'] === 'pending'): ?>
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                        Oczekująca
                                    </span>
                                <?php elseif ($booking['status'] === 'confirmed'): ?>
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                        Potwierdzona
                                    </span>
                                <?php elseif ($booking['status'] === 'active'): ?>
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                        Aktywna
                                    </span>
                                <?php elseif ($booking['status'] === 'completed'): ?>
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                                        Zakończona
                                    </span>
                                <?php elseif ($booking['status'] === 'canceled'): ?>
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                        Anulowana
                                    </span>
                                <?php else: ?>
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                        <?= htmlspecialchars($booking['status']) ?>
                                    </span>
                                <?php endif; ?>
                            </td>
                            
                            <!-- Total price -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <?= number_format($booking['total_price'], 2, ',', ' ') ?> zł
                            </td>
                            
                            <!-- Actions -->
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <div class="flex space-x-2">
                                    <a href="/booking/<?= $booking['id'] ?>" class="text-blue-600 hover:text-blue-900">
                                        Podgląd
                                    </a>
                                    
                                    <?php if (in_array($booking['status'], ['pending', 'confirmed', 'active'])): ?>
                                        <button
                                            @click="currentBookingId = <?= $booking['id'] ?>; showRescheduleModal = true; pickupDate = '<?= date('Y-m-d', strtotime($booking['pickup_date'])) ?>'; dropoffDate = '<?= date('Y-m-d', strtotime($booking['dropoff_date'])) ?>'"
                                            class="text-indigo-600 hover:text-indigo-900">
                                            Zmień termin
                                        </button>
                                        
                                        <button
                                            class="text-red-600 hover:text-red-900"
                                            hx-post="/booking/<?= $booking['id'] ?>/cancel"
                                            hx-confirm="Czy na pewno chcesz anulować tę rezerwację? Może to skutkować częściowym zwrotem środków zgodnie z polityką anulowania."
                                            hx-target="#booking-<?= $booking['id'] ?>"
                                            hx-swap="outerHTML"
                                            hx-indicator=".htmx-indicator">
                                            Anuluj
                                        </button>
                                    <?php endif; ?>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- Expandable details section -->
                        <tr id="booking-details-<?= $booking['id'] ?>" 
                            x-show="showDetails[<?= $booking['id'] ?>]" 
                            x-cloak 
                            class="bg-gray-50">
                            <td colspan="7" class="px-6 py-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <h4 class="text-sm font-medium text-gray-500 mb-2">Miejsce odbioru</h4>
                                        <p class="text-sm text-gray-900"><?= htmlspecialchars($booking['pickup_location']) ?></p>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-medium text-gray-500 mb-2">Miejsce zwrotu</h4>
                                        <p class="text-sm text-gray-900"><?= htmlspecialchars($booking['dropoff_location']) ?></p>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <h4 class="text-sm font-medium text-gray-500 mb-2">Historia rezerwacji</h4>
                                    <div hx-get="/booking/<?= $booking['id'] ?>/logs" 
                                         hx-trigger="revealed once"
                                         hx-indicator=".htmx-indicator">
                                        <div class="htmx-indicator flex items-center">
                                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <span class="text-sm text-gray-500">Ładowanie historii...</span>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                <?php endif; ?>
            </tbody>
        </table>
    </div>

    <!-- Reschedule Modal -->
    <div x-show="showRescheduleModal" 
         x-cloak
         class="fixed z-10 inset-0 overflow-y-auto" 
         aria-labelledby="modal-title" 
         role="dialog" 
         aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" @click="showRescheduleModal = false"></div>
            
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            
            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                <form hx-post="/booking/" :hx-post="'/booking/' + currentBookingId + '/reschedule'" hx-swap="outerHTML" class="space-y-4">
                    <div>
                        <label for="pickup_date" class="block text-sm font-medium text-gray-700">Nowa data odbioru</label>
                        <input type="date" name="pickup_date" id="pickup_date" x-model="pickupDate" required
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    
                    <div>
                        <label for="dropoff_date" class="block text-sm font-medium text-gray-700">Nowa data zwrotu</label>
                        <input type="date" name="dropoff_date" id="dropoff_date" x-model="dropoffDate" required
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    
                    <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3">
                        <button type="button" @click="showRescheduleModal = false" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">
                            Anuluj
                        </button>
                        <button type="submit" class="mt-3 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:text-sm">
                            Potwierdź zmianę
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        [x-cloak] { display: none !important; }
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator { display: flex; }
        .htmx-request.htmx-indicator { display: flex; }
    </style>
</div>
=== public/views/partials/notifications-list.php ===
<?php
/**
 * Consolidated Notifications List Component
 * Works for both admin and user contexts
 */

// Detect context - check if we're in admin context
$isAdmin = isset($_SESSION['user_role']) && $_SESSION['user_role'] === 'admin';

// Set appropriate endpoints based on context
$endpointBase = $isAdmin ? '/admin' : '';
$notificationsEndpoint = $endpointBase . '/notifications';
$markReadEndpoint = $endpointBase . '/notifications/mark-' . ($isAdmin ? '' : 'as-') . 'read';
$markAllReadEndpoint = $endpointBase . '/notifications/mark-all-read';
$deleteEndpoint = $endpointBase . '/notifications/delete';
$containerId = $isAdmin ? 'admin-notifications-container' : 'notifications-container';

// Component title
$title = $isAdmin ? "Powiadomienia Systemowe" : "Powiadomienia";

// Empty state message
$emptyStateMessage = $isAdmin 
    ? "Nie ma żadnych powiadomień systemowych do wyświetlenia."
    : "Nie masz żadnych powiadomień do wyświetlenia.";
?>

<div 
    x-data="notificationsPanel(<?= $isAdmin ? 'true' : 'false' ?>)" 
    @notification-received.window="addNotification($event.detail)"
    class="bg-white rounded-lg shadow divide-y divide-gray-200">

    <div class="p-4 flex items-center justify-between bg-gray-50">
        <h3 class="text-lg font-medium text-gray-700"><?= $title ?></h3>
        <div class="flex items-center space-x-2">
            <!-- Add filter dropdown for admin users -->
            <?php if ($isAdmin): ?>
            <div class="relative" x-data="{ open: false }">
                <button 
                    @click="open = !open" 
                    class="text-sm text-gray-600 hover:text-gray-800 flex items-center mr-2">
                    <i class="fas fa-filter mr-1"></i>
                    <span>Filtruj</span>
                </button>
                <div 
                    x-show="open" 
                    @click.away="open = false"
                    class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 py-1">
                    <div class="px-3 py-2">
                        <label class="block text-xs font-medium text-gray-700">Typ</label>
                        <select 
                            @change="filterNotifications($event.target.value, filters.priority)" 
                            x-model="filters.type"
                            class="mt-1 block w-full text-sm border-gray-300 rounded-md">
                            <option value="all">Wszystkie</option>
                            <option value="booking">Rezerwacje</option>
                            <option value="payment">Płatności</option>
                            <option value="system">System</option>
                            <option value="user">Użytkownicy</option>
                            <option value="error">Błędy</option>
                            <option value="alert">Alerty</option>
                            <option value="security">Bezpieczeństwo</option>
                            <option value="info">Informacje</option>
                        </select>
                    </div>
                    <div class="px-3 py-2 border-t border-gray-100">
                        <label class="block text-xs font-medium text-gray-700">Priorytet</label>
                        <select 
                            @change="filterNotifications(filters.type, $event.target.value)" 
                            x-model="filters.priority"
                            class="mt-1 block w-full text-sm border-gray-300 rounded-md">
                            <option value="all">Wszystkie</option>
                            <option value="high">Wysoki</option>
                            <option value="normal">Normalny</option>
                            <option value="low">Niski</option>
                        </select>
                    </div>
                </div>
            </div>
            <?php endif; ?>
            
            <!-- Existing buttons for mark all read and refresh -->
            <button 
                @click="markAllAsRead()" 
                class="text-sm text-blue-600 hover:text-blue-800 flex items-center"
                x-show="unreadCount > 0">
                <i class="fas fa-check-double mr-1"></i> Oznacz wszystkie jako przeczytane
            </button>
            <button 
                hx-get="<?= $notificationsEndpoint ?>" 
                hx-trigger="click" 
                hx-target="#<?= $containerId ?>"
                hx-indicator=".notifications-indicator"
                class="text-sm text-gray-600 hover:text-gray-800">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>
    
    <div class="max-h-96 overflow-y-auto" id="<?= $containerId ?>">
        <template x-if="loading">
            <div class="notifications-indicator flex justify-center p-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            </div>
        </template>
        
        <template x-if="!loading && notifications.length === 0">
            <div class="py-8 text-center">
                <div class="mx-auto h-12 w-12 text-gray-400 flex items-center justify-center">
                    <i class="fas fa-bell-slash text-2xl"></i>
                </div>
                <p class="mt-2 text-sm font-medium text-gray-900">Brak powiadomień</p>
                <p class="mt-1 text-sm text-gray-500"><?= $emptyStateMessage ?></p>
            </div>
        </template>
        
        <template x-if="!loading && notifications.length > 0">
            <div class="divide-y divide-gray-200">
                <template x-for="notification in notifications" :key="notification.id">
                    <div 
                        :class="!notification.read_at ? 'bg-blue-50' : ''" 
                        class="p-4 hover:bg-gray-50 transition duration-150 ease-in-out">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <div :class="getNotificationIconClass(notification.type)" class="h-10 w-10 rounded-full flex items-center justify-center">
                                    <i :class="getNotificationIcon(notification.type)" class="text-lg"></i>
                                </div>
                            </div>
                            <div class="ml-3 flex-1">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900" x-text="notification.title || 'Powiadomienie systemowe'"></p>
                                        <p x-show="isAdmin && notification.user_id" class="text-xs text-gray-500">
                                            Dotyczy użytkownika: <span x-text="notification.user_name || `ID: ${notification.user_id}`" class="font-medium"></span>
                                        </p>
                                    </div>
                                    <p class="text-xs text-gray-500" x-text="formatDate(notification.created_at)"></p>
                                </div>
                                <p class="mt-1 text-sm text-gray-600" x-text="notification.message"></p>
                                <div class="mt-2 flex items-center space-x-4">
                                    <template x-if="notification.action_url">
                                        <a :href="notification.action_url" class="text-xs text-blue-600 hover:text-blue-800 font-medium flex items-center">
                                            <i class="fas fa-external-link-alt mr-1"></i>
                                            <span>Przejdź do szczegółów</span>
                                        </a>
                                    </template>
                                    
                                    <!-- Admin-specific actions -->
                                    <template x-if="isAdmin && notification.booking_id">
                                        <a :href="`/admin/bookings/${notification.booking_id}`" class="text-xs text-green-600 hover:text-green-800 font-medium flex items-center">
                                            <i class="fas fa-calendar-check mr-1"></i>
                                            <span>Zobacz rezerwację</span>
                                        </a>
                                    </template>
                                    <template x-if="isAdmin && notification.user_id">
                                        <a :href="`/admin/users/${notification.user_id}`" class="text-xs text-purple-600 hover:text-purple-800 font-medium flex items-center">
                                            <i class="fas fa-user mr-1"></i>
                                            <span>Profil użytkownika</span>
                                        </a>
                                    </template>
                                    
                                    <button 
                                        x-show="!notification.read_at" 
                                        @click="markAsRead(notification.id)"
                                        class="text-xs text-gray-600 hover:text-gray-800 font-medium flex items-center">
                                        <i class="fas fa-check mr-1"></i>
                                        <span>Oznacz jako przeczytane</span>
                                    </button>
                                    <button 
                                        @click="deleteNotification(notification.id)"
                                        class="text-xs text-red-600 hover:text-red-800 font-medium flex items-center">
                                        <i class="fas fa-trash-alt mr-1"></i>
                                        <span>Usuń</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </template>
    </div>

    <template x-if="totalPages > 1">
        <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between items-center">
                <button 
                    @click="prevPage()" 
                    :disabled="currentPage === 1" 
                    :class="{'opacity-50 cursor-not-allowed': currentPage === 1}"
                    class="relative inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Poprzednia
                </button>
                <span class="text-sm text-gray-700">
                    Strona <span class="font-medium" x-text="currentPage"></span> z <span class="font-medium" x-text="totalPages"></span>
                </span>
                <button 
                    @click="nextPage()" 
                    :disabled="currentPage === totalPages" 
                    :class="{'opacity-50 cursor-not-allowed': currentPage === totalPages}"
                    class="relative inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Następna
                </button>
            </div>
        </div>
    </template>

    <!-- Alpine.js Component Logic -->
    <script>
        function notificationsPanel(isAdmin = false) {
            return {
                notifications: [],
                currentPage: 1,
                totalPages: 1,
                loading: true,
                unreadCount: 0,
                isAdmin: isAdmin,
                filters: {
                    type: 'all',
                    priority: 'all'
                },
                
                init() {
                    this.fetchNotifications();
                    
                    // Set up auto-refresh every 30-60 seconds
                    setInterval(() => {
                        this.fetchNotifications();
                    }, this.isAdmin ? 30000 : 60000);
                },
                
                fetchNotifications() {
                    this.loading = true;
                    
                    // Build query parameters
                    const queryParams = new URLSearchParams({
                        page: this.currentPage
                    });
                    
                    // Add admin-specific filters if needed
                    if (this.isAdmin) {
                        queryParams.append('type', this.filters.type);
                        queryParams.append('priority', this.filters.priority);
                    }
                    
                    // Determine the correct endpoint
                    const endpoint = this.isAdmin 
                        ? `/admin/notifications?${queryParams.toString()}`
                        : `/user/notifications?${queryParams.toString()}`;
                    
                    fetch(endpoint)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                this.notifications = data.data.notifications;
                                this.totalPages = data.data.meta?.total_pages || 1;
                                this.unreadCount = this.notifications.filter(n => !n.read_at).length;
                            } else {
                                console.error('Błąd pobierania powiadomień:', data.message);
                            }
                            this.loading = false;
                        })
                        .catch(error => {
                            console.error('Błąd podczas łączenia z serwerem:', error);
                            this.loading = false;
                        });
                },
                
                markAsRead(notificationId) {
                    // Determine the correct endpoint
                    const endpoint = this.isAdmin 
                        ? '/admin/notifications/mark-read'
                        : '/notifications/mark-as-read';
                    
                    fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `notification_id=${notificationId}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Aktualizacja lokalnej kopii powiadomienia
                            const index = this.notifications.findIndex(n => n.id === notificationId);
                            if (index !== -1) {
                                this.notifications[index].read_at = new Date().toISOString();
                                this.unreadCount = Math.max(0, this.unreadCount - 1);
                            }
                        } else {
                            console.error('Błąd oznaczania powiadomienia jako przeczytane:', data.message);
                        }
                    })
                    .catch(error => console.error('Błąd połączenia:', error));
                },
                
                markAllAsRead() {
                    // Determine the correct endpoint
                    const endpoint = this.isAdmin 
                        ? '/admin/notifications/mark-all-read'
                        : '/notifications/mark-all-read';
                    
                    fetch(endpoint, {
                        method: 'POST',
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Aktualizacja wszystkich powiadomień
                            this.notifications.forEach(notification => {
                                if (!notification.read_at) {
                                    notification.read_at = new Date().toISOString();
                                }
                            });
                            this.unreadCount = 0;
                        } else {
                            console.error('Błąd oznaczania powiadomień jako przeczytane:', data.message);
                        }
                    })
                    .catch(error => console.error('Błąd połączenia:', error));
                },
                
                deleteNotification(notificationId) {
                    if (!confirm('Czy na pewno chcesz usunąć to powiadomienie?')) {
                        return;
                    }
                    
                    // Determine the correct endpoint
                    const endpoint = this.isAdmin 
                        ? '/admin/notifications/delete'
                        : '/notifications/delete';
                    
                    fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `notification_id=${notificationId}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Usuń z lokalnej listy
                            const index = this.notifications.findIndex(n => n.id === notificationId);
                            if (index !== -1) {
                                if (!this.notifications[index].read_at) {
                                    this.unreadCount = Math.max(0, this.unreadCount - 1);
                                }
                                this.notifications.splice(index, 1);
                            }
                        } else {
                            console.error('Błąd usuwania powiadomienia:', data.message);
                        }
                    })
                    .catch(error => console.error('Błąd połączenia:', error));
                },
                
                nextPage() {
                    if (this.currentPage < this.totalPages) {
                        this.currentPage++;
                        this.fetchNotifications();
                    }
                },
                
                prevPage() {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                        this.fetchNotifications();
                    }
                },
                
                filterNotifications(type = 'all', priority = 'all') {
                    if (!this.isAdmin) return; // Only admins can filter
                    
                    this.filters.type = type;
                    this.filters.priority = priority;
                    this.currentPage = 1;
                    this.fetchNotifications();
                },
                
                formatDate(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffInMs = now - date;
                    const diffInMinutes = Math.floor(diffInMs / 60000);
                    const diffInHours = Math.floor(diffInMinutes / 60);
                    const diffInDays = Math.floor(diffInHours / 24);
                    
                    if (diffInMinutes < 1) {
                        return 'Przed chwilą';
                    } else if (diffInMinutes < 60) {
                        return `${diffInMinutes} min temu`;
                    } else if (diffInHours < 24) {
                        return `${diffInHours} godz. temu`;
                    } else if (diffInDays < 7) {
                        return `${diffInDays} dni temu`;
                    } else {
                        return date.toLocaleDateString('pl-PL', { 
                            day: '2-digit', 
                            month: '2-digit',
                            year: 'numeric' 
                        });
                    }
                },
                
                getNotificationIconClass(type) {
                    switch (type) {
                        case 'booking':
                            return 'bg-green-100 text-green-600';
                        case 'payment':
                            return 'bg-yellow-100 text-yellow-600';
                        case 'alert':
                            return 'bg-red-100 text-red-600';
                        case 'system':
                            return 'bg-purple-100 text-purple-600';
                        case 'error':
                            return 'bg-red-100 text-red-600';
                        case 'security':
                            return 'bg-orange-100 text-orange-600';
                        case 'user':
                            return 'bg-blue-100 text-blue-600';
                        case 'info':
                            return 'bg-blue-100 text-blue-600';
                        default:
                            return 'bg-gray-100 text-gray-600';
                    }
                },
                
                getNotificationIcon(type) {
                    switch (type) {
                        case 'booking':
                            return 'fas fa-calendar-check';
                        case 'payment':
                            return 'fas fa-money-bill-wave';
                        case 'alert':
                            return 'fas fa-exclamation-triangle';
                        case 'system':
                            return 'fas fa-server';
                        case 'error':
                            return 'fas fa-bug';
                        case 'security':
                            return 'fas fa-shield-alt';
                        case 'user':
                            return 'fas fa-user-edit';
                        case 'info':
                            return 'fas fa-info-circle';
                        default:
                            return 'fas fa-bell';
                    }
                },
                
                addNotification(notification) {
                    // Dodaj nowe powiadomienie na górę listy
                    if (this.currentPage === 1) {
                        this.notifications.unshift(notification);
                        this.unreadCount++;
                    }
                }
            };
        }
    </script>
</div>
=== public/views/user/profile.php ===
<?php
/**
 * User profile management view
 * 
 * This view allows users to update their profile information
 */
$pageTitle = "Mój profil | CarFuse";
require_once BASE_PATH . '/public/views/layout/base.php';
?>

<?php startSection('content'); ?>

<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-semibold mb-6 text-gray-800">Zarządzanie profilem</h1>
    
    <!-- Status messages -->
    <div x-data="{ showSuccess: false, showError: false, message: '' }">
        <div 
            x-show="showSuccess" 
            x-transition
            class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6 rounded" 
            role="alert">
            <p x-text="message">Profil został zaktualizowany pomyślnie!</p>
        </div>
        
        <div 
            x-show="showError" 
            x-transition
            class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded" 
            role="alert">
            <p x-text="message">Wystąpił błąd podczas aktualizacji profilu.</p>
        </div>
    </div>
    
    <!-- Main profile form -->
    <div 
        x-data="profileForm()" 
        class="bg-white rounded-lg shadow-md p-6">
        
        <form 
            id="profileForm"
            hx-post="/profile/update" 
            hx-target="#profileForm"
            hx-swap="outerHTML"
            hx-indicator="#submit-indicator"
            hx-on::after-request="handleResponse(event.detail)"
            @submit.prevent="validateForm($event)"
            enctype="multipart/form-data">
            
            <!-- Profile picture section -->
            <div class="mb-8 flex flex-col items-center sm:flex-row sm:items-start">
                <div class="w-32 h-32 relative mb-4 sm:mb-0 sm:mr-6">
                    <img 
                        :src="avatar_preview || avatar_url || '/assets/images/default-avatar.png'" 
                        class="w-32 h-32 rounded-full object-cover border-4 border-gray-200" 
                        alt="Zdjęcie profilowe">
                    
                    <div class="absolute bottom-0 right-0">
                        <label for="avatar_upload" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full cursor-pointer shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </label>
                        <input 
                            type="file" 
                            id="avatar_upload" 
                            name="avatar" 
                            accept="image/*" 
                            class="hidden"
                            @change="handleAvatarUpload">
                    </div>
                </div>
                
                <div class="flex-1">
                    <h3 class="text-xl font-medium text-gray-800" x-text="name || 'Użytkownik'"></h3>
                    <p class="text-gray-600 mb-2" x-text="email || ''"></p>
                    <p class="text-sm text-gray-500">Dołączono: <span x-text="joined_date || ''"></span></p>
                    <div class="mt-3">
                        <button 
                            type="button" 
                            class="text-sm text-blue-600 hover:text-blue-800"
                            @click="removeAvatar"
                            x-show="avatar_url || avatar_preview">
                            Usuń zdjęcie profilowe
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Profile sections -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Personal information -->
                <div class="bg-gray-50 p-5 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">Dane osobowe</h3>
                    
                    <div class="mb-4">
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Imię i nazwisko</label>
                        <input 
                            type="text" 
                            id="name" 
                            name="name" 
                            x-model="name" 
                            @blur="validateField('name')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Twoje imię i nazwisko">
                        <p 
                            x-show="errors.name" 
                            x-text="errors.name" 
                            class="text-red-500 text-xs mt-1"></p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="bio" class="block text-sm font-medium text-gray-700 mb-1">O mnie</label>
                        <textarea 
                            id="bio" 
                            name="bio" 
                            x-model="bio"
                            rows="3" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Krótka informacja o Tobie"></textarea>
                        <p 
                            x-show="errors.bio" 
                            x-text="errors.bio" 
                            class="text-red-500 text-xs mt-1"></p>
                    </div>
                </div>
                
                <!-- Contact information -->
                <div class="bg-gray-50 p-5 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">Dane kontaktowe</h3>
                    
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input 
                            type="email" 
                            id="email" 
                            name="email" 
                            x-model="email" 
                            disabled
                            class="w-full px-3 py-2 border border-gray-300 bg-gray-100 rounded-md cursor-not-allowed"
                            placeholder="Twój adres email">
                        <p class="text-xs text-gray-500 mt-1">Adres email nie może zostać zmieniony.</p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefon</label>
                        <input 
                            type="tel" 
                            id="phone" 
                            name="phone" 
                            x-model="phone"
                            @blur="validateField('phone')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Numer telefonu">
                        <p 
                            x-show="errors.phone" 
                            x-text="errors.phone" 
                            class="text-red-500 text-xs mt-1"></p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Lokalizacja</label>
                        <input 
                            type="text" 
                            id="location" 
                            name="location" 
                            x-model="location"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Miejscowość">
                        <p 
                            x-show="errors.location" 
                            x-text="errors.location" 
                            class="text-red-500 text-xs mt-1"></p>
                    </div>
                </div>
            </div>
            
            <!-- Preferences -->
            <div class="mt-6 bg-gray-50 p-5 rounded-lg">
                <h3 class="text-lg font-medium text-gray-800 mb-4">Preferencje</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="preferences[email_notifications]" x-model="preferences.email_notifications" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <span class="ml-2 text-sm text-gray-700">Powiadomienia email</span>
                        </label>
                    </div>
                    
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="preferences[sms_notifications]" x-model="preferences.sms_notifications" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <span class="ml-2 text-sm text-gray-700">Powiadomienia SMS</span>
                        </label>
                    </div>
                    
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="preferences[marketing_emails]" x-model="preferences.marketing_emails" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <span class="ml-2 text-sm text-gray-700">Wiadomości marketingowe</span>
                        </label>
                    </div>
                    
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="preferences[newsletter]" x-model="preferences.newsletter" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <span class="ml-2 text-sm text-gray-700">Newsletter</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Submit button -->
            <div class="mt-6 flex justify-end">
                <button 
                    type="submit" 
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center"
                    :disabled="isSubmitting">
                    <span id="submit-indicator" class="htmx-indicator">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                    Aktualizuj profil
                </button>
            </div>
        </form>
        
        <!-- Password change form -->
        <div class="mt-10 pt-6 border-t border-gray-200">
            <h3 class="text-lg font-medium text-gray-800 mb-4">Zmień hasło</h3>
            
            <form 
                x-data="passwordForm()" 
                @submit.prevent="validatePasswordForm($event)"
                hx-post="/user/change-password" 
                hx-swap="none"
                hx-on::after-request="handlePasswordResponse(event.detail)">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="current_password" class="block text-sm font-medium text-gray-700 mb-1">Aktualne hasło</label>
                        <input 
                            type="password" 
                            id="current_password" 
                            name="current_password" 
                            x-model="current_password"
                            @blur="validatePasswordField('current_password')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p 
                            x-show="errors.current_password" 
                            x-text="errors.current_password" 
                            class="text-red-500 text-xs mt-1"></p>
                    </div>
                    
                    <div>
                        <label for="new_password" class="block text-sm font-medium text-gray-700 mb-1">Nowe hasło</label>
                        <input 
                            type="password" 
                            id="new_password" 
                            name="new_password" 
                            x-model="new_password"
                            @blur="validatePasswordField('new_password')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p 
                            x-show="errors.new_password" 
                            x-text="errors.new_password" 
                            class="text-red-500 text-xs mt-1"></p>
                    </div>
                    
                    <div>
                        <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-1">Potwierdź hasło</label>
                        <input 
                            type="password" 
                            id="confirm_password" 
                            name="confirm_password" 
                            x-model="confirm_password"
                            @blur="validatePasswordField('confirm_password')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p 
                            x-show="errors.confirm_password" 
                            x-text="errors.confirm_password" 
                            class="text-red-500 text-xs mt-1"></p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <button 
                        type="submit" 
                        class="px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
                        :disabled="isSubmitting">
                        Zmień hasło
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Alpine.js form validation logic -->
<script>
    function profileForm() {
        return {
            // User data
            id: <?= htmlspecialchars(json_encode($_SESSION['user_id'] ?? '')) ?>,
            name: <?= htmlspecialchars(json_encode($profileData['name'] ?? '')) ?>,
            email: <?= htmlspecialchars(json_encode($profileData['email'] ?? '')) ?>,
            bio: <?= htmlspecialchars(json_encode($profileData['bio'] ?? '')) ?>,
            location: <?= htmlspecialchars(json_encode($profileData['location'] ?? '')) ?>,
            phone: <?= htmlspecialchars(json_encode($profileData['phone'] ?? '')) ?>,
            avatar_url: <?= htmlspecialchars(json_encode($profileData['avatar_url'] ?? '')) ?>,
            joined_date: <?= htmlspecialchars(json_encode($profileData['joined_date'] ?? '')) ?>,
            avatar_preview: null,
            avatar_file: null,
            preferences: {
                email_notifications: <?= $profileData['preferences']['email_notifications'] ?? 'true' ?>,
                sms_notifications: <?= $profileData['preferences']['sms_notifications'] ?? 'false' ?>,
                marketing_emails: <?= $profileData['preferences']['marketing_emails'] ?? 'false' ?>,
                newsletter: <?= $profileData['preferences']['newsletter'] ?? 'true' ?>
            },
            errors: {},
            isSubmitting: false,
            
            // Validation methods
            validateField(field) {
                this.errors[field] = null;
                
                if (field === 'name' && !this.name) {
                    this.errors.name = 'Imię i nazwisko jest wymagane';
                } else if (field === 'name' && this.name.length > 100) {
                    this.errors.name = 'Imię i nazwisko może mieć maksymalnie 100 znaków';
                }
                
                if (field === 'bio' && this.bio && this.bio.length > 500) {
                    this.errors.bio = 'Opis może mieć maksymalnie 500 znaków';
                }
                
                if (field === 'phone' && this.phone) {
                    const phonePattern = /^(?:\+48\s?|0048\s?)?(?:5[0-9]{8}|6[0-9]{8}|7[0-9]{8}|8[0-9]{8}|9[0-9]{8})$/;
                    if (!phonePattern.test(this.phone)) {
                        this.errors.phone = 'Podaj poprawny numer telefonu';
                    }
                }
                
                if (field === 'location' && this.location && this.location.length > 100) {
                    this.errors.location = 'Lokalizacja może mieć maksymalnie 100 znaków';
                }
                
                return !this.errors[field];
            },
            
            validateForm(event) {
                this.errors = {};
                let isValid = true;
                
                // Validate each field
                if (!this.validateField('name')) isValid = false;
                if (!this.validateField('bio')) isValid = false;
                if (!this.validateField('phone')) isValid = false;
                if (!this.validateField('location')) isValid = false;
                
                if (!isValid) {
                    event.preventDefault();
                    return false;
                }
                
                this.isSubmitting = true;
                return true;
            },
            
            // Handle avatar upload
            handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Validate file type
                if (!file.type.match('image.*')) {
                    alert('Wybierz plik graficzny (JPG, PNG, GIF)');
                    return;
                }
                
                // Validate file size (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('Rozmiar pliku nie może przekraczać 2MB');
                    return;
                }
                
                this.avatar_file = file;
                
                // Create preview
                const reader = new FileReader();
                reader.onload = e => {
                    this.avatar_preview = e.target.result;
                };
                reader.readAsDataURL(file);
            },
            
            // Remove avatar
            removeAvatar() {
                this.avatar_preview = null;
                this.avatar_url = null;
                this.avatar_file = null;
                document.getElementById('avatar_upload').value = '';
                // Add a hidden input to tell the server to remove the avatar
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'remove_avatar';
                hiddenInput.value = '1';
                document.getElementById('profileForm').appendChild(hiddenInput);
            },
            
            // Handle form submission response
            handleResponse(detail) {
                this.isSubmitting = false;
                
                const event = new CustomEvent('profile-response', {
                    detail: detail.xhr.responseText ? JSON.parse(detail.xhr.responseText) : {}
                });
                
                window.dispatchEvent(event);
                
                const response = event.detail;
                
                if (response.status === 'success') {
                    document.querySelector('[x-data="{ showSuccess: false, showError: false, message: \'\' }"]').__x.$data.showSuccess = true;
                    document.querySelector('[x-data="{ showSuccess: false, showError: false, message: \'\' }"]').__x.$data.message = response.message;
                    
                    // Hide the success message after 4 seconds
                    setTimeout(() => {
                        document.querySelector('[x-data="{ showSuccess: false, showError: false, message: \'\' }"]').__x.$data.showSuccess = false;
                    }, 4000);
                } else {
                    document.querySelector('[x-data="{ showSuccess: false, showError: false, message: \'\' }"]').__x.$data.showError = true;
                    document.querySelector('[x-data="{ showSuccess: false, showError: false, message: \'\' }"]').__x.$data.message = response.message || 'Wystąpił błąd podczas aktualizacji profilu.';
                    
                    // If we have field-specific errors
                    if (response.errors) {
                        this.errors = response.errors;
                    }
                }
            }
        };
    }
    
    function passwordForm() {
        return {
            current_password: '',
            new_password: '',
            confirm_password: '',
            errors: {},
            isSubmitting: false,
            
            validatePasswordField(field) {
                this.errors[field] = null;
                
                if (field === 'current_password' && !this.current_password) {
                    this.errors.current_password = 'Aktualne hasło jest wymagane';
                }
                
                if (field === 'new_password') {
                    if (!this.new_password) {
                        this.errors.new_password = 'Nowe hasło jest wymagane';
                    } else if (this.new_password.length < 6) {
                        this.errors.new_password = 'Hasło musi mieć co najmniej 6 znaków';
                    }
                }
                
                if (field === 'confirm_password') {
                    if (!this.confirm_password) {
                        this.errors.confirm_password = 'Proszę potwierdzić nowe hasło';
                    } else if (this.confirm_password !== this.new_password) {
                        this.errors.confirm_password = 'Hasła nie są zgodne';
                    }
                }
                
                return !this.errors[field];
            },
            
            validatePasswordForm(event) {
                this.errors = {};
                let isValid = true;
                
                if (!this.validatePasswordField('current_password')) isValid = false;
                if (!this.validatePasswordField('new_password')) isValid = false;
                if (!this.validatePasswordField('confirm_password')) isValid = false;
                
                if (!isValid) {
                    event.preventDefault();
                    return false;
                }
                
                this.isSubmitting = true;
                return true;
            },
            
            handlePasswordResponse(detail) {
                this.isSubmitting = false;
                
                try {
                    const response = JSON.parse(detail.xhr.responseText);
                    
                    if (response.status === 'success') {
                        document.querySelector('[x-data="{ showSuccess: false, showError: false, message: \'\' }"]').__x.$data.showSuccess = true;
                        document.querySelector('[x-data="{ showSuccess: false, showError: false, message: \'\' }"]').__x.$data.message = response.message || 'Hasło zostało zmienione pomyślnie.';
                        
                        // Clear password fields
                        this.current_password = '';
                        this.new_password = '';
                        this.confirm_password = '';
                        
                        // Hide the success message after 4 seconds
                        setTimeout(() => {
                            document.querySelector('[x-data="{ showSuccess: false, showError: false, message: \'\' }"]').__x.$data.showSuccess = false;
                        }, 4000);
                    } else {
                        document.querySelector('[x-data="{ showSuccess: false, showError: false, message: \'\' }"]').__x.$data.showError = true;
                        document.querySelector('[x-data="{ showSuccess: false, showError: false, message: \'\' }"]').__x.$data.message = response.message || 'Wystąpił błąd podczas zmiany hasła.';
                        
                        // If we have field-specific errors
                        if (response.errors) {
                            this.errors = response.errors;
                        }
                    }
                } catch (e) {
                    console.error("Error parsing response:", e);
                    document.querySelector('[x-data="{ showSuccess: false, showError: false, message: \'\' }"]').__x.$data.showError = true;
                    document.querySelector('[x-data="{ showSuccess: false, showError: false, message: \'\' }"]').__x.$data.message = 'Wystąpił błąd podczas przetwarzania odpowiedzi.';
                }
            }
        };
    }
</script>

<?php endSection(); ?>
=== public/views/user/payments-history.php ===
<?php
// Authentication check
if (!isset($_SESSION['user_id'])) {
    header('Location: /login?redirect=' . urlencode($_SERVER['REQUEST_URI']));
    exit;
}

$title = "Historia płatności";
$userId = $_SESSION['user_id'];

// Helper function for formatting currency
function formatCurrency($amount, $currency = 'PLN') {
    return number_format($amount, 2, ',', ' ') . ' ' . $currency;
}

// Helper function for formatting dates in Polish
function formatPolishDate($date) {
    $timestamp = strtotime($date);
    $months = [
        'stycznia', 'lutego', 'marca', 'kwietnia', 'maja', 'czerwca', 
        'lipca', 'sierpnia', 'września', 'października', 'listopada', 'grudnia'
    ];
    $day = date('j', $timestamp);
    $month = $months[date('n', $timestamp) - 1];
    $year = date('Y', $timestamp);
    $hour = date('H:i', $timestamp);
    
    return "$day $month $year, $hour";
}

include BASE_PATH . '/public/views/base.php';
?>

<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Historia płatności</h1>
    
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <!-- Tabs for navigation -->
        <div class="border-b border-gray-200 mb-6" x-data="{ activeTab: 'history' }">
            <ul class="flex flex-wrap -mb-px">
                <li class="mr-2">
                    <a href="#" 
                       @click.prevent="activeTab = 'history'" 
                       :class="{ 'border-blue-500 text-blue-600': activeTab === 'history', 
                                'border-transparent text-gray-500 hover:text-gray-700': activeTab !== 'history' }"
                       class="inline-block p-4 border-b-2 font-medium">
                        Historia transakcji
                    </a>
                </li>
                <li class="mr-2">
                    <a href="#" 
                       @click.prevent="activeTab = 'methods'" 
                       :class="{ 'border-blue-500 text-blue-600': activeTab === 'methods', 
                                'border-transparent text-gray-500 hover:text-gray-700': activeTab !== 'methods' }"
                       class="inline-block p-4 border-b-2 font-medium">
                        Metody płatności
                    </a>
                </li>
            </ul>
        </div>

        <!-- Transaction History Tab -->
        <div x-show="activeTab === 'history'">
            <!-- Search and Filter Section -->
            <div class="flex flex-wrap items-center justify-between mb-6">
                <div class="w-full lg:w-1/2 mb-4 lg:mb-0">
                    <div class="relative">
                        <input type="text" 
                               id="payment-search" 
                               placeholder="Wyszukaj transakcję..." 
                               class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               hx-trigger="keyup changed delay:500ms"
                               hx-get="/payments/search"
                               hx-target="#payments-table-body"
                               hx-include="[name='payment-filter']">
                        <div class="absolute left-3 top-2.5 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="w-full lg:w-1/2 flex justify-end space-x-4">
                    <select name="payment-filter" 
                            class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            hx-trigger="change"
                            hx-get="/payments/filter"
                            hx-target="#payments-table-body">
                        <option value="all">Wszystkie transakcje</option>
                        <option value="payment">Tylko płatności</option>
                        <option value="refund">Tylko zwroty</option>
                    </select>

                    <select name="payment-sort" 
                            class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            hx-trigger="change"
                            hx-get="/payments/sort"
                            hx-target="#payments-table-body">
                        <option value="date_desc">Od najnowszych</option>
                        <option value="date_asc">Od najstarszych</option>
                        <option value="amount_desc">Kwota (malejąco)</option>
                        <option value="amount_asc">Kwota (rosnąco)</option>
                    </select>
                </div>
            </div>

            <!-- Transactions Table -->
            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <th class="px-4 py-3">Data</th>
                            <th class="px-4 py-3">Nr transakcji</th>
                            <th class="px-4 py-3">Typ</th>
                            <th class="px-4 py-3">Kwota</th>
                            <th class="px-4 py-3">Status</th>
                            <th class="px-4 py-3">Akcje</th>
                        </tr>
                    </thead>
                    <tbody id="payments-table-body" hx-get="/payments/history" hx-trigger="load">
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="flex justify-center items-center">
                                    <svg class="animate-spin h-6 w-6 text-blue-500 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Ładowanie transakcji...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="no-transactions" class="hidden text-center py-8 text-gray-500">
                Nie znaleziono żadnych transakcji
            </div>

            <div class="mt-4 flex justify-center">
                <button id="load-more-btn" 
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                        hx-get="/payments/history?page=2" 
                        hx-target="#payments-table-body" 
                        hx-swap="beforeend"
                        hx-trigger="click">
                    Załaduj więcej
                </button>
            </div>
        </div>
        
        <!-- Payment Methods Tab -->
        <div x-show="activeTab === 'methods'" x-data="paymentMethods()">
            <div class="mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Twoje metody płatności</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="payment-methods-container" hx-get="/payments/methods" hx-trigger="load">
                    <!-- Payment methods will be loaded here -->
                    <div class="col-span-full text-center py-4">
                        <div class="flex justify-center items-center">
                            <svg class="animate-spin h-6 w-6 text-blue-500 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Ładowanie metod płatności...
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button @click="showAddMethodModal = true" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Dodaj nową metodę płatności
                    </button>
                </div>
            </div>
            
            <!-- Modal for adding payment method -->
            <div x-show="showAddMethodModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md" @click.outside="showAddMethodModal = false">
                    <h3 class="text-xl font-bold mb-4">Dodaj nową metodę płatności</h3>
                    
                    <form id="add-payment-method-form" @submit.prevent="submitPaymentMethod">
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">Typ płatności</label>
                            <select x-model="newMethod.type" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="credit_card">Karta kredytowa</option>
                                <option value="bank_transfer">Przelew bankowy</option>
                                <option value="blik">BLIK</option>
                            </select>
                        </div>
                        
                        <div x-show="newMethod.type === 'credit_card'">
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2">Numer karty</label>
                                <input type="text" x-model="newMethod.card_number" placeholder="1234 5678 9012 3456" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" maxlength="19">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-gray-700 mb-2">Data ważności</label>
                                    <input type="text" x-model="newMethod.expiry_date" placeholder="MM/RR" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" maxlength="5">
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-2">CVV</label>
                                    <input type="text" x-model="newMethod.cvv" placeholder="123" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" maxlength="3">
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2">Nazwa na karcie</label>
                                <input type="text" x-model="newMethod.cardholder_name" placeholder="Jan Kowalski" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <div x-show="newMethod.type === 'bank_transfer'">
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2">Nazwa banku</label>
                                <input type="text" x-model="newMethod.bank_name" placeholder="Nazwa banku" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2">Numer konta</label>
                                <input type="text" x-model="newMethod.account_number" placeholder="PL61 1090 1014 0000 0712 1981 2874" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <div x-show="newMethod.type === 'blik'">
                            <div class="mb-4">
                                <p class="text-gray-600 mb-2">
                                    Metoda BLIK zostanie dodana do Twojego konta. Kod BLIK będzie generowany przy każdej płatności.
                                </p>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" x-model="newMethod.is_default" class="rounded text-blue-500 mr-2">
                                <span class="text-gray-700">Ustaw jako domyślną metodę płatności</span>
                            </label>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" @click="showAddMethodModal = false" class="px-4 py-2 border rounded-lg">Anuluj</button>
                            <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                Zapisz metodę płatności
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Modal for payment method details -->
            <div x-show="showDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md" @click.outside="showDetailModal = false">
                    <h3 class="text-xl font-bold mb-4">Szczegóły metody płatności</h3>
                    
                    <div id="payment-method-details">
                        <!-- Details will be loaded here via HTMX -->
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button type="button" @click="showDetailModal = false" class="px-4 py-2 border rounded-lg">Zamknij</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Detail Modal -->
<div id="payment-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Szczegóły transakcji</h3>
            <button onclick="document.getElementById('payment-detail-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <div id="payment-detail-content">
            <!-- Payment details will be loaded here -->
        </div>
    </div>
</div>

<script>
    // Alpine.js component for payment methods
    function paymentMethods() {
        return {
            showAddMethodModal: false,
            showDetailModal: false,
            newMethod: {
                type: 'credit_card',
                card_number: '',
                expiry_date: '',
                cvv: '',
                cardholder_name: '',
                bank_name: '',
                account_number: '',
                is_default: false
            },
            
            formatCardNumber(e) {
                let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = '';
                
                for (let i = 0; i < value.length; i++) {
                    if (i > 0 && i % 4 === 0) {
                        formattedValue += ' ';
                    }
                    formattedValue += value[i];
                }
                
                this.newMethod.card_number = formattedValue;
            },
            
            submitPaymentMethod() {
                // Submit via AJAX to avoid page reload
                fetch('/payments/methods/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.newMethod),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Refresh payment methods list
                        htmx.trigger('#payment-methods-container', 'load');
                        this.showAddMethodModal = false;
                        
                        // Reset form
                        this.newMethod = {
                            type: 'credit_card',
                            card_number: '',
                            expiry_date: '',
                            cvv: '',
                            cardholder_name: '',
                            bank_name: '',
                            account_number: '',
                            is_default: false
                        };
                        
                        // Show success message
                        alert('Metoda płatności została dodana pomyślnie.');
                    } else {
                        alert('Błąd: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Wystąpił błąd podczas dodawania metody płatności.');
                });
            },
            
            viewPaymentMethodDetails(id) {
                this.showDetailModal = true;
                
                // Load payment method details using HTMX
                htmx.ajax('GET', `/payments/methods/${id}`, {
                    target: '#payment-method-details',
                    swap: 'innerHTML'
                });
            },
            
            deletePaymentMethod(id) {
                if (confirm('Czy na pewno chcesz usunąć tę metodę płatności?')) {
                    fetch(`/payments/methods/${id}/delete`, {
                        method: 'DELETE',
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Refresh payment methods list
                            htmx.trigger('#payment-methods-container', 'load');
                            alert('Metoda płatności została usunięta.');
                        } else {
                            alert('Błąd: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Wystąpił błąd podczas usuwania metody płatności.');
                    });
                }
            }
        }
    }
    
    // Function to show payment details
    function showPaymentDetails(id) {
        const modal = document.getElementById('payment-detail-modal');
        modal.classList.remove('hidden');
        
        // Load payment details using HTMX
        htmx.ajax('GET', `/payments/${id}/details`, {
            target: '#payment-detail-content',
            swap: 'innerHTML'
        });
    }
    
    // Function to download invoice
    function downloadInvoice(id) {
        window.location.href = `/payments/${id}/invoice`;
    }
</script>
=== public/views/user/dashboard.php ===
<?php
/**
 * User Dashboard - Panel Użytkownika
 * Main dashboard view for CarFuse users
 * 
 * Connected to DashboardController methods:
 * - index() - Main view
 * - getUserStatistics() - For statistics panel
 * - getUserBookings() - For recent bookings
 * - getUserNotifications() - For notifications panel
 */

// Ensure the user is authenticated
if (!isset($_SESSION['user_id'])) {
    header('Location: /auth/login');
    exit;
}

// Get user data from session
$userId = $_SESSION['user_id'];
$userName = $_SESSION['user_name'] ?? 'Użytkowniku';

// Helper function to format currency
function formatCurrency($amount) {
    return number_format($amount, 2, ',', ' ') . ' zł';
}

// Set layout variables for base template
$pageTitle = "CarFuse - Panel Użytkownika";
$metaDescription = "Panel użytkownika CarFuse - zarządzaj swoimi rezerwacjami i sprawdź dostępne pojazdy.";

// Start output buffering to capture content for the base template
ob_start();
?>

<div class="container mx-auto px-4 py-8">
    <!-- Dashboard Header -->
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <div class="flex flex-wrap items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Witaj, <?= htmlspecialchars($userName) ?> 👋</h1>
                <p class="text-gray-600">Zarządzaj swoimi rezerwacjami i sprawdź dostępne pojazdy w jednym miejscu.</p>
            </div>
            <div class="mt-4 md:mt-0">
                <a href="/vehicles/browse" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex items-center">
                    <i class="fas fa-car mr-2"></i> Przeglądaj pojazdy
                </a>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Stats -->
    <div class="mb-6" id="user-statistics" 
         hx-get="/dashboard/statistics" 
         hx-trigger="load" 
         hx-indicator=".htmx-indicator"
         hx-swap="innerHTML">
        <div class="flex justify-center htmx-indicator">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="flex flex-wrap -mx-3">
        <!-- Recent Bookings -->
        <div class="w-full lg:w-2/3 px-3 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-gray-800">Twoje rezerwacje</h2>
                    <div class="flex">
                        <button 
                            hx-get="/dashboard/bookings" 
                            hx-target="#recent-bookings-content"
                            hx-indicator="#bookings-spinner"
                            class="text-sm font-medium text-blue-600 hover:text-blue-800 flex items-center">
                            <i class="fas fa-sync-alt mr-1"></i> Odśwież
                        </button>
                        <span id="bookings-spinner" class="htmx-indicator ml-2">
                            <i class="fas fa-circle-notch animate-spin text-blue-500"></i>
                        </span>
                    </div>
                </div>
                
                <div>
                    <!-- Tabs -->
                    <div class="border-b border-gray-200 mb-4">
                        <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" x-data="{ activeTab: 'all' }">
                            <li class="mr-2">
                                <a href="#" 
                                   @click.prevent="activeTab = 'all'" 
                                   :class="{'border-b-2 border-blue-500 text-blue-600': activeTab === 'all'}"
                                   class="inline-block p-4 rounded-t-lg hover:text-blue-600"
                                   hx-get="/dashboard/bookings" 
                                   hx-target="#recent-bookings-content">
                                    Wszystkie
                                </a>
                            </li>
                            <li class="mr-2">
                                <a href="#" 
                                   @click.prevent="activeTab = 'active'" 
                                   :class="{'border-b-2 border-blue-500 text-blue-600': activeTab === 'active'}"
                                   class="inline-block p-4 rounded-t-lg hover:text-blue-600"
                                   hx-get="/dashboard/bookings?status=active" 
                                   hx-target="#recent-bookings-content">
                                    Aktywne
                                </a>
                            </li>
                            <li class="mr-2">
                                <a href="#" 
                                   @click.prevent="activeTab = 'completed'" 
                                   :class="{'border-b-2 border-blue-500 text-blue-600': activeTab === 'completed'}"
                                   class="inline-block p-4 rounded-t-lg hover:text-blue-600"
                                   hx-get="/dashboard/bookings?status=completed" 
                                   hx-target="#recent-bookings-content">
                                    Ukończone
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- Bookings Content -->
                    <div id="recent-bookings-content" 
                         hx-get="/dashboard/bookings" 
                         hx-trigger="load" 
                         hx-swap="innerHTML"
                         class="min-h-[300px]">
                        <div class="flex justify-center items-center h-32">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                        </div>
                    </div>
                    
                    <!-- No Bookings Message (hidden by default) -->
                    <div id="no-bookings-message" class="text-center py-8 hidden">
                        <div class="text-gray-400 text-5xl mb-4">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <h3 class="text-xl font-medium text-gray-700 mb-1">Brak rezerwacji</h3>
                        <p class="text-gray-500 mb-4">Nie masz jeszcze żadnych rezerwacji</p>
                        <a href="/vehicles/browse" class="inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md">
                            <i class="fas fa-car mr-2"></i> Zarezerwuj pojazd
                        </a>
                    </div>
                </div>
                
                <div class="mt-4 text-center">
                    <a href="/bookings/my" class="inline-block text-sm font-medium text-blue-600 hover:text-blue-800">
                        Zobacz wszystkie rezerwacje <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- User Profile & Notifications -->
        <div class="w-full lg:w-1/3 px-3 mb-6">
            <!-- User Profile Card -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6" 
                 id="user-profile" 
                 hx-get="/dashboard/profile" 
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <div class="animate-pulse">
                    <div class="flex items-center">
                        <div class="rounded-full bg-gray-200 h-16 w-16 mr-4"></div>
                        <div class="flex-1">
                            <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                    <div class="mt-4 space-y-3">
                        <div class="h-3 bg-gray-200 rounded w-full"></div>
                        <div class="h-3 bg-gray-200 rounded w-3/4"></div>
                    </div>
                    <div class="mt-4 text-center">
                        <a href="/profile" class="text-sm font-medium text-blue-600 hover:text-blue-800">
                            Edytuj profil <i class="fas fa-user-edit ml-1"></i>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Notifications -->
            <div class="bg-white rounded-lg shadow-md p-6" x-data="{ showNotifications: false, showAllNotifications: false }">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800">
                        <button @click="showNotifications = !showNotifications" class="flex items-center">
                            Powiadomienia
                            <i class="fas" :class="showNotifications ? 'fa-chevron-up ml-2' : 'fa-chevron-down ml-2'"></i>
                        </button>
                    </h2>
                    <div class="flex items-center">
                        <span class="bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center mr-2" id="notification-count">0</span>
                        <button 
                            hx-get="/dashboard/notifications" 
                            hx-target="#notifications-list"
                            hx-indicator="#notifications-spinner"
                            class="text-sm font-medium text-blue-600 hover:text-blue-800">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <span id="notifications-spinner" class="htmx-indicator ml-2">
                            <i class="fas fa-circle-notch animate-spin text-blue-500"></i>
                        </span>
                    </div>
                </div>
                <div x-show="showNotifications" x-transition>
                    <div id="notifications-list" 
                         hx-get="/dashboard/notifications" 
                         hx-trigger="load" 
                         hx-swap="innerHTML"
                         class="space-y-4 max-h-[300px] overflow-y-auto">
                        <div class="animate-pulse space-y-3">
                            <div class="flex items-start">
                                <div class="h-8 w-8 rounded-full bg-gray-200 flex-shrink-0"></div>
                                <div class="ml-3 flex-1">
                                    <div class="h-3 bg-gray-200 rounded w-3/4 mb-1"></div>
                                    <div class="h-2 bg-gray-200 rounded w-1/2"></div>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="h-8 w-8 rounded-full bg-gray-200 flex-shrink-0"></div>
                                <div class="ml-3 flex-1">
                                    <div class="h-3 bg-gray-200 rounded w-3/4 mb-1"></div>
                                    <div class="h-2 bg-gray-200 rounded w-1/2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 text-center" x-show="!showAllNotifications">
                        <button @click="showAllNotifications = true" class="inline-block text-sm font-medium text-blue-600 hover:text-blue-800">
                            Pokaż wszystkie powiadomienia <i class="fas fa-arrow-right ml-1"></i>
                        </button>
                    </div>
                    <div class="mt-4 text-center" x-show="showAllNotifications" x-cloak>
                        <button @click="showAllNotifications = false" class="inline-block text-sm font-medium text-blue-600 hover:text-blue-800">
                            Pokaż mniej <i class="fas fa-arrow-up ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-lg font-bold text-gray-800 mb-4">Szybkie akcje</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <a href="/vehicles/browse" class="flex flex-col items-center justify-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                <div class="bg-blue-100 rounded-full p-3 mb-3">
                    <i class="fas fa-car text-blue-600 text-xl"></i>
                </div>
                <span class="text-sm font-medium text-gray-900">Przeglądaj pojazdy</span>
            </a>
            <a href="/bookings/new" class="flex flex-col items-center justify-center p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                <div class="bg-green-100 rounded-full p-3 mb-3">
                    <i class="fas fa-calendar-plus text-green-600 text-xl"></i>
                </div>
                <span class="text-sm font-medium text-gray-900">Nowa rezerwacja</span>
            </a>
            <a href="/profile/edit" class="flex flex-col items-center justify-center p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
                <div class="bg-purple-100 rounded-full p-3 mb-3">
                    <i class="fas fa-user-edit text-purple-600 text-xl"></i>
                </div>
                <span class="text-sm font-medium text-gray-900">Edytuj profil</span>
            </a>
            <a href="/support" class="flex flex-col items-center justify-center p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition-colors">
                <div class="bg-yellow-100 rounded-full p-3 mb-3">
                    <i class="fas fa-headset text-yellow-600 text-xl"></i>
                </div>
                <span class="text-sm font-medium text-gray-900">Wsparcie</span>
            </a>
        </div>
    </div>
</div>

<script>
    // Update notification count when notifications are loaded
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'notifications-list') {
            // Count unread notifications
            const unreadCount = document.querySelectorAll('#notifications-list .unread-notification').length;
            document.getElementById('notification-count').innerText = unreadCount;
            
            // If no unread notifications, remove the red background
            if (unreadCount === 0) {
                document.getElementById('notification-count').classList.remove('bg-red-500');
                document.getElementById('notification-count').classList.add('bg-gray-300');
            } else {
                document.getElementById('notification-count').classList.add('bg-red-500');
                document.getElementById('notification-count').classList.remove('bg-gray-300');
            }
        }
    });
</script>

<?php
// Get the content and clean output buffer
$content = ob_get_clean();

// Include base layout with captured content
include BASE_PATH . '/public/views/layouts/base.php';
?>
=== public/views/user/bookings.php ===
<?php
// Authentication check - redirect if not logged in
if (!isset($_SESSION['user_id'])) {
    header('Location: /login?redirect=' . urlencode($_SERVER['REQUEST_URI']));
    exit;
}

// Load layout
$pageTitle = "Moje Rezerwacje";
$metaDescription = "Zarządzaj swoimi rezerwacjami samochodów w CarFuse";

include BASE_PATH . '/public/views/layouts/base.php';
?>

<!-- Main Content -->
<div class="container mx-auto px-4 py-8" x-data="{ showModal: false, modalType: '', bookingId: null }">
    <div class="max-w-5xl mx-auto">
        <!-- Include user statistics at the top -->
        <div class="mb-8">
            <?php include BASE_PATH . '/public/views/partials/user-statistics.php'; ?>
        </div>
        
        <!-- Main bookings management component -->
        <?php include BASE_PATH . '/public/views/partials/user-bookings.php'; ?>
    </div>
</div>

<!-- Confirmation Modal -->
<div x-show="showModal" 
     class="fixed inset-0 z-50 overflow-y-auto" 
     x-cloak>
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div x-show="showModal" 
             x-transition:enter="ease-out duration-300" 
             x-transition:enter-start="opacity-0" 
             x-transition:enter-end="opacity-100" 
             x-transition:leave="ease-in duration-200" 
             x-transition:leave-start="opacity-100" 
             x-transition:leave-end="opacity-0" 
             class="fixed inset-0 transition-opacity" 
             @click="showModal = false">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div x-show="showModal" 
             x-transition:enter="ease-out duration-300" 
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" 
             x-transition:leave="ease-in duration-200" 
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" 
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" 
             class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full sm:mx-0 sm:h-10 sm:w-10" 
                         :class="modalType === 'cancel' ? 'bg-red-100' : 'bg-yellow-100'">
                        <svg class="h-6 w-6" :class="modalType === 'cancel' ? 'text-red-600' : 'text-yellow-600'" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">
                            <span x-show="modalType === 'cancel'">Anuluj rezerwację</span>
                            <span x-show="modalType === 'reschedule'">Zmień termin rezerwacji</span>
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500" x-show="modalType === 'cancel'">
                                Czy na pewno chcesz anulować tę rezerwację? Ta akcja może podlegać opłatom za anulowanie oraz nie może zostać cofnięta.
                            </p>
                            <div x-show="modalType === 'reschedule'" class="mt-4">
                                <form id="rescheduleForm" hx-post="/bookings/reschedule" hx-swap="outerHTML">
                                    <input type="hidden" name="booking_id" :value="bookingId">
                                    <div class="mb-4">
                                        <label for="pickup_date" class="block text-sm font-medium text-gray-700">Nowa data odbioru</label>
                                        <input type="datetime-local" id="pickup_date" name="pickup_date" 
                                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>
                                    <div class="mb-4">
                                        <label for="dropoff_date" class="block text-sm font-medium text-gray-700">Nowa data zwrotu</label>
                                        <input type="datetime-local" id="dropoff_date" name="dropoff_date" 
                                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button x-show="modalType === 'cancel'" 
                        type="button" 
                        hx-post="/bookings/cancel" 
                        :hx-vals="JSON.stringify({booking_id: bookingId})"
                        hx-target="#bookings-container"
                        hx-swap="innerHTML"
                        @click="showModal = false"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Tak, anuluj rezerwację
                </button>
                <button x-show="modalType === 'reschedule'" 
                        type="button" 
                        @click="document.getElementById('rescheduleForm').dispatchEvent(new Event('submit')); showModal = false"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Zmień termin
                </button>
                <button type="button" 
                        @click="showModal = false"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Anuluj
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Global function to open confirmation modals
    function openModal(type, id) {
        const modal = document.querySelector('[x-data*="showModal"]').__x.$data;
        modal.modalType = type;
        modal.bookingId = id;
        modal.showModal = true;
    }

    document.addEventListener('alpine:init', () => {
        Alpine.data('bookingCard', (booking) => ({
            expanded: false,
            booking: booking,
            toggleExpand() {
                this.expanded = !this.expanded;
            }
        }));
    });
</script>
=== public/views/user/payments.php ===
=== public/views/info/cookie_policy.php ===
<?php
require_once __DIR__ . '/../vendor/autoload.php';
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cookie & Data Policy</title>
</head>
<body>
    <h2>Cookie & Data Storage Policy</h2>
    <p>We use cookies to improve user experience and store minimal user data for security.</p>
    <p>By clicking "Accept", you consent to our use of cookies and data storage as outlined in our privacy policy.</p>
    
    <button id="accept-cookies">Accept</button>
    <button id="revoke-consent">Revoke Consent</button>

    <script type="module">
        import CookieHandler from '/js/cookies.js';

        const cookieHandler = new CookieHandler();
        cookieHandler.setLanguage('pl'); // Example: Set language to Polish

        document.getElementById("accept-cookies").addEventListener("click", function () {
            cookieHandler.acceptConsent();
        });

        document.getElementById("revoke-consent").addEventListener("click", function () {
            cookieHandler.revokeConsent();
        });
    </script>
</body>
</html>
=== public/js/main.js ===
/**
 * CarFuse - Main JavaScript File
 * Central initialization and utility functions for the CarFuse application
 */

// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', () => {
    // Initialize components
    initializeComponents();
    
    // Set up event listeners
    setupEventListeners();
    
    // Handle responsive navigation
    setupResponsiveNavigation();
    
    // Initialize Tailwind components that need JavaScript
    initializeTailwindComponents();
});

/**
 * Initialize all JavaScript components
 */
function initializeComponents() {
    // Initialize HTMX extensions
    if (window.htmx) {
        // Add CSRF headers to all HTMX requests
        document.body.addEventListener('htmx:configRequest', (event) => {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (csrfToken) {
                event.detail.headers['X-CSRF-Token'] = csrfToken;
            }
            // Add X-Requested-With header for proper backend detection
            event.detail.headers['X-Requested-With'] = 'XMLHttpRequest';
        });
        
        // Handle HTMX responses with specific headers
        document.body.addEventListener('htmx:afterSwap', (event) => {
            // Check for toast messages in headers
            const toastTitle = event.detail.xhr.getResponseHeader('X-Toast-Title');
            const toastMessage = event.detail.xhr.getResponseHeader('X-Toast-Message');
            const toastType = event.detail.xhr.getResponseHeader('X-Toast-Type') || 'success';
            
            if (toastTitle && toastMessage) {
                showToast(toastTitle, toastMessage, toastType);
            }
            
            // Handle redirect headers
            const redirectTo = event.detail.xhr.getResponseHeader('X-Redirect-To');
            if (redirectTo) {
                window.location.href = redirectTo;
            }
        });
    }
    
    // Initialize cookie consent
    setupCookieConsent();
    
    // Global utilities
    window.CarFuse = {
        // Date formatting utilities
        formatDate: formatDate,
        formatDateTime: formatDateTime,
        
        // Currency formatting utilities
        formatCurrency: formatCurrency,
        
        // Toast system
        showToast: showToast,
        
        // Form utilities
        validateForm: validateForm,
        
        // Booking utilities
        calculateBookingPrice: calculateBookingPrice,
        
        // Payment utilities
        processPayment: processPayment,
        
        // Navigation utilities
        toggleMobileMenu: toggleMobileMenu
    };
}

/**
 * Set up global event listeners
 */
function setupEventListeners() {
    // Handle form submissions
    document.addEventListener('submit', (event) => {
        const form = event.target;
        
        // Skip if the form has htmx attributes or data-no-validate
        if (form.hasAttribute('hx-post') || 
            form.hasAttribute('hx-get') || 
            form.hasAttribute('data-no-validate')) {
            return;
        }
        
        // Check if the form needs validation
        if (form.hasAttribute('data-validate')) {
            event.preventDefault();
            
            if (validateForm(form)) {
                // Form is valid, submit it programmatically
                form.submit();
            }
        }
    });
    
    // Handle booking date selections
    document.querySelectorAll('.booking-date-picker').forEach(el => {
        el.addEventListener('change', updateBookingDetails);
    });
    
    // Handle payment method selections
    document.querySelectorAll('.payment-method-select').forEach(el => {
        el.addEventListener('change', handlePaymentMethodChange);
    });
}

/**
 * Handle responsive navigation menu
 */
function setupResponsiveNavigation() {
    const menuButton = document.getElementById('menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    
    if (menuButton && mobileMenu) {
        menuButton.addEventListener('click', () => {
            toggleMobileMenu(mobileMenu);
        });
        
        // Close mobile menu on window resize (if switching to desktop)
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768 && mobileMenu.classList.contains('block')) {
                mobileMenu.classList.remove('block');
                mobileMenu.classList.add('hidden');
            }
        });
        
        // Handle click outside to close menu
        document.addEventListener('click', (event) => {
            const isClickInside = menuButton.contains(event.target) || mobileMenu.contains(event.target);
            
            if (!isClickInside && mobileMenu.classList.contains('block')) {
                mobileMenu.classList.remove('block');
                mobileMenu.classList.add('hidden');
            }
        });
    }
}

/**
 * Toggle mobile navigation menu
 * @param {HTMLElement} mobileMenu - The mobile menu element
 */
function toggleMobileMenu(mobileMenu) {
    if (mobileMenu.classList.contains('hidden')) {
        mobileMenu.classList.remove('hidden');
        mobileMenu.classList.add('block');
    } else {
        mobileMenu.classList.remove('block');
        mobileMenu.classList.add('hidden');
    }
}

/**
 * Initialize Tailwind components that require JavaScript
 */
function initializeTailwindComponents() {
    // Initialize dropdowns
    document.querySelectorAll('[data-dropdown-toggle]').forEach(triggerEl => {
        const targetId = triggerEl.getAttribute('data-dropdown-toggle');
        const targetEl = document.getElementById(targetId);
        
        if (targetEl) {
            triggerEl.addEventListener('click', (e) => {
                e.preventDefault();
                targetEl.classList.toggle('hidden');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!targetEl.contains(e.target) && !triggerEl.contains(e.target)) {
                    targetEl.classList.add('hidden');
                }
            });
        }
    });
    
    // Initialize modals
    document.querySelectorAll('[data-modal-toggle]').forEach(triggerEl => {
        const targetId = triggerEl.getAttribute('data-modal-toggle');
        const targetEl = document.getElementById(targetId);
        const closeEls = targetEl?.querySelectorAll('[data-modal-close]');
        
        if (targetEl) {
            triggerEl.addEventListener('click', (e) => {
                e.preventDefault();
                targetEl.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            });
            
            // Add close functionality
            closeEls?.forEach(closeEl => {
                closeEl.addEventListener('click', () => {
                    targetEl.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                });
            });
            
            // Close on backdrop click if data attribute is present
            if (targetEl.hasAttribute('data-modal-backdrop')) {
                targetEl.addEventListener('click', (e) => {
                    if (e.target === targetEl) {
                        targetEl.classList.add('hidden');
                        document.body.classList.remove('overflow-hidden');
                    }
                });
            }
        }
    });
}

/**
 * Set up cookie consent banner
 */
function setupCookieConsent() {
    const cookieConsent = document.getElementById('cookie-consent-banner');
    const acceptButton = document.getElementById('accept-cookies');
    const declineButton = document.getElementById('decline-cookies');
    
    if (cookieConsent && !getCookie('cookie-consent')) {
        cookieConsent.classList.remove('hidden');
        
        if (acceptButton) {
            acceptButton.addEventListener('click', () => {
                setCookie('cookie-consent', 'accepted', 365);
                cookieConsent.classList.add('hidden');
            });
        }
        
        if (declineButton) {
            declineButton.addEventListener('click', () => {
                setCookie('cookie-consent', 'declined', 365);
                cookieConsent.classList.add('hidden');
            });
        }
    }
}

/**
 * Format date according to Polish locale
 * @param {string|Date} date - Date to format
 * @param {Object} options - Intl.DateTimeFormat options
 * @returns {string} Formatted date
 */
function formatDate(date, options = {}) {
    const defaultOptions = { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit' 
    };
    
    return new Intl.DateTimeFormat('pl-PL', { ...defaultOptions, ...options }).format(
        date instanceof Date ? date : new Date(date)
    );
}

/**
 * Format date and time according to Polish locale
 * @param {string|Date} date - Date to format
 * @returns {string} Formatted date and time
 */
function formatDateTime(date) {
    return formatDate(date, {
        hour: '2-digit',
        minute: '2-digit'
    });
}

/**
 * Format currency according to Polish locale
 * @param {number} amount - Amount to format
 * @param {string} currency - Currency code (default: PLN)
 * @returns {string} Formatted currency
 */
function formatCurrency(amount, currency = 'PLN') {
    return new Intl.NumberFormat('pl-PL', {
        style: 'currency',
        currency: currency
    }).format(amount);
}

/**
 * Show toast notification
 * @param {string} title - Toast title
 * @param {string} message - Toast message
 * @param {string} type - Toast type: success, error, warning, info
 */
function showToast(title, message, type = 'success') {
    // Check if we have Alpine.js toast system
    const toastSystem = document.querySelector('[x-data*="toastSystem"]');
    
    if (toastSystem && window.Alpine) {
        // Use Alpine.js toast system
        window.dispatchEvent(new CustomEvent('show-toast', {
            detail: { title, message, type }
        }));
    } else {
        // Fallback to simple toast implementation
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-md';
        
        // Apply styles based on type
        switch (type) {
            case 'success':
                toast.classList.add('bg-green-500', 'text-white');
                break;
            case 'error':
                toast.classList.add('bg-red-500', 'text-white');
                break;
            case 'warning':
                toast.classList.add('bg-yellow-500', 'text-white');
                break;
            case 'info':
                toast.classList.add('bg-blue-500', 'text-white');
                break;
        }
        
        // Create toast content
        toast.innerHTML = `
            <div class="flex items-center">
                <div class="flex-1">
                    <h3 class="font-medium">${title}</h3>
                    <p class="text-sm opacity-90">${message}</p>
                </div>
                <button class="ml-4 text-white" onclick="this.parentNode.parentNode.remove()">×</button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Remove after 5 seconds
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }
}

/**
 * Validate form based on data attributes
 * @param {HTMLFormElement} form - Form to validate
 * @returns {boolean} True if form is valid
 */
function validateForm(form) {
    // If we have Alpine.js form validation, use it
    if (window.Alpine && form._x_dataStack) {
        const validation = form._x_dataStack[0].validateForm?.(form);
        return validation !== false;
    }
    
    // Simple validation fallback
    let isValid = true;
    const fields = form.querySelectorAll('[data-validate]');
    
    fields.forEach(field => {
        const rules = field.dataset.validate.split('|');
        const value = field.value;
        let fieldValid = true;
        let errorMessage = '';
        
        // Reset field error state
        field.classList.remove('border-red-500');
        const errorEl = document.getElementById(`${field.name}-error`);
        if (errorEl) errorEl.textContent = '';
        
        // Process each validation rule
        for (const rule of rules) {
            if (!fieldValid) break; // Stop on first error
            
            if (rule === 'required' && (!value || value.trim() === '')) {
                fieldValid = false;
                errorMessage = 'To pole jest wymagane.';
            } else if (rule === 'email' && value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                fieldValid = false;
                errorMessage = 'Proszę podać prawidłowy adres email.';
            } else if (rule.startsWith('min:') && value) {
                const min = parseInt(rule.split(':')[1]);
                if (value.length < min) {
                    fieldValid = false;
                    errorMessage = `Wartość musi zawierać co najmniej ${min} znaków.`;
                }
            } else if (rule.startsWith('max:') && value) {
                const max = parseInt(rule.split(':')[1]);
                if (value.length > max) {
                    fieldValid = false;
                    errorMessage = `Wartość nie może przekraczać ${max} znaków.`;
                }
            } else if (rule === 'numeric' && value && !/^-?\d*\.?\d+$/.test(value)) {
                fieldValid = false;
                errorMessage = 'Proszę podać wartość liczbową.';
            } else if (rule === 'phone' && value && !/^(?:\+48|48)?[0-9]{9}$/.test(value.replace(/\s+/g, ''))) {
                fieldValid = false;
                errorMessage = 'Proszę podać prawidłowy numer telefonu.';
            }
        }
        
        // Mark field as invalid if needed
        if (!fieldValid) {
            isValid = false;
            field.classList.add('border-red-500');
            
            // Show error message
            if (!errorEl) {
                const newErrorEl = document.createElement('p');
                newErrorEl.id = `${field.name}-error`;
                newErrorEl.className = 'text-red-500 text-sm mt-1';
                field.parentNode.appendChild(newErrorEl);
                newErrorEl.textContent = errorMessage;
            } else {
                errorEl.textContent = errorMessage;
            }
        }
    });
    
    return isValid;
}

/**
 * Calculate booking price based on selected dates and car
 * @param {HTMLElement} form - Booking form element
 */
function updateBookingDetails() {
    const pickupDate = document.getElementById('pickup_date')?.value;
    const dropoffDate = document.getElementById('dropoff_date')?.value;
    const carId = document.getElementById('car_id')?.value;
    const pricePerDay = parseFloat(document.getElementById('price_per_day')?.value || 0);
    
    if (pickupDate && dropoffDate && pricePerDay > 0) {
        const startDate = new Date(pickupDate);
        const endDate = new Date(dropoffDate);
        
        // Check if dates are valid
        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
            return;
        }
        
        // Calculate days difference
        const diffTime = endDate - startDate;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 1;
        
        // Calculate total price
        const totalPrice = pricePerDay * diffDays;
        
        // Update UI elements
        const daysElement = document.getElementById('booking-days');
        const priceElement = document.getElementById('booking-price');
        
        if (daysElement) daysElement.textContent = diffDays;
        if (priceElement) priceElement.textContent = formatCurrency(totalPrice);
        
        // Update hidden input field for form submission
        const totalPriceInput = document.getElementById('total_price');
        if (totalPriceInput) totalPriceInput.value = totalPrice.toFixed(2);
        
        // Update rental period text summary
        const periodElement = document.getElementById('rental-period');
        if (periodElement) {
            periodElement.textContent = `${formatDate(startDate)} - ${formatDate(endDate)} (${diffDays} dni)`;
        }
    }
}

/**
 * Calculate booking total price
 * @param {Date} startDate - Pickup date
 * @param {Date} endDate - Dropoff date
 * @param {number} pricePerDay - Price per day
 * @returns {number} Total price
 */
function calculateBookingPrice(startDate, endDate, pricePerDay) {
    // Calculate days difference
    const diffTime = endDate - startDate;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 1;
    
    // Calculate total price
    return pricePerDay * diffDays;
}

/**
 * Handle payment method change
 * @param {Event} event - Change event
 */
function handlePaymentMethodChange(event) {
    const paymentMethod = event.target.value;
    const allPaymentDetails = document.querySelectorAll('.payment-details');
    
    // Hide all payment details sections
    allPaymentDetails.forEach(section => {
        section.classList.add('hidden');
    });
    
    // Show selected payment details
    const selectedDetails = document.getElementById(`${paymentMethod}-details`);
    if (selectedDetails) {
        selectedDetails.classList.remove('hidden');
    }
}

/**
 * Process payment
 * @param {string} paymentMethod - Payment method
 * @param {Object} paymentData - Payment data
 * @returns {Promise} Payment result promise
 */
function processPayment(paymentMethod, paymentData) {
    return new Promise((resolve, reject) => {
        // Simulate API call
        fetch('/api/payment/process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
            },
            body: JSON.stringify({
                method: paymentMethod,
                data: paymentData
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Payment processing failed');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                resolve(data);
            } else {
                reject(new Error(data.message || 'Payment processing failed'));
            }
        })
        .catch(error => {
            reject(error);
        });
    });
}

/**
 * Helper to set a cookie
 * @param {string} name - Cookie name
 * @param {string} value - Cookie value
 * @param {number} days - Days until expiration
 */
function setCookie(name, value, days) {
    let expires = '';
    
    if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = '; expires=' + date.toUTCString();
    }
    
    document.cookie = name + '=' + (value || '') + expires + '; path=/; SameSite=Lax';
}

/**
 * Helper to get a cookie
 * @param {string} name - Cookie name
 * @returns {string|null} Cookie value or null
 */
function getCookie(name) {
    const nameEQ = name + '=';
    const ca = document.cookie.split(';');
    
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    
    return null;
}
=== public/js/cookies.js ===
class CookieHandler {
    constructor(options = {}) {
        this.options = {
            secure: true, // Default to secure cookies
            httpOnly: true, // Default to HttpOnly cookies
            path: '/',
            domain: null,
            expires: 365, // Default expiration of 365 days
            ...options
        };
        this.consentCookieName = 'cookie_consent';
        this.userPreferencesCookieName = 'user_preferences';
        this.translations = {
            'en': {
                'consentAccepted': 'Consent accepted.',
                'consentRevoked': 'Consent revoked. Some site features may be disabled.'
            },
            'pl': {
                'consentAccepted': 'Zgoda zaakceptowana.',
                'consentRevoked': 'Zgoda cofnięta. Niektóre funkcje strony mogą być wyłączone.'
            }
        };
        this.currentLanguage = 'en'; // Default language
    }

    setLanguage(lang) {
        this.currentLanguage = lang;
    }

    getTranslation(key) {
        return this.translations[this.currentLanguage][key] || this.translations['en'][key] || key;
    }

    setCookie(name, value, options = {}) {
        let cookieString = `${name}=${value}; path=${this.options.path}`;

        if (options.expires || this.options.expires) {
            const days = options.expires || this.options.expires;
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            cookieString += `; expires=${date.toUTCString()}`;
        }

        if (this.options.domain) {
            cookieString += `; domain=${this.options.domain}`;
        }

        if (this.options.secure) {
            cookieString += '; secure';
        }

        if (this.options.httpOnly) {
            cookieString += '; HttpOnly';
        }

        document.cookie = cookieString;
    }

    getCookie(name) {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            let cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.startsWith(name + '=')) {
                return cookie.substring(name.length + 1);
            }
        }
        return null;
    }

    deleteCookie(name) {
        document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${this.options.path}`;
    }

    hasConsent() {
        return this.getCookie(this.consentCookieName) === 'true';
    }

    acceptConsent() {
        return fetch("/api/consent/accept.php", { method: "POST" })
            .then(() => {
                this.setCookie(this.consentCookieName, 'true', { expires: 365 });
                alert(this.getTranslation('consentAccepted'));
            });
    }

    revokeConsent() {
        return fetch("/api/consent/revoke.php", { method: "POST" })
            .then(() => {
                this.deleteCookie(this.consentCookieName);
                alert(this.getTranslation('consentRevoked'));
            });
    }

    setUserPreferences(preferences) {
        this.setCookie(this.userPreferencesCookieName, JSON.stringify(preferences), { expires: 365 });
    }

    getUserPreferences() {
        const prefs = this.getCookie(this.userPreferencesCookieName);
        return prefs ? JSON.parse(prefs) : {};
    }
}

// Export the CookieHandler class so it can be imported in other files
export default CookieHandler;
=== public/js/htmx.js ===
/**
 * CarFuse HTMX Extensions
 * Extends HTMX with custom functionality for CarFuse car rental platform
 * 
 * This file should be loaded after the main HTMX library.
 */

(function() {
    // Make sure HTMX is loaded
    if (typeof htmx === 'undefined') {
        console.error('HTMX library not found. Please load htmx.org before this script.');
        return;
    }
    
    // 1. Global HTMX Configuration
    htmx.config.defaultSwapStyle = 'transition:opacity 150ms';
    htmx.config.defaultSwapDelay = 0;
    htmx.config.globalViewTransitions = true;
    htmx.config.refreshOnHistoryMiss = true;
    htmx.config.allowEval = false; // For security
    htmx.config.allowScriptTags = false; // For security
    htmx.config.historyCacheSize = 10;
    htmx.config.methodsThatUseUrlParams = ['get'];
    
    // Default timeouts
    htmx.config.timeout = 20000; // 20 seconds
    htmx.config.wsReconnectDelay = 2000; // 2 seconds
    
    // 2. CSRF Token Handling
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    
    if (csrfToken) {
        // Add CSRF token to all HTMX requests
        document.body.addEventListener('htmx:configRequest', function(event) {
            event.detail.headers['X-CSRF-Token'] = csrfToken;
        });
    } else {
        console.warn('CSRF token not found. CSRF protection is not active for HTMX requests.');
    }
    
    // 3. Custom Events for CarFuse
    
    // Booking events
    htmx.defineExtension('carfuse-booking', {
        onEvent: function(name, event) {
            if (name === 'htmx:afterSwap' && event.detail.target.id === 'booking-form-container') {
                // Initialize date pickers after booking form is loaded
                if (typeof initDateRangePickers === 'function') {
                    initDateRangePickers();
                }
            }
            
            if (name === 'htmx:afterRequest' && event.detail.pathInfo.requestPath.includes('/booking/create')) {
                // After booking creation, show confirmation
                if (event.detail.successful) {
                    document.dispatchEvent(new CustomEvent('show-toast', {
                        detail: {
                            title: 'Sukces',
                            message: 'Rezerwacja została utworzona pomyślnie.',
                            type: 'success'
                        }
                    }));
                }
            }
        }
    });
    
    // Payment events
    htmx.defineExtension('carfuse-payment', {
        onEvent: function(name, event) {
            if (name === 'htmx:afterRequest' && event.detail.pathInfo.requestPath.includes('/payments/')) {
                const xhr = event.detail.xhr;
                
                try {
                    // Try to parse response as JSON
                    const contentType = xhr.getResponseHeader('Content-Type');
                    if (contentType && contentType.includes('application/json')) {
                        const response = JSON.parse(xhr.responseText);
                        
                        // Handle payment gateway redirects
                        if (response.redirect_url) {
                            window.location.href = response.redirect_url;
                        }
                        
                        // Handle payment confirmation
                        if (response.status === 'success' && response.payment_confirmed) {
                            document.dispatchEvent(new CustomEvent('show-toast', {
                                detail: {
                                    title: 'Płatność zatwierdzona',
                                    message: 'Twoja płatność została pomyślnie zatwierdzona.',
                                    type: 'success'
                                }
                            }));
                        }
                    }
                } catch (e) {
                    // Not JSON response or error parsing, normal HTML swap will occur
                    console.error('Error parsing JSON from payment response', e);
                }
            }
        }
    });
    
    // 4. Custom Swap Strategies
    
    // Fade in/out swap
    htmx.defineExtension('fade-swap', {
        onEvent: function(name, event) {
            if (name === 'htmx:beforeSwap') {
                const target = event.detail.target;
                
                // Add fade-out class to target before swap
                target.classList.add('opacity-0');
                target.classList.add('transition-opacity');
                
                // Delay the swap slightly to allow for animation
                event.detail.shouldSwap = false;
                setTimeout(function() {
                    event.detail.shouldSwap = true;
                    htmx.swap(event.detail.target, event.detail.serverResponse, event.detail);
                    
                    // Fade in after swap
                    setTimeout(function() {
                        target.classList.remove('opacity-0');
                    }, 50);
                }, 200);
            }
        }
    });
    
    // Form validation swap that preserves errors
    htmx.defineExtension('preserve-validation', {
        onEvent: function(name, event) {
            if (name === 'htmx:beforeSwap' && event.detail.isError) {
                // Store the current form values
                const form = event.detail.requestConfig.elt;
                if (form.tagName === 'FORM') {
                    const formData = new FormData(form);
                    const formValues = Object.fromEntries(formData.entries());
                    
                    // After swap, restore form values
                    setTimeout(function() {
                        for (const [name, value] of Object.entries(formValues)) {
                            const input = form.querySelector(`[name="${name}"]`);
                            if (input) {
                                input.value = value;
                            }
                        }
                    }, 0);
                }
            }
        }
    });
    
    // 5. Loading Indicators with Polish Messages
    
    // Global loading indicators
    htmx.defineExtension('polish-indicators', {
        onEvent: function(name, event) {
            // Generate loading indicator if needed
            if (name === 'htmx:beforeRequest') {
                const target = event.detail.target;
                
                // Check if target already has an indicator
                if (!target.querySelector('.htmx-indicator')) {
                    const pathInfo = event.detail.pathInfo;
                    let message = 'Ładowanie...';
                    
                    // Customize message based on the request type
                    if (pathInfo.requestPath.includes('/booking/')) {
                        message = 'Trwa przetwarzanie rezerwacji...';
                    } else if (pathInfo.requestPath.includes('/payments/')) {
                        message = 'Przetwarzanie płatności...';
                    } else if (pathInfo.requestPath.includes('/search')) {
                        message = 'Wyszukiwanie...';
                    }
                    
                    const indicator = document.createElement('div');
                    indicator.className = 'htmx-indicator flex items-center justify-center p-4';
                    indicator.innerHTML = `
                        <svg class="animate-spin h-5 w-5 text-blue-500 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>${message}</span>
                    `;
                    
                    // Insert indicator
                    if (event.detail.elt.tagName === 'FORM') {
                        // For forms, append to end of form
                        event.detail.elt.appendChild(indicator);
                    } else {
                        // For other elements, insert after the element
                        target.parentNode.insertBefore(indicator, target.nextSibling);
                    }
                }
            }
        }
    });
    
    // 6. Authentication Token Refresh
    
    // Session timeout handling
    htmx.defineExtension('auth-refresh', {
        onEvent: function(name, event) {
            if (name === 'htmx:beforeRequest') {
                // Check if session is about to expire
                const sessionExpiresAt = parseInt(localStorage.getItem('session_expires_at') || '0', 10);
                const currentTime = Math.floor(Date.now() / 1000);
                const refreshThreshold = 300; // 5 minutes before expiry
                
                if (sessionExpiresAt > 0 && (sessionExpiresAt - currentTime) < refreshThreshold) {
                    // Session is about to expire, refresh it
                    fetch('/auth/refresh-token', {
                        method: 'POST',
                        headers: {
                            'X-CSRF-Token': csrfToken,
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update session expiry time
                            localStorage.setItem('session_expires_at', data.expires_at);
                            
                            // Continue with the original request
                            event.detail.xhr.send();
                        }
                    })
                    .catch(error => {
                        console.error('Error refreshing auth token:', error);
                        
                        // If refresh fails but user is still active, try to continue
                        event.detail.xhr.send();
                    });
                    
                    // Prevent the original request from proceeding until token refresh completes
                    event.detail.shouldCancel = true;
                }
            }
        }
    });
    
    // 7. Error Handling
    
    // Handle failed HTMX requests
    document.body.addEventListener('htmx:responseError', function(event) {
        const xhr = event.detail.xhr;
        const target = event.detail.target;
        
        let errorMessage = 'Wystąpił błąd podczas przetwarzania żądania.';
        
        // Try to extract error message from response
        try {
            const response = JSON.parse(xhr.responseText);
            if (response.message) {
                errorMessage = response.message;
            }
        } catch (e) {
            // Not JSON, set error based on status code
            if (xhr.status === 401 || xhr.status === 403) {
                errorMessage = 'Nie masz uprawnień do wykonania tej akcji. Zaloguj się ponownie.';
                
                // Redirect to login after a delay
                setTimeout(() => {
                    window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                }, 3000);
            } else if (xhr.status === 404) {
                errorMessage = 'Żądany zasób nie został znaleziony.';
            } else if (xhr.status === 422) {
                errorMessage = 'Przesłane dane są nieprawidłowe.';
            } else if (xhr.status === 500) {
                errorMessage = 'Wystąpił wewnętrzny błąd serwera. Spróbuj ponownie później.';
            } else if (xhr.status === 504 || xhr.status === 0) {
                errorMessage = 'Brak połączenia z serwerem. Sprawdź swoje połączenie internetowe.';
            }
        }
        
        // Show error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4';
        errorDiv.innerHTML = `
            <strong class="font-bold">Błąd!</strong>
            <span>${errorMessage}</span>
        `;
        
        // Insert error message at the top of the target
        if (target) {
            target.insertBefore(errorDiv, target.firstChild);
        } else {
            // If no target, display a global error
            document.body.prepend(errorDiv);
        }
    });
    
    // 8. Helper Functions for Booking and Payment Systems
    
    // Booking system helpers
    window.bookingHelpers = {
        showBookingDetails: function(bookingId) {
            // Function to show booking details
            htmx.ajax('GET', `/booking/${bookingId}/details`, {
                target: '#booking-details-modal',
                swap: 'innerHTML'
            });
        },
        
        cancelBooking: function(bookingId) {
            // Function to cancel a booking
            if (confirm('Czy na pewno chcesz anulować tę rezerwację?')) {
                htmx.ajax('POST', `/booking/${bookingId}/cancel`, {
                    target: '#booking-list',
                    swap: 'outerHTML'
                });
            }
        }
    };
    
    // Payment system helpers
    window.paymentHelpers = {
        showPaymentDetails: function(paymentId) {
            // Function to show payment details
            htmx.ajax('GET', `/payments/${paymentId}/details`, {
                target: '#payment-details-modal',
                swap: 'innerHTML'
            });
        },
        
        refundPayment: function(paymentId) {
            // Function to refund a payment
            if (confirm('Czy na pewno chcesz zwrócić tę płatność?')) {
                htmx.ajax('POST', `/payments/${paymentId}/refund`, {
                    target: '#payment-list',
                    swap: 'outerHTML'
                });
            }
        }
    };
    
    // Apply extensions
    htmx.use('carfuse-booking');
    htmx.use('carfuse-payment');
    htmx.use('fade-swap');
    htmx.use('preserve-validation');
    htmx.use('polish-indicators');
    htmx.use('auth-refresh');
})();
=== public/js/alpine-components/accessibility.js ===
/**
 * CarFuse Alpine.js Accessibility Enhancements
 * Keyboard navigation utilities
 */

document.addEventListener('alpine:init', () => {
    // Keyboard navigation utilities
    Alpine.data('keyboardNav', () => ({
        // Add keyboard navigation to a list of items
        initKeyboardNav(selector, options = {}) {
            const container = options.container || this.$el;
            const items = container.querySelectorAll(selector);
            
            items.forEach((item, index) => {
                item.setAttribute('tabindex', '0');
                
                item.addEventListener('keydown', (e) => {
                    const lastIndex = items.length - 1;
                    let nextIndex = null;
                    
                    switch(e.key) {
                        case 'ArrowDown':
                            nextIndex = index < lastIndex ? index + 1 : 0;
                            e.preventDefault();
                            break;
                        case 'ArrowUp':
                            nextIndex = index > 0 ? index - 1 : lastIndex;
                            e.preventDefault();
                            break;
                        case 'Home':
                            nextIndex = 0;
                            e.preventDefault();
                            break;
                        case 'End':
                            nextIndex = lastIndex;
                            e.preventDefault();
                            break;
                    }
                    
                    if (nextIndex !== null) {
                        items[nextIndex].focus();
                    }
                });
            });
        }
    }));
});
=== public/js/alpine-components/data.js ===
/**
 * CarFuse Alpine.js Data Patterns
 * Reusable data patterns for bookings, users, and payments
 */

document.addEventListener('alpine:init', () => {
    // User Management Component
    Alpine.data('userManagement', () => ({
        users: [],
        currentPage: 1,
        totalPages: 1,
        totalItems: 0,
        itemsPerPage: 10,
        filterRole: 'all',
        filterStatus: 'all',
        searchQuery: '',
        loading: false,
        showNewUserModal: false,
        showPassword: false,
        newUser: {
            name: '',
            surname: '',
            email: '',
            password: '',
            role: 'user'
        },
        isSubmitting: false,
        
        init() {
            this.loadUsers();
        },
        
        get startItem() {
            return Math.min((this.currentPage - 1) * this.itemsPerPage + 1, this.totalItems);
        },
        
        get endItem() {
            return Math.min(this.currentPage * this.itemsPerPage, this.totalItems);
        },
        
        loadUsers() {
            this.loading = true;
            
            // Prepare URL with query parameters
            const params = new URLSearchParams({
                page: this.currentPage,
                role: this.filterRole,
                status: this.filterStatus,
                search: this.searchQuery
            });
            
            // Use HTMX to load users
            htmx.ajax('GET', `/admin/api/users?${params.toString()}`, {
                target: '#users-container',
                swap: 'innerHTML',
                headers: {
                    'HX-Request': 'true'
                }
            }).then((response) => {
                this.loading = false;
                
                // Check response headers for pagination data
                const paginationData = JSON.parse(response.headers.get('X-Pagination') || '{}');
                
                if (paginationData) {
                    this.totalPages = paginationData.totalPages || 1;
                    this.totalItems = paginationData.totalItems || 0;
                }
                
                // Show or hide "no users" message
                const hasUsers = document.querySelectorAll('#users-container tr').length > 0;
                document.getElementById('no-users-message')?.classList.toggle('hidden', hasUsers);
            }).catch(() => {
                this.loading = false;
                // Dispatch toast event
                window.dispatchEvent(new CustomEvent('show-toast', {
                    detail: { title: 'Błąd', message: 'Wystąpił błąd podczas ładowania listy użytkowników.', type: 'error' }
                }));
            });
        },
        
        reloadUserList() {
            this.loadUsers();
        },
        
        nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                this.loadUsers();
            }
        },
        
        prevPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.loadUsers();
            }
        },
    }));
    
    // Booking Management Component
    Alpine.data('bookingManagement', () => ({
        bookings: [],
        currentPage: 1,
        totalPages: 1,
        itemsPerPage: 10,
        filterStatus: 'all',
        searchQuery: '',
        fromDate: '',
        toDate: '',
        loading: false,
        showDetails: {},
        
        init() {
            this.loadBookings();
        },
        
        loadBookings() {
            this.loading = true;
            
            // Prepare URL with query parameters
            const params = new URLSearchParams({
                page: this.currentPage,
                status: this.filterStatus,
                search: this.searchQuery,
                from_date: this.fromDate,
                to_date: this.toDate
            });
            
            fetch(`/api/bookings?${params.toString()}`)
                .then(response => {
                    // Get pagination info from headers
                    const totalPages = parseInt(response.headers.get('X-Total-Pages') || '1');
                    
                    return response.json().then(data => {
                        this.totalPages = totalPages;
                        return data;
                    });
                })
                .then(data => {
                    this.bookings = data.bookings;
                    this.loading = false;
                })
                .catch(error => {
                    console.error('Error loading bookings:', error);
                    this.loading = false;
                    // Dispatch toast event
                    window.dispatchEvent(new CustomEvent('show-toast', {
                        detail: { title: 'Błąd', message: 'Wystąpił błąd podczas ładowania rezerwacji.', type: 'error' }
                    }));
                });
        },
        
        toggleDetails(id) {
            this.showDetails = {
                ...this.showDetails,
                [id]: !this.showDetails[id]
            };
        },
        
        nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                this.loadBookings();
            }
        },
        
        prevPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.loadBookings();
            }
        },
        
        getStatusClass(status) {
            const statusClasses = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'confirmed': 'bg-blue-100 text-blue-800',
                'active': 'bg-green-100 text-green-800',
                'completed': 'bg-purple-100 text-purple-800',
                'canceled': 'bg-red-100 text-red-800'
            };
            
            return statusClasses[status] || 'bg-gray-100 text-gray-800';
        },
        
        formatDate(dateString) {
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('pl-PL', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        },
        
        formatCurrency(amount) {
            return new Intl.NumberFormat('pl-PL', {
                style: 'currency',
                currency: 'PLN'
            }).format(amount);
        }
    }));
    
    // Payment Processing Component
    Alpine.data('paymentSystem', () => ({
        currentPage: 1,
        limit: 10, 
        type: 'all', 
        sortBy: 'date', 
        sortDir: 'desc',
        loading: false,
        showDetails: false,
        selectedTransaction: null,
        
        fetchTransactions() {
            this.loading = true;
            
            const url = '/payment/transactions';
            const params = new URLSearchParams({
                page: this.currentPage,
                limit: this.limit,
                type: this.type,
                sort_by: this.sortBy,
                sort_dir: this.sortDir
            });
            
            htmx.ajax('GET', `${url}?${params.toString()}`, {
                target: '#transactions-list',
                swap: 'innerHTML',
                headers: {
                    'HX-Request': 'true'
                }
            }).then(() => {
                this.loading = false;
                
                // Show no transactions message if needed
                const transactionItems = document.querySelectorAll('#transactions-list .transaction-row');
                if (transactionItems.length === 0) {
                    document.getElementById('no-transactions')?.classList.remove('hidden');
                } else {
                    document.getElementById('no-transactions')?.classList.add('hidden');
                }
            });
        },
        
        viewTransactionDetails(transactionId) {
            this.loading = true;
            
            fetch(`/payment/${transactionId}/details`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        this.selectedTransaction = data.data.details;
                        this.showDetails = true;
                    } else {
                        // Dispatch toast event
                        window.dispatchEvent(new CustomEvent('show-toast', {
                            detail: { title: 'Błąd', message: 'Nie udało się pobrać szczegółów transakcji: ' + data.message, type: 'error' }
                        }));
                    }
                    this.loading = false;
                })
                .catch(error => {
                    console.error('Error fetching transaction details:', error);
                    // Dispatch toast event
                    window.dispatchEvent(new CustomEvent('show-toast', {
                        detail: { title: 'Błąd', message: 'Wystąpił błąd podczas pobierania szczegółów transakcji.', type: 'error' }
                    }));
                    this.loading = false;
                });
        }
    }));
});
=== public/js/alpine-components/form.js ===
/**
 * CarFuse Alpine.js Form Utilities
 * Form handling and validation
 */

document.addEventListener('alpine:init', () => {
    // Form Validation System
    Alpine.data('formValidation', () => ({
        errors: {},
        isSubmitting: false,
        
        // Polish language validation messages
        validationMessages: {
            required: 'To pole jest wymagane.',
            email: 'Proszę podać prawidłowy adres email.',
            min: 'Wartość musi zawierać co najmniej {min} znaków.',
            max: 'Wartość nie może przekraczać {max} znaków.',
            minValue: 'Wartość musi być większa lub równa {min}.',
            maxValue: 'Wartość musi być mniejsza lub równa {max}.',
            pattern: 'Proszę podać wartość w prawidłowym formacie.',
            numeric: 'Proszę podać wartość liczbową.',
            integer: 'Proszę podać liczbę całkowitą.',
            phoneNumber: 'Proszę podać prawidłowy numer telefonu.',
            postalCode: 'Proszę podać prawidłowy kod pocztowy.',
            passwordMatch: 'Hasła muszą być identyczne.',
            pesel: 'Podany numer PESEL jest nieprawidłowy.',
            nip: 'Podany numer NIP jest nieprawidłowy.',
            regon: 'Podany numer REGON jest nieprawidłowy.',
            date: 'Proszę podać prawidłową datę.',
            futureDate: 'Data musi być w przyszłości.',
            pastDate: 'Data musi być w przeszłości.'
        },
        
        // Validation rules
        validateField(field, value, rules) {
            let error = '';
            
            // Process each validation rule
            for (const rule of rules.split('|')) {
                if (error) break; // Stop on first error
                
                const [ruleName, ruleValue] = rule.includes(':') 
                    ? rule.split(':') 
                    : [rule, null];
                
                switch (ruleName) {
                    case 'required':
                        if (!value || (typeof value === 'string' && value.trim() === '')) {
                            error = this.validationMessages.required;
                        }
                        break;
                        
                    case 'email':
                        if (value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                            error = this.validationMessages.email;
                        }
                        break;
                        
                    case 'min':
                        if (value && value.length < parseInt(ruleValue)) {
                            error = this.validationMessages.min.replace('{min}', ruleValue);
                        }
                        break;
                        
                    case 'max':
                        if (value && value.length > parseInt(ruleValue)) {
                            error = this.validationMessages.max.replace('{max}', ruleValue);
                        }
                        break;
                        
                    case 'numeric':
                        if (value && !/^-?\d*\.?\d+$/.test(value)) {
                            error = this.validationMessages.numeric;
                        }
                        break;
                        
                    case 'integer':
                        if (value && !/^-?\d+$/.test(value)) {
                            error = this.validationMessages.integer;
                        }
                        break;
                        
                    case 'phone':
                        // Polish phone number format validation
                        if (value && !/^(?:\+48|48)?[0-9]{9}$/.test(value.replace(/\s+/g, ''))) {
                            error = this.validationMessages.phoneNumber;
                        }
                        break;
                        
                    case 'postalCode':
                        // Polish postal code format (XX-XXX)
                        if (value && !/^\d{2}-\d{3}$/.test(value)) {
                            error = this.validationMessages.postalCode;
                        }
                        break;
                        
                    case 'pesel':
                        // Basic PESEL validation (more complex validation could be added)
                        if (value && (!/^\d{11}$/.test(value))) {
                            error = this.validationMessages.pesel;
                        }
                        break;
                        
                    case 'date':
                        // Check if valid date
                        if (value) {
                            const date = new Date(value);
                            if (isNaN(date.getTime())) {
                                error = this.validationMessages.date;
                            }
                        }
                        break;
                        
                    case 'futureDate':
                        // Check if date is in the future
                        if (value) {
                            const date = new Date(value);
                            const now = new Date();
                            if (!isNaN(date.getTime()) && date <= now) {
                                error = this.validationMessages.futureDate;
                            }
                        }
                        break;
                }
            }
            
            // Update errors object
            if (error) {
                this.errors[field] = error;
                return false;
            } else {
                delete this.errors[field];
                return true;
            }
        },
        
        // Validate the entire form
        validateForm(form) {
            let isValid = true;
            
            // Get all form elements with data-validate attribute
            const fields = form.querySelectorAll('[data-validate]');
            
            fields.forEach(field => {
                const rules = field.dataset.validate;
                const value = field.value;
                const name = field.name;
                
                // Validate each field
                if (!this.validateField(name, value, rules)) {
                    isValid = false;
                }
            });
            
            return isValid;
        },
        
        // Handle form submission with validation
        handleSubmit(form, successCallback, errorCallback) {
            // Reset form state
            this.isSubmitting = true;
            this.errors = {};
            
            // Validate form
            if (!this.validateForm(form)) {
                this.isSubmitting = false;
                if (errorCallback) errorCallback(this.errors);
                return;
            }
            
            // Add CSRF token if needed
            if (window.csrfHandler) {
                window.csrfHandler.addCsrfToForm(form);
            }
            
            // Submit form via fetch
            const formData = new FormData(form);
            const url = form.action;
            const method = form.method.toUpperCase() || 'POST';
            
            fetch(url, {
                method,
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw response;
                }
                return response.json();
            })
            .then(data => {
                this.isSubmitting = false;
                if (successCallback) successCallback(data);
            })
            .catch(async error => {
                this.isSubmitting = false;
                
                try {
                    // Try to parse validation errors from response
                    const data = await error.json();
                    
                    if (data.errors) {
                        // Laravel/API style validation errors
                        this.errors = data.errors;
                    } else if (data.message) {
                        // Set general error message
                        this.errors._general = data.message;
                    }
                } catch (e) {
                    // Generic error
                    this.errors._general = 'Wystąpił błąd podczas przetwarzania żądania.';
                }
                
                if (errorCallback) errorCallback(this.errors);
            });
        }
    }));
});
=== public/js/alpine-components/ui.js ===
/**
 * CarFuse Alpine.js UI Components
 * Common UI components (modals, dropdowns, tabs)
 */

document.addEventListener('alpine:init', () => {
    // Modal Dialog Component
    Alpine.data('modal', (options = {}) => ({
        isOpen: false,
        title: options.title || '',
        showCloseButton: options.showCloseButton !== false,
        escToClose: options.escToClose !== false,
        clickOutsideToClose: options.clickOutsideToClose !== false,
        size: options.size || 'md', // sm, md, lg, xl, or full
        
        // Map sizes to Tailwind classes
        sizeClasses: {
            sm: 'max-w-md',
            md: 'max-w-lg',
            lg: 'max-w-2xl',
            xl: 'max-w-4xl',
            full: 'max-w-full mx-4'
        },
        
        init() {
            // Setup event listeners
            if (this.escToClose) {
                window.addEventListener('keydown', e => {
                    if (this.isOpen && e.key === 'Escape') {
                        this.close();
                    }
                });
            }
            
            // Register a global modal event listener
            window.addEventListener('open-modal', e => {
                if (e.detail.id === this.$el.id) {
                    this.open(e.detail.data);
                }
            });
            
            window.addEventListener('close-modal', e => {
                if (!e.detail.id || e.detail.id === this.$el.id) {
                    this.close();
                }
            });
        },
        
        getSizeClass() {
            return this.sizeClasses[this.size] || this.sizeClasses.md;
        },
        
        open(data) {
            // Trigger an event that can be captured by parent components
            this.$dispatch('modal-opening', { id: this.$el.id, data });
            this.isOpen = true;
            document.body.classList.add('overflow-hidden');
            
            // Focus the first focusable element in the modal
            this.$nextTick(() => {
                const focusable = this.$el.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (focusable.length > 0) {
                    focusable[0].focus();
                }
                
                this.$dispatch('modal-opened', { id: this.$el.id, data });
            });
        },
        
        close() {
            // Trigger an event that can be captured by parent components
            this.$dispatch('modal-closing', { id: this.$el.id });
            this.isOpen = false;
            document.body.classList.remove('overflow-hidden');
            
            this.$nextTick(() => {
                this.$dispatch('modal-closed', { id: this.$el.id });
            });
        },
        
        handleBackdropClick(e) {
            if (this.clickOutsideToClose && e.target === e.currentTarget) {
                this.close();
            }
        }
    }));
    
    // Dropdown Component
    Alpine.data('dropdown', (options = {}) => ({
        open: false,
        position: options.position || 'bottom-right', // top-left, top-right, bottom-left, bottom-right
        
        init() {
            // Close dropdown on outside click
            document.addEventListener('click', (e) => {
                if (this.open && !this.$el.contains(e.target)) {
                    this.open = false;
                }
            });
            
            // Close dropdown on escape key
            window.addEventListener('keydown', (e) => {
                if (this.open && e.key === 'Escape') {
                    this.open = false;
                    e.preventDefault();
                }
            });
        },
        
        toggle() {
            this.open = !this.open;
            
            if (this.open) {
                this.$nextTick(() => {
                    // Focus the first focusable element in the dropdown
                    const focusable = this.$refs.panel.querySelectorAll('a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (focusable.length > 0) {
                        focusable[0].focus();
                    }
                });
            }
        },
        
        positionClass() {
            const positions = {
                'top-left': 'bottom-full right-0 mb-2',
                'top-right': 'bottom-full left-0 mb-2',
                'bottom-left': 'top-full right-0 mt-2',
                'bottom-right': 'top-full left-0 mt-2'
            };
            return positions[this.position] || positions['bottom-right'];
        }
    }));
    
    // Tabs Component
    Alpine.data('tabs', (options = {}) => ({
        activeTab: options.defaultTab || null,
        tabs: [],
        
        init() {
            // Find tabs from DOM if not provided
            if (!this.tabs.length) {
                const tabElements = this.$el.querySelectorAll('[x-tab]');
                this.tabs = Array.from(tabElements).map(el => el.getAttribute('x-tab'));
            }
            
            // Set initial active tab
            if (!this.activeTab && this.tabs.length) {
                this.activeTab = this.tabs[0];
            }
            
            // Check URL hash for tab
            const hash = window.location.hash.substring(1);
            if (hash && this.tabs.includes(hash)) {
                this.activeTab = hash;
            }
            
            // Handle keyboard navigation
            this.$watch('activeTab', value => {
                // Update URL hash if needed
                if (options.updateHash) {
                    window.location.hash = value;
                }
                
                // Focus the active tab
                this.$nextTick(() => {
                    const activeTabElement = this.$el.querySelector(`[x-tab="${value}"]`);
                    if (activeTabElement) {
                        activeTabElement.focus();
                    }
                });
            });
        },
        
        setActiveTab(tab) {
            this.activeTab = tab;
        },
        
        handleKeyDown(event, currentIndex) {
            const lastIndex = this.tabs.length - 1;
            
            switch(event.key) {
                case 'ArrowRight':
                case 'ArrowDown':
                    this.setActiveTab(this.tabs[(currentIndex + 1) % this.tabs.length]);
                    event.preventDefault();
                    break;
                case 'ArrowLeft':
                case 'ArrowUp':
                    this.setActiveTab(this.tabs[currentIndex === 0 ? lastIndex : currentIndex - 1]);
                    event.preventDefault();
                    break;
                case 'Home':
                    this.setActiveTab(this.tabs[0]);
                    event.preventDefault();
                    break;
                case 'End':
                    this.setActiveTab(this.tabs[lastIndex]);
                    event.preventDefault();
                    break;
            }
        }
    }));
});
=== public/js/alpine-components/core.js ===
/**
 * CarFuse Alpine.js Core Utilities
 * CSRF handling and toast notifications
 */

document.addEventListener('alpine:init', () => {
    // CSRF Token Handling
    Alpine.data('csrfHandler', () => ({
        csrfToken: document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '',
        
        // Add CSRF token to fetch requests
        fetchWithCsrf(url, options = {}) {
            const headers = options.headers || {};
            
            return fetch(url, {
                ...options,
                headers: {
                    ...headers,
                    'X-CSRF-Token': this.csrfToken,
                    'Content-Type': headers['Content-Type'] || 'application/json'
                }
            });
        },
        
        // Add CSRF token to forms
        addCsrfToForm(form) {
            if (!form.querySelector('input[name="_token"]')) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_token';
                csrfInput.value = this.csrfToken;
                form.appendChild(csrfInput);
            }
        }
    }));
    
    // Toast Notification System
    Alpine.data('toastSystem', () => ({
        toasts: [],
        toastIdCounter: 0,
        
        showToast(title, message, type = 'success', duration = 3000) {
            const id = ++this.toastIdCounter;
            
            // Define toast types and their styles
            const types = {
                success: {
                    bgColor: 'bg-green-600',
                    icon: '<svg class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                },
                error: {
                    bgColor: 'bg-red-600',
                    icon: '<svg class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>'
                },
                warning: {
                    bgColor: 'bg-yellow-500',
                    icon: '<svg class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>'
                },
                info: {
                    bgColor: 'bg-blue-600',
                    icon: '<svg class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                }
            };
            
            const toast = {
                id,
                title,
                message,
                type,
                bgColor: types[type]?.bgColor || types.info.bgColor,
                icon: types[type]?.icon || types.info.icon
            };
            
            this.toasts.push(toast);
            
            // Auto remove toast after duration
            setTimeout(() => {
                this.removeToast(id);
            }, duration);
            
            return id;
        },
        
        removeToast(id) {
            const index = this.toasts.findIndex(toast => toast.id === id);
            if (index !== -1) {
                this.toasts.splice(index, 1);
            }
        }
    }));
});
=== public/js/alpine.js ===
/**
 * CarFuse Alpine.js Components
 * Centralized Alpine.js components and utilities for use across the application
 */

import './alpine-components/core.js';
import './alpine-components/form.js';
import './alpine-components/ui.js';
import './alpine-components/data.js';
import './alpine-components/accessibility.js';

// Global toast listener
document.addEventListener('alpine:init', () => {
    window.addEventListener('show-toast', event => {
        const { title, message, type } = event.detail;
        
        // Find the toast system and show the toast
        const toastSystem = document.querySelector('[x-data*="toastSystem"]').__x.$data;
        toastSystem.showToast(title, message, type);
    });
});
