# Authentication System

## Authentication Methods Supported

The carfuse application supports multiple authentication methods:

1. **JWT Token Authentication** - Primary authentication method using JSON Web Tokens
   - Bearer token in Authorization header
   - Secure HttpOnly cookie storage
   
2. **Session-based Authentication** - Used for web interface access
   - PHP session management with enhanced security
   - Integration with JWT tokens for consistent authentication

3. **Dual-token System**
   - Short-lived access tokens for API requests
   - Long-lived refresh tokens for obtaining new access tokens

## Token Structure and Lifecycle

### Token Structure

JWT tokens contain the following claims:

```
{
  "iss": "[configured issuer]",   // Token issuer
  "aud": "[configured audience]", // Token audience
  "iat": 1623456789,              // Issued at timestamp
  "exp": 1623460389,              // Expiration timestamp
  "nbf": 1623456789,              // Not valid before timestamp
  "sub": "123",                   // User ID
  "role": "user"                  // User role
}
```

### Token Lifecycle

1. **Creation** - Generated by AuthService/TokenService during:
   - Login success
   - Token refresh
   - Registration (if auto-login)

2. **Storage**
   - Access token stored as HttpOnly cookie with 1-hour expiry
   - Refresh token stored as HttpOnly cookie with 7-day expiry
   - Database record maintained in RefreshToken model

3. **Validation**
   - Handled by TokenService.verifyToken()
   - Performed by AuthMiddleware and TokenValidationMiddleware
   - Checks signature, expiration, and token revocation status

4. **Refresh**
   - Client uses refresh token to obtain new access token
   - Old access token is invalidated
   - Token rotation for security

5. **Revocation**
   - Explicit logout (clearing cookies)
   - Database revocation flagging
   - Expired token cleanup via scheduled task

## Session Management Implementation

The session management system employs a layered approach:

1. **Secure Configuration**
   - HttpOnly flag prevents JavaScript access
   - Secure flag ensures HTTPS-only transmission
   - SameSite=Strict/Lax prevents CSRF attacks
   - Custom session name to avoid fingerprinting

2. **Session Integrity Protection**
   - IP address fingerprinting to detect session hijacking
   - User agent validation on each request
   - Automatic session regeneration every 30 minutes
   - Session fixation prevention

3. **State Management**
   - Request attribute-based session data handling
   - Session middleware coordination with authentication

4. **Expiry Handling**
   - Absolute session timeout (2 hours default)
   - Inactivity timeout (30 minutes default)
   - Forced re-authentication for sensitive operations

## Login Security Measures

The system implements multiple layers of login security:

1. **Rate Limiting**
   - Per-email rate limiting (5 attempts per 15 minutes)
   - Per-IP address rate limiting (10 attempts per hour)
   - Exponential backoff for repeated failures
   - Separate limits for password reset attempts

2. **Account Lockout Protection**
   - Temporary account lockout after multiple failed attempts
   - Notification to user on suspicious login activity
   - Admin alert on repeated lockouts

3. **Monitoring and Logging**
   - All authentication attempts logged via AuditService
   - Login location tracking for anomaly detection
   - Comprehensive audit trail with IP addresses

4. **Multi-factor Hooks**
   - Architecture supports adding second factor authentication
   - Risk-based authentication framework

## Credential Storage Approach

1. **Password Hashing**
   - Passwords hashed using PHP's password_hash() with PASSWORD_DEFAULT
   - Automatically upgrades hash algorithm when PHP default changes
   - Individual salt for each password

2. **Database Security**
   - No plaintext passwords stored at any point
   - Password reset uses one-time tokens, not original passwords
   - Encrypted database connection

3. **Credential Validation**
   - Time-constant comparison for password verification
   - Validation performed server-side only
   - Model-based encapsulation of credential verification

## Authentication Flow Diagram

```
┌──────┐     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│Client│     │AuthController │     │ AuthService   │     │ TokenService  │
└──┬───┘     └───────┬───────┘     └───────┬───────┘     └───────┬───────┘
   │                 │                     │                     │
   │  Login Request  │                     │                     │
   │────────────────>│                     │                     │
   │                 │                     │                     │
   │                 │   Validate Request  │                     │
   │                 │────────────────────>│                     │
   │                 │                     │                     │
   │                 │                     │  Rate Limit Check   │
   │                 │                     │──────────────────   │
   │                 │                     │                  │  │
   │                 │                     │<─────────────────┘  │
   │                 │                     │                     │
   │                 │                     │ Validate Credentials│
   │                 │                     │──────────────────   │
   │                 │                     │                  │  │
   │                 │                     │<─────────────────┘  │
   │                 │                     │                     │
   │                 │                     │  Generate Tokens    │
   │                 │                     │────────────────────>│
   │                 │                     │                     │
   │                 │                     │                     │  Create JWT
   │                 │                     │                     │──────────────────
   │                 │                     │                     │                 │
   │                 │                     │                     │<─────────────────
   │                 │                     │                     │
   │                 │                     │<───────────────────────Token Generated│
   │                 │                     │                     │
   │                 │ Store Refresh Token │                     │
   │                 │────────────────────>│                     │
   │                 │                     │                     │
   │                 │<─────────────────────Tokens & User Data   │
   │                 │                     │                     │
   │<────────────────│Set Secure Cookies   │                     │
   │     Success     │& Send Response      │                     │
   │                 │                     │                     │
└──────┘     └───────────────┘     └───────────────┘     └───────────────┘
```

## Security Best Practices for Clients

When implementing authentication in client applications:

1. **Token Handling**
   - Never store tokens in localStorage or sessionStorage
   - Rely on secure HttpOnly cookies
   - Don't extract or parse tokens in JavaScript
   - Implement token refresh logic properly

2. **Login Form Security**
   - Implement CSRF protection on login forms
   - Use HTTPS for all authentication requests
   - Disable autocomplete for sensitive fields
   - Implement proper input validation

3. **Logout Handling**
   - Always call the server logout endpoint
   - Clear local application state after logout
   - Implement proper error handling for failed logout
   - Consider session timeout notifications

4. **Error Handling**
   - Use generic error messages to prevent user enumeration
   - Log authentication failures but don't display specific errors
   - Implement proper rate limiting on client side

5. **Security Headers**
   - Set proper Content-Security-Policy headers
   - Use X-Content-Type-Options: nosniff
   - Enable Strict-Transport-Security
   - Consider X-Frame-Options to prevent clickjacking

6. **Mobile Applications**
   - Securely store refresh tokens in the keychain/keystore
   - Implement certificate pinning
   - Support biometric authentication when available
   - Implement app-level session timeouts
