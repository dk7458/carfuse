=== docs/backend/api/overview.md ===
# API Overview

## Introduction
Overview of the CarFuse API. This RESTful API provides programmatic access to CarFuse's vehicle data, user management, and diagnostic services. It enables developers to integrate vehicle information, maintenance records, and diagnostics into third-party applications.

## Design Principles and Conventions
-   RESTful architecture
-   Predictable resource URLs
-   HTTP verbs for actions (GET, POST, PUT, DELETE)
-   JSON for request and response bodies
-   Consistent naming conventions
-   Resource-oriented design with clear hierarchies
-   Stateless operations for horizontal scalability
-   Idempotent operations where applicable
-   Hypermedia links for discoverability (HATEOAS)
-   Comprehensive error reporting with actionable details

## Authentication
-   JWT (JSON Web Token) authentication via `Authorization` header
-   Token-based authentication for statelessness
-   Secure handling of credentials
-   Tokens must be included as `Authorization: Bearer <token>` header
-   OAuth2.0 flow supported for third-party applications
-   Refresh tokens provided with 14-day validity
-   Access tokens expire after 1 hour
-   HTTPS required for all API calls

## Rate Limiting
-   Implemented to prevent abuse and ensure availability
-   Based on IP address and/or user account
-   Details in response headers (`X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`)
-   Standard tier: 1000 requests per hour
-   Premium tier: 5000 requests per hour
-   Burst allowance: Short bursts exceeding limits are permitted
-   429 responses include a Retry-After header
-   Rate limits are applied per endpoint category

## Versioning
-   API versioning using URI path (e.g., `/api/v1/`)
-   Backward compatibility maintained as much as possible
-   Clear communication of breaking changes
-   Deprecation notices provided at least 6 months in advance
-   Multiple versions supported simultaneously during transition periods
-   Version-specific documentation available
-   Header-based version override available for testing: `Accept-Version: v2`

## Base URL Structure
`https://carfuse.example.com/api/v1/`

Resource paths follow a logical hierarchy:
- `/vehicles` - Vehicle resources
- `/users` - User management
- `/diagnostics` - Diagnostic services
- `/maintenance` - Maintenance records
- `/reports` - Reporting services

## Common HTTP Status Codes
-   200 OK: Success
-   201 Created: Resource created successfully
-   204 No Content: Request processed successfully, no content returned
-   400 Bad Request: Invalid request format or parameters
-   401 Unauthorized: Authentication required
-   403 Forbidden: Insufficient permissions
-   404 Not Found: Resource not found
-   409 Conflict: Request conflicts with current state of the target resource
-   422 Unprocessable Entity: Validation errors in request
-   429 Too Many Requests: Rate limit exceeded
-   500 Internal Server Error: Unexpected server error
-   503 Service Unavailable: System temporarily unavailable

## Request Format
Standard format for API requests:

- Content-Type must be `application/json` unless uploading files
- Request bodies should be valid JSON
- Query parameters used for filtering, sorting, and pagination
- Special characters in URL parameters must be URL-encoded
- Datetime values should use ISO 8601 format (UTC)
- Requests with invalid JSON will receive a 400 Bad Request response
- Large requests (>1MB) should use pagination or streaming endpoints

## Response Format
Standard format for API responses:

- All responses are JSON (`application/json`) unless specified otherwise
- Standard envelope format with `data` and `meta` fields
- Error responses include an `error` object with code and message
- Collections include pagination information
- Timestamps in ISO 8601 format (UTC)
- All IDs are strings, even if they appear numeric
- Consistent field naming with camelCase
- See `/api/responses.md` for detailed response formats
=== docs/backend/api/responses.md ===
# API Response Documentation

## Standard Response Format

All CarFuse API responses follow a consistent JSON structure:

```json
{
  "data": {
    // Resource data or array of resources
  },
  "meta": {
    "requestId": "a1b2c3d4-e5f6-7890-abcd-1234567890ab",
    "timestamp": "2023-11-15T08:30:45Z",
    "pagination": {
      // Pagination details (if applicable)
    }
  }
}
```

## Error Response Structure

Error responses provide detailed information to help diagnose issues:

```json
{
  "error": {
    "code": "RESOURCE_NOT_FOUND",
    "message": "The requested vehicle could not be found",
    "details": [
      {
        "field": "vehicleId",
        "issue": "No vehicle exists with ID v-12345"
      }
    ],
    "documentation": "https://carfuse.example.com/docs/errors/RESOURCE_NOT_FOUND"
  },
  "meta": {
    "requestId": "a1b2c3d4-e5f6-7890-abcd-1234567890ab",
    "timestamp": "2023-11-15T08:30:45Z"
  }
}
```

Common error codes:
- `INVALID_REQUEST` - Request syntax or semantics invalid
- `AUTHENTICATION_REQUIRED` - Authentication credentials missing or invalid
- `PERMISSION_DENIED` - User lacks required permissions
- `RESOURCE_NOT_FOUND` - Requested resource does not exist
- `VALIDATION_FAILED` - Request parameters failed validation
- `RATE_LIMIT_EXCEEDED` - User has sent too many requests
- `INTERNAL_ERROR` - Server encountered an unexpected error
- `SERVICE_UNAVAILABLE` - Service temporarily unavailable

## Pagination Pattern

List endpoints return paginated results using cursor-based pagination:

```json
{
  "data": [
    // Array of resources
  ],
  "meta": {
    "pagination": {
      "pageSize": 25,
      "totalCount": 1358,
      "nextCursor": "WyIyMDIzLTExLTE1VDEwOjMwOjAwWiIsIDEwMDJd",
      "previousCursor": null,
      "hasNextPage": true,
      "hasPreviousPage": false
    },
    "requestId": "a1b2c3d4-e5f6-7890-abcd-1234567890ab",
    "timestamp": "2023-11-15T08:30:45Z"
  }
}
```

Pagination query parameters:
- `pageSize` - Number of items per page (default 25, max 100)
- `cursor` - Position in the dataset for pagination
- `sort` - Field to sort by (prefix with `-` for descending order)

## Data Envelope Format

### Single Resource

```json
{
  "data": {
    "id": "v-12345",
    "type": "vehicle",
    "attributes": {
      "make": "Toyota",
      "model": "Camry",
      "year": 2022,
      "vin": "1T7HT2B23CX361200",
      "color": "Silver",
      "lastUpdated": "2023-10-15T14:22:30Z"
    },
    "relationships": {
      "owner": {
        "id": "u-789",
        "type": "user"
      },
      "diagnostics": {
        "href": "/api/v1/vehicles/v-12345/diagnostics"
      }
    }
  },
  "meta": {
    "requestId": "a1b2c3d4-e5f6-7890-abcd-1234567890ab",
    "timestamp": "2023-11-15T08:30:45Z"
  }
}
```

### Resource Collection

```json
{
  "data": [
    {
      "id": "v-12345",
      "type": "vehicle",
      "attributes": {
        "make": "Toyota",
        "model": "Camry",
        "year": 2022
      },
      "links": {
        "self": "/api/v1/vehicles/v-12345"
      }
    },
    {
      "id": "v-67890",
      "type": "vehicle",
      "attributes": {
        "make": "Honda",
        "model": "Civic",
        "year": 2023
      },
      "links": {
        "self": "/api/v1/vehicles/v-67890"
      }
    }
  ],
  "meta": {
    "pagination": {
      "pageSize": 25,
      "totalCount": 1358,
      "nextCursor": "WyIyMDIzLTExLTE1VDEwOjMwOjAwWiIsIDEwMDJd",
      "previousCursor": null,
      "hasNextPage": true,
      "hasPreviousPage": false
    },
    "requestId": "a1b2c3d4-e5f6-7890-abcd-1234567890ab",
    "timestamp": "2023-11-15T08:30:45Z"
  }
}
```

## JSON Schema Examples

### Vehicle Resource

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier for the vehicle",
      "pattern": "^v-[a-zA-Z0-9]{5,}$"
    },
    "type": {
      "type": "string",
      "enum": ["vehicle"]
    },
    "attributes": {
      "type": "object",
      "properties": {
        "make": {
          "type": "string"
        },
        "model": {
          "type": "string"
        },
        "year": {
          "type": "integer",
          "minimum": 1900,
          "maximum": 2100
        },
        "vin": {
          "type": "string",
          "pattern": "^[A-HJ-NPR-Z0-9]{17}$"
        },
        "color": {
          "type": "string"
        },
        "lastUpdated": {
          "type": "string",
          "format": "date-time"
        }
      },
      "required": ["make", "model", "year"]
    }
  },
  "required": ["id", "type", "attributes"]
}
```

## Response Headers and Their Meanings

| Header                 | Description                                   | Example                              |
|------------------------|-----------------------------------------------|--------------------------------------|
| `Content-Type`         | Media type of the response                    | `application/json`                   |
| `X-Request-ID`         | Unique identifier for the request             | `a1b2c3d4-e5f6-7890-abcd-1234567890ab` |
| `X-RateLimit-Limit`    | Number of requests allowed in period          | `1000`                               |
| `X-RateLimit-Remaining`| Number of requests remaining in period        | `999`                                |
| `X-RateLimit-Reset`    | Time when rate limit resets (Unix timestamp)  | `1605434365`                         |
| `Cache-Control`        | Caching directives                            | `private, max-age=300`               |
| `ETag`                 | Version identifier for resource               | `"33a64df551425fcc55e4d42a148795d9f25f89d4"` |
| `X-Version`            | API version used for the request              | `v1`                                 |
| `X-Deprecation-Notice` | Warning about deprecated features (if any)    | `The 'color_hex' field is deprecated and will be removed in v2` |
=== docs/backend/api/endpoints/payments.md ===
# Payments API Endpoints

## Overview

The Payments API provides endpoints for processing payments, refunds, and managing payment methods. This API also handles retrieving transaction history, generating invoices, and interacting with external payment gateways.

## Authentication and Permissions

| Endpoint Pattern                     | Required Role | Notes                                      |
|-------------------------------------|---------------|-------------------------------------------|
| `POST /payments/process`             | User          | Process a payment                          |
| `POST /payments/refund`              | Admin         | Process a refund (admin only)              |
| `GET /payments/user`                 | User          | Get user's transaction history            |
| `GET /payments/{id}`                 | User          | Get payment details                       |
| `POST /payments/methods`             | User          | Add a payment method                      |
| `GET /payments/methods`              | User          | Get user's payment methods                |
| `DELETE /payments/methods/{id}`      | User          | Delete a payment method                   |
| `POST /payments/gateway`             | User          | Process payment via gateway               |
| `POST /payments/gateway/{gateway}/callback` | None   | Handle gateway callback (no auth required) |
| `GET /payments/invoice/{id}`         | User          | Download payment invoice                  |

## Rate Limiting

Payment endpoints have stricter rate limits to prevent abuse:
- Standard tier: 30 requests per minute
- Premium tier: 60 requests per minute
- Payment processing: 10 requests per hour per user
- Invoice generation: 20 requests per hour per user

---

## Process Payment

Process a payment for a booking.

### HTTP Request

`POST /payments/process`

### Authentication

Requires a valid user authentication token.

### Request Body Parameters

| Parameter          | Type    | Required | Description                  | Constraints                       |
|--------------------|---------|----------|------------------------------|----------------------------------|
| `booking_id`       | Integer | Yes      | ID of the booking            | Must be a valid booking ID        |
| `amount`           | Number  | Yes      | Payment amount               | Must be greater than 0.01        |
| `payment_method_id`| Integer | Yes      | ID of the payment method     | Must be a valid payment method ID |
| `currency`         | String  | No       | 3-letter currency code       | Default: system default (e.g., USD)|

### Example Request

```json
{
  "booking_id": 456,
  "amount": 349.99,
  "payment_method_id": 123,
  "currency": "USD"
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Payment processed",
  "data": {
    "payment": {
      "id": 789,
      "amount": 349.99,
      "currency": "USD",
      "status": "completed",
      "transaction_id": "txn_123456789",
      "created_at": "2023-06-15T14:30:00Z"
    }
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                    |
|-------------|--------------------------|------------------------------------------------|
| 400         | `VALIDATION_ERROR`       | Invalid request parameters                      |
| 400         | `PAYMENT_AMOUNT_MISMATCH`| Payment amount does not match booking amount   |
| 400         | `BOOKING_ALREADY_PAID`   | Booking is already paid for                    |
| 400         | `INVALID_PAYMENT_METHOD` | Payment method is invalid or expired           |
| 401         | `UNAUTHORIZED`           | User not authenticated                         |
| 403         | `PERMISSION_DENIED`      | User cannot access this booking                |
| 404         | `BOOKING_NOT_FOUND`      | Booking not found                              |
| 500         | `PAYMENT_FAILED`         | Payment processing failed                      |

### Notes

- Payment confirmation notification is sent on success
- Transaction is logged in the system
- Payment method ownership is validated before processing
- Multiple payments for the same booking are prevented

---

## Process Refund

Process a refund for an existing payment. Admin access required.

### HTTP Request

`POST /payments/refund`

### Authentication

Requires a valid admin authentication token.

### Request Body Parameters

| Parameter    | Type    | Required | Description                  | Constraints                       |
|--------------|---------|----------|------------------------------|----------------------------------|
| `payment_id` | Integer | Yes      | ID of the payment to refund  | Must be a valid payment ID        |
| `amount`     | Number  | Yes      | Refund amount                | Must be > 0 and <= original amount|
| `reason`     | String  | Yes      | Reason for the refund        | Non-empty string                  |

### Example Request

```json
{
  "payment_id": 789,
  "amount": 349.99,
  "reason": "Booking cancellation"
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Refund processed",
  "data": {
    "refund": {
      "id": 123,
      "payment_id": 789,
      "amount": 349.99,
      "currency": "USD",
      "reason": "Booking cancellation",
      "status": "completed",
      "transaction_id": "ref_987654321",
      "created_at": "2023-06-16T10:22:18Z"
    }
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                    |
|-------------|--------------------------|------------------------------------------------|
| 400         | `VALIDATION_ERROR`       | Invalid request parameters                      |
| 400         | `REFUND_AMOUNT_EXCESSIVE`| Refund amount exceeds original payment         |
| 400         | `PAYMENT_NOT_REFUNDABLE` | Payment is not refundable                      |
| 401         | `UNAUTHORIZED`           | User not authenticated                         |
| 403         | `PERMISSION_DENIED`      | User does not have admin rights                |
| 404         | `PAYMENT_NOT_FOUND`      | Payment not found                              |
| 500         | `REFUND_FAILED`          | Refund processing failed                       |

### Notes

- Refund notification is sent to affected user
- Refund is recorded in the transaction history
- Original payment is linked to the refund record
- Audit logs are created for refund operations

---

## Get User Transaction History

Retrieve the authenticated user's transaction history.

### HTTP Request

`GET /payments/user`

### Authentication

Requires a valid user authentication token.

### Query Parameters

| Parameter | Type    | Required | Description                   | Constraints                        |
|-----------|---------|----------|------------------------------ |-----------------------------------|
| `page`    | Integer | No       | Page number for pagination    | Default: 1, Min: 1                |
| `limit`   | Integer | No       | Number of items per page      | Default: 20, Max: 100             |
| `type`    | String  | No       | Filter by transaction type    | Values: payment, refund           |
| `status`  | String  | No       | Filter by transaction status  | Values: pending, completed, failed|
| `from_date`| String | No       | Filter by minimum date        | ISO 8601 format                   |
| `to_date` | String  | No       | Filter by maximum date        | ISO 8601 format                   |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Transactions fetched",
  "data": [
    {
      "id": 789,
      "booking_id": 456,
      "type": "payment",
      "amount": 349.99,
      "currency": "USD",
      "status": "completed",
      "method": "credit_card",
      "card_last4": "4242",
      "transaction_id": "txn_123456789",
      "created_at": "2023-06-15T14:30:00Z"
    },
    {
      "id": 790,
      "booking_id": 457,
      "type": "payment",
      "amount": 249.99,
      "currency": "USD",
      "status": "pending",
      "method": "paypal",
      "transaction_id": "txn_987654321",
      "created_at": "2023-06-16T09:22:18Z"
    }
  ],
  "meta": {
    "current_page": 1,
    "total_pages": 3,
    "total_items": 45,
    "per_page": 20
  }
}
```

### Error Codes

| Status Code | Error Code         | Description                                    |
|-------------|-------------------|------------------------------------------------|
| 401         | `UNAUTHORIZED`     | User not authenticated                         |
| 500         | `SERVER_ERROR`     | Failed to fetch transactions                   |

### Notes

- Results are typically sorted by date (newest first)
- Sensitive payment details are partially masked
- Response includes pagination metadata
- Transaction history access is logged for audit purposes

---

## Get Payment Details

Retrieve detailed information for a specific payment.

### HTTP Request

`GET /payments/{id}`

### Authentication

Requires a valid user authentication token.

### Path Parameters

| Parameter | Type    | Required | Description        | Constraints                   |
|-----------|---------|----------|--------------------|------------------------------|
| `id`      | Integer | Yes      | Payment identifier | Must be a valid payment ID    |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Payment details fetched",
  "data": {
    "details": {
      "id": 789,
      "booking_id": 456,
      "user_id": 123,
      "type": "payment",
      "amount": 349.99,
      "currency": "USD",
      "status": "completed",
      "method": "credit_card",
      "card_brand": "Visa",
      "card_last4": "4242",
      "transaction_id": "txn_123456789",
      "reference": "BOOK-456-PAY",
      "description": "Payment for booking #456",
      "metadata": {
        "booking_date": "2023-07-15T10:00:00Z",
        "vehicle": "Toyota Camry"
      },
      "created_at": "2023-06-15T14:30:00Z",
      "updated_at": "2023-06-15T14:30:45Z",
      "booking": {
        "id": 456,
        "pickup_date": "2023-07-15T10:00:00Z",
        "dropoff_date": "2023-07-18T10:00:00Z",
        "vehicle_id": 789
      },
      "refunds": []
    }
  }
}
```

### Error Codes

| Status Code | Error Code         | Description                                    |
|-------------|-------------------|------------------------------------------------|
| 401         | `UNAUTHORIZED`     | User not authenticated                         |
| 403         | `PERMISSION_DENIED`| User does not have permission for this payment |
| 404         | `PAYMENT_NOT_FOUND`| Payment not found                              |
| 500         | `SERVER_ERROR`     | Failed to retrieve payment details             |

### Notes

- Users can only view their own payment details
- Admins can view all payment details
- Permission checking handles owner verification
- Includes linked booking information

---

## Add Payment Method

Add a new payment method to the user's account.

### HTTP Request

`POST /payments/methods`

### Authentication

Requires a valid user authentication token.

### Request Body Parameters

| Parameter       | Type    | Required | Description                      | Constraints                       |
|-----------------|---------|----------|----------------------------------|----------------------------------|
| `type`          | String  | Yes      | Type of payment method           | Values: credit_card, paypal, etc. |
| `card_last4`    | String  | Conditional | Last 4 digits of card         | Required if type is credit_card   |
| `card_brand`    | String  | Conditional | Card brand                    | Required if type is credit_card   |
| `expiry_date`   | String  | Conditional | Card expiry date (MM/YY)      | Required if type is credit_card   |
| `is_default`    | Boolean | No       | Set as default payment method    | Default: false                    |

### Example Request

```json
{
  "type": "credit_card",
  "card_last4": "4242",
  "card_brand": "Visa",
  "expiry_date": "12/25",
  "is_default": true
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Payment method added successfully",
  "data": {
    "payment_method": {
      "id": 123,
      "type": "credit_card",
      "card_last4": "4242",
      "card_brand": "Visa",
      "expiry_date": "12/25",
      "is_default": true,
      "created_at": "2023-06-16T14:30:00Z"
    }
  }
}
```

### Error Codes

| Status Code | Error Code                  | Description                                    |
|-------------|----------------------------|------------------------------------------------|
| 400         | `VALIDATION_ERROR`         | Invalid request parameters                      |
| 400         | `INVALID_PAYMENT_TYPE`     | Unsupported payment method type                 |
| 401         | `UNAUTHORIZED`             | User not authenticated                          |
| 500         | `METHOD_CREATION_FAILED`   | Failed to add payment method                    |

### Notes

- If set as default, other payment methods are automatically un-set as default
- Actual card data should not be sent directly to this API; use tokenization
- Sensitive payment details are securely stored according to PCI standards

---

## Get User Payment Methods

Retrieve all payment methods for the authenticated user.

### HTTP Request

`GET /payments/methods`

### Authentication

Requires a valid user authentication token.

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Payment methods retrieved successfully",
  "data": {
    "payment_methods": [
      {
        "id": 123,
        "type": "credit_card",
        "card_last4": "4242",
        "card_brand": "Visa",
        "expiry_date": "12/25",
        "is_default": true,
        "created_at": "2023-06-16T14:30:00Z"
      },
      {
        "id": 124,
        "type": "paypal",
        "email": "user@example.com",
        "is_default": false,
        "created_at": "2023-06-17T10:22:18Z"
      }
    ]
  }
}
```

### Error Codes

| Status Code | Error Code         | Description                                    |
|-------------|-------------------|------------------------------------------------|
| 401         | `UNAUTHORIZED`     | User not authenticated                         |
| 500         | `SERVER_ERROR`     | Failed to retrieve payment methods             |

### Notes

- Methods are sorted with default method first, then by creation date
- Sensitive payment information is partially masked
- The method count is not limited, but UI may limit display

---

## Delete Payment Method

Delete a payment method from the user's account.

### HTTP Request

`DELETE /payments/methods/{id}`

### Authentication

Requires a valid user authentication token.

### Path Parameters

| Parameter | Type    | Required | Description               | Constraints                       |
|-----------|---------|----------|---------------------------|----------------------------------|
| `id`      | Integer | Yes      | Payment method identifier | Must be a valid payment method ID |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Payment method deleted successfully"
}
```

### Error Codes

| Status Code | Error Code               | Description                                         |
|-------------|-------------------------|-----------------------------------------------------|
| 401         | `UNAUTHORIZED`          | User not authenticated                               |
| 403         | `PERMISSION_DENIED`     | Payment method doesn't belong to authenticated user  |
| 404         | `METHOD_NOT_FOUND`      | Payment method not found                             |
| 500         | `SERVER_ERROR`          | Failed to delete payment method                      |

### Notes

- If the default payment method is deleted, another method will be set as default if available
- Methods in use for recurring payments may require additional steps before deletion
- Deletion is logged for audit purposes

---

## Process Gateway Payment

Initiate a payment using a specific payment gateway.

### HTTP Request

`POST /payments/gateway`

### Authentication

Requires a valid user authentication token.

### Request Body Parameters

| Parameter    | Type    | Required | Description                      | Constraints                       |
|--------------|---------|----------|----------------------------------|----------------------------------|
| `gateway`    | String  | Yes      | Payment gateway to use           | Values: stripe, paypal, payu     |
| `booking_id` | Integer | Yes      | ID of the booking                | Must be a valid booking ID        |
| `amount`     | Number  | Yes      | Payment amount                   | Must be greater than 0.01        |
| `currency`   | String  | Yes      | 3-letter currency code           | Must be a supported currency code |
| `return_url` | String  | Yes      | URL to return on success         | Valid URL                         |
| `cancel_url` | String  | Yes      | URL to return on cancellation    | Valid URL                         |

### Example Request

```json
{
  "gateway": "stripe",
  "booking_id": 456,
  "amount": 349.99,
  "currency": "USD",
  "return_url": "https://carfuse.example.com/bookings/456/confirmation",
  "cancel_url": "https://carfuse.example.com/bookings/456/payment"
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Gateway payment initiated",
  "data": {
    "redirect_url": "https://checkout.stripe.com/pay/cs_test_...",
    "session_id": "cs_test_...",
    "expires_at": "2023-06-16T15:30:00Z"
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                    |
|-------------|--------------------------|------------------------------------------------|
| 400         | `VALIDATION_ERROR`       | Invalid request parameters                      |
| 400         | `UNSUPPORTED_GATEWAY`    | Selected gateway is not supported              |
| 400         | `GATEWAY_CONFIG_ERROR`   | Gateway configuration error                    |
| 401         | `UNAUTHORIZED`           | User not authenticated                         |
| 403         | `PERMISSION_DENIED`      | User cannot access this booking                |
| 404         | `BOOKING_NOT_FOUND`      | Booking not found                              |
| 500         | `GATEWAY_ERROR`          | Payment gateway error                          |

### Notes

- Different gateways may require different parameters
- Session/transaction info is stored for callback validation
- IP address and user agent are recorded for security purposes
- Response structure varies by gateway

---

## Handle Gateway Callback

Process callbacks from payment gateways after payment completion or cancellation.

### HTTP Request

`POST /payments/gateway/{gateway}/callback`

### Path Parameters

| Parameter | Type   | Required | Description            | Constraints                     |
|-----------|--------|----------|------------------------|--------------------------------|
| `gateway` | String | Yes      | Payment gateway name   | Must be a supported gateway     |

### Request Parameters

Parameters vary by gateway but typically include:

| Parameter    | Type   | Location | Description                                 |
|--------------|--------|----------|---------------------------------------------|
| `session_id` | String | Body/Query | Gateway session or transaction ID           |
| `status`     | String | Body/Query | Payment status from gateway                 |
| Various security tokens and signatures specific to each gateway                    |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Callback processed"
}
```

### Error Codes

| Status Code | Error Code            | Description                                    |
|-------------|----------------------|------------------------------------------------|
| 400         | `INVALID_CALLBACK`   | Invalid callback parameters                     |
| 400         | `SIGNATURE_MISMATCH` | Security signature validation failed            |
| 500         | `PROCESSING_FAILED`  | Failed to process callback                      |

### Notes

- No authentication is required as callbacks come from payment gateways
- Strict validation of callback data and signatures is performed
- IP address verification against gateway IPs may be implemented
- Payment status is updated based on callback information
- Success/failure notifications are triggered based on payment outcome

---

## Download Payment Invoice

Generate and download an invoice for a payment.

### HTTP Request

`GET /payments/invoice/{id}`

### Authentication

Requires a valid user authentication token.

### Path Parameters

| Parameter | Type    | Required | Description        | Constraints                   |
|-----------|---------|----------|--------------------|------------------------------|
| `id`      | Integer | Yes      | Payment identifier | Must be a valid payment ID    |

### Response

Status code: `200 OK`

Content-Type: `application/pdf`
Content-Disposition: `attachment; filename="invoice-{reference}.pdf"`

Binary PDF data containing the invoice.

### Error Codes

| Status Code | Error Code               | Description                                         |
|-------------|-------------------------|-----------------------------------------------------|
| 401         | `UNAUTHORIZED`          | User not authenticated                               |
| 403         | `PERMISSION_DENIED`     | User does not have access to this payment            |
| 404         | `PAYMENT_NOT_FOUND`     | Payment not found                                    |
| 404         | `INVOICE_NOT_AVAILABLE` | Invoice cannot be generated for this payment         |
| 500         | `GENERATION_FAILED`     | Failed to generate invoice                           |

### Notes

- Invoices are only available for completed payments
- Download is logged for audit purposes
- Admins can access invoices for any payment
- Regular users can only access invoices for their own payments
- Invoice includes legally required fiscal information
=== docs/backend/api/endpoints/notifications.md ===
# Notifications API Endpoints

## Overview

The Notifications API enables management of user notifications including viewing, marking as read, deleting, and sending notifications. These endpoints support multiple notification channels (in-app, email, SMS) and provide real-time updates to users about booking status, payments, and system events.

## Authentication and Permissions

| Endpoint Pattern                    | Required Role | Notes                                      |
|------------------------------------|---------------|-------------------------------------------|
| `GET /notifications`                | User          | View user notifications (HTML response)    |
| `GET /notifications/user`           | User          | Get user notifications (JSON response)     |
| `GET /notifications/unread`         | User          | Fetch unread notifications                |
| `POST /notifications/mark-read`     | User          | Mark notification as read                 |
| `POST /notifications/delete`        | User          | Delete a notification                     |
| `POST /notifications/send`          | Admin         | Send a notification (admin only)          |
| `GET /notifications/preferences`    | User          | Get user notification preferences         |
| `PUT /notifications/preferences`    | User          | Update user notification preferences      |

## Rate Limiting

Notification endpoints have the following rate limits:
- Standard tier: 60 requests per minute
- Premium tier: 120 requests per minute
- Sending notifications (admin): 100 requests per minute

---

## View User Notifications

Get a rendered HTML view of user notifications for UI integration.

### HTTP Request

`GET /notifications`

### Authentication

Requires a valid user authentication token.

### Query Parameters

| Parameter  | Type    | Required | Description               | Constraints                     |
|------------|---------|----------|---------------------------|--------------------------------|
| `page`     | Integer | No       | Page number               | Default: 1, Min: 1              |
| `per_page` | Integer | No       | Items per page            | Default: 10, Max: 50            |

### Response

Status code: `200 OK`

Returns HTML content for rendering in the UI. Typical response is a rendered HTML fragment with notification items.

### Error Codes

| Status Code | Error Code           | Description                                      |
|-------------|---------------------|--------------------------------------------------|
| 401         | `UNAUTHORIZED`       | User not authenticated                           |
| 500         | `SERVER_ERROR`       | Failed to retrieve notifications                 |

### Notes

- Optimized for HTMX integration
- All notifications viewed will be marked as seen (but not read)
- Supports infinite scrolling via pagination

---

## Get User Notifications 

Get a JSON list of notifications for the authenticated user.

### HTTP Request

`GET /notifications/user`

### Authentication

Requires a valid user authentication token.

### Query Parameters

| Parameter  | Type    | Required | Description               | Constraints                     |
|------------|---------|----------|---------------------------|--------------------------------|
| `page`     | Integer | No       | Page number               | Default: 1, Min: 1              |
| `per_page` | Integer | No       | Items per page            | Default: 20, Max: 100           |
| `read`     | Boolean | No       | Filter by read status     | true/false                      |
| `type`     | String  | No       | Filter by notification type| e.g., booking, payment, system  |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Notifications retrieved successfully",
  "data": {
    "notifications": [
      {
        "id": 123,
        "type": "booking_confirmation",
        "message": "Your booking #456 has been confirmed",
        "read": false,
        "data": {
          "booking_id": 456,
          "vehicle": "Toyota Camry"
        },
        "created_at": "2023-06-15T14:30:00Z"
      },
      {
        "id": 124,
        "type": "payment_processed",
        "message": "Your payment of $349.99 has been processed",
        "read": true,
        "data": {
          "payment_id": 789,
          "booking_id": 456,
          "amount": 349.99
        },
        "created_at": "2023-06-15T14:31:22Z"
      }
    ]
  },
  "meta": {
    "current_page": 1,
    "total_pages": 5,
    "total_items": 92,
    "per_page": 20,
    "unread_count": 7
  }
}
```

### Error Codes

| Status Code | Error Code           | Description                                      |
|-------------|---------------------|--------------------------------------------------|
| 401         | `UNAUTHORIZED`       | User not authenticated                           |
| 500         | `SERVER_ERROR`       | Failed to retrieve notifications                 |

### Notes

- Notifications are sorted by creation date (newest first)
- Response includes total unread count for badge display
- Notification viewing is logged for audit purposes

---

## Fetch Unread Notifications

Get only unread notifications for the authenticated user.

### HTTP Request

`GET /notifications/unread`

### Authentication

Requires a valid user authentication token.

### Query Parameters

| Parameter  | Type    | Required | Description               | Constraints                     |
|------------|---------|----------|---------------------------|--------------------------------|
| `limit`    | Integer | No       | Maximum items to return   | Default: 10, Max: 50            |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Unread notifications retrieved successfully",
  "data": {
    "notifications": [
      {
        "id": 123,
        "type": "booking_confirmation",
        "message": "Your booking #456 has been confirmed",
        "data": {
          "booking_id": 456,
          "vehicle": "Toyota Camry"
        },
        "created_at": "2023-06-15T14:30:00Z"
      }
    ]
  },
  "meta": {
    "total_unread": 7
  }
}
```

### Error Codes

| Status Code | Error Code           | Description                                      |
|-------------|---------------------|--------------------------------------------------|
| 401         | `UNAUTHORIZED`       | User not authenticated                           |
| 500         | `SERVER_ERROR`       | Failed to retrieve notifications                 |

### Notes

- Optimized for real-time notification display
- Suitable for notification badge counts
- Supports polling for new notifications

---

## Mark Notification as Read

Mark a specific notification as read.

### HTTP Request

`POST /notifications/mark-read`

### Authentication

Requires a valid user authentication token.

### Request Body Parameters

| Parameter         | Type    | Required | Description                  | Constraints                       |
|-------------------|---------|----------|------------------------------|----------------------------------|
| `notification_id` | Integer | Yes      | ID of notification to mark   | Must be a valid notification ID   |

### Example Request

```json
{
  "notification_id": 123
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Notification marked as read"
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `MISSING_NOTIFICATION_ID`| Notification ID is missing                        |
| 401         | `UNAUTHORIZED`           | User not authenticated                            |
| 403         | `FORBIDDEN`              | User does not own this notification               |
| 404         | `NOTIFICATION_NOT_FOUND` | Notification not found                            |
| 500         | `SERVER_ERROR`           | Failed to mark notification as read               |

### Notes

- Only the notification owner can mark it as read
- Operation is idempotent - marking already read notifications is allowed
- Notification read status is logged for audit purposes

---

## Delete Notification

Delete a specific notification.

### HTTP Request

`POST /notifications/delete`

### Authentication

Requires a valid user authentication token.

### Request Body Parameters

| Parameter         | Type    | Required | Description                  | Constraints                       |
|-------------------|---------|----------|------------------------------|----------------------------------|
| `notification_id` | Integer | Yes      | ID of notification to delete | Must be a valid notification ID   |

### Example Request

```json
{
  "notification_id": 123
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Notification deleted successfully"
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `MISSING_NOTIFICATION_ID`| Notification ID is missing                        |
| 401         | `UNAUTHORIZED`           | User not authenticated                            |
| 403         | `FORBIDDEN`              | User does not own this notification               |
| 404         | `NOTIFICATION_NOT_FOUND` | Notification not found                            |
| 500         | `SERVER_ERROR`           | Failed to delete notification                     |

### Notes

- Only the notification owner can delete it
- System critical notifications might be undeletable
- Deletion is logged for audit purposes
- Notification might be soft-deleted for retention policies

---

## Send Notification

Send a notification to a specific user or group of users (admin only).

### HTTP Request

`POST /notifications/send`

### Authentication

Requires admin privileges.

### Request Body Parameters

| Parameter       | Type    | Required | Description                  | Constraints                       |
|-----------------|---------|----------|------------------------------|----------------------------------|
| `user_id`       | Integer | Conditional | Recipient user ID         | Required if no user_ids provided  |
| `user_ids`      | Array   | Conditional | Array of recipient user IDs | Required if no user_id provided   |
| `type`          | String  | Yes      | Notification type            | Must be a valid notification type |
| `message`       | String  | Yes      | Notification message         | Max: 500 characters               |
| `data`          | Object  | No       | Additional notification data | Max size: 5KB                     |
| `send_email`    | Boolean | No       | Also send as email           | Default: false                    |
| `send_sms`      | Boolean | No       | Also send as SMS             | Default: false                    |
| `priority`      | String  | No       | Notification priority        | Values: low, normal, high         |

### Example Request

```json
{
  "user_id": 123,
  "type": "system_notification",
  "message": "Your vehicle inspection is due next week",
  "data": {
    "booking_id": 456,
    "vehicle_id": 789,
    "inspection_date": "2023-06-22T14:00:00Z"
  },
  "send_email": true,
  "priority": "normal"
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Notification sent successfully",
  "data": {
    "notification_id": 125,
    "channels_sent": ["in_app", "email"]
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `VALIDATION_ERROR`       | Invalid or missing parameters                     |
| 401         | `UNAUTHORIZED`           | User not authenticated                            |
| 403         | `FORBIDDEN`              | User does not have admin privileges               |
| 404         | `USER_NOT_FOUND`         | One or more users not found                       |
| 500         | `NOTIFICATION_FAILED`    | Failed to send notification                       |

### Notes

- Message templates are supported using {{variable}} placeholders
- Email and SMS delivery is asynchronous
- Notifications respect user preferences
- Rate limiting and throttling apply to prevent notification spam
- Bulk notifications to many users are processed in batches

---

## Get Notification Preferences

Retrieve notification preferences for the authenticated user.

### HTTP Request

`GET /notifications/preferences`

### Authentication

Requires a valid user authentication token.

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "data": {
    "preferences": {
      "email_enabled": true,
      "sms_enabled": false,
      "push_enabled": true,
      "categories": {
        "booking": {
          "in_app": true,
          "email": true,
          "sms": false,
          "push": true
        },
        "payment": {
          "in_app": true,
          "email": true,
          "sms": false,
          "push": false
        },
        "system": {
          "in_app": true,
          "email": false,
          "sms": false,
          "push": false
        }
      },
      "quiet_hours": {
        "enabled": true,
        "start": "22:00",
        "end": "08:00",
        "timezone": "America/New_York"
      }
    }
  }
}
```

### Error Codes

| Status Code | Error Code           | Description                                      |
|-------------|---------------------|--------------------------------------------------|
| 401         | `UNAUTHORIZED`       | User not authenticated                           |
| 500         | `SERVER_ERROR`       | Failed to retrieve notification preferences      |

### Notes

- Default preferences are used if user hasn't set custom preferences
- Preferences are used to filter notifications across all channels
- Time-sensitive critical notifications may override quiet hours

---

## Update Notification Preferences

Update notification preferences for the authenticated user.

### HTTP Request

`PUT /notifications/preferences`

### Authentication

Requires a valid user authentication token.

### Request Body Parameters

| Parameter        | Type    | Required | Description                  | Constraints                       |
|------------------|---------|----------|------------------------------|----------------------------------|
| `email_enabled`  | Boolean | No       | Enable email notifications   | true/false                        |
| `sms_enabled`    | Boolean | No       | Enable SMS notifications     | true/false                        |
| `push_enabled`   | Boolean | No       | Enable push notifications    | true/false                        |
| `categories`     | Object  | No       | Category-specific settings   | See example below                 |
| `quiet_hours`    | Object  | No       | Quiet hours settings         | See example below                 |

### Example Request

```json
{
  "email_enabled": true,
  "sms_enabled": false,
  "categories": {
    "booking": {
      "email": true,
      "sms": false
    }
  },
  "quiet_hours": {
    "enabled": true,
    "start": "23:00",
    "end": "07:00",
    "timezone": "America/New_York"
  }
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Notification preferences updated successfully"
}
```

### Error Codes

| Status Code | Error Code           | Description                                      |
|-------------|---------------------|--------------------------------------------------|
| 400         | `VALIDATION_ERROR`   | Invalid preferences format                       |
| 401         | `UNAUTHORIZED`       | User not authenticated                           |
| 500         | `UPDATE_FAILED`      | Failed to update notification preferences        |

### Notes

- Partial updates are supported - only specified fields will be changed
- Preferences update is logged for audit purposes
- Timezone must be a valid IANA timezone identifier
- Changes take effect immediately for new notifications
=== docs/backend/api/endpoints/admin.md ===
# Admin API Endpoints

## Overview

The Admin API provides system administration capabilities including user management, permission control, system configuration, and administrative operations. These endpoints are restricted to users with admin privileges.

## Authentication and Permissions

| Endpoint Pattern                | Required Role | Notes                                      |
|--------------------------------|---------------|-------------------------------------------|
| `GET /admin/users`              | Admin         | Get all users                             |
| `GET /admin/users/{id}`         | Admin         | Get user by ID                            |
| `POST /admin/users`             | Admin         | Create a new user                         |
| `PUT /admin/users/{id}`         | Admin         | Update user details                       |
| `POST /admin/users/{id}/status` | Admin         | Toggle user active status                 |
| `POST /admin/users/{id}/role`   | Admin         | Update user role                          |
| `DELETE /admin/users/{id}`      | Admin         | Delete a user (soft delete)               |
| `POST /admin/users/admin`       | Admin         | Create a new admin user                   |
| `GET /admin/users/page`         | Admin         | HTML format for user management           |

## Rate Limiting

Admin endpoints have stricter rate limiting:
- 30 requests per minute per admin user
- Bulk operations are limited to 10 per hour

---

## Get All Users

Retrieve a paginated list of all users with their roles and status.

### HTTP Request

`GET /admin/users`

### Authentication

Requires a valid admin authentication token.

### Query Parameters

| Parameter  | Type    | Required | Description            | Constraints                     |
|------------|---------|----------|------------------------|--------------------------------|
| `page`     | Integer | No       | Page number            | Default: 1, Min: 1              |
| `per_page` | Integer | No       | Items per page         | Default: 10, Max: 100           |
| `role`     | String  | No       | Filter by user role    | Values: user, admin, manager    |
| `status`   | String  | No       | Filter by user status  | Values: active, inactive        |
| `search`   | String  | No       | Search term            | Searches name, email, phone     |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "User list retrieved successfully",
  "data": [
    {
      "id": 123,
      "name": "John Doe",
      "surname": "Doe",
      "email": "john@example.com",
      "role": "user",
      "active": true,
      "created_at": "2023-04-01T10:20:30Z"
    },
    {
      "id": 124,
      "name": "Jane Smith",
      "surname": "Smith",
      "email": "jane@example.com",
      "role": "admin",
      "active": true,
      "created_at": "2023-04-02T11:20:30Z"
    }
  ],
  "meta": {
    "current_page": 1,
    "total_pages": 5,
    "total": 45,
    "per_page": 10
  }
}
```

For HTMX requests (with `HX-Request: true` header), returns HTML table rows.

### Error Codes

| Status Code | Error Code         | Description                                    |
|-------------|-------------------|------------------------------------------------|
| 401         | `UNAUTHORIZED`     | User not authenticated                         |
| 403         | `FORBIDDEN`        | User does not have admin privileges            |
| 500         | `SERVER_ERROR`     | Failed to retrieve users                       |

### Notes

- Sensitive user data like password hashes are never included
- User list access is logged for audit purposes
- Pagination headers are included for UI controls
- Supports both JSON and HTML responses for different UI approaches

---

## Get User by ID

Retrieve detailed information for a specific user.

### HTTP Request

`GET /admin/users/{id}`

### Authentication

Requires a valid admin authentication token.

### Path Parameters

| Parameter | Type    | Required | Description     | Constraints                     |
|-----------|---------|----------|-----------------|--------------------------------|
| `id`      | Integer | Yes      | User identifier | Must be a valid user ID         |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "User retrieved successfully",
  "data": {
    "id": 123,
    "name": "John",
    "surname": "Doe",
    "email": "john@example.com",
    "role": "user",
    "phone": "+1234567890",
    "address": "123 Main St, Anytown, USA",
    "active": true,
    "created_at": "2023-04-01T10:20:30Z",
    "updated_at": "2023-05-15T14:30:45Z",
    "last_login": "2023-06-01T08:22:10Z",
    "metadata": {
      "registration_source": "web",
      "referral_code": "REF123"
    }
  }
}
```

### Error Codes

| Status Code | Error Code           | Description                                    |
|-------------|---------------------|------------------------------------------------|
| 401         | `UNAUTHORIZED`       | User not authenticated                         |
| 403         | `FORBIDDEN`          | User does not have admin privileges            |
| 404         | `USER_NOT_FOUND`     | User not found                                 |
| 500         | `SERVER_ERROR`       | Failed to retrieve user                        |

### Notes

- More detailed user information than the list endpoint
- Viewing user details is logged for audit purposes
- Includes important but non-sensitive metadata

---

## Create User

Create a new user account.

### HTTP Request

`POST /admin/users`

### Authentication

Requires a valid admin authentication token.

### Request Body Parameters

| Parameter | Type   | Required | Description           | Constraints                    |
|-----------|--------|----------|-----------------------|-------------------------------|
| `name`    | String | Yes      | User's first name     | Max: 50 characters            |
| `surname` | String | Yes      | User's last name      | Max: 50 characters            |
| `email`   | String | Yes      | User's email address  | Valid email format            |
| `password`| String | Yes      | User's password       | Min: 8 characters             |
| `role`    | String | No       | User's role           | Default: "user"               |
| `phone`   | String | No       | User's phone number   | Valid phone number format     |
| `active`  | Boolean| No       | User's status         | Default: true                 |

### Example Request

```json
{
  "name": "Jane",
  "surname": "Smith",
  "email": "jane@example.com",
  "password": "securePassword123",
  "role": "user",
  "phone": "+1987654321",
  "active": true
}
```

### Response

Status code: `201 Created`

```json
{
  "status": "success",
  "message": "User created successfully",
  "data": {
    "id": 125,
    "name": "Jane",
    "surname": "Smith",
    "email": "jane@example.com",
    "role": "user",
    "active": true,
    "created_at": "2023-06-15T14:30:00Z"
  }
}
```

### Error Codes

| Status Code | Error Code           | Description                                    |
|-------------|---------------------|------------------------------------------------|
| 400         | `VALIDATION_ERROR`   | Invalid or missing required fields             |
| 400         | `EMAIL_EXISTS`       | Email address is already in use                |
| 401         | `UNAUTHORIZED`       | User not authenticated                         |
| 403         | `FORBIDDEN`          | User does not have admin privileges            |
| 500         | `USER_CREATION_FAILED`| Failed to create user                        |

### Notes

- Password is automatically hashed before storage
- User creation is logged for audit purposes
- Email verification may be required depending on settings
- Admins can create users with specific roles

---

## Update User Details

Update details for an existing user.

### HTTP Request

`PUT /admin/users/{id}`

### Authentication

Requires a valid admin authentication token.

### Path Parameters

| Parameter | Type    | Required | Description     | Constraints                     |
|-----------|---------|----------|-----------------|--------------------------------|
| `id`      | Integer | Yes      | User identifier | Must be a valid user ID         |

### Request Body Parameters

| Parameter | Type   | Required | Description           | Constraints                    |
|-----------|--------|----------|-----------------------|-------------------------------|
| `name`    | String | No       | User's first name     | Max: 50 characters            |
| `surname` | String | No       | User's last name      | Max: 50 characters            |
| `phone`   | String | No       | User's phone number   | Valid phone number format     |
| `address` | String | No       | User's address        | Max: 200 characters           |
| `metadata`| Object | No       | User metadata         | Valid JSON object             |

### Example Request

```json
{
  "name": "Jane",
  "surname": "Smith-Johnson",
  "phone": "+1987654321",
  "address": "456 Oak St, Newtown, USA"
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "User updated successfully",
  "data": {
    "id": 125,
    "name": "Jane",
    "surname": "Smith-Johnson",
    "email": "jane@example.com",
    "role": "user",
    "phone": "+1987654321",
    "address": "456 Oak St, Newtown, USA",
    "active": true,
    "updated_at": "2023-06-15T15:22:12Z"
  }
}
```

### Error Codes

| Status Code | Error Code           | Description                                    |
|-------------|---------------------|------------------------------------------------|
| 400         | `VALIDATION_ERROR`   | Invalid field values                           |
| 401         | `UNAUTHORIZED`       | User not authenticated                         |
| 403         | `FORBIDDEN`          | User does not have admin privileges            |
| 404         | `USER_NOT_FOUND`     | User not found                                 |
| 500         | `UPDATE_FAILED`      | Failed to update user                          |

### Notes

- Email and password updates are handled by separate endpoints for security
- User update is logged for audit purposes
- Partial updates are supported - only provide fields that need changes

---

## Toggle User Status

Enable or disable a user account.

### HTTP Request

`POST /admin/users/{id}/status`

### Authentication

Requires a valid admin authentication token.

### Path Parameters

| Parameter | Type    | Required | Description     | Constraints                     |
|-----------|---------|----------|-----------------|--------------------------------|
| `id`      | Integer | Yes      | User identifier | Must be a valid user ID         |

### Request Body Parameters

| Parameter | Type    | Required | Description        | Constraints                     |
|-----------|---------|----------|--------------------|--------------------------------|
| `active`  | Boolean | Yes      | New status value   | true or false                   |

### Example Request

```json
{
  "active": false
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "User status changed successfully",
  "data": {
    "active": false
  }
}
```

For HTMX requests, returns updated status component HTML.

### Error Codes

| Status Code | Error Code           | Description                                    |
|-------------|---------------------|------------------------------------------------|
| 400         | `MISSING_STATUS`     | Active status not specified                     |
| 401         | `UNAUTHORIZED`       | User not authenticated                         |
| 403         | `FORBIDDEN`          | User does not have admin privileges            |
| 404         | `USER_NOT_FOUND`     | User not found                                 |
| 500         | `STATUS_CHANGE_FAILED`| Failed to change user status                   |

### Notes

- Inactive users cannot log in to the system
- Existing sessions for deactivated users are invalidated
- Status changes are logged for audit purposes
- Cannot deactivate your own admin account

---

## Update User Role

Change a user's role in the system.

### HTTP Request

`POST /admin/users/{id}/role`

### Authentication

Requires a valid admin authentication token.

### Path Parameters

| Parameter | Type    | Required | Description     | Constraints                     |
|-----------|---------|----------|-----------------|--------------------------------|
| `id`      | Integer | Yes      | User identifier | Must be a valid user ID         |

### Request Body Parameters

| Parameter | Type   | Required | Description      | Constraints                     |
|-----------|--------|----------|------------------|--------------------------------|
| `role`    | String | Yes      | New role to assign| Values: user, admin, manager    |

### Example Request

```json
{
  "role": "manager"
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "User role updated successfully"
}
```

For HTMX requests, returns updated role component HTML.

### Error Codes

| Status Code | Error Code           | Description                                    |
|-------------|---------------------|------------------------------------------------|
| 400         | `INVALID_ROLE`       | Role is invalid                                |
| 401         | `UNAUTHORIZED`       | User not authenticated                         |
| 403         | `FORBIDDEN`          | User does not have admin privileges            |
| 404         | `USER_NOT_FOUND`     | User not found                                 |
| 500         | `ROLE_UPDATE_FAILED` | Failed to update user role                     |

### Notes

- Role changes may affect user permissions immediately
- Role changes are logged for audit purposes
- Cannot downgrade your own admin role
- Role hierarchy enforcement prevents privilege escalation

---

## Delete User

Soft-delete a user from the system.

### HTTP Request

`DELETE /admin/users/{id}`

### Authentication

Requires a valid admin authentication token.

### Path Parameters

| Parameter | Type    | Required | Description     | Constraints                     |
|-----------|---------|----------|-----------------|--------------------------------|
| `id`      | Integer | Yes      | User identifier | Must be a valid user ID         |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "User deleted successfully"
}
```

### Error Codes

| Status Code | Error Code           | Description                                    |
|-------------|---------------------|------------------------------------------------|
| 401         | `UNAUTHORIZED`       | User not authenticated                         |
| 403         | `FORBIDDEN`          | User does not have admin privileges            |
| 403         | `CANNOT_DELETE_SELF` | Cannot delete your own account                 |
| 404         | `USER_NOT_FOUND`     | User not found                                 |
| 500         | `DELETE_FAILED`      | Failed to delete user                          |

### Notes

- This is a soft delete - user data remains in the database but is marked as deleted
- Deleted users cannot log in or use the system
- User delete is logged for audit purposes
- Associated data may be anonymized but preserved for integrity
- Cannot delete your own admin account

---

## Create Admin User

Create a new user with admin privileges.

### HTTP Request

`POST /admin/users/admin`

### Authentication

Requires a valid admin authentication token.

### Request Body Parameters

| Parameter | Type   | Required | Description           | Constraints                    |
|-----------|--------|----------|-----------------------|-------------------------------|
| `name`    | String | Yes      | Admin's first name    | Max: 50 characters            |
| `email`   | String | Yes      | Admin's email address | Valid email format            |
| `password`| String | Yes      | Admin's password      | Min: 8 characters             |
| `role`    | String | No       | Admin role level      | Default: "admin"              |

### Example Request

```json
{
  "name": "Robert",
  "email": "robert@example.com",
  "password": "secureAdminPassword123",
  "role": "admin"
}
```

### Response

Status code: `201 Created`

```json
{
  "status": "success",
  "message": "Admin created successfully",
  "data": {
    "id": 126,
    "name": "Robert",
    "email": "robert@example.com",
    "role": "admin",
    "created_at": "2023-06-15T16:45:22Z"
  }
}
```

### Error Codes

| Status Code | Error Code           | Description                                    |
|-------------|---------------------|------------------------------------------------|
| 400         | `VALIDATION_ERROR`   | Invalid or missing required fields             |
| 400         | `EMAIL_EXISTS`       | Email address is already in use                |
| 401         | `UNAUTHORIZED`       | User not authenticated                         |
| 403         | `FORBIDDEN`          | User does not have sufficient admin privileges |
| 500         | `ADMIN_CREATION_FAILED`| Failed to create admin user                 |

### Notes

- Creating admin users requires elevated permissions
- Admin creation is logged for audit purposes with detailed context
- Enhanced security measures like mandatory 2FA may apply for admin accounts
- Admin users cannot be created through the standard user registration flow
=== docs/backend/api/endpoints/signatures.md ===
# Signatures API Endpoints

## Overview

The Signatures API enables secure electronic signature management for documents and contracts. These endpoints handle signature upload, verification, and retrieval for legal documents within the CarFuse platform.

## Authentication and Permissions

| Endpoint Pattern                | Required Role | Notes                                      |
|--------------------------------|---------------|-------------------------------------------|
| `POST /signatures/upload`       | User          | Upload a signature                         |
| `POST /signatures/verify`       | User          | Verify signature against document hash     |
| `GET /signatures/user/{userId}` | User          | Retrieve a user's signature                |
| `POST /signatures/document`     | User          | Sign a specific document                   |
| `GET /signatures/status/{documentId}` | User    | Check signature status for a document      |

## Rate Limiting

Signature endpoints have the following rate limits:
- Standard tier: 20 requests per minute
- Premium tier: 50 requests per minute
- Signature upload: 10 requests per hour per user
- Verification: 60 requests per hour per user

---

## Upload Signature

Upload a new signature for the authenticated user.

### HTTP Request

`POST /signatures/upload`

### Authentication

Requires a valid user authentication token.

### Request Body Parameters

This endpoint expects a multipart/form-data request with the following parameters:

| Parameter | Type    | Required | Description                  | Constraints                       |
|-----------|---------|----------|------------------------------|----------------------------------|
| `user_id` | Integer | Yes      | User ID                      | Must match authenticated user ID  |
| `file`    | File    | Yes      | Signature image or data file | PNG, JPG, JPEG; Max size: 2MB     |
| `type`    | String  | No       | Signature type               | Values: image, vector, drawn; Default: image |

### Response

Status code: `200 OK`

```json
{
  "status": "success", 
  "message": "Signature uploaded successfully", 
  "data": {
    "signature_id": 123,
    "path": "/uploads/signatures/user_123_timestamp.png",
    "created_at": "2023-06-15T14:30:00Z"
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `INVALID_FILE_FORMAT`    | File format not supported                        |
| 400         | `FILE_TOO_LARGE`         | File exceeds maximum size limit                  |
| 400         | `USER_MISMATCH`          | User ID does not match authenticated user        |
| 401         | `UNAUTHORIZED`           | User not authenticated                           |
| 500         | `UPLOAD_FAILED`          | Failed to upload signature                       |

### Notes

- Uploaded signatures are processed to ensure consistent formatting
- Previous signatures for the user are preserved but marked as inactive
- Signature upload is logged for audit and legal purposes
- Transparent background is automatically applied to image signatures

---

## Verify Signature

Verify the authenticity of a signature against a document hash.

### HTTP Request

`POST /signatures/verify`

### Authentication

Requires a valid user authentication token.

### Request Body Parameters

| Parameter        | Type   | Required | Description                  | Constraints                       |
|------------------|--------|----------|------------------------------|----------------------------------|
| `signature_id`   | Integer| Yes      | Signature identifier         | Must be a valid signature ID      |
| `document_hash`  | String | Yes      | Document hash for verification | SHA-256 hash of document content |
| `document_id`    | Integer| Yes      | Document identifier          | Must be a valid document ID       |

### Example Request

```json
{
  "signature_id": 123,
  "document_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
  "document_id": 456
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "verified": true,
  "data": {
    "signature_info": {
      "id": 123,
      "user_id": 789,
      "created_at": "2023-06-15T14:30:00Z"
    },
    "document_info": {
      "id": 456,
      "name": "Vehicle Rental Agreement",
      "signed_at": "2023-06-15T14:35:22Z"
    }
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `MISSING_PARAMETERS`     | Required parameters are missing                   |
| 400         | `INVALID_HASH_FORMAT`    | Document hash format is invalid                   |
| 401         | `UNAUTHORIZED`           | User not authenticated                           |
| 403         | `PERMISSION_DENIED`      | User does not have permission for this signature |
| 404         | `SIGNATURE_NOT_FOUND`    | Signature not found                              |
| 404         | `DOCUMENT_NOT_FOUND`     | Document not found                               |
| 500         | `VERIFICATION_FAILED`    | Failed to verify signature                       |

### Notes

- Successful verification confirms signature was applied to document
- Verification results are logged for audit and compliance purposes
- Digital signatures include timestamp and user identification
- Failed verifications may indicate tampering or document changes

---

## Retrieve User Signature

Retrieve the signature for a specific user.

### HTTP Request

`GET /signatures/user/{userId}`

### Authentication

Requires a valid user authentication token.

### Path Parameters

| Parameter | Type    | Required | Description         | Constraints                     |
|-----------|---------|----------|---------------------|--------------------------------|
| `userId`  | Integer | Yes      | User identifier     | Must be a valid user ID         |

### Query Parameters

| Parameter | Type    | Required | Description                  | Constraints                       |
|-----------|---------|----------|------------------------------|----------------------------------|
| `format`  | String  | No       | Format of signature to return| Values: base64, url; Default: url |

### Response

Status code: `200 OK`

If format is url (default):
```json
{
  "status": "success",
  "data": {
    "signature": {
      "id": 123,
      "user_id": 789,
      "path": "/uploads/signatures/user_789_timestamp.png",
      "type": "image",
      "created_at": "2023-06-15T14:30:00Z"
    }
  }
}
```

If format is base64:
```json
{
  "status": "success",
  "data": {
    "signature": {
      "id": 123,
      "user_id": 789,
      "data": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
      "type": "image",
      "created_at": "2023-06-15T14:30:00Z"
    }
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `INVALID_USER_ID`        | User ID is invalid                               |
| 401         | `UNAUTHORIZED`           | User not authenticated                           |
| 403         | `PERMISSION_DENIED`      | User does not have permission to access this signature |
| 404         | `SIGNATURE_NOT_FOUND`    | No signature found for user                      |
| 404         | `USER_NOT_FOUND`         | User not found                                   |
| 500         | `SERVER_ERROR`           | Failed to retrieve signature                     |

### Notes

- Users can only access their own signatures unless they are admins
- Most recent active signature is returned if user has multiple signatures
- Signature retrieval is logged for audit purposes
- Access to signatures is strictly controlled for security and legal reasons

---

## Sign Document

Apply a user's signature to a specific document.

### HTTP Request

`POST /signatures/document`

### Authentication

Requires a valid user authentication token.

### Request Body Parameters

| Parameter        | Type    | Required | Description                  | Constraints                       |
|------------------|---------|----------|------------------------------|----------------------------------|
| `document_id`    | Integer | Yes      | Document identifier          | Must be a valid document ID       |
| `signature_id`   | Integer | Yes      | Signature identifier         | Must be a valid signature ID      |
| `position_x`     | Integer | No       | X-coordinate on document     | Default based on document type    |
| `position_y`     | Integer | No       | Y-coordinate on document     | Default based on document type    |
| `page`           | Integer | No       | Document page to sign        | Default: 1                        |
| `scale`          | Float   | No       | Signature scale factor       | Range: 0.5-2.0; Default: 1.0      |

### Example Request

```json
{
  "document_id": 456,
  "signature_id": 123,
  "page": 3,
  "position_x": 350,
  "position_y": 500,
  "scale": 0.8
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Document signed successfully",
  "data": {
    "signature_id": 123,
    "document_id": 456,
    "signed_at": "2023-06-15T14:35:22Z",
    "download_url": "/documents/signed/456.pdf"
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `MISSING_PARAMETERS`     | Required parameters are missing                   |
| 400         | `INVALID_POSITION`       | Position coordinates are invalid                  |
| 401         | `UNAUTHORIZED`           | User not authenticated                           |
| 403         | `PERMISSION_DENIED`      | User does not have permission to sign this document |
| 404         | `DOCUMENT_NOT_FOUND`     | Document not found                               |
| 404         | `SIGNATURE_NOT_FOUND`    | Signature not found                              |
| 500         | `SIGNING_FAILED`         | Failed to sign document                          |

### Notes

- Document signing creates a legally binding electronic signature
- Document hash is calculated and stored for verification
- A new signed version of the document is created, preserving the original
- Digital certificate is applied to ensure document integrity
- Document signing is logged with user details and timestamp for legal compliance

---

## Check Signature Status

Check the signature status of a document.

### HTTP Request

`GET /signatures/status/{documentId}`

### Authentication

Requires a valid user authentication token.

### Path Parameters

| Parameter    | Type    | Required | Description         | Constraints                     |
|-------------|---------|----------|---------------------|--------------------------------|
| `documentId`| Integer | Yes      | Document identifier | Must be a valid document ID     |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "data": {
    "document_id": 456,
    "document_name": "Vehicle Rental Agreement",
    "is_signed": true,
    "signatures": [
      {
        "user_id": 789,
        "user_name": "John Doe",
        "signed_at": "2023-06-15T14:35:22Z",
        "signature_id": 123,
        "position": {"page": 3, "x": 350, "y": 500}
      },
      {
        "user_id": 790,
        "user_name": "Jane Smith",
        "signed_at": "2023-06-15T16:42:10Z",
        "signature_id": 124,
        "position": {"page": 3, "x": 350, "y": 600}
      }
    ],
    "pending_signatures": [
      {
        "user_id": 791,
        "user_name": "Robert Johnson",
        "status": "pending"
      }
    ],
    "completed": false
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `INVALID_DOCUMENT_ID`    | Document ID is invalid                           |
| 401         | `UNAUTHORIZED`           | User not authenticated                           |
| 403         | `PERMISSION_DENIED`      | User does not have permission to access this document |
| 404         | `DOCUMENT_NOT_FOUND`     | Document not found                               |
| 500         | `SERVER_ERROR`           | Failed to check signature status                 |

### Notes

- Returns all signatures applied to the document
- Includes list of pending signatures if multi-party signing is required
- Document is considered fully signed only when all required parties have signed
- Status check is read-only and does not modify the document
=== docs/backend/api/endpoints/auth.md ===
# Authentication API Endpoints

## Overview

The authentication system in CarFuse employs a hybrid approach, combining JWT (JSON Web Tokens) with traditional PHP session management for maximum security and flexibility.

### Authentication Methods

- **JWT Authentication**: Used primarily for API requests, with tokens stored in secure HttpOnly cookies
- **Session Authentication**: Used for web UI access, with secure PHP native sessions
- **Hybrid Approach**: Some endpoints support both methods depending on context

### Key Components

- **SessionMiddleware**: Configures secure PHP sessions with protection against session fixation, hijacking, and CSRF
- **TokenValidationMiddleware**: Validates JWT tokens from cookies or Authorization headers
- **RequireAuthMiddleware**: Ensures a user is authenticated before accessing protected resources
- **SecurityHelper**: Provides session integrity validation, CSRF protection, and security logging

## Authentication Flow

1. **Login Process**:
   - User submits credentials to `/auth/login`
   - JWT and refresh tokens are set as HttpOnly cookies
   - Session is also established with security fingerprinting
   
2. **Authenticated Requests**:
   - API requests: Validated via TokenValidationMiddleware
   - Web UI requests: Validated via session checks
   - Session integrity verified by IP and user-agent fingerprinting
   
3. **Session Security**:
   - Sessions regenerated every 30 minutes to prevent fixation
   - Automatic timeout after 30 minutes of inactivity
   - CSRF tokens required for sensitive operations

## Authentication and Permissions

| Endpoint Pattern         | Required Role | Auth Method        | Notes                                       |
|--------------------------|---------------|--------------------|--------------------------------------------|
| `POST /auth/login`       | None          | -                  | Public endpoint to authenticate users        |
| `POST /auth/register`    | None          | -                  | Public endpoint in UserController            |
| `GET /auth/user`         | User          | JWT or Session     | Get authenticated user details              |
| `POST /auth/logout`      | User          | JWT or Session     | Invalidates both JWT and session            |
| `POST /auth/reset_request` | None        | -                  | Request password reset (no auth required)   |
| `POST /auth/reset`       | None          | Reset Token        | Reset password with single-use token        |
| `GET /user/profile`      | User          | JWT or Session     | Get user profile (in UserController)        |
| `POST /user/profile`     | User          | JWT or Session     | Update user profile (in UserController)     |

## Rate Limiting

Authentication endpoints employ strict rate limits to prevent brute force attacks:
- Login: 10 attempts per minute per IP address/email
- Registration: 5 attempts per hour per IP address
- Password reset request: 3 attempts per hour per email
- Password reset: 5 attempts per hour per token

---

## User Login

Authenticates a user and provides access tokens.

### HTTP Request

`POST /auth/login`

### Request Body Parameters

| Parameter | Type   | Required | Description              | Constraints                     |
|-----------|--------|----------|--------------------------|--------------------------------|
| `email`   | String | Yes      | User's email address     | Valid email format             |
| `password`| String | Yes      | User's password          | Min length: 6 characters       |

### Example Request

```json
{
  "email": "user@example.com",
  "password": "securePassword123"
}
```

### Response

Status code: `200 OK`

```json
{
  "message": "Login successful",
  "user_id": 123,
  "name": "John Doe"
}
```

JWT and refresh tokens are sent as secure HttpOnly cookies with the following properties:
- `jwt`: 1-hour expiration, Secure, HttpOnly, SameSite=Strict
- `refresh_token`: 7-day expiration, Secure, HttpOnly, SameSite=Strict

### Error Codes

| Status Code | Error Code          | Description                                      |
|-------------|---------------------|--------------------------------------------------|
| 400         | `INVALID_INPUT`     | Missing required fields                          |
| 401         | `UNAUTHORIZED`      | Invalid email or password                        |
| 429         | `TOO_MANY_ATTEMPTS` | Too many login attempts, try again later       |

### Implementation Notes

- Implemented in `AuthController::login()`
- Rate limiting is enforced by `RateLimiter` service
- Login failures are securely logged for anomaly detection

---

## User Registration

Register a new user account.

### HTTP Request

`POST /auth/register` (mapped to UserController::registerUser)

### Request Body Parameters

| Parameter         | Type   | Required | Description            | Constraints                     |
|-------------------|--------|----------|------------------------|--------------------------------|
| `name`            | String | Yes      | User's name            | Required string                 |
| `email`           | String | Yes      | User's email address   | Valid email format             |
| `password`        | String | Yes      | User's password        | Min length: 6 characters       |

### Example Request

```json
{
  "name": "John Doe",
  "email": "john.doe@example.com",
  "password": "securePassword123"
}
```

### Response

Status code: `201 Created`

```json
{
  "status": "success",
  "message": "User registered successfully",
  "user_id": 123
}
```

### Error Codes

| Status Code | Error Code      | Description                                      |
|-------------|-----------------|--------------------------------------------------|
| 400         | `error`         | Missing required fields or validation failed     |
| 400         | `error`         | Email already in use                            |
| 500         | `error`         | Registration failed due to server error          |

### Implementation Notes

- Implemented in `UserController::registerUser()`
- Password is securely hashed by the User model
- Default role 'user' is assigned to new registrations

---

## User Logout

Invalidates current user authentication.

### HTTP Request

`POST /auth/logout`

### Authentication

Requires valid JWT token or active session.

### Response

Status code: `200 OK`

```json
{
  "message": "Logout successful"
}
```

JWT and refresh token cookies are cleared, and PHP session is destroyed.

### Error Codes

| Status Code | Error Code     | Description                                      |
|-------------|----------------|--------------------------------------------------|
| 500         | `error`        | Logout failed due to server error                |

### Implementation Notes

- Implemented in `AuthController::logout()`
- Clears both JWT cookies and PHP session data
- Can be accessed via API or web interface

---

## Get Authenticated User

Get details of the currently authenticated user.

### HTTP Request

`GET /auth/user`

### Authentication

Requires valid JWT token or active session.

### Response

Status code: `200 OK`

```json
{
  "user": {
    "id": 123,
    "name": "John Doe",
    "email": "john.doe@example.com",
    "role": "user",
    "created_at": "2023-01-15T08:30:45Z"
  }
}
```

### Error Codes

| Status Code | Error Code     | Description                                      |
|-------------|----------------|--------------------------------------------------|
| 401         | `error`        | Authentication required                          |
| 500         | `error`        | Failed to get user details                       |

### Implementation Notes

- Implemented in `AuthController::userDetails()`
- Relies on RequireAuthMiddleware for authentication
- Removes sensitive fields like password_hash from response

---

## Request Password Reset

Request a password reset link via email.

### HTTP Request

`POST /auth/reset_request`

### Request Body Parameters

| Parameter | Type   | Required | Description              | Constraints                     |
|-----------|--------|----------|--------------------------|--------------------------------|
| `email`   | String | Yes      | User's email address     | Valid email format             |

### Example Request

```json
{
  "email": "user@example.com"
}
```

### Response

Status code: `200 OK`

```json
{
  "message": "Password reset email sent"
}
```

### Error Codes

| Status Code | Error Code     | Description                                      |
|-------------|----------------|--------------------------------------------------|
| 400         | `error`        | Missing or invalid email                         |
| 500         | `error`        | Password reset request failed                    |

### Implementation Notes

- Implemented in both `AuthController::resetPasswordRequest()` and `UserController::requestPasswordReset()`
- For security, returns success even if email doesn't exist
- Generates a secure token that expires in 1 hour
- Records IP address of requester for security monitoring

---

## Reset Password

Reset password using a token received via email.

### HTTP Request

`POST /auth/reset`

### Request Body Parameters

| Parameter         | Type   | Required | Description              | Constraints                     |
|-------------------|--------|----------|--------------------------|--------------------------------|
| `token`           | String | Yes      | Password reset token     | Valid reset token              |
| `password`        | String | Yes      | New password             | Min length: 6 characters       |
| `confirm_password`| String | Yes      | Confirm new password     | Must match `password`          |

### Example Request

```json
{
  "token": "a1b2c3d4e5...",
  "password": "newSecurePassword123",
  "confirm_password": "newSecurePassword123"
}
```

### Response

Status code: `200 OK`

```json
{
  "message": "Password has been reset successfully"
}
```

### Error Codes

| Status Code | Error Code     | Description                                      |
|-------------|----------------|--------------------------------------------------|
| 400         | `error`        | Missing required fields or passwords don't match |
| 400         | `error`        | Invalid or expired token                         |
| 500         | `error`        | Password reset failed                            |

### Implementation Notes

- Implemented in both `AuthController::resetPassword()` and `UserController::resetPassword()`
- Validates token expiration and single-use status
- Updates password with secure hashing
- Invalidates previous sessions for security

---

## User Profile Management

Profile management endpoints are handled by UserController.

### HTTP Request

`GET /user/profile`

### Authentication

Requires valid JWT token or active session.

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "User profile retrieved",
  "data": {
    "id": 123,
    "name": "John Doe",
    "email": "john@example.com",
    "bio": "Example bio",
    "location": "New York"
  }
}
```

### Implementation Notes

- Implemented in `UserController::getUserProfile()`
- Updates are handled by `UserController::updateUserProfile()`
- All profile operations require authentication

---

## Applying Middleware to Routes

### Example Middleware Stack

```php
// Protected route requiring authentication
$app->get('/api/secure-resource', 'ResourceController:getResource')
    ->add(RequireAuthMiddleware::class)
    ->add(TokenValidationMiddleware::class)
    ->add(SessionMiddleware::class);

// Public route with optional authentication
$app->get('/api/public-resource', 'ResourceController:getPublicResource')
    ->add(TokenValidationMiddleware::class)
    ->add(SessionMiddleware::class);
```

### Middleware Processing Flow

1. `SessionMiddleware` initializes secure session
2. `TokenValidationMiddleware` extracts and validates JWT token
3. `RequireAuthMiddleware` ensures user is authenticated

### Authentication Error Responses

```json
// 401 Unauthorized from TokenValidationMiddleware
{
  "status": "error",
  "message": "Unauthorized"
}

// 401 Unauthorized from RequireAuthMiddleware
{
  "error": "Authentication required",
  "status": 401
}
```

## Security Implementation Details

### Session Security (SecurityHelper)

- **Session Integrity**: IP and User-Agent fingerprinting
- **Session Regeneration**: IDs regenerated every 30 minutes
- **Expiry Enforcement**: Automatic timeout after 30 minutes of inactivity
- **CSRF Protection**: Token generation and validation for form submissions

### Token Validation Process

1. Extract token from HTTP-only cookie or Authorization header
2. Validate token signature and expiration
3. Retrieve and populate user information
4. Add user data to request attributes for controllers

### Rate Limiting Configuration

Rate limiting is applied to sensitive authentication endpoints:
- Login attempts are limited by both email and IP address
- Password reset requests are limited by email address
- All limits are configured in the RateLimiter service
=== docs/backend/api/endpoints/users.md ===
# User Management API Endpoints

## Overview

The User Management API provides endpoints for managing user accounts, profiles, and account settings. This documentation distinguishes between API endpoints (JSON-based) and UI endpoints (HTML/form-based).

## Authentication and Permissions

| Endpoint Pattern              | Required Role | Authentication Method | Notes                                     |
|-------------------------------|---------------|----------------------|-------------------------------------------|
| `POST /users/register`        | None          | None                 | Public JSON endpoint to register users    |
| `GET /users/profile`          | User          | Token                | JSON API for profile retrieval            |
| `PUT /users/profile`          | User          | Token                | JSON API for profile updates              |
| `POST /users/password/reset-request` | None   | None                 | Public JSON endpoint for password reset   |
| `POST /users/password/reset`  | None          | None                 | Reset password with token (JSON)          |
| `GET /users/dashboard`        | User          | Token                | JSON API for dashboard data               |
| `GET /users/profile/page`     | User          | Session              | HTML page for user profile                |
| `POST /users/profile/update`  | User          | Session              | Form-based profile update (supports files)|
| `POST /users/password/change` | User          | Session              | Form-based password change                |

## Rate Limiting

The following rate limits apply to user management endpoints:
- Registration: 5 attempts per hour per IP address
- Password operations: 10 attempts per hour per user or IP address
- Profile updates: 30 requests per hour per user

---

## JSON API Endpoints

### Register User

Create a new user account in the system.

#### HTTP Request

`POST /users/register`

#### Content-Type

`application/json`

#### Request Body Parameters

| Parameter  | Type   | Required | Description           | Constraints                    |
|------------|--------|----------|-----------------------|-------------------------------|
| `email`    | String | Yes      | User's email address  | Valid email format            |
| `password` | String | Yes      | User's password       | Min: 6 characters             |
| `name`     | String | Yes      | User's name           | Non-empty string              |

#### Example Request

```json
{
  "email": "new.user@example.com",
  "password": "securePassword123",
  "name": "Jane Smith"
}
```

#### Response

Status code: `201 Created`

```json
{
  "status": "success",
  "message": "User registered successfully",
  "data": {
    "user_id": "123"
  }
}
```

#### Error Codes

| Status Code | Error Code           | Description                                    |
|-------------|----------------------|------------------------------------------------|
| 400         | `VALIDATION_ERROR`   | Missing required fields or validation failed   |
| 400         | `EMAIL_IN_USE`       | Email address is already registered            |
| 500         | `REGISTRATION_FAILED`| Server failed to process registration          |

#### Notes

- Users are assigned the default "user" role automatically
- Passwords are securely hashed before storage
- New user accounts are logged in the audit trail

---

### Get User Profile

Retrieve the profile information of the authenticated user.

#### HTTP Request

`GET /users/profile`

#### Authentication

Requires a valid authentication token in the Authorization header.

#### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "User profile retrieved",
  "data": {
    "id": "123",
    "name": "Jane Smith",
    "email": "jane.smith@example.com",
    "bio": "Software developer",
    "location": "New York",
    "avatar_url": "/uploads/avatars/123.jpg",
    "created_at": "2023-05-01T14:30:45Z",
    "updated_at": "2023-06-15T09:22:18Z"
  }
}
```

#### Error Codes

| Status Code | Error Code           | Description                                  |
|-------------|----------------------|----------------------------------------------|
| 401         | `UNAUTHORIZED`       | User not authenticated                       |
| 404         | `USER_NOT_FOUND`     | User account not found                       |
| 500         | `SERVER_ERROR`       | Failed to retrieve profile                   |

#### Notes

- Profile views are logged for security auditing
- Sensitive data is excluded from the response

---

### Update User Profile (JSON API)

Update the profile information of the authenticated user.

#### HTTP Request

`PUT /users/profile`

#### Authentication

Requires a valid authentication token in the Authorization header.

#### Content-Type

`application/json`

#### Request Body Parameters

| Parameter   | Type   | Required | Description            | Constraints                     |
|-------------|--------|----------|------------------------|--------------------------------|
| `name`      | String | No       | User's name            | Max: 100 characters            |
| `bio`       | String | No       | User biography         | Max: 500 characters            |
| `location`  | String | No       | User location          | Max: 100 characters            |
| `avatar_url`| String | No       | URL to user avatar     | Valid URL format, Max: 255 chars|

#### Example Request

```json
{
  "name": "Jane Smith",
  "bio": "Senior Software Developer with 10 years experience",
  "location": "New York, USA"
}
```

#### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Profile updated successfully",
  "data": {
    "id": "123",
    "name": "Jane Smith",
    "email": "jane.smith@example.com",
    "bio": "Senior Software Developer with 10 years experience",
    "location": "New York, USA",
    "avatar_url": "/uploads/avatars/123.jpg",
    "updated_at": "2023-06-15T10:22:18Z"
  }
}
```

#### Error Codes

| Status Code | Error Code           | Description                                  |
|-------------|----------------------|----------------------------------------------|
| 400         | `VALIDATION_ERROR`   | Invalid field values                         |
| 401         | `UNAUTHORIZED`       | User not authenticated                       |
| 500         | `UPDATE_FAILED`      | Failed to update profile                     |

#### Notes

- Profile updates are logged in the audit trail
- Only fields that need to be updated should be included in the request

---

### Request Password Reset

Request a password reset link via email.

#### HTTP Request

`POST /users/password/reset-request`

#### Content-Type

`application/json`

#### Request Body Parameters

| Parameter | Type   | Required | Description           | Constraints           |
|-----------|--------|----------|----------------------|----------------------|
| `email`   | String | Yes      | User's email address | Valid email format    |

#### Example Request

```json
{
  "email": "user@example.com"
}
```

#### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "If your email is in our system, you will receive reset instructions shortly"
}
```

#### Error Codes

| Status Code | Error Code           | Description                                  |
|-------------|----------------------|----------------------------------------------|
| 400         | `INVALID_EMAIL`      | Invalid email format                         |
| 500         | `REQUEST_FAILED`     | Failed to process reset request              |

#### Notes

- For security reasons, success response is returned even if email is not found
- IP address of the request is logged
- Reset tokens expire after 1 hour
- Reset requests are logged in the audit trail

---

### Reset Password with Token

Reset a user's password using a valid reset token.

#### HTTP Request

`POST /users/password/reset`

#### Content-Type

`application/json`

#### Request Body Parameters

| Parameter | Type   | Required | Description           | Constraints                    |
|-----------|--------|----------|-----------------------|-------------------------------|
| `token`   | String | Yes      | Password reset token  | Valid non-expired token       |
| `password`| String | Yes      | New password          | Min: 6 characters             |

#### Example Request

```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "password": "newSecurePassword456"
}
```

#### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Password has been reset successfully"
}
```

#### Error Codes

| Status Code | Error Code           | Description                                  |
|-------------|----------------------|----------------------------------------------|
| 400         | `INVALID_INPUT`      | Missing token or password                    |
| 400         | `PASSWORD_TOO_SHORT` | Password does not meet minimum requirements  |
| 400         | `INVALID_TOKEN`      | Token is invalid or expired                  |
| 500         | `RESET_FAILED`       | Failed to reset password                     |

#### Notes

- Tokens are single-use and expire after 1 hour
- Password resets are logged in the audit trail
- Passwords are securely hashed before storage

---

### User Dashboard

Retrieve user's dashboard data including account information and recent activities.

#### HTTP Request

`GET /users/dashboard`

#### Authentication

Requires a valid authentication token in the Authorization header.

#### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "User Dashboard",
  "data": {
    "user": {
      "id": "123",
      "name": "Jane Smith",
      "email": "jane.smith@example.com",
      "avatar_url": "/uploads/avatars/123.jpg"
    },
    "recent_activity": [
      {
        "id": 1,
        "type": "profile_updated",
        "description": "Updated profile information",
        "timestamp": "2023-06-10T14:30:45Z",
        "ip_address": "192.168.1.1"
      },
      {
        "id": 2,
        "type": "login",
        "description": "Successful login",
        "timestamp": "2023-06-09T08:15:22Z",
        "ip_address": "192.168.1.1"
      }
    ]
  }
}
```

#### Error Codes

| Status Code | Error Code           | Description                                  |
|-------------|----------------------|----------------------------------------------|
| 401         | `UNAUTHORIZED`       | User not authenticated                       |
| 404         | `USER_NOT_FOUND`     | User account not found                       |
| 500         | `SERVER_ERROR`       | Failed to retrieve dashboard data            |

#### Notes

- Dashboard access is logged in the audit trail
- Recent activity is limited to the 5 most recent events

---

## HTML/Form-Based Endpoints

### View Profile Page

View the user profile page in HTML format.

#### HTTP Request

`GET /users/profile/page`

#### Authentication

Requires an active user session.

#### Response

Returns an HTML page with the user's profile information.

#### Error Handling

- If not authenticated, redirects to login page
- If server error occurs, redirects to error page

#### Notes

- The profile view contains user details including:
  - Name, email, bio, phone
  - Location, avatar image
  - Registration date
  - User preferences
- Profile page views are logged in the audit trail

---

### Update Profile (Form-based)

Update the user profile using a form submission.

#### HTTP Request

`POST /users/profile/update`

#### Authentication

Requires an active user session.

#### Content-Type

`multipart/form-data` (for file uploads) or `application/json`

#### Request Parameters

| Parameter     | Type   | Required | Description               | Constraints                     |
|---------------|--------|----------|---------------------------|--------------------------------|
| `name`        | String | Yes      | User's name               | Max: 100 characters            |
| `bio`         | String | No       | User biography            | Max: 500 characters            |
| `phone`       | String | No       | Phone number              | Max: 20 characters             |
| `location`    | String | No       | User location             | Max: 100 characters            |
| `avatar`      | File   | No       | Profile picture           | JPG, PNG, or GIF; Max: 2MB     |
| `remove_avatar` | String | No     | Remove profile picture    | Value: "1" to remove           |
| `preferences` | Array  | No       | User preferences          | Array of key-value pairs       |

#### Response

```json
{
  "status": "success",
  "message": "Profil zosta zaktualizowany pomylnie",
  "data": {
    "user": {
      "id": "123",
      "name": "Jane Smith",
      "email": "jane.smith@example.com",
      "bio": "Senior Developer",
      "phone": "123456789",
      "location": "New York",
      "avatar_url": "/uploads/avatars/avatar_123_1623760938.jpg"
    }
  }
}
```

#### Error Codes

| Status Code | Error Code           | Description                                  |
|-------------|----------------------|----------------------------------------------|
| 400         | `VALIDATION_ERROR`   | Form validation errors                       |
| 401         | `UNAUTHORIZED`       | User not authenticated                       |
| 500         | `AVATAR_UPLOAD_FAILED` | Failed to upload profile picture           |
| 500         | `UPDATE_FAILED`      | Failed to update profile                     |

#### Notes

- Supports both form submissions and JSON requests
- Avatar uploads have size and type restrictions
- Profile updates are logged in the audit trail

---

### Change Password (Form-based)

Change the password for the authenticated user.

#### HTTP Request

`POST /users/password/change`

#### Authentication

Requires an active user session.

#### Request Parameters

| Parameter         | Type   | Required | Description             | Constraints                    |
|-------------------|--------|----------|-------------------------|-------------------------------|
| `current_password`| String | Yes      | Current user password   | Must match current password   |
| `new_password`    | String | Yes      | New password            | Min: 6 characters             |
| `confirm_password`| String | Yes      | Confirm new password    | Must match new_password       |

#### Response

```json
{
  "status": "success",
  "message": "Haso zostao zmienione pomylnie"
}
```

#### Error Codes

| Status Code | Error Code             | Description                                  |
|-------------|------------------------|----------------------------------------------|
| 400         | `MISSING_FIELDS`       | Required fields not provided                 |
| 400         | `PASSWORDS_NOT_MATCH`  | New password and confirmation don't match    |
| 400         | `PASSWORD_TOO_SHORT`   | Password too short (minimum 6 characters)    |
| 400         | `INCORRECT_PASSWORD`   | Current password is incorrect                |
| 401         | `UNAUTHORIZED`         | User not authenticated                       |
| 500         | `CHANGE_FAILED`        | Failed to change password                    |

#### Notes

- Password changes are logged in the audit trail
- Passwords are securely hashed before storage
=== docs/backend/api/endpoints/bookings.md ===
# Bookings API Endpoints

## Overview

The Bookings API allows users to manage vehicle bookings, including creating new bookings, viewing booking details, rescheduling, canceling, and accessing booking history. These endpoints handle all aspects of the vehicle reservation lifecycle.

## Authentication and Permissions

| Endpoint Pattern                | Required Role | Notes                                      |
|--------------------------------|---------------|-------------------------------------------|
| `GET /bookings/{id}`           | User          | User can view their own bookings           |
| `GET /bookings`                | User          | List user's bookings                       |
| `POST /bookings`               | User          | Create a new booking                       |
| `PUT /bookings/{id}/reschedule`| User          | Reschedule an existing booking            |
| `POST /bookings/{id}/cancel`   | User          | Cancel a booking                          |
| `GET /bookings/{id}/logs`      | User          | Get booking activity logs                 |
| `GET /bookings/list`           | User          | HTML format booking list (for HTMX)       |

## Rate Limiting

> **Note**: Rate limiting is planned for future implementation. The specific limits described below are not currently enforced.

---

## View Booking Details

Retrieve details for a specific booking.

### HTTP Request

`GET /bookings/{id}`

### Authentication

Requires a valid user authentication token.

### Path Parameters

| Parameter | Type    | Required | Description         | Constraints                     |
|-----------|---------|----------|---------------------|--------------------------------|
| `id`      | Integer | Yes      | Booking identifier  | Must be a valid booking ID     |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Booking details fetched",
  "data": {
    "booking": {
      "id": 456,
      "user_id": 123,
      "vehicle_id": 789,
      "pickup_date": "2023-07-15T10:00:00Z",
      "dropoff_date": "2023-07-18T10:00:00Z",
      "pickup_location": "New York Downtown",
      "dropoff_location": "New York Downtown",
      "status": "confirmed",
      "total_amount": 349.99,
      "created_at": "2023-06-01T14:30:45Z",
      "updated_at": "2023-06-01T14:30:45Z",
      "vehicle": {
        "make": "Toyota",
        "model": "Camry",
        "year": 2022,
        "type": "sedan",
        "registration_number": "ABC123"
      },
      "payment_status": "paid"
    }
  }
}
```

### Error Responses

| Status Code | Message                      | Description                                |
|-------------|------------------------------|--------------------------------------------|
| 401         | Unauthorized access          | User not authenticated                     |
| 403         | You do not have permission   | User does not have access to this booking  |
| 404         | Booking not found            | The specified booking cannot be found      |
| 500         | Failed to fetch booking details | Server error                           |

### Notes

- Users can only view their own bookings unless they have admin privileges
- Booking views are logged for audit purposes
- Vehicle details are included in the response to reduce additional API calls

---

## List User Bookings

Retrieve a paginated list of bookings for the authenticated user.

### HTTP Request

`GET /bookings`

### Authentication

Requires a valid user authentication token.

### Query Parameters

| Parameter | Type    | Required | Description                      | Constraints                      |
|-----------|---------|----------|----------------------------------|----------------------------------|
| `page`    | Integer | No       | Page number for pagination       | Default: 1, Min: 1               |
| `per_page`| Integer | No       | Number of items per page         | Default: 10                      |
| `status`  | String  | No       | Filter by booking status         | If not provided, returns all statuses |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "User bookings fetched successfully",
  "data": [
    {
      "id": 456,
      "vehicle_id": 789,
      "pickup_date": "2023-07-15T10:00:00Z",
      "dropoff_date": "2023-07-18T10:00:00Z",
      "status": "confirmed",
      "total_amount": 349.99,
      "vehicle": {
        "make": "Toyota",
        "model": "Camry",
        "year": 2022
      },
      "created_at": "2023-06-01T14:30:45Z"
    },
    {
      "id": 457,
      "vehicle_id": 790,
      "pickup_date": "2023-08-05T14:00:00Z",
      "dropoff_date": "2023-08-07T14:00:00Z",
      "status": "pending",
      "total_amount": 249.99,
      "vehicle": {
        "make": "Honda",
        "model": "Accord",
        "year": 2023
      },
      "created_at": "2023-06-05T09:22:18Z"
    }
  ],
  "meta": {
    "current_page": 1,
    "total_pages": 3,
    "total": 25,
    "per_page": 10
  }
}
```

### Error Responses

| Status Code | Message                      | Description                                |
|-------------|------------------------------|--------------------------------------------|
| 401         | Unauthorized access          | User not authenticated                     |
| 500         | Failed to fetch user bookings | Server error                             |

### Notes

- Results include pagination metadata for client-side pagination controls
- Limited vehicle details are included for each booking to reduce additional API calls

---

## Create Booking

Create a new vehicle booking.

### HTTP Request

`POST /bookings`

### Authentication

Requires a valid user authentication token.

### Request Body Parameters

| Parameter         | Type    | Required | Description                 | Constraints                        |
|-------------------|---------|----------|-----------------------------|-----------------------------------|
| `vehicle_id`      | Integer | Yes      | Vehicle to book             | Must be a valid vehicle ID        |
| `pickup_date`     | String  | Yes      | Pickup date and time        | ISO 8601 format, future date      |
| `dropoff_date`    | String  | Yes      | Drop-off date and time      | ISO 8601 format, after pickup date|
| `pickup_location` | String  | Yes      | Location for pickup         | Non-empty string                  |
| `dropoff_location`| String  | Yes      | Location for drop-off       | Non-empty string                  |
| `payment_method_id`| Integer| Yes      | Payment method to use       | Must be a valid payment method ID |

### Example Request

```json
{
  "vehicle_id": 789,
  "pickup_date": "2023-07-15T10:00:00Z",
  "dropoff_date": "2023-07-18T10:00:00Z",
  "pickup_location": "New York Downtown",
  "dropoff_location": "New York Downtown",
  "payment_method_id": 123
}
```

### Response

Status code: `201 Created`

```json
{
  "status": "success",
  "message": "Booking created successfully",
  "data": {
    "booking_id": 456
  }
}
```

### Error Responses

| Status Code | Message                      | Description                                      |
|-------------|------------------------------|--------------------------------------------------|
| 400         | Validation error             | Request contains invalid or missing fields       |
| 401         | Invalid token                | User not authenticated                           |
| 500         | Failed to create booking     | Server error                                    |

### Notes

- Vehicle availability is checked before booking is created
- Creates audit log entries for booking creation
- Sends notification to user after successful booking
- The booking service handles all validation and business logic

---

## Reschedule Booking

Change the dates of an existing booking.

### HTTP Request

`PUT /bookings/{id}/reschedule`

### Authentication

Requires a valid user authentication token.

### Path Parameters

| Parameter | Type    | Required | Description         | Constraints                     |
|-----------|---------|----------|---------------------|--------------------------------|
| `id`      | Integer | Yes      | Booking identifier  | Must be a valid booking ID     |

### Request Body Parameters

| Parameter     | Type   | Required | Description            | Constraints                        |
|---------------|--------|----------|------------------------|-----------------------------------|
| `pickup_date` | String | Yes      | New pickup date/time   | ISO 8601 format, future date      |
| `dropoff_date`| String | Yes      | New drop-off date/time | ISO 8601 format, after pickup date|

### Example Request

```json
{
  "pickup_date": "2023-07-20T10:00:00Z",
  "dropoff_date": "2023-07-23T10:00:00Z"
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Booking rescheduled successfully"
}
```

### Error Responses

| Status Code | Message                      | Description                                      |
|-------------|------------------------------|--------------------------------------------------|
| 400         | Validation error             | Invalid dates                                     |
| 401         | Unauthorized access          | User not authenticated                            |
| 500         | Failed to reschedule booking | Server error                                      |

### Notes

- Vehicle availability is checked before rescheduling is confirmed
- Audit logs are created for reschedule events
- Notification is sent about rescheduled booking

---

## Cancel Booking

Cancel an existing booking and process any applicable refund.

### HTTP Request

`POST /bookings/{id}/cancel`

### Authentication

Requires a valid user authentication token.

### Path Parameters

| Parameter | Type    | Required | Description         | Constraints                     |
|-----------|---------|----------|---------------------|--------------------------------|
| `id`      | Integer | Yes      | Booking identifier  | Must be a valid booking ID     |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Booking canceled successfully",
  "data": {
    "refund_amount": 349.99
  }
}
```

### Error Responses

| Status Code | Message                      | Description                                      |
|-------------|------------------------------|--------------------------------------------------|
| 400         | Error message from service   | Various booking cancellation errors              |
| 401         | Unauthorized access          | User not authenticated                            |
| 500         | Failed to cancel booking     | Server error                                      |

### Notes

- Cancellation policy determines refund amount based on time until pickup
- Refund is automatically processed if applicable through the payment service
- Audit logs are created for cancellation and refund events
- Notification is sent about canceled booking

---

## Get Booking Logs

Retrieve activity logs for a specific booking.

### HTTP Request

`GET /bookings/{id}/logs`

### Authentication

Requires a valid user authentication token.

### Path Parameters

| Parameter | Type    | Required | Description         | Constraints                     |
|-----------|---------|----------|---------------------|--------------------------------|
| `id`      | Integer | Yes      | Booking identifier  | Must be a valid booking ID     |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Booking logs fetched successfully",
  "data": {
    "logs": [
      {
        "id": 501,
        "event_type": "booking_created",
        "message": "Booking created",
        "user_id": 123,
        "timestamp": "2023-06-01T14:30:45Z",
        "details": {
          "vehicle_id": 789,
          "pickup_date": "2023-07-15T10:00:00Z",
          "dropoff_date": "2023-07-18T10:00:00Z"
        }
      },
      {
        "id": 502,
        "event_type": "payment_processed",
        "message": "Payment processed for booking",
        "user_id": 123,
        "timestamp": "2023-06-01T14:31:22Z",
        "details": {
          "amount": 349.99,
          "payment_method": "credit_card",
          "status": "completed"
        }
      }
    ]
  }
}
```

### Error Responses

| Status Code | Message                      | Description                                |
|-------------|------------------------------|--------------------------------------------|
| 401         | Unauthorized access          | User not authenticated                     |
| 403         | You do not have permission to view this booking | User doesn't own booking |
| 500         | Failed to fetch booking logs | Server error                              |

### Notes

- Admin users can access logs for any booking
- Regular users can only access logs for their own bookings
- Accessing booking logs is recorded in the audit trail

---

## Get Booking List (HTMX)

Retrieve an HTML formatted list of bookings for HTMX integration.

### HTTP Request

`GET /bookings/list`

### Authentication

Requires a valid session with user_id.

### Query Parameters

| Parameter | Type    | Required | Description                      | Constraints                      |
|-----------|---------|----------|----------------------------------|----------------------------------|
| `page`    | Integer | No       | Page number for pagination       | Default: 0                       |
| `per_page`| Integer | No       | Number of items per page         | Default: 5                       |
| `status`  | String  | No       | Filter by booking status         | Default: 'all'                  |

### Response

Status code: `200 OK`

Returns HTML content directly, not JSON. The HTML contains booking list items as defined in the `/public/views/partials/booking-list-item.php` template.

### Error Responses

HTML error messages are directly returned in case of failure.

### Notes

- Uses session authentication rather than token authentication
- Returns HTML directly for HTMX integration
- Creates audit log entries for booking list access
=== docs/backend/api/endpoints/reports.md ===
# Reports API

This document outlines the available report endpoints for generating and accessing system reports.

## Endpoints Overview

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | /admin/reports | Admin | Report dashboard view for administrators |
| POST | /admin/reports/generate | Admin | Generate reports for administrators |
| GET | /reports/user | User | User report dashboard view |
| POST | /reports/user/generate | User/Admin | Generate user-specific reports |
| GET | /reports/download/{filePath} | User/Admin | Download a generated report |

## Admin Reports

### GET /admin/reports
Displays the admin report dashboard interface.

**Authentication Required**: Admin role
**Response**: HTML dashboard view

**Example Response**:
```json
{
  "status": "success",
  "message": "Report dashboard loaded",
  "data": {
    "view": "admin/reports"
  }
}
```

**Common Errors**:
- 401 Unauthorized - If user is not authenticated or lacks admin privileges

### POST /admin/reports/generate
Generate a report based on specified parameters.

**Authentication Required**: Admin role

**Required Parameters**:
- `date_range` (object): Date range for report data
  - `start` (string): Start date in YYYY-MM-DD format
  - `end` (string): End date in YYYY-MM-DD format
- `format` (string): Report format (e.g., 'pdf', 'csv', 'xlsx')
- `report_type` (string): Type of report to generate

**Optional Parameters**:
- `filters` (object): Additional filters specific to report type

**Example Request**:
```json
{
  "date_range": {
    "start": "2023-01-01",
    "end": "2023-12-31"
  },
  "format": "pdf",
  "report_type": "sales",
  "filters": {
    "product_category": "vehicles",
    "min_amount": 1000
  }
}
```

**Response**: Binary file download

**Common Errors**:
- 400 Bad Request - Missing required parameters
- 401 Unauthorized - If user is not authenticated or lacks admin privileges
- 500 Internal Server Error - Report generation failed

## User Reports

### GET /reports/user
Displays the user report dashboard interface.

**Authentication Required**: User account

**Response**: HTML dashboard view

**Example Response**:
```json
{
  "status": "success",
  "message": "User report dashboard loaded",
  "data": {
    "view": "user/reports"
  }
}
```

### POST /reports/user/generate
Generate a user-specific report.

**Authentication Required**: User account (for own reports) or Admin (for any user)

**Required Parameters**:
- `user_id` (integer): ID of user for whom to generate report
- `date_range` (object): Date range for report data
  - `start` (string): Start date in YYYY-MM-DD format
  - `end` (string): End date in YYYY-MM-DD format
- `format` (string): Report format (e.g., 'pdf', 'csv', 'xlsx')
- `report_type` (string): Type of report to generate

**Example Request**:
```json
{
  "user_id": 123,
  "date_range": {
    "start": "2023-01-01",
    "end": "2023-12-31"
  },
  "format": "pdf",
  "report_type": "activity"
}
```

**Response**: Binary file download

**Common Errors**:
- 400 Bad Request - Missing required parameters
- 401 Unauthorized - If user is not authenticated
- 403 Forbidden - If trying to access another user's data without admin privileges
- 500 Internal Server Error - Report generation failed

## Report Download

### GET /reports/download/{filePath}
Download a previously generated report file.

**Authentication Required**: User account or Admin role

**Path Parameters**:
- `filePath` (string): Path to the generated report file

**Response**: Binary file download with appropriate headers:
- Content-Type: application/octet-stream
- Content-Disposition: attachment; filename=reportname.ext

**Common Errors**:
- 404 Not Found - If report file does not exist
- 401 Unauthorized - If user is not authenticated
- 403 Forbidden - If trying to access another user's report without admin privileges

## Available Report Types

The system supports the following report types:

1. **Sales Reports** (`sales`)
   - Revenue metrics
   - Transaction summaries
   - Payment method distribution

2. **User Activity Reports** (`activity`)
   - Login frequency
   - Feature usage
   - Engagement metrics

3. **Booking Reports** (`bookings`)
   - Reservation statistics
   - Cancellation rates
   - Seasonal trends

4. **System Performance Reports** (`performance`)
   - Response times
   - Error rates
   - API usage statistics

## Report Formats

Reports can be generated in the following formats:

- PDF (`pdf`): Formatted document suitable for printing
- CSV (`csv`): Comma-separated values for data analysis
- Excel (`xlsx`): Microsoft Excel format for advanced analysis
- JSON (`json`): Machine-readable format for API integrations
=== docs/backend/api/endpoints/admin-settings.md ===
# Admin Settings API Documentation

## Endpoints Overview

| Method   | Endpoint                    | Auth  | Description                                      |
|----------|-----------------------------|-------|--------------------------------------------------|
| GET/PUT  | /admin/settings/{category}  | Admin | Retrieve or update settings for a given category |

## Endpoint Details

### GET /admin/settings/{category}
Retrieves the settings for the specified category.

**Available Settings & Data Types:**

- **General**:
  - site_name: string  
    - Validation: required, maximum length 255  
    - Default: "My Website"
  - site_url: string (URL)  
    - Validation: required, must be a valid URL  
    - Default: "http://localhost"
  - contact_email: string (email)  
    - Validation: required, valid email format  
    - Default: "admin@example.com"

- **Security**:
  - password_min_length: integer  
    - Validation: required, minimum value 6  
    - Default: 8
  - enable_2fa: boolean  
    - Validation: required  
    - Default: false
  - session_timeout: integer (minutes)  
    - Validation: required, minimum value 10  
    - Default: 30

- **Notifications**:
  - notify_on_comment: boolean  
    - Validation: required  
    - Default: true
  - smtp_server: string  
    - Validation: required  
    - Default: null
  - smtp_port: integer  
    - Validation: required, valid port number  
    - Default: 587

**Permission Requirements:**
- Only administrators may access this endpoint.

### PUT /admin/settings/{category}
Updates the settings for the specified category.

**Payload Requirements:**
- Must include valid values for the settings as detailed above.
- All fields are validated based on their respective rules.

**Permission Requirements:**
- Only administrators are allowed to perform updates.

## Setting Categories & Their Purposes

| Category      | Purpose                                                           |
|---------------|-------------------------------------------------------------------|
| general       | Contains basic site configuration and informational settings.     |
| security      | Manages settings related to authentication, password policies, and session management. |
| notifications | Configures email and other notification-related settings.         |

*Note: Replace `{category}` with one of the available categories ("general", "security", "notifications") when making requests.*
=== docs/backend/api/endpoints/admin-dashboard.md ===
# Admin Dashboard API Endpoints

## Overview

The Admin Dashboard API provides statistical data, metrics, and operational insights for administrators to monitor and manage the CarFuse platform. These endpoints deliver real-time and historical data for business intelligence and decision making.

## Authentication and Permissions

| Endpoint Pattern                | Required Role | Notes                                      |
|--------------------------------|---------------|-------------------------------------------|
| `GET /admin/dashboard`          | Admin         | Admin dashboard main view (HTML)           |
| `GET /admin/dashboard/data`     | Admin         | Get admin dashboard statistics via API     |
| `GET /admin/dashboard/bookings` | Admin         | Get booking statistics                     |
| `GET /admin/dashboard/users`    | Admin         | Get user statistics                        |
| `GET /admin/dashboard/revenue`  | Admin         | Get revenue statistics                     |
| `GET /admin/dashboard/metrics`  | Admin         | Get combined platform metrics              |

## Rate Limiting

Dashboard endpoints have the following rate limits:
- Standard admin tier: 120 requests per minute
- Dashboard data refresh: maximum once per 30 seconds

---

## Admin Dashboard Main View

Get the main admin dashboard HTML view.

### HTTP Request

`GET /admin/dashboard`

### Authentication

Requires a valid admin authentication token.

### Response

Status code: `200 OK`

Returns HTML content for the admin dashboard interface.

### Error Codes

| Status Code | Error Code         | Description                                    |
|-------------|-------------------|------------------------------------------------|
| 401         | `UNAUTHORIZED`     | User not authenticated                         |
| 403         | `FORBIDDEN`        | User does not have admin privileges            |
| 500         | `SERVER_ERROR`     | Failed to render dashboard                     |

### Notes

- This endpoint returns a full HTML page for direct browser rendering
- Dashboard access is logged for audit purposes
- Data in the dashboard is loaded via separate AJAX/HTMX calls

---

## Get Dashboard Data

Retrieve all dashboard metrics and statistics in a single call.

### HTTP Request

`GET /admin/dashboard/data`

### Authentication

Requires a valid admin authentication token.

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Dashboard data fetched",
  "data": {
    "metrics": {
      "total_users": 250,
      "active_users": 185,
      "total_bookings": 450,
      "completed_bookings": 375,
      "canceled_bookings": 25,
      "total_revenue": 12500.75,
      "total_refunds": 450.50,
      "net_revenue": 12050.25
    },
    "trends": {
      "user_growth": 5.2,
      "booking_growth": 7.8,
      "revenue_growth": 4.6
    },
    "recent_bookings": [
      {
        "id": 1001,
        "user_id": 123,
        "vehicle_id": 45,
        "status": "completed",
        "amount": 249.99,
        "created_at": "2023-05-15T14:30:22Z"
      },
      {
        "id": 1002,
        "user_id": 124,
        "vehicle_id": 46,
        "status": "pending",
        "amount": 349.99,
        "created_at": "2023-05-16T10:22:18Z"
      }
    ],
    "recent_users": [
      {
        "id": 150,
        "name": "Alice Johnson",
        "email": "alice@example.com",
        "created_at": "2023-05-15T09:20:15Z"
      },
      {
        "id": 151,
        "name": "Bob Wilson",
        "email": "bob@example.com",
        "created_at": "2023-05-15T14:45:30Z"
      }
    ]
  }
}
```

### Error Codes

| Status Code | Error Code           | Description                                      |
|-------------|---------------------|--------------------------------------------------|
| 401         | `UNAUTHORIZED`       | User not authenticated                           |
| 403         | `FORBIDDEN`          | User does not have admin privileges              |
| 500         | `SERVER_ERROR`       | Failed to retrieve dashboard data                |

### Notes

- Provides comprehensive system metrics in a single API call
- Data is cached for 30 seconds to reduce database load
- Includes summary data for recent platform activity
- Response size can be large depending on system activity
- For more detailed or specific metrics, use specialized endpoints

---

## Get Booking Statistics

Retrieve detailed booking statistics and trends.

### HTTP Request

`GET /admin/dashboard/bookings`

### Authentication

Requires a valid admin authentication token.

### Query Parameters

| Parameter       | Type    | Required | Description                          | Constraints                      |
|----------------|---------|----------|--------------------------------------|---------------------------------|
| `period`       | String  | No       | Time period for statistics            | Values: day, week, month, year; Default: month |
| `start_date`   | String  | No       | Start date for custom period          | ISO 8601 format                  |
| `end_date`     | String  | No       | End date for custom period            | ISO 8601 format                  |
| `group_by`     | String  | No       | How to group the statistics           | Values: day, week, month; Default: day |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Booking statistics fetched",
  "data": {
    "summary": {
      "total_bookings": 450,
      "pending_bookings": 50,
      "confirmed_bookings": 375,
      "canceled_bookings": 25,
      "average_duration": 3.5,
      "average_amount": 275.50
    },
    "trends": {
      "booking_growth": 7.8,
      "completion_rate": 83.3,
      "cancellation_rate": 5.6
    },
    "timeline": [
      {
        "period": "2023-05-01",
        "new_bookings": 15,
        "completed_bookings": 12,
        "canceled_bookings": 2,
        "revenue": 3299.97
      },
      {
        "period": "2023-05-02",
        "new_bookings": 18,
        "completed_bookings": 14,
        "canceled_bookings": 1,
        "revenue": 3499.86
      }
      // Additional timeline entries...
    ],
    "top_vehicles": [
      {
        "vehicle_id": 45,
        "make": "Toyota",
        "model": "Camry",
        "bookings_count": 28,
        "revenue": 6999.72
      },
      {
        "vehicle_id": 52,
        "make": "Honda",
        "model": "Civic",
        "bookings_count": 24,
        "revenue": 5279.76
      }
      // Additional top vehicles...
    ]
  }
}
```

### Error Codes

| Status Code | Error Code              | Description                                      |
|-------------|------------------------|--------------------------------------------------|
| 400         | `INVALID_PARAMETERS`    | Invalid date range or parameters                 |
| 401         | `UNAUTHORIZED`          | User not authenticated                           |
| 403         | `FORBIDDEN`             | User does not have admin privileges              |
| 500         | `SERVER_ERROR`          | Failed to retrieve booking statistics            |

### Notes

- Statistics accuracy depends on the completeness of historical data
- For large date ranges, data may be aggregated at a higher level
- Custom date ranges limited to maximum of 366 days
- Booking amounts include any refunds processed
- Timeline data is paginated based on selected period and grouping

---

## Get User Statistics

Retrieve detailed user statistics and trends.

### HTTP Request

`GET /admin/dashboard/users`

### Authentication

Requires a valid admin authentication token.

### Query Parameters

| Parameter       | Type    | Required | Description                          | Constraints                      |
|----------------|---------|----------|--------------------------------------|---------------------------------|
| `period`       | String  | No       | Time period for statistics            | Values: day, week, month, year; Default: month |
| `start_date`   | String  | No       | Start date for custom period          | ISO 8601 format                  |
| `end_date`     | String  | No       | End date for custom period            | ISO 8601 format                  |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "User statistics fetched",
  "data": {
    "summary": {
      "total_users": 250,
      "active_users": 185,
      "inactive_users": 65,
      "new_users_current_period": 28,
      "new_users_previous_period": 22
    },
    "trends": {
      "user_growth": 5.2,
      "activity_rate": 74.0,
      "retention_rate": 92.5
    },
    "timeline": [
      {
        "period": "2023-05-01",
        "new_users": 3,
        "active_users": 178
      },
      {
        "period": "2023-05-02",
        "new_users": 5,
        "active_users": 180
      }
      // Additional timeline entries...
    ],
    "demographics": {
      "top_locations": [
        {"name": "New York", "count": 45},
        {"name": "Los Angeles", "count": 32},
        {"name": "Chicago", "count": 28}
      ],
      "device_breakdown": {
        "mobile": 65,
        "desktop": 30,
        "tablet": 5
      },
      "registration_sources": {
        "direct": 40,
        "google": 25,
        "facebook": 15,
        "referral": 10,
        "other": 10
      }
    }
  }
}
```

### Error Codes

| Status Code | Error Code              | Description                                      |
|-------------|------------------------|--------------------------------------------------|
| 400         | `INVALID_PARAMETERS`    | Invalid date range or parameters                 |
| 401         | `UNAUTHORIZED`          | User not authenticated                           |
| 403         | `FORBIDDEN`             | User does not have admin privileges              |
| 500         | `SERVER_ERROR`          | Failed to retrieve user statistics               |

### Notes

- Active users defined as users who logged in during the selected period
- Demographics data is anonymized and aggregated
- Location data is based on user profile information or IP geolocation
- Device breakdown based on last login device
- User retention calculated based on returning users in the period

---

## Get Revenue Statistics

Retrieve detailed revenue statistics and financial trends.

### HTTP Request

`GET /admin/dashboard/revenue`

### Authentication

Requires a valid admin authentication token.

### Query Parameters

| Parameter       | Type    | Required | Description                          | Constraints                      |
|----------------|---------|----------|--------------------------------------|---------------------------------|
| `period`       | String  | No       | Time period for statistics            | Values: day, week, month, year; Default: month |
| `start_date`   | String  | No       | Start date for custom period          | ISO 8601 format                  |
| `end_date`     | String  | No       | End date for custom period            | ISO 8601 format                  |
| `currency`     | String  | No       | Currency for amounts                  | Default: USD                     |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Revenue statistics fetched",
  "data": {
    "summary": {
      "total_revenue": 12500.75,
      "total_refunds": 450.50,
      "net_revenue": 12050.25,
      "average_booking_value": 275.50,
      "projected_monthly_revenue": 14800.00
    },
    "trends": {
      "revenue_growth": 4.6,
      "refund_rate": 3.6,
      "average_value_change": 2.1
    },
    "timeline": [
      {
        "period": "2023-05-01",
        "gross_revenue": 599.97,
        "refunds": 49.99,
        "net_revenue": 549.98,
        "bookings": 2
      },
      {
        "period": "2023-05-02",
        "gross_revenue": 749.98,
        "refunds": 0,
        "net_revenue": 749.98,
        "bookings": 3
      }
      // Additional timeline entries...
    ],
    "payment_methods": {
      "credit_card": {
        "count": 350,
        "amount": 9625.50
      },
      "paypal": {
        "count": 75,
        "amount": 1875.25
      },
      "bank_transfer": {
        "count": 25,
        "amount": 1000.00
      }
    },
    "top_revenue_vehicles": [
      {
        "vehicle_id": 45,
        "make": "Toyota",
        "model": "Camry",
        "revenue": 6999.72,
        "bookings": 28
      },
      {
        "vehicle_id": 52,
        "make": "Honda",
        "model": "Civic",
        "revenue": 5279.76,
        "bookings": 24
      }
    ]
  }
}
```

### Error Codes

| Status Code | Error Code              | Description                                      |
|-------------|------------------------|--------------------------------------------------|
| 400         | `INVALID_PARAMETERS`    | Invalid date range or parameters                 |
| 401         | `UNAUTHORIZED`          | User not authenticated                           |
| 403         | `FORBIDDEN`             | User does not have admin privileges              |
| 500         | `SERVER_ERROR`          | Failed to retrieve revenue statistics            |

### Notes

- All monetary values are provided in the requested currency
- Projected revenue based on current period trends
- Revenue calculations include all completed bookings
- Refunds are tracked separately for accurate financial reporting
- Payment method breakdown shows transaction count and total amounts
- Financial data access is restricted to admin users with financial permissions

---

## Get Platform Metrics

Retrieve combined platform metrics including activity, performance, and system health.

### HTTP Request

`GET /admin/dashboard/metrics`

### Authentication

Requires a valid admin authentication token.

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Platform metrics fetched",
  "data": {
    "system_health": {
      "api_response_time": 235,
      "database_query_time": 85,
      "server_load": 0.45,
      "memory_usage": 68.5,
      "storage_usage": 42.3
    },
    "activity": {
      "active_users_now": 32,
      "logins_today": 175,
      "api_requests_today": 12450,
      "page_views_today": 3250
    },
    "performance": {
      "average_page_load": 1.2,
      "average_api_response": 0.25,
      "error_rate": 0.02
    },
    "fleet_status": {
      "total_vehicles": 85,
      "available_vehicles": 42,
      "booked_vehicles": 38,
      "maintenance_vehicles": 5
    },
    "business_metrics": {
      "conversion_rate": 8.5,
      "average_session_duration": 145,
      "booking_abandonment_rate": 12.3
    }
  }
}
```

### Error Codes

| Status Code | Error Code           | Description                                      |
|-------------|---------------------|--------------------------------------------------|
| 401         | `UNAUTHORIZED`       | User not authenticated                           |
| 403         | `FORBIDDEN`          | User does not have admin privileges              |
| 500         | `SERVER_ERROR`       | Failed to retrieve platform metrics              |

### Notes

- Response times are in milliseconds
- Server load is normalized between 0 and 1
- Memory and storage usage are percentages
- These metrics are real-time snapshots of system performance
- Fleet status provides an overview of current vehicle availability
- Business metrics help track platform effectiveness
- Data may be cached for up to 1 minute to reduce system load
=== docs/backend/api/endpoints/vehicles.md ===
# Vehicles API Endpoints

## Overview

The Vehicles API provides endpoints for managing the vehicle fleet, including vehicle registration, updates, deletion, search, and availability checking. These endpoints enable administrators to manage the fleet inventory and users to search and view vehicle details.

## Authentication and Permissions

| Endpoint Pattern                      | Required Role | Notes                                      |
|--------------------------------------|---------------|-------------------------------------------|
| `GET /vehicles`                       | None          | Search/list vehicles (public)              |
| `GET /vehicles/{id}`                  | None          | Get vehicle details (public)               |
| `POST /vehicles`                      | Admin         | Create a new vehicle                       |
| `PUT /vehicles/{id}`                  | Admin         | Update vehicle details                     |
| `DELETE /vehicles/{id}`               | Admin         | Delete a vehicle (soft delete)             |
| `GET /vehicles/availability/{id}`     | None          | Check vehicle availability                 |
| `GET /vehicles/types`                 | None          | Get all vehicle types (public)             |
| `PUT /vehicles/{id}/status`           | Admin         | Update vehicle status                      |
| `POST /vehicles/{id}/maintenance`     | Admin         | Record vehicle maintenance                 |
| `GET /vehicles/{id}/history`          | Admin         | Get vehicle history                        |
| `GET /vehicles/admin`                 | Admin         | Admin view of vehicles                     |

## Rate Limiting

Vehicle endpoints have the following rate limits:
- Standard tier: 100 requests per minute
- Premium tier: 500 requests per minute
- Public search: 60 requests per minute per IP

---

## Search/List Vehicles

Search for vehicles or get a paginated list of available vehicles.

### HTTP Request

`GET /vehicles`

### Query Parameters

| Parameter       | Type    | Required | Description                                | Constraints                        |
|----------------|---------|----------|--------------------------------------------|-----------------------------------|
| `page`         | Integer | No       | Page number                                | Default: 1, Min: 1                 |
| `per_page`     | Integer | No       | Items per page                             | Default: 20, Max: 50               |
| `type`         | String  | No       | Vehicle type                               | e.g., sedan, suv, truck            |
| `make`         | String  | No       | Vehicle manufacturer                       | e.g., Toyota, Honda                |
| `model`        | String  | No       | Vehicle model                              | e.g., Camry, Civic                 |
| `year`         | Integer | No       | Manufacturing year                         | Format: YYYY                       |
| `min_price`    | Float   | No       | Minimum daily rate                         | Must be >= 0                       |
| `max_price`    | Float   | No       | Maximum daily rate                         | Must be > min_price                |
| `features`     | String  | No       | Comma-separated list of features           | e.g., gps,bluetooth,backup_camera  |
| `available_from`| String  | No       | Start of availability period               | ISO 8601 format                    |
| `available_to` | String  | No       | End of availability period                 | ISO 8601 format                    |
| `location`     | String  | No       | Pick-up location                           | City name or location code         |
| `sort`         | String  | No       | Sort order                                 | Format: field:direction (e.g., price:asc) |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Vehicles retrieved successfully",
  "data": {
    "vehicles": [
      {
        "id": "v-123",
        "make": "Toyota",
        "model": "Camry",
        "year": 2022,
        "type": "sedan",
        "daily_rate": 49.99,
        "registration_number": "ABC123",
        "color": "Silver",
        "seats": 5,
        "features": ["bluetooth", "backup_camera", "cruise_control"],
        "status": "available",
        "thumbnail": "https://example.com/images/vehicles/v-123_thumb.jpg",
        "location": "New York Downtown"
      },
      {
        "id": "v-124",
        "make": "Honda",
        "model": "CR-V",
        "year": 2023,
        "type": "suv",
        "daily_rate": 69.99,
        "registration_number": "XYZ456",
        "color": "Blue",
        "seats": 5,
        "features": ["bluetooth", "navigation", "backup_camera", "cruise_control"],
        "status": "available",
        "thumbnail": "https://example.com/images/vehicles/v-124_thumb.jpg",
        "location": "New York Downtown"
      }
    ]
  },
  "meta": {
    "current_page": 1,
    "total_pages": 10,
    "total_vehicles": 187,
    "per_page": 20
  }
}
```

### Error Codes

| Status Code | Error Code              | Description                                      |
|-------------|------------------------|--------------------------------------------------|
| 400         | `INVALID_PARAMETERS`    | Invalid search parameters                        |
| 500         | `SERVER_ERROR`          | Failed to retrieve vehicles                      |

### Notes

- Public endpoint - no authentication required
- Results are filtered to show only available vehicles by default
- Multiple search criteria can be combined for narrower results
- Only basic vehicle information is included in list results
- Full details are available via the vehicle details endpoint
- Date range filtering checks for vehicles available during the entire specified period

---

## Get Vehicle Details

Retrieve detailed information for a specific vehicle.

### HTTP Request

`GET /vehicles/{id}`

### Path Parameters

| Parameter | Type   | Required | Description         | Constraints                     |
|-----------|--------|----------|---------------------|--------------------------------|
| `id`      | String | Yes      | Vehicle identifier  | Must be a valid vehicle ID      |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Vehicle details retrieved successfully",
  "data": {
    "vehicle": {
      "id": "v-123",
      "make": "Toyota",
      "model": "Camry",
      "year": 2022,
      "type": "sedan",
      "daily_rate": 49.99,
      "weekly_rate": 299.94,
      "monthly_rate": 1199.76,
      "registration_number": "ABC123",
      "color": "Silver",
      "seats": 5,
      "engine": "2.5L 4-cylinder",
      "transmission": "automatic",
      "fuel_type": "gasoline",
      "fuel_efficiency": "28 mpg city / 39 mpg highway",
      "features": [
        "bluetooth",
        "backup_camera",
        "cruise_control",
        "lane_departure_warning",
        "automatic_emergency_braking"
      ],
      "description": "A comfortable mid-size sedan with excellent fuel efficiency and modern safety features. Ideal for business trips and family vacations.",
      "status": "available",
      "mileage": 15250,
      "images": [
        "https://example.com/images/vehicles/v-123_1.jpg",
        "https://example.com/images/vehicles/v-123_2.jpg",
        "https://example.com/images/vehicles/v-123_3.jpg",
        "https://example.com/images/vehicles/v-123_4.jpg"
      ],
      "location": "New York Downtown",
      "location_coordinates": {
        "latitude": 40.7127281,
        "longitude": -74.0060152
      },
      "average_rating": 4.7,
      "reviews_count": 24,
      "insurance_options": [
        {
          "id": "ins_basic",
          "name": "Basic Coverage",
          "daily_rate": 9.99,
          "description": "Includes liability and collision coverage with $1000 deductible"
        },
        {
          "id": "ins_premium",
          "name": "Premium Coverage",
          "daily_rate": 19.99,
          "description": "Includes liability, collision, and comprehensive coverage with $500 deductible"
        }
      ]
    }
  }
}
```

### Error Codes

| Status Code | Error Code              | Description                                      |
|-------------|------------------------|--------------------------------------------------|
| 400         | `INVALID_VEHICLE_ID`    | Invalid vehicle ID format                        |
| 404         | `VEHICLE_NOT_FOUND`     | Vehicle not found                                |
| 500         | `SERVER_ERROR`          | Failed to retrieve vehicle details               |

### Notes

- Public endpoint - no authentication required
- Includes comprehensive vehicle details including photos and specifications
- Insurance options are based on vehicle type and value
- Average rating is calculated from customer reviews
- Vehicle location may be generalized for public access
- Detailed view counts are logged for analytics purposes

---

## Create Vehicle

Create a new vehicle in the system.

### HTTP Request

`POST /vehicles`

### Authentication

Requires a valid admin authentication token.

### Request Body Parameters

| Parameter              | Type    | Required | Description                      | Constraints                       |
|-----------------------|---------|----------|----------------------------------|----------------------------------|
| `make`                | String  | Yes      | Vehicle manufacturer              | Non-empty string                  |
| `model`               | String  | Yes      | Vehicle model                     | Non-empty string                  |
| `year`                | Integer | Yes      | Manufacturing year                | Between 1900 and current year + 1 |
| `type`                | String  | Yes      | Vehicle type                      | Must be a valid vehicle type      |
| `registration_number` | String  | Yes      | Registration plate               | Unique in the system              |
| `daily_rate`          | Float   | Yes      | Daily rental rate                 | Greater than 0                    |
| `weekly_rate`         | Float   | No       | Weekly rental rate               | Greater than 0                    |
| `monthly_rate`        | Float   | No       | Monthly rental rate              | Greater than 0                    |
| `color`               | String  | Yes      | Vehicle color                     | Non-empty string                  |
| `seats`               | Integer | Yes      | Number of seats                   | Between 1 and 20                  |
| `engine`              | String  | No       | Engine details                    | String                            |
| `transmission`        | String  | Yes      | Transmission type                 | Values: automatic, manual         |
| `fuel_type`           | String  | Yes      | Fuel type                         | e.g., gasoline, diesel, electric  |
| `fuel_efficiency`     | String  | No       | Fuel efficiency details           | String                            |
| `features`            | Array   | No       | Array of vehicle features         | Array of strings                  |
| `description`         | String  | No       | Vehicle description               | Max: 2000 characters              |
| `mileage`             | Integer | Yes      | Current odometer reading          | Non-negative integer              |
| `location`            | String  | Yes      | Current vehicle location          | Non-empty string                  |
| `location_coordinates`| Object  | No       | GPS coordinates                   | Contains latitude and longitude   |
| `status`              | String  | No       | Initial vehicle status            | Default: available                |
| `images`              | Array   | No       | Array of image URLs               | Array of strings                  |

### Example Request

```json
{
  "make": "Honda",
  "model": "Civic",
  "year": 2023,
  "type": "sedan",
  "registration_number": "XYZ789",
  "daily_rate": 45.99,
  "weekly_rate": 275.94,
  "monthly_rate": 1103.76,
  "color": "Red",
  "seats": 5,
  "engine": "1.5L 4-cylinder Turbo",
  "transmission": "automatic",
  "fuel_type": "gasoline",
  "fuel_efficiency": "31 mpg city / 40 mpg highway",
  "features": ["bluetooth", "navigation", "backup_camera", "lane_assist"],
  "description": "A sporty and efficient compact sedan with excellent fuel economy and modern technology features.",
  "mileage": 3500,
  "location": "Boston Downtown",
  "location_coordinates": {
    "latitude": 42.3600825,
    "longitude": -71.0588801
  },
  "status": "available"
}
```

### Response

Status code: `201 Created`

```json
{
  "status": "success",
  "message": "Vehicle created successfully",
  "data": {
    "vehicle_id": "v-125",
    "registration_number": "XYZ789"
  }
}
```

### Error Codes

| Status Code | Error Code                  | Description                                      |
|-------------|---------------------------|--------------------------------------------------|
| 400         | `VALIDATION_ERROR`         | Invalid or missing required fields                |
| 400         | `REGISTRATION_EXISTS`      | Registration number already exists                |
| 401         | `UNAUTHORIZED`             | User not authenticated                            |
| 403         | `FORBIDDEN`                | User does not have admin privileges               |
| 500         | `VEHICLE_CREATION_FAILED`  | Failed to create vehicle                          |

### Notes

- Vehicle creation is logged for audit purposes
- Registration number is validated for uniqueness
- System automatically generates a unique vehicle ID
- Weekly and monthly rates are calculated from daily rate if not provided
- Image upload is handled separately via a dedicated upload endpoint
- Vehicle status defaults to available but can be set initially to maintenance or unavailable

---

## Update Vehicle

Update an existing vehicle's details.

### HTTP Request

`PUT /vehicles/{id}`

### Authentication

Requires a valid admin authentication token.

### Path Parameters

| Parameter | Type   | Required | Description         | Constraints                     |
|-----------|--------|----------|---------------------|--------------------------------|
| `id`      | String | Yes      | Vehicle identifier  | Must be a valid vehicle ID      |

### Request Body Parameters

Parameters are the same as for vehicle creation, but all are optional. Only provided fields will be updated.

### Example Request

```json
{
  "daily_rate": 47.99,
  "weekly_rate": 287.94,
  "monthly_rate": 1151.76,
  "features": ["bluetooth", "navigation", "backup_camera", "lane_assist", "sunroof"],
  "mileage": 4500,
  "status": "maintenance"
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Vehicle updated successfully",
  "data": {
    "vehicle_id": "v-125",
    "updated_fields": ["daily_rate", "weekly_rate", "monthly_rate", "features", "mileage", "status"]
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `VALIDATION_ERROR`       | Invalid field values                              |
| 400         | `REGISTRATION_EXISTS`    | Registration number already exists                |
| 401         | `UNAUTHORIZED`           | User not authenticated                            |
| 403         | `FORBIDDEN`              | User does not have admin privileges               |
| 404         | `VEHICLE_NOT_FOUND`      | Vehicle not found                                 |
| 500         | `UPDATE_FAILED`          | Failed to update vehicle                          |

### Notes

- Only provided fields are updated; others remain unchanged
- Vehicle update is logged for audit purposes
- Status changes may affect existing bookings and require additional handling
- Registration number changes are checked for uniqueness
- Booking conflicts are checked when changing vehicle status
- Rate changes only affect future bookings, not existing ones

---

## Delete Vehicle

Remove a vehicle from the system (soft delete).

### HTTP Request

`DELETE /vehicles/{id}`

### Authentication

Requires a valid admin authentication token.

### Path Parameters

| Parameter | Type   | Required | Description         | Constraints                     |
|-----------|--------|----------|---------------------|--------------------------------|
| `id`      | String | Yes      | Vehicle identifier  | Must be a valid vehicle ID      |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Vehicle deleted successfully"
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `INVALID_VEHICLE_ID`     | Invalid vehicle ID format                        |
| 401         | `UNAUTHORIZED`           | User not authenticated                            |
| 403         | `FORBIDDEN`              | User does not have admin privileges               |
| 404         | `VEHICLE_NOT_FOUND`      | Vehicle not found                                 |
| 409         | `ACTIVE_BOOKINGS`        | Vehicle has active bookings and cannot be deleted |
| 500         | `DELETE_FAILED`          | Failed to delete vehicle                          |

### Notes

- This performs a soft delete - vehicle records remain in the database but are marked as deleted
- Vehicles with active bookings cannot be deleted
- A vehicle can be restored later by an admin if needed
- Deletion is logged for audit purposes
- Historical bookings and revenue data are maintained

---

## Check Vehicle Availability

Check if a vehicle is available for a specific date range.

### HTTP Request

`GET /vehicles/availability/{id}`

### Path Parameters

| Parameter | Type   | Required | Description         | Constraints                     |
|-----------|--------|----------|---------------------|--------------------------------|
| `id`      | String | Yes      | Vehicle identifier  | Must be a valid vehicle ID      |

### Query Parameters

| Parameter     | Type   | Required | Description                | Constraints                     |
|--------------|--------|----------|----------------------------|--------------------------------|
| `start_date` | String | Yes      | Start date of rental period| ISO 8601 format                |
| `end_date`   | String | Yes      | End date of rental period  | ISO 8601 format                |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "data": {
    "vehicle_id": "v-123",
    "available": true,
    "conflicting_bookings": [],
    "pricing": {
      "daily_rate": 49.99,
      "days": 5,
      "base_amount": 249.95,
      "taxes": 20.00,
      "total": 269.95
    }
  }
}
```

If not available:
```json
{
  "status": "success",
  "data": {
    "vehicle_id": "v-123",
    "available": false,
    "conflicting_bookings": [
      {
        "start_date": "2023-07-18T10:00:00Z",
        "end_date": "2023-07-20T10:00:00Z"
      }
    ],
    "next_available_date": "2023-07-21T10:00:00Z"
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `INVALID_VEHICLE_ID`     | Invalid vehicle ID format                        |
| 400         | `INVALID_DATES`          | Invalid date range or format                      |
| 404         | `VEHICLE_NOT_FOUND`      | Vehicle not found                                 |
| 500         | `SERVER_ERROR`           | Failed to check availability                      |

### Notes

- Public endpoint - no authentication required
- Checks both bookings and maintenance schedules
- Returns pricing information for the specified period when available
- Provides conflicting booking dates when unavailable
- Date range validation ensures end date is after start date
- Minimum rental period may apply based on vehicle type

---

## Get Vehicle Types

Retrieve a list of all vehicle types with descriptions.

### HTTP Request

`GET /vehicles/types`

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "data": {
    "types": [
      {
        "id": "sedan",
        "name": "Sedan",
        "description": "A standard 4-door car suitable for up to 5 passengers with trunk storage",
        "image": "https://example.com/images/types/sedan.jpg",
        "capacity": {
          "passengers": 5,
          "luggage": "2 large suitcases"
        }
      },
      {
        "id": "suv",
        "name": "SUV",
        "description": "Sport Utility Vehicle with increased ground clearance and spacious interior",
        "image": "https://example.com/images/types/suv.jpg",
        "capacity": {
          "passengers": 7,
          "luggage": "3 large suitcases"
        }
      },
      {
        "id": "compact",
        "name": "Compact",
        "description": "Small, fuel-efficient car ideal for city driving",
        "image": "https://example.com/images/types/compact.jpg",
        "capacity": {
          "passengers": 4,
          "luggage": "1 large suitcase"
        }
      },
      {
        "id": "luxury",
        "name": "Luxury",
        "description": "Premium vehicles offering superior comfort and features",
        "image": "https://example.com/images/types/luxury.jpg",
        "capacity": {
          "passengers": 5,
          "luggage": "3 large suitcases"
        }
      }
    ]
  }
}
```

### Error Codes

| Status Code | Error Code           | Description                                      |
|-------------|---------------------|--------------------------------------------------|
| 500         | `SERVER_ERROR`       | Failed to retrieve vehicle types                 |

### Notes

- Public endpoint - no authentication required
- Vehicle types are defined by the system and rarely change
- Vehicle types may affect pricing, insurance options, and rental policies
- Used primarily for search filtering and vehicle categorization

---

## Update Vehicle Status

Update the status of a specific vehicle.

### HTTP Request

`PUT /vehicles/{id}/status`

### Authentication

Requires a valid admin authentication token.

### Path Parameters

| Parameter | Type   | Required | Description         | Constraints                     |
|-----------|--------|----------|---------------------|--------------------------------|
| `id`      | String | Yes      | Vehicle identifier  | Must be a valid vehicle ID      |

### Request Body Parameters

| Parameter | Type   | Required | Description       | Constraints                                |
|-----------|--------|----------|-------------------|-------------------------------------------|
| `status`  | String | Yes      | New vehicle status| Values: available, unavailable, maintenance|
| `reason`  | String | No       | Reason for status change | Required for maintenance and unavailable|

### Example Request

```json
{
  "status": "maintenance",
  "reason": "Scheduled oil change and tire rotation"
}
```

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Vehicle status updated successfully",
  "data": {
    "vehicle_id": "v-123",
    "previous_status": "available",
    "new_status": "maintenance"
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `INVALID_VEHICLE_ID`     | Invalid vehicle ID format                        |
| 400         | `INVALID_STATUS`         | Invalid status value                             |
| 400         | `REASON_REQUIRED`        | Reason required for maintenance/unavailable status|
| 401         | `UNAUTHORIZED`           | User not authenticated                           |
| 403         | `FORBIDDEN`              | User does not have admin privileges              |
| 404         | `VEHICLE_NOT_FOUND`      | Vehicle not found                                |
| 409         | `ACTIVE_BOOKINGS`        | Vehicle has active bookings that conflict        |
| 500         | `UPDATE_FAILED`          | Failed to update vehicle status                   |

### Notes

- Status changes are logged for audit purposes
- Setting a vehicle to maintenance or unavailable checks for booking conflicts
- Status changes triggering booking conflicts require admin confirmation
- Status history is maintained for reporting purposes
- Automated notifications may be sent to affected bookings

---

## Record Vehicle Maintenance

Record maintenance activity for a vehicle.

### HTTP Request

`POST /vehicles/{id}/maintenance`

### Authentication

Requires a valid admin authentication token.

### Path Parameters

| Parameter | Type   | Required | Description         | Constraints                     |
|-----------|--------|----------|---------------------|--------------------------------|
| `id`      | String | Yes      | Vehicle identifier  | Must be a valid vehicle ID      |

### Request Body Parameters

| Parameter          | Type    | Required | Description                       | Constraints                    |
|-------------------|---------|----------|-----------------------------------|-------------------------------|
| `type`            | String  | Yes      | Maintenance type                   | e.g., repair, service, inspection|
| `description`     | String  | Yes      | Maintenance description           | Non-empty string              |
| `start_date`      | String  | Yes      | Maintenance start date            | ISO 8601 format               |
| `end_date`        | String  | No       | Expected end date                 | ISO 8601 format               |
| `cost`            | Float   | No       | Maintenance cost                  | Non-negative number           |
| `odometer`        | Integer | No       | Current odometer reading          | Non-negative integer          |
| `performed_by`    | String  | No       | Person/company performing work    | String                        |
| `parts_replaced`  | Array   | No       | List of parts replaced            | Array of strings              |
| `notes`           | String  | No       | Additional notes                  | String                        |

### Example Request

```json
{
  "type": "service",
  "description": "Regular 10,000 mile service",
  "start_date": "2023-07-15T09:00:00Z",
  "end_date": "2023-07-15T16:00:00Z",
  "cost": 249.99,
  "odometer": 10250,
  "performed_by": "AutoService Center",
  "parts_replaced": [
    "Oil filter",
    "Air filter", 
    "Wiper blades"
  ],
  "notes": "All fluids topped up, brakes inspected - 80% remaining"
}
```

### Response

Status code: `201 Created`

```json
{
  "status": "success",
  "message": "Maintenance record created successfully",
  "data": {
    "maintenance_id": 456,
    "vehicle_id": "v-123",
    "status_updated": true
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `INVALID_VEHICLE_ID`     | Invalid vehicle ID format                        |
| 400         | `VALIDATION_ERROR`       | Invalid or missing required fields               |
| 401         | `UNAUTHORIZED`           | User not authenticated                           |
| 403         | `FORBIDDEN`              | User does not have admin privileges              |
| 404         | `VEHICLE_NOT_FOUND`      | Vehicle not found                                |
| 500         | `RECORD_CREATION_FAILED` | Failed to create maintenance record              |

### Notes

- Maintenance recording can automatically update vehicle status
- Vehicle odometer reading is updated if provided
- Maintenance history is used for service scheduling and vehicle valuation
- Costs are tracked for financial reporting
- Maintenance records can be viewed in the vehicle history

---

## Get Vehicle History

Retrieve the history of a vehicle including bookings, maintenance, and status changes.

### HTTP Request

`GET /vehicles/{id}/history`

### Authentication

Requires a valid admin authentication token.

### Path Parameters

| Parameter | Type   | Required | Description         | Constraints                     |
|-----------|--------|----------|---------------------|--------------------------------|
| `id`      | String | Yes      | Vehicle identifier  | Must be a valid vehicle ID      |

### Query Parameters

| Parameter  | Type    | Required | Description               | Constraints                     |
|------------|---------|----------|---------------------------|--------------------------------|
| `page`     | Integer | No       | Page number               | Default: 1, Min: 1              |
| `per_page` | Integer | No       | Items per page            | Default: 20, Max: 100           |
| `type`     | String  | No       | Filter by history type    | Values: booking, maintenance, status |
| `from_date`| String  | No       | Start date for filtering  | ISO 8601 format                |
| `to_date`  | String  | No       | End date for filtering    | ISO 8601 format                |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "data": {
    "vehicle": {
      "id": "v-123",
      "make": "Toyota",
      "model": "Camry",
      "year": 2022,
      "registration_number": "ABC123"
    },
    "history": [
      {
        "type": "status_change",
        "timestamp": "2023-07-14T16:30:00Z",
        "details": {
          "from": "available",
          "to": "maintenance",
          "reason": "Scheduled maintenance",
          "changed_by": "admin@example.com"
        }
      },
      {
        "type": "maintenance",
        "timestamp": "2023-07-15T09:00:00Z",
        "details": {
          "maintenance_id": 456,
          "type": "service",
          "description": "Regular 10,000 mile service",
          "start_date": "2023-07-15T09:00:00Z",
          "end_date": "2023-07-15T16:00:00Z",
          "performed_by": "AutoService Center",
          "cost": 249.99
        }
      },
      {
        "type": "status_change",
        "timestamp": "2023-07-15T16:35:00Z",
        "details": {
          "from": "maintenance",
          "to": "available",
          "reason": "Maintenance completed",
          "changed_by": "admin@example.com"
        }
      },
      {
        "type": "booking",
        "timestamp": "2023-07-01T10:30:00Z",
        "details": {
          "booking_id": 789,
          "user_id": 456,
          "pickup_date": "2023-07-10T14:00:00Z",
          "dropoff_date": "2023-07-13T12:00:00Z",
          "status": "completed",
          "amount": 149.97,
          "user_name": "John Doe"
        }
      }
    ]
  },
  "meta": {
    "current_page": 1,
    "total_pages": 3,
    "total_items": 42,
    "per_page": 20
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `INVALID_VEHICLE_ID`     | Invalid vehicle ID format                        |
| 401         | `UNAUTHORIZED`           | User not authenticated                           |
| 403         | `FORBIDDEN`              | User does not have admin privileges              |
| 404         | `VEHICLE_NOT_FOUND`      | Vehicle not found                                |
| 500         | `SERVER_ERROR`           | Failed to retrieve vehicle history               |

### Notes

- Comprehensive history includes all vehicle-related events
- Events are sorted chronologically (newest first)
- History can be filtered by type for focused analysis
- Includes maintenance records, status changes, and booking history
- Personally identifiable information is limited for data protection compliance
- Detailed maintenance costs are only visible to admins
=== docs/backend/api/endpoints/documents.md ===
# Documents API Endpoints

## Overview

The Documents API provides endpoints for managing document templates, generating contracts, invoices, and terms & conditions. These endpoints enable secure creation, management, and retrieval of important legal and financial documents.

## Authentication and Permissions

| Endpoint Pattern                     | Required Role | Notes                                      |
|-------------------------------------|---------------|-------------------------------------------|
| `POST /documents/templates`          | Admin         | Upload document template                   |
| `POST /documents/contracts/{bookingId}/{userId}` | User | Generate contract for booking         |
| `POST /documents/terms`             | Admin         | Upload terms & conditions                  |
| `POST /documents/invoices/{bookingId}` | User       | Generate invoice for booking               |
| `DELETE /documents/{id}`            | Admin         | Delete a document                          |
| `GET /documents/templates`          | Admin         | Get all templates                          |
| `GET /documents/templates/{id}`     | Admin         | Get specific template                      |

## Rate Limiting

Document endpoints have the following rate limits:
- Standard tier: 20 requests per minute
- Premium tier: 50 requests per minute
- Template operations (admin): 100 requests per hour
- Document generation: 30 requests per hour per user

---

## Upload Document Template

Upload a new document template.

### HTTP Request

`POST /documents/templates`

### Authentication

Requires admin privileges.

### Request Body Parameters

| Parameter  | Type   | Required | Description                | Constraints                     |
|-----------|--------|----------|----------------------------|--------------------------------|
| `name`    | String | Yes      | Template name              | Max: 255 characters              |
| `content` | String | Yes      | Template content           | HTML/Markdown with placeholders  |
| `description` | String | No   | Template description       | Max: 1000 characters            |

### Example Request

```json
{
  "name": "booking_contract",
  "content": "<h1>Vehicle Rental Agreement</h1><p>This agreement is between {{company_name}} and {{customer_name}}...</p>",
  "description": "Standard vehicle rental agreement template"
}
```

### Response

Status code: `201 Created`

```json
{
  "status": "success",
  "message": "Template uploaded successfully",
  "data": {
    "template_id": 123,
    "name": "booking_contract",
    "created_at": "2023-06-15T14:30:00Z"
  }
}
```

### Error Codes

| Status Code | Error Code           | Description                                      |
|-------------|---------------------|--------------------------------------------------|
| 400         | `VALIDATION_ERROR`   | Missing required fields or validation failed     |
| 401         | `UNAUTHORIZED`       | User not authenticated                           |
| 403         | `FORBIDDEN`          | User does not have admin privileges              |
| 409         | `TEMPLATE_EXISTS`    | Template with same name already exists           |
| 500         | `UPLOAD_FAILED`      | Failed to upload template                        |

### Notes

- Templates can contain placeholders using {{variable}} syntax
- Templates are validated for proper HTML/markdown structure
- System templates (default) cannot be overwritten

---

## Generate Contract

Generate a contract for a specific booking.

### HTTP Request

`POST /documents/contracts/{bookingId}/{userId}`

### Authentication

Requires a valid user authentication token.

### Path Parameters

| Parameter   | Type    | Required | Description              | Constraints                     |
|-------------|---------|----------|--------------------------|--------------------------------|
| `bookingId` | Integer | Yes      | Booking identifier       | Must be a valid booking ID      |
| `userId`    | Integer | Yes      | User identifier          | Must be a valid user ID         |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "message": "Contract generated successfully",
  "data": {
    "contract_path": "/documents/contracts/booking_456_user_123.pdf",
    "contract_id": 789,
    "created_at": "2023-06-15T14:30:00Z"
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `INVALID_BOOKING_ID`     | Invalid booking ID                               |
| 400         | `INVALID_USER_ID`        | Invalid user ID                                  |
| 401         | `UNAUTHORIZED`           | User not authenticated                           |
| 403         | `ACCESS_DENIED`          | User does not have access to this booking        |
| 404         | `BOOKING_NOT_FOUND`      | Booking not found                                |
| 404         | `USER_NOT_FOUND`         | User not found                                   |
| 404         | `TEMPLATE_NOT_FOUND`     | Contract template not found                      |
| 500         | `GENERATION_FAILED`      | Failed to generate contract                      |

### Notes

- User must be the owner of the booking or an admin
- Generated contract includes booking and vehicle details
- Contract is securely stored with limited access
- Contract generation is logged for audit purposes

---

## Upload Terms & Conditions

Upload a new terms & conditions document.

### HTTP Request

`POST /documents/terms`

### Authentication

Requires admin privileges.

### Request Body Parameters

| Parameter  | Type   | Required | Description                | Constraints                     |
|-----------|--------|----------|----------------------------|--------------------------------|
| `content` | String | Yes      | T&C document content       | HTML/Markdown format            |
| `version` | String | Yes      | Version identifier         | Semantic versioning recommended |
| `effective_date` | String | Yes | Date when T&C becomes effective | ISO 8601 date format     |

### Example Request

```json
{
  "content": "<h1>Terms & Conditions</h1><p>These terms and conditions govern your use of the CarFuse vehicle rental platform...</p>",
  "version": "1.2.0",
  "effective_date": "2023-07-01T00:00:00Z"
}
```

### Response

Status code: `201 Created`

```json
{
  "status": "success",
  "message": "T&C document uploaded successfully",
  "data": {
    "terms_id": 123,
    "version": "1.2.0",
    "effective_date": "2023-07-01T00:00:00Z",
    "created_at": "2023-06-15T14:30:00Z"
  }
}
```

### Error Codes

| Status Code | Error Code           | Description                                      |
|-------------|---------------------|--------------------------------------------------|
| 400         | `VALIDATION_ERROR`   | Missing required content                         |
| 401         | `UNAUTHORIZED`       | User not authenticated                           |
| 403         | `FORBIDDEN`          | User does not have admin privileges              |
| 409         | `VERSION_EXISTS`     | Version already exists                           |
| 500         | `UPLOAD_FAILED`      | Failed to upload T&C document                    |

### Notes

- Previous versions are preserved for reference
- Users may need to accept new terms upon login after effective date
- Change logs between versions are automatically generated
- HTML is sanitized before storage to prevent security issues

---

## Generate Invoice

Generate an invoice for a specific booking.

### HTTP Request

`POST /documents/invoices/{bookingId}`

### Authentication

Requires a valid user authentication token.

### Path Parameters

| Parameter   | Type    | Required | Description              | Constraints                     |
|-------------|---------|----------|--------------------------|--------------------------------|
| `bookingId` | Integer | Yes      | Booking identifier       | Must be a valid booking ID      |

### Query Parameters

| Parameter   | Type    | Required | Description                | Constraints                     |
|-------------|---------|----------|----------------------------|--------------------------------|
| `format`    | String  | No       | Output format              | Values: pdf, html; Default: pdf |

### Response

Status code: `200 OK`

If format is PDF (default):
- Content-Type: `application/pdf`
- Content-Disposition: `attachment; filename="invoice_booking_456.pdf"`
- Binary PDF data

If format is HTML:
```json
{
  "status": "success",
  "message": "Invoice generated successfully",
  "data": {
    "html": "<!DOCTYPE html><html><head>...</head><body>...</body></html>",
    "invoice_id": 789,
    "created_at": "2023-06-15T14:30:00Z"
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `INVALID_BOOKING_ID`     | Invalid booking ID                               |
| 400         | `INVALID_FORMAT`         | Invalid format specified                         |
| 401         | `UNAUTHORIZED`           | User not authenticated                           |
| 403         | `ACCESS_DENIED`          | User does not have access to this booking        |
| 404         | `BOOKING_NOT_FOUND`      | Booking not found                                |
| 404         | `PAYMENT_REQUIRED`       | Booking has no associated payment                |
| 500         | `GENERATION_FAILED`      | Failed to generate invoice                       |

### Notes

- User must be the owner of the booking or an admin
- Invoices include legally required fiscal information
- Invoice generation is logged for audit purposes
- Invoices are only available for bookings with completed payments

---

## Delete Document

Delete a document from the system.

### HTTP Request

`DELETE /documents/{id}`

### Authentication

Requires admin privileges.

### Path Parameters

| Parameter | Type    | Required | Description         | Constraints                     |
|-----------|---------|----------|---------------------|--------------------------------|
| `id`      | Integer | Yes      | Document identifier | Must be a valid document ID     |

### Response

Status code: `204 No Content`

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `INVALID_DOCUMENT_ID`    | Invalid document ID                              |
| 401         | `UNAUTHORIZED`           | User not authenticated                           |
| 403         | `FORBIDDEN`              | User does not have admin privileges              |
| 404         | `DOCUMENT_NOT_FOUND`     | Document not found                               |
| 409         | `DOCUMENT_IN_USE`        | Document is in use and cannot be deleted         |
| 500         | `DELETE_FAILED`          | Failed to delete document                        |

### Notes

- System templates and required documents cannot be deleted
- Deletion is logged for audit purposes
- Document deletion may be a soft delete depending on document type

---

## Get All Templates

Retrieve all document templates.

### HTTP Request

`GET /documents/templates`

### Authentication

Requires admin privileges.

### Query Parameters

| Parameter   | Type    | Required | Description                | Constraints                     |
|-------------|---------|----------|----------------------------|--------------------------------|
| `page`      | Integer | No       | Page number                | Default: 1, Min: 1              |
| `per_page`  | Integer | No       | Items per page             | Default: 20, Max: 100           |
| `type`      | String  | No       | Filter by template type    | e.g., contract, invoice, terms  |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "data": {
    "templates": [
      {
        "id": 123,
        "name": "booking_contract",
        "description": "Standard vehicle rental agreement template",
        "type": "contract",
        "created_at": "2023-06-01T14:30:45Z",
        "updated_at": "2023-06-01T14:30:45Z"
      },
      {
        "id": 124,
        "name": "standard_invoice",
        "description": "Standard invoice template",
        "type": "invoice",
        "created_at": "2023-06-02T10:22:18Z",
        "updated_at": "2023-06-02T10:22:18Z"
      }
    ]
  },
  "meta": {
    "current_page": 1,
    "total_pages": 1,
    "total_items": 2,
    "per_page": 20
  }
}
```

### Error Codes

| Status Code | Error Code           | Description                                      |
|-------------|---------------------|--------------------------------------------------|
| 401         | `UNAUTHORIZED`       | User not authenticated                           |
| 403         | `FORBIDDEN`          | User does not have admin privileges              |
| 500         | `SERVER_ERROR`       | Failed to retrieve templates                     |

### Notes

- Templates are sorted by creation date (newest first) by default
- Only metadata is returned, not the full template content

---

## Get Template Details

Retrieve details for a specific template.

### HTTP Request

`GET /documents/templates/{id}`

### Authentication

Requires admin privileges.

### Path Parameters

| Parameter | Type    | Required | Description          | Constraints                     |
|-----------|---------|----------|----------------------|--------------------------------|
| `id`      | Integer | Yes      | Template identifier  | Must be a valid template ID     |

### Response

Status code: `200 OK`

```json
{
  "status": "success",
  "data": {
    "template": {
      "id": 123,
      "name": "booking_contract",
      "description": "Standard vehicle rental agreement template",
      "type": "contract",
      "content": "<h1>Vehicle Rental Agreement</h1><p>This agreement is between {{company_name}} and {{customer_name}}...</p>",
      "variables": ["company_name", "customer_name", "vehicle_details", "rental_period", "rate", "terms"],
      "created_at": "2023-06-01T14:30:45Z",
      "updated_at": "2023-06-01T14:30:45Z"
    }
  }
}
```

### Error Codes

| Status Code | Error Code                | Description                                      |
|-------------|--------------------------|--------------------------------------------------|
| 400         | `INVALID_TEMPLATE_ID`    | Invalid template ID                              |
| 401         | `UNAUTHORIZED`           | User not authenticated                           |
| 403         | `FORBIDDEN`              | User does not have admin privileges              |
| 404         | `TEMPLATE_NOT_FOUND`     | Template not found                               |
| 500         | `SERVER_ERROR`           | Failed to retrieve template                      |

### Notes

- Full template content is included in the response
- Available template variables are automatically extracted and listed
- Template content may be large for complex documents
=== docs/backend/api/endpoints/template.md ===
# [Resource Group] API Endpoints

## Overview

Brief description of this endpoint group, its purpose, and the resources it manages.

## Authentication and Permissions

| Endpoint Pattern     | Required Role | Notes                                      |
|----------------------|---------------|-------------------------------------------|
| `GET /resources`     | `viewer`      | List accessible resources                  |
| `GET /resources/:id` | `viewer`      | View individual resource details           |
| `POST /resources`    | `editor`      | Create new resources                       |
| `PUT /resources/:id` | `editor`      | Update existing resources                  |
| `DELETE /resources/:id` | `admin`    | Delete resources (soft delete)             |

## Rate Limiting

This endpoint group follows the standard API rate limits with the following specifics:
- Standard tier: 100 requests per minute
- Premium tier: 500 requests per minute
- Throttling applied individually to high-volume endpoints

---

## List Resources

Retrieves a paginated list of resources with optional filtering.

### HTTP Request

`GET /api/v1/resources`

### Query Parameters

| Parameter  | Type    | Required | Description                                    | Constraints                      |
|------------|---------|----------|------------------------------------------------|----------------------------------|
| `pageSize` | Integer | No       | Number of items per page                       | Default: 25, Max: 100            |
| `cursor`   | String  | No       | Pagination cursor                              | Obtained from previous responses |
| `status`   | String  | No       | Filter by resource status                      | Values: active, inactive, pending|
| `sort`     | String  | No       | Field to sort by                               | Format: fieldName or -fieldName for descending |
| `search`   | String  | No       | Search term for filtering results              | Min: 3 characters                |

### Response

Status code: `200 OK`

```json
{
  "data": [
    {
      "id": "res_12345",
      "type": "resource",
      "attributes": {
        "name": "Example Resource",
        "status": "active",
        "createdAt": "2023-11-15T08:30:45Z",
        "updatedAt": "2023-11-15T10:22:18Z"
      },
      "links": {
        "self": "/api/v1/resources/res_12345"
      }
    },
    // Additional resources...
  ],
  "meta": {
    "pagination": {
      "pageSize": 25,
      "totalCount": 243,
      "nextCursor": "WyIyMDIzLTExLTE1VDEwOjMwOjAwWiIsIDEwMDJd",
      "previousCursor": null,
      "hasNextPage": true,
      "hasPreviousPage": false
    }
  }
}
```

### Error Codes

| Status Code | Error Code           | Description                                                 |
|-------------|-----------------------|-------------------------------------------------------------|
| 400         | `INVALID_PARAMETER`   | One or more query parameters have invalid values            |
| 401         | `AUTHENTICATION_REQUIRED` | Authentication is required to access this endpoint      |
| 403         | `PERMISSION_DENIED`   | User does not have permission to list resources             |

---

## Get Resource Details

Retrieves detailed information about a specific resource.

### HTTP Request

`GET /api/v1/resources/:id`

### Path Parameters

| Parameter | Type   | Required | Description              | Constraints                   |
|-----------|--------|----------|--------------------------|-------------------------------|
| `id`      | String | Yes      | Unique resource ID       | Format: res_[a-zA-Z0-9]{5,}   |

### Response

Status code: `200 OK`

```json
{
  "data": {
    "id": "res_12345",
    "type": "resource",
    "attributes": {
      "name": "Example Resource",
      "description": "A detailed description of the resource",
      "status": "active",
      "category": "primary",
      "tags": ["example", "documentation"],
      "metadata": {
        "version": "1.0",
        "origin": "user_created"
      },
      "createdAt": "2023-11-15T08:30:45Z",
      "updatedAt": "2023-11-15T10:22:18Z"
    },
    "relationships": {
      "owner": {
        "id": "u-789",
        "type": "user"
      },
      "children": {
        "href": "/api/v1/resources/res_12345/children"
      }
    }
  },
  "meta": {
    "requestId": "a1b2c3d4-e5f6-7890-abcd-1234567890ab",
    "timestamp": "2023-11-15T08:30:45Z"
  }
}
```

### Error Codes

| Status Code | Error Code               | Description                                                 |
|-------------|--------------------------|-------------------------------------------------------------|
| 400         | `INVALID_RESOURCE_ID`    | The resource ID format is invalid                           |
| 401         | `AUTHENTICATION_REQUIRED`| Authentication is required to access this endpoint          |
| 403         | `PERMISSION_DENIED`      | User does not have permission to view this resource         |
| 404         | `RESOURCE_NOT_FOUND`     | No resource exists with the specified ID                    |

---

## Create Resource

Creates a new resource with the provided attributes.

### HTTP Request

`POST /api/v1/resources`

### Request Body Parameters

| Parameter     | Type    | Required | Description                          | Constraints                      |
|---------------|---------|----------|--------------------------------------|----------------------------------|
| `name`        | String  | Yes      | Name of the resource                 | Min: 3, Max: 100 characters      |
| `description` | String  | No       | Detailed description of the resource | Max: 1000 characters             |
| `status`      | String  | No       | Initial status of the resource       | Default: "pending"               |
| `category`    | String  | Yes      | Category classification              | Values: primary, secondary, other|
| `tags`        | Array   | No       | Associated tags                      | Max: 10 tags                     |
| `metadata`    | Object  | No       | Additional resource metadata         | Max size: 5KB                    |

### Example Request

```json
{
  "name": "New Resource",
  "description": "This is a newly created resource for demonstration",
  "category": "primary",
  "tags": ["new", "example"],
  "metadata": {
    "source": "api_documentation",
    "priority": "high"
  }
}
```

### Response

Status code: `201 Created`

```json
{
  "data": {
    "id": "res_67890",
    "type": "resource",
    "attributes": {
      "name": "New Resource",
      "description": "This is a newly created resource for demonstration",
      "status": "pending",
      "category": "primary",
      "tags": ["new", "example"],
      "metadata": {
        "source": "api_documentation",
        "priority": "high"
      },
      "createdAt": "2023-11-15T14:22:36Z",
      "updatedAt": "2023-11-15T14:22:36Z"
    },
    "links": {
      "self": "/api/v1/resources/res_67890"
    }
  },
  "meta": {
    "requestId": "b2c3d4e5-f6a7-8901-bcde-2345678901fa",
    "timestamp": "2023-11-15T14:22:36Z"
  }
}
```

### Error Codes

| Status Code | Error Code               | Description                                                 |
|-------------|--------------------------|-------------------------------------------------------------|
| 400         | `INVALID_REQUEST`        | The request body is malformed or invalid                    |
| 400         | `VALIDATION_FAILED`      | One or more fields failed validation                        |
| 401         | `AUTHENTICATION_REQUIRED`| Authentication is required to access this endpoint          |
| 403         | `PERMISSION_DENIED`      | User does not have permission to create resources           |
| 409         | `RESOURCE_ALREADY_EXISTS`| A resource with the same unique identifier already exists   |
| 422         | `UNPROCESSABLE_ENTITY`   | The request is valid but cannot be processed                |

### Notes on Idempotency

- This endpoint supports idempotency using the `Idempotency-Key` header
- Providing the same idempotency key with identical request bodies will not create duplicate resources
- Idempotency keys expire after 24 hours

---

## Update Resource

Updates an existing resource with the provided attributes.

### HTTP Request

`PUT /api/v1/resources/:id`

### Path Parameters

| Parameter | Type   | Required | Description              | Constraints                   |
|-----------|--------|----------|--------------------------|-------------------------------|
| `id`      | String | Yes      | Unique resource ID       | Format: res_[a-zA-Z0-9]{5,}   |

### Request Body Parameters

| Parameter     | Type    | Required | Description                          | Constraints                      |
|---------------|---------|----------|--------------------------------------|----------------------------------|
| `name`        | String  | No       | Name of the resource                 | Min: 3, Max: 100 characters      |
| `description` | String  | No       | Detailed description of the resource | Max: 1000 characters             |
| `status`      | String  | No       | Status of the resource               | Values: active, inactive, pending|
| `category`    | String  | No       | Category classification              | Values: primary, secondary, other|
| `tags`        | Array   | No       | Associated tags                      | Max: 10 tags                     |
| `metadata`    | Object  | No       | Additional resource metadata         | Max size: 5KB                    |

### Example Request

```json
{
  "name": "Updated Resource Name",
  "status": "active",
  "tags": ["updated", "example", "documentation"]
}
```

### Response

Status code: `200 OK`

```json
{
  "data": {
    "id": "res_12345",
    "type": "resource",
    "attributes": {
      "name": "Updated Resource Name",
      "description": "A detailed description of the resource",
      "status": "active",
      "category": "primary",
      "tags": ["updated", "example", "documentation"],
      "metadata": {
        "version": "1.0",
        "origin": "user_created"
      },
      "createdAt": "2023-11-15T08:30:45Z",
      "updatedAt": "2023-11-15T15:10:22Z"
    },
    "links": {
      "self": "/api/v1/resources/res_12345"
    }
  },
  "meta": {
    "requestId": "c3d4e5f6-a7b8-9012-cdef-34567890abcd",
    "timestamp": "2023-11-15T15:10:22Z"
  }
}
```

### Error Codes

| Status Code | Error Code               | Description                                                 |
|-------------|--------------------------|-------------------------------------------------------------|
| 400         | `INVALID_REQUEST`        | The request body is malformed or invalid                    |
| 400         | `INVALID_RESOURCE_ID`    | The resource ID format is invalid                           |
| 400         | `VALIDATION_FAILED`      | One or more fields failed validation                        |
| 401         | `AUTHENTICATION_REQUIRED`| Authentication is required to access this endpoint          |
| 403         | `PERMISSION_DENIED`      | User does not have permission to update this resource       |
| 404         | `RESOURCE_NOT_FOUND`     | No resource exists with the specified ID                    |
| 409         | `RESOURCE_CONFLICT`      | The update conflicts with the current resource state        |
| 422         | `UNPROCESSABLE_ENTITY`   | The request is valid but cannot be processed                |

### Notes on Idempotency

- This operation is naturally idempotent - calling it multiple times with the same parameters will not cause additional side effects beyond the first successful call
- Optimistic concurrency control is available using the `If-Match` header with the resource's ETag

---

## Delete Resource

Deletes an existing resource. This is a soft delete operation.

### HTTP Request

`DELETE /api/v1/resources/:id`

### Path Parameters

| Parameter | Type   | Required | Description              | Constraints                   |
|-----------|--------|----------|--------------------------|-------------------------------|
| `id`      | String | Yes      | Unique resource ID       | Format: res_[a-zA-Z0-9]{5,}   |

### Query Parameters

| Parameter     | Type    | Required | Description                          | Constraints                      |
|---------------|---------|----------|--------------------------------------|----------------------------------|
| `permanent`   | Boolean | No       | Whether to perform a permanent delete | Default: false                   |

### Response

Status code: `204 No Content`

No response body is returned for successful deletion operations.

### Error Codes

| Status Code | Error Code               | Description                                                 |
|-------------|--------------------------|-------------------------------------------------------------|
| 400         | `INVALID_RESOURCE_ID`    | The resource ID format is invalid                           |
| 401         | `AUTHENTICATION_REQUIRED`| Authentication is required to access this endpoint          |
| 403         | `PERMISSION_DENIED`      | User does not have permission to delete this resource       |
| 404         | `RESOURCE_NOT_FOUND`     | No resource exists with the specified ID                    |
| 409         | `RESOURCE_IN_USE`        | The resource cannot be deleted because it is in use         |

### Notes on Side Effects

- Soft deletion marks the resource as deleted but retains the data
- Associated child resources are not automatically deleted
- Permanently deleted resources cannot be recovered
- Only administrators can perform permanent deletions
=== docs/backend/api/endpoints/audit.md ===
# Audit API Endpoints

This document describes the audit endpoints available under the `/api/audit` route.

> **Note:** All endpoints require admin access. Unauthorized requests will receive a 403 Forbidden response.

---

## GET /api/audit

**Description:**  
Retrieves audit logs based on optional filter parameters.

**Authorization:** Admin access required

**Query Parameters:**
- `category` (string, optional): Filter by log category.
- `action` (string, optional): Filter by specific action.
- `user_id` (integer, optional): Filter by user ID.
- `booking_id` (integer, optional): Filter by booking ID.
- `start_date` (string, optional): Filter by start date (YYYY-MM-DD).
- `end_date` (string, optional): Filter by end date (YYYY-MM-DD).
- `page` (integer, optional): Page number for pagination. Defaults to 1.
- `per_page` (integer, optional): Items per page. Maximum 100, defaults to 10.
- `log_level` (string, optional): Filter by log level.

**Status Codes:**
- 200 OK: Successful retrieval
- 403 Forbidden: Insufficient permissions
- 500 Internal Server Error: Server error occurred

**Success Response:**
```json
{
  "status": "success",
  "data": [
    {
      "id": 101,
      "action": "admin_dashboard_viewed",
      "message": "Admin dashboard viewed",
      "details": { "admin_id": 1 },
      "created_at": "2023-10-01 12:34:56"
    },
    // ... more logs ...
  ]
}
```

**Error Response:**
```json
{
  "status": "error",
  "message": "Admin access required"
}
```

---

## POST /api/audit/fetchLogs

**Description:**  
Fetches audit logs with the filters provided in the request body.

**Authorization:** Admin access required

**Payload Parameters:**  
- `category` (string, optional): Filter by log category.
- `action` (string, optional): Filter by specific action.
- `user_id` (integer, optional): Filter by user ID.
- `booking_id` (integer, optional): Filter by booking ID.
- `start_date` (string, optional): Filter by start date (YYYY-MM-DD).
- `end_date` (string, optional): Filter by end date (YYYY-MM-DD).
- `page` (integer, optional): Page number for pagination. Defaults to 1.
- `per_page` (integer, optional): Items per page. Maximum 100, defaults to 10.
- `log_level` (string, optional): Filter by log level.

**Status Codes:**
- 200 OK: Successful retrieval
- 403 Forbidden: Insufficient permissions
- 500 Internal Server Error: Server error occurred

**Success Response:**  
Same structure as the GET endpoint response.

**Error Response:**
```json
{
  "status": "error",
  "message": "Failed to fetch logs"
}
```

---

## GET /api/audit/{id}

**Description:**  
Retrieves detailed information for a single audit log entry identified by its ID.

**Authorization:** Admin access required

**URL Parameter:**
- `id` (integer): The unique identifier of the audit log entry.

**Status Codes:**
- 200 OK: Successful retrieval
- 403 Forbidden: Insufficient permissions
- 404 Not Found: Log not found
- 500 Internal Server Error: Server error occurred

**Success Response:**
```json
{
  "status": "success",
  "data": {
    "log": {
      "id": 101,
      "action": "admin_dashboard_viewed",
      "message": "Admin dashboard viewed",
      "details": { "admin_id": 1 },
      "created_at": "2023-10-01 12:34:56"
    }
  }
}
```

**Error Response:**
```json
{
  "status": "error",
  "message": "Log not found"
}
```

---

## POST /api/audit/exportLogs

**Description:**  
Exports audit logs matching the provided filters. Returns information about the generated export file.

**Authorization:** Admin access required

**Payload Parameters:**  
- `category` (string, optional): Filter by log category.
- `action` (string, optional): Filter by specific action.
- `user_id` (integer, optional): Filter by user ID.
- `booking_id` (integer, optional): Filter by booking ID.
- `start_date` (string, optional): Filter by start date (YYYY-MM-DD).
- `end_date` (string, optional): Filter by end date (YYYY-MM-DD).
- `log_level` (string, optional): Filter by log level.

**Status Codes:**
- 200 OK: Successful export
- 403 Forbidden: Insufficient permissions
- 500 Internal Server Error: Server error occurred

**Success Response:**
```json
{
  "status": "success",
  "data": {
    "export": {
      "file_path": "/tmp/secure_exports/audit_logs_export_20231001_123456_abcd1234.csv",
      "file_name": "audit_logs_export_20231001_123456_abcd1234.csv",
      "export_id": "20231001_123456_abcd1234",
      "row_count": 50,
      "expiry_time": 1700000000,
      "expiry_formatted": "2023-10-15 00:00:00"
    }
  }
}
```

**Error Response:**
```json
{
  "status": "error",
  "message": "Failed to export logs"
}
```
=== docs/backend/DependencyInjection.md ===
# CarFuse Dependency Injection System

This document provides a comprehensive overview of the dependency injection (DI) system used in the CarFuse application. The DI system is built using PHP-DI and follows a structured initialization and service registration approach.

## 1. Container Initialization Process

The dependency injection container is initialized during the application bootstrap process through a sequence of carefully orchestrated steps:

### 1.1. Bootstrap Sequence

1. **Logger Initialization**: 
   ```php
   $logger = require_once __DIR__ . '/logger.php';
   global $loggers;
   ```
   The system first initializes the logging system, making both the main logger and category-specific loggers available globally.

2. **Environment Loading**:
   ```php
   $dotenv = Dotenv::createImmutable($dotenvPath);
   $dotenv->load();
   ```
   Environment variables are loaded from the `.env` file using the Dotenv library.

3. **Configuration Loading**:
   ```php
   $config = [];
   $configDir = __DIR__ . '/config';
   $requiredConfigs = ['database', 'encryption', 'app', 'filestorage', 'keymanager', 'documents'];
   // Load required configs first, then additional configs...
   ```
   Configuration files are loaded dynamically, with required configurations checked first.

4. **Core Service Initialization**:
   ```php
   $exceptionHandler = new ExceptionHandler($loggers['db'], $loggers['auth'], $logger);
   // Additional core services initialized...
   ```
   Critical services like ExceptionHandler, LogLevelFilter, and AuditService are pre-initialized in a specific order to resolve dependency chains.

5. **Container Creation**:
   ```php
   $container = new \DI\Container();
   $GLOBALS['container'] = $container; // Make container available globally
   ```
   The DI container is created and made available globally.

### 1.2. Container Configuration

In `dependencies.php`, the container is either reused from the bootstrap process or created with production optimizations:

```php
if (isset($container) && $container instanceof Container) {
    $logger->info("Using pre-configured container from bootstrap");
} else {
    $containerBuilder = new ContainerBuilder();
    
    // Enable container compilation for production
    if (isset($config['environment']) && $config['environment'] === 'production') {
        $cacheDir = __DIR__ . '/../var/cache';
        if (!is_dir($cacheDir)) {
            mkdir($cacheDir, 0755, true);
        }
        $containerBuilder->enableCompilation($cacheDir);
        $containerBuilder->writeProxiesToFile(true, $cacheDir . '/proxies');
    }
    
    $container = $containerBuilder->build();
}
```

For production environments, the container is configured with compilation enabled to optimize performance:
- Compiled container definitions are stored in a cache directory
- Proxy classes are written to files for faster instantiation
- This significantly improves service resolution speed

## 2. Service Registration and Autowiring

The CarFuse DI system uses three primary methods for registering and autowiring services:

### 2.1. Pre-initialized Service Registration

Core services are initialized during bootstrap and then registered directly:

```php
// Register pre-initialized services in bootstrap.php
$container->set(App\Helpers\ExceptionHandler::class, $coreServices['exceptionHandler']);
$container->set(App\Services\AuditService::class, $coreServices['auditService']);
$container->set(DatabaseHelper::class, $database);
```

### 2.2. Factory Function Registration

Most services are registered using factory functions that define how to create the service and its dependencies:

```php
// From dependencies.php
$container->set(DatabaseHelper::class, function(Container $c) use ($config) {
    $logger = $c->get('logger.db') ?? $c->get(LoggerInterface::class);
    $apiHelper = $c->get(ApiHelper::class);
    return new DatabaseHelper($config['database'] ?? [], $logger, $apiHelper);
});
```

### 2.3. Service Dependency Resolution

Dependencies are resolved by requesting them from the container within the factory function:

```php
// From svc_dep.php
$container->set(AuthService::class, function($c) use ($config) {
    return new AuthService(
        $c->get(DatabaseHelper::class),
        $c->get(TokenService::class),
        $c->get(ExceptionHandler::class),
        $c->get('logger.auth'),
        $c->get(AuditService::class),
        $config['encryption'] ?? [],
        $c->get(Validator::class),
        $c->get(User::class)
    );
});
```

### 2.4. Fallback Mechanism for Loggers

The system implements a fallback mechanism for logger services, ensuring that even if a category-specific logger isn't available, a default logger is used:

```php
$logger = $c->get('logger.auth') ?? $c->get(LoggerInterface::class);
```

### 2.5. Service Organization

Services are organized into logical groups across multiple files:

- **dependencies.php**: Registers helpers and middleware
- **svc_dep.php**: Registers business services and models
- **ctrl_dep.php**: Registers controllers with their dependencies

## 3. Service Lifetime Management

The CarFuse DI system manages service lifetimes in several ways:

### 3.1. Default Singleton Behavior

By default, the PHP-DI container treats services as singletons, creating one instance per request:

```php
// Once resolved, subsequent calls to $container->get(DatabaseHelper::class) 
// will return the same instance
$container->set(DatabaseHelper::class, function(Container $c) use ($config) {
    // ...implementation...
});
```

### 3.2. Explicit Caching in Production

For production environments, container compilation enhances performance by generating optimized code:

```php
if ($config['environment'] === 'production') {
    $containerBuilder->enableCompilation($cacheDir);
    $containerBuilder->writeProxiesToFile(true, $cacheDir . '/proxies');
}
```

### 3.3. Pre-initialized Services

Some critical services are pre-initialized during bootstrap and shared throughout the application lifetime:

```php
// These services are created once during bootstrap
$exceptionHandler = new ExceptionHandler(/*...*/);
$auditService = new AuditService(/*...*/);

// And registered in the container
$container->set(App\Helpers\ExceptionHandler::class, $exceptionHandler);
$container->set(App\Services\AuditService::class, $auditService);
```

### 3.4. Service Verification

The system verifies that critical services are properly loaded:

```php
$requiredServices = [
    DatabaseHelper::class,
    ExceptionHandler::class,
    SecurityHelper::class,
    AuditService::class,
    // ...
];

foreach ($requiredServices as $service) {
    try {
        $container->get($service);
        // Service loaded successfully
    } catch (\Exception $e) {
        // Service failed to load
        $failedServices[] = $errorMsg;
    }
}
```

## 4. Examples of Defining Injectable Services

### 4.1. Simple Service with Basic Dependencies

```php
$container->set(Validator::class, function($c) {
    return new Validator(
        $c->get('logger.api') ?? $c->get(LoggerInterface::class),
        $c->get(DatabaseHelper::class),
        $c->get(ExceptionHandler::class)
    );
});
```

### 4.2. Service with Configuration Dependencies

```php
$container->set(EncryptionService::class, function($c) use ($config) {
    return new EncryptionService(
        $c->get('logger.security') ?? $c->get(LoggerInterface::class),
        $c->get(ExceptionHandler::class),
        $config['encryption']['key']
    );
});
```

### 4.3. Controller with Multiple Service Dependencies

```php
$container->set(BookingController::class, function($c) use ($logger, $loggers) {
    return new BookingController(
        $loggers['booking'] ?? $logger,
        $c->get(BookingService::class),
        $c->get(PaymentService::class),
        $c->get(Validator::class),
        $c->get(AuditService::class),
        $c->get(NotificationService::class),
        $c->get(ResponseFactoryInterface::class),
        $c->get(TokenService::class),
        $c->get(ExceptionHandler::class)
    );
});
```

### 4.4. Service with Conditional Registration

```php
// Only register if not already registered
if (!$container->has(AuditService::class)) {
    $container->set(AuditService::class, function($c) use ($loggers, $logger, $config) {
        // Implementation...
    });
}
```

### 4.5. Model with Database Dependencies

```php
$container->set(User::class, function($c) {
    return new User(
        $c->get(DatabaseHelper::class),
        $c->get('logger.api') ?? $c->get('logger.db') ?? $c->get(LoggerInterface::class),
        $c->get(AuditService::class)
    );
});
```

## 5. Best Practices for Adding New Services

When adding new services to the CarFuse application, follow these best practices:

1. **Determine the correct file for registration**:
   - `svc_dep.php` for business logic services and models
   - `ctrl_dep.php` for controllers
   - `dependencies.php` for helpers and middleware

2. **Use consistent registration patterns**:
   ```php
   $container->set(YourNewService::class, function($c) use ($config, $logger, $loggers) {
       return new YourNewService(
           $loggers['appropriate_category'] ?? $logger,
           $c->get(RequiredDependency::class),
           // Additional dependencies...
           $config['relevant_config'] ?? []
       );
   });
   ```

3. **Follow the logger fallback pattern**:
   ```php
   $logger = $c->get('logger.your_category') ?? $c->get(LoggerInterface::class);
   ```

4. **Check for existing instances before registration** (for services that might be pre-initialized):
   ```php
   if (!$container->has(YourService::class)) {
       $container->set(YourService::class, function($c) {
           // Implementation...
       });
   }
   ```

5. **Register service implementations rather than interfaces** unless you need to swap implementations:
   ```php
   $container->set(ConcreteImplementation::class, function($c) {
       // Implementation...
   });
   ```

## 6. Debugging Dependency Issues

When experiencing dependency resolution issues:

1. Check the application logs for container initialization errors
2. Verify that all required services are registered
3. Look for circular dependencies in service definitions
4. Ensure the service constructor matches the dependencies being provided
5. Check for typos in service class names or namespaces

The system automatically logs service initialization failures:

```php
foreach ($requiredServices as $service) {
    try {
        $container->get($service);
        $container->get('logger.dependencies')->debug("Service loaded successfully: {$service}");
    } catch (\Exception $e) {
        $errorMsg = "Service failed to load: {$service}: " . $e->getMessage();
        $container->get('logger.dependencies')->critical($errorMsg);
        $failedServices[] = $errorMsg;
    }
}
```

## Conclusion

The CarFuse dependency injection system provides a robust foundation for managing service dependencies throughout the application. By leveraging PHP-DI with a structured initialization and registration process, the system ensures that services are properly wired together, while allowing for optimization in production environments.

The combination of pre-initialized critical services, factory-based registration, and proper service lifetime management creates a flexible and maintainable dependency injection system that can easily accommodate new services as the application grows.
=== docs/backend/security/overview.md ===
# Security Overview

## Security Architecture Overview
The backend security architecture implements a multi-layered defense approach through specialized middleware components and services. Authentication is primarily handled via JWT tokens (using AuthMiddleware and TokenService), while data protection is ensured through CSRF protection (CsrfMiddleware) and selective encryption (EncryptionMiddleware). Sessions are secured with HTTP-only cookies, secure flags, and automatic regeneration to prevent fixation attacks. The system incorporates robust token validation, rate limiting on authentication endpoints, comprehensive security logging, and user data protection through careful attribute management in the request lifecycle.

## Key Security Measures Implemented
- JWT-based authentication with secure token management (generation, validation, refresh)
- Session protection with secure cookies, automatic ID regeneration, and strict configuration
- CSRF protection with token validation for state-changing requests
- Request/response encryption for sensitive endpoints and data fields
- Rate limiting on authentication endpoints to prevent brute force attacks
- Secure cookie attributes (HttpOnly, SameSite, Secure flags)
- Session fingerprinting to detect hijacking attempts
- Input sanitization to prevent XSS attacks
- Comprehensive security audit logging
- Token revocation capabilities and expired token cleanup
- Different authentication flows (header-based, cookie-based)
- Special security handling for HTMX requests

## Security Responsibilities by Component

| Component               | Responsibility                                                       |
|-------------------------|----------------------------------------------------------------------|
| AuthMiddleware          | Extracts and validates JWT tokens, attaches user data to requests    |
| CsrfMiddleware          | Generates and validates CSRF tokens for state-changing operations    |
| EncryptionMiddleware    | Encrypts/decrypts sensitive request and response data               |
| TokenService            | Manages JWT tokens (creation, verification, refresh, revocation)     |
| SessionMiddleware       | Secures sessions with regeneration, secure cookies, and fingerprinting |
| RequireAuthMiddleware   | Enforces authentication requirements on protected routes             |
| UserDataMiddleware      | Manages user data in session and request attributes                 |
| SecurityHelper          | Provides security utilities (sanitization, session management, CSRF) |
| TokenValidationMiddleware| Validates tokens and attaches user data to request                  |
| RateLimiter             | Prevents brute force attacks on authentication endpoints            |

## Integration Points between Security Systems

1. **Auth Flow Integration**:
   - AuthMiddleware extracts tokens  TokenService validates  User data attached to request
   - RequireAuthMiddleware checks request attributes set by AuthMiddleware
   - AuthController uses TokenService and RateLimiter to secure authentication endpoints

2. **Session and CSRF Integration**:
   - SessionMiddleware secures session  CsrfMiddleware uses session to store/validate tokens
   - HtmxMiddleware adds CSRF tokens to response headers for AJAX requests
   - UserDataMiddleware loads user data from session secured by SessionMiddleware

3. **Data Protection Chain**:
   - EncryptionMiddleware protects sensitive data based on endpoint configuration
   - SecurityHelper sanitizes input that may be processed by other components
   - TokenService integrates with AuditService to log security events

4. **Token Lifecycle Management**:
   - AuthService issues tokens  TokenService manages  AuthMiddleware validates
   - RefreshToken model tracks token status  TokenService coordinates revocation

## Security Flow Diagram

```
                    
                      Client Request  
                    
                             
                             

               Session Handling                 
            
  SessionMiddle-Session Integrity   
      ware                   Check          
            

                     
                     

                CSRF Protection                 
            
  CsrfMiddlewareToken Validation    
                              
                            

                     
                     

             Authentication Flow                
            
  AuthMiddleware  TokenService      
           Token Validation   
                           
                                               
                               
  RequireAuth                                
   Middleware                                
                               

                     
                     

               Data Protection                  
            
  Encryption    Sensitive Data      
  Middleware            Processing          
            

                     
                     
         
           Application Logic   
           (Controllers)       
         
```

## Security Best Practices Implemented

- Tokens are stored using HTTP-only cookies to prevent JavaScript access
- Rate limiting prevents brute force attacks on authentication endpoints
- Session IDs are regenerated periodically to prevent session fixation
- Sensitive data is encrypted when stored and transmitted
- CSRF tokens protect against cross-site request forgery
- Input sanitization defends against XSS attacks
- Comprehensive security logging provides audit trail for security events
- Multiple validation layers ensure defense in depth
=== docs/backend/security/authentication.md ===
# Authentication System

## Authentication Methods Supported

The carfuse application supports multiple authentication methods:

1. **JWT Token Authentication** - Primary authentication method using JSON Web Tokens
   - Bearer token in Authorization header
   - Secure HttpOnly cookie storage
   
2. **Session-based Authentication** - Used for web interface access
   - PHP session management with enhanced security
   - Integration with JWT tokens for consistent authentication

3. **Dual-token System**
   - Short-lived access tokens for API requests
   - Long-lived refresh tokens for obtaining new access tokens

## Token Structure and Lifecycle

### Token Structure

JWT tokens contain the following claims:

```
{
  "iss": "[configured issuer]",   // Token issuer
  "aud": "[configured audience]", // Token audience
  "iat": 1623456789,              // Issued at timestamp
  "exp": 1623460389,              // Expiration timestamp
  "nbf": 1623456789,              // Not valid before timestamp
  "sub": "123",                   // User ID
  "role": "user"                  // User role
}
```

### Token Lifecycle

1. **Creation** - Generated by AuthService/TokenService during:
   - Login success
   - Token refresh
   - Registration (if auto-login)

2. **Storage**
   - Access token stored as HttpOnly cookie with 1-hour expiry
   - Refresh token stored as HttpOnly cookie with 7-day expiry
   - Database record maintained in RefreshToken model

3. **Validation**
   - Handled by TokenService.verifyToken()
   - Performed by AuthMiddleware and TokenValidationMiddleware
   - Checks signature, expiration, and token revocation status

4. **Refresh**
   - Client uses refresh token to obtain new access token
   - Old access token is invalidated
   - Token rotation for security

5. **Revocation**
   - Explicit logout (clearing cookies)
   - Database revocation flagging
   - Expired token cleanup via scheduled task

## Session Management Implementation

The session management system employs a layered approach:

1. **Secure Configuration**
   - HttpOnly flag prevents JavaScript access
   - Secure flag ensures HTTPS-only transmission
   - SameSite=Strict/Lax prevents CSRF attacks
   - Custom session name to avoid fingerprinting

2. **Session Integrity Protection**
   - IP address fingerprinting to detect session hijacking
   - User agent validation on each request
   - Automatic session regeneration every 30 minutes
   - Session fixation prevention

3. **State Management**
   - Request attribute-based session data handling
   - Session middleware coordination with authentication

4. **Expiry Handling**
   - Absolute session timeout (2 hours default)
   - Inactivity timeout (30 minutes default)
   - Forced re-authentication for sensitive operations

## Login Security Measures

The system implements multiple layers of login security:

1. **Rate Limiting**
   - Per-email rate limiting (5 attempts per 15 minutes)
   - Per-IP address rate limiting (10 attempts per hour)
   - Exponential backoff for repeated failures
   - Separate limits for password reset attempts

2. **Account Lockout Protection**
   - Temporary account lockout after multiple failed attempts
   - Notification to user on suspicious login activity
   - Admin alert on repeated lockouts

3. **Monitoring and Logging**
   - All authentication attempts logged via AuditService
   - Login location tracking for anomaly detection
   - Comprehensive audit trail with IP addresses

4. **Multi-factor Hooks**
   - Architecture supports adding second factor authentication
   - Risk-based authentication framework

## Credential Storage Approach

1. **Password Hashing**
   - Passwords hashed using PHP's password_hash() with PASSWORD_DEFAULT
   - Automatically upgrades hash algorithm when PHP default changes
   - Individual salt for each password

2. **Database Security**
   - No plaintext passwords stored at any point
   - Password reset uses one-time tokens, not original passwords
   - Encrypted database connection

3. **Credential Validation**
   - Time-constant comparison for password verification
   - Validation performed server-side only
   - Model-based encapsulation of credential verification

## Authentication Flow Diagram

```
               
Client     AuthController       AuthService         TokenService  
               
                                                              
     Login Request                                            
   >                                          
                                                              
                       Validate Request                       
                    >                     
                                                              
                                           Rate Limit Check   
                                            
                                                             
                                         <  
                                                              
                                          Validate Credentials
                                            
                                                             
                                         <  
                                                              
                                           Generate Tokens    
                                         >
                                                              
                                                                Create JWT
                                                              
                                                                               
                                                              <
                                                              
                                         <Token Generated
                                                              
                     Store Refresh Token                      
                    >                     
                                                              
                    <Tokens & User Data   
                                                              
   <Set Secure Cookies                        
        Success     & Send Response                           
                                                              
               
```

## Security Best Practices for Clients

When implementing authentication in client applications:

1. **Token Handling**
   - Never store tokens in localStorage or sessionStorage
   - Rely on secure HttpOnly cookies
   - Don't extract or parse tokens in JavaScript
   - Implement token refresh logic properly

2. **Login Form Security**
   - Implement CSRF protection on login forms
   - Use HTTPS for all authentication requests
   - Disable autocomplete for sensitive fields
   - Implement proper input validation

3. **Logout Handling**
   - Always call the server logout endpoint
   - Clear local application state after logout
   - Implement proper error handling for failed logout
   - Consider session timeout notifications

4. **Error Handling**
   - Use generic error messages to prevent user enumeration
   - Log authentication failures but don't display specific errors
   - Implement proper rate limiting on client side

5. **Security Headers**
   - Set proper Content-Security-Policy headers
   - Use X-Content-Type-Options: nosniff
   - Enable Strict-Transport-Security
   - Consider X-Frame-Options to prevent clickjacking

6. **Mobile Applications**
   - Securely store refresh tokens in the keychain/keystore
   - Implement certificate pinning
   - Support biometric authentication when available
   - Implement app-level session timeouts
=== docs/backend/security/encryption.md ===
# Encryption

## Overview

The CarFuse application employs a multi-layered encryption approach to protect sensitive data both at rest (in storage) and in transit. This document outlines how encryption is implemented throughout the application.

## Encryption Standards and Algorithms

### Core Encryption

- **Primary Algorithm**: AES-256 (Advanced Encryption Standard with 256-bit key)
- **Implementation**: Laravel's `Crypt` facade for standard operations
- **Key Derivation**: PBKDF2 (Password-Based Key Derivation Function 2)
- **Data Signatures**: HMAC with SHA-256

### Transport Security

- **HTTPS/TLS**: Required for all API endpoints
- **API Payload Encryption**: Additional application-level encryption for sensitive endpoints
- **JWT Security**: Signed tokens with HS256 algorithm

## Key Management

The application uses the `KeyManager` service to manage encryption keys:

### Key Hierarchy

1. **Master Key**: Used for encrypting other keys
2. **Domain-specific Keys**: Separate keys for different data domains
3. **Rotation Keys**: Temporary keys used during key rotation processes

### Key Generation

```php
// Example using the KeyManager service
$keyManager = new KeyManager($config, $logger, $exceptionHandler);
$newKey = $keyManager->generateKey(); // Returns a cryptographically secure random key
```

### Key Rotation

Keys are rotated according to the following schedule:
- Master key: Every 90 days
- Domain keys: Every 30 days
- JWT keys: Every 14 days

```php
// Key rotation example
$keyManager->rotateKey('payments');
```

### Key Storage

- Keys are never stored in code or version control
- Keys are stored in secure key vaults or encrypted configuration
- In development environments, keys are stored in `.env` files (excluded from version control)
- In production, keys are stored in a secure key management service

## Data-at-Rest Encryption

### Database Encryption

Sensitive fields in the database are encrypted before storage and decrypted after retrieval:

```php
// How encryption is applied to model data
protected function encryptSensitiveData(array $data): array
{
    foreach ($this->encryptedFields as $field) {
        if (isset($data[$field])) {
            $data[$field] = $this->encryptionService->encrypt($data[$field]);
        }
    }
    return $data;
}
```

### Sensitive Fields

The following types of data are automatically encrypted:
1. **Financial Information**: Payment card numbers, account details
2. **Personal Identifiers**: National ID numbers, passport numbers
3. **Contact Information**: When specified in model configuration

### File Encryption

Sensitive files are encrypted using the `FileStorage` service with the `encrypt` flag:

```php
// Example of storing an encrypted file
$encryptedPath = $fileStorage->storeFile("documents/secure", 
                                        "contract.pdf", 
                                        $content, 
                                        true); // true enables encryption
```

## Data-in-Transit Protection

### API Request/Response Encryption

The `EncryptionMiddleware` provides application-level encryption for sensitive API endpoints:

1. Endpoint configuration is stored in `config/sensitive_endpoints.json`
2. Field configuration is stored in `config/sensitive_fields.json`
3. Requests to sensitive endpoints have their sensitive fields encrypted
4. Responses from sensitive endpoints are encrypted in their entirety

### JWT Token Security

- Access tokens expire after 1 hour
- Refresh tokens expire after 7 days
- Tokens are cryptographically signed using HMAC SHA-256
- Token verification includes issuer and audience validation

## Best Practices for Developers

### Adding Encryption to New Fields

1. Identify sensitive fields in your model
2. Add field names to the `$encryptedFields` array:

```php
protected $encryptedFields = ['existing_field', 'your_new_sensitive_field'];
```

3. Ensure model extends `BaseModel` and implements encryption methods
4. Update relevant tests to account for encryption/decryption

### Working with Encrypted Data

1. **Never log encrypted data** in its raw form
2. **Never store encryption keys** in the repository
3. Use the `EncryptionService` directly for manual encryption needs:

```php
$encrypted = $this->encryptionService->encrypt($sensitiveData);
$decrypted = $this->encryptionService->decrypt($encrypted);
```

4. For file operations, use the `FileStorage` service with the encryption flag

### Debugging Encryption Issues

1. Enable DEBUG_MODE only in development environments
2. Look for specific encryption error messages in the logs
3. Verify key availability and permissions
4. Check if the encrypted data was modified after encryption

### Security Auditing

The system automatically logs encryption-related events:
- Key rotations
- Encryption failures
- Suspicious decryption attempts
- File encryption operations

## Implementation Details

### EncryptionService

The core service handling all encryption/decryption operations:

```php
// Example usage
$encryptionService = new EncryptionService($logger, $exceptionHandler, $encryptionKey);

// String encryption
$encrypted = $encryptionService->encrypt($sensitiveData);
$decrypted = $encryptionService->decrypt($encrypted);

// File encryption
$encryptionService->encryptFile($inputPath, $outputPath);
$encryptionService->decryptFile($encryptedPath, $decryptedOutputPath);

// Signatures
$signature = $encryptionService->sign($data);
$isValid = $encryptionService->verify($data, $signature);
```

### Security Recommendations

1. **Defense in Depth**: Don't rely solely on encryption; implement proper access controls
2. **Regular Auditing**: Review encryption logs and key usage periodically
3. **Key Rotation**: Rotate keys according to schedule or after security incidents
4. **Separation of Duties**: Use different keys for different types of data
=== docs/backend/security/authorization.md ===
# Authorization System

## Overview

The Carfuse application implements a straightforward role-based access control (RBAC) system that governs what actions authenticated users can perform. Authorization is enforced through:

1. **Middleware-based authentication verification**
2. **Role checks in controllers and services**
3. **Service-level authorization logic**
4. **UI element visibility control based on user roles**

This documentation covers the authorization mechanisms and provides guidance on implementing authorization checks in new code.

## Role-Based Access Control System

The authorization system uses a hierarchical role structure stored directly in the user record. Each user is assigned a single role that determines their permissions throughout the application. Role assignments are managed by administrators through the admin interface.

### Implementation Details

- Roles are stored in the `role` field of the user record
- Role checks occur primarily at the controller/service level
- Some routes are protected by role-specific middleware
- No separate permissions table - capabilities are tied directly to roles
- Admin-specific routes use the `AdminService->validateAdmin()` method as a gatekeeper

## Available Roles and Capabilities

| Role        | Capabilities | Description |
|-------------|--------------|-------------|
| `super_admin` | All system functions<br>User management<br>System configuration<br>Cannot be deleted | Highest level of access for system owners |
| `admin` | User management<br>Booking management<br>Payment operations<br>Dashboard access<br>Audit log access | Administrative staff managing day-to-day operations |
| `manager` | Limited user management<br>Vehicle management<br>Booking approvals<br>Reports access | Staff supervising specific operational areas |
| `user` | Personal profile management<br>Vehicle bookings<br>Payment processing<br>Viewing own data | Standard customer account |
| `guest` | Public page access<br>Registration<br>Login | Unauthenticated visitor |

## Permission Checking Methodology

Permissions in Carfuse are checked through several mechanisms:

### 1. Middleware-Based Authentication Checks

`RequireAuthMiddleware` ensures a user is authenticated before accessing protected routes:

```php
// Enforces authentication but not specific roles
public function process(Request $request, RequestHandler $handler): Response
{
    $user = $request->getAttribute('user');
    
    if (!$user) {
        $this->logger->warning("Access attempt to protected route without authentication");
        
        $response = new \Slim\Psr7\Response();
        $response->getBody()->write(json_encode([
            'error' => 'Authentication required',
            'status' => 401
        ]));
        
        return $response
            ->withHeader('Content-Type', 'application/json')
            ->withStatus(401);
    }
    
    return $handler->handle($request);
}
```

### 2. Role-Based Access Control in Controllers

Controllers check user roles to authorize specific actions:

```php
public function deleteUser($userId): ResponseInterface
{
    try {
        $admin = $this->adminService->validateAdmin($this->request);
        if (!$admin) {
            return $this->jsonResponse([
                'status' => 'error',
                'message' => 'Invalid token or insufficient permissions'
            ], 401);
        }
        
        // Additional logic...
        if ($userRole === 'super_admin') {
            return ['error' => 'Super admins cannot be deleted'];
        }
        
        // Proceed with deletion...
    }
    catch (\Exception $e) {
        // Error handling...
    }
}
```

### 3. Service-Level Validation

Services like `AdminService` provide role validation helpers:

```php
/**
 * Validate admin token and return admin data
 */
public function validateAdmin(ServerRequestInterface $request): ?array
{
    // Extract token
    $token = $this->tokenService->extractToken($request);
    
    if (empty($token)) {
        return null;
    }
    
    // Validate token and fetch admin details
    $admin = $this->adminModel->findByToken($token);
        
    if (empty($admin) || $admin['role'] !== 'admin') {
        return null;
    }
    
    return $admin;
}
```

### 4. SecurityHelper Role Checks

The `SecurityHelper` class provides utility methods for role checking:

```php
// Get the logged-in user's role
public function getUserRole()
{
    return isset($_SESSION['user_id']) ? ($_SESSION['user_role'] ?? 'guest') : 'guest';
}
```

## How to Enforce Permissions in New Code

### 1. Using Middleware for Route Protection

When creating new routes, apply the appropriate middleware stack:

```php
// For routes requiring authentication but no specific role
$app->get('/user/profile', UserController::class . ':viewProfile')
    ->add(RequireAuthMiddleware::class);

// For routes requiring admin role
$app->get('/admin/users', AdminController::class . ':getAllUsers')
    ->add(AdminAuthMiddleware::class);
```

### 2. Controller-Level Role Checks

Implement role checks in your controller methods:

```php
public function performAdminAction(Request $request, Response $response)
{
    $user = $request->getAttribute('user');
    
    // Check if user has admin role
    if (!$user || $user['role'] !== 'admin') {
        return $this->jsonResponse($response, [
            'error' => 'Permission denied',
            'message' => 'This action requires administrator privileges'
        ], 403);
    }
    
    // Admin-only logic here
    // ...
    
    return $this->jsonResponse($response, ['status' => 'success']);
}
```

### 3. Using Admin/Role Validation Services

For admin-specific functionality, use the AdminService:

```php
public function manageUsers(Request $request, Response $response)
{
    try {
        // Validate admin access
        $admin = $this->adminService->validateAdmin($request);
        if (!$admin) {
            return $this->jsonResponse([
                'status' => 'error',
                'message' => 'Access denied'
            ], 403);
        }
        
        // Admin functionality here
        // ...
        
    } catch (\Exception $e) {
        // Error handling
    }
}
```

### 4. Creating Role-Specific Functionality

When implementing features with role-based differences:

```php
public function viewDashboard(Request $request, Response $response)
{
    $user = $request->getAttribute('user');
    $data = [];
    
    // Base dashboard data for all users
    $data['userStats'] = $this->userService->getUserStats($user['id']);
    
    // Add role-specific data
    if ($user['role'] === 'admin' || $user['role'] === 'manager') {
        $data['systemStats'] = $this->statsService->getSystemStats();
    }
    
    if ($user['role'] === 'admin') {
        $data['adminControls'] = $this->adminService->getAdminControlData();
    }
    
    return $this->jsonResponse($response, $data);
}
```

## Best Practices

1. **Defense in Depth**: Implement authorization checks at multiple levels (route, controller, service)

2. **Least Privilege**: Assign users the minimum role needed for their functionality

3. **Consistency**: Use established patterns for permission checking:
   ```php
   // Preferred approach for simple role checks
   if ($user['role'] !== 'admin') {
       return $this->unauthorized();
   }
   
   // For more complex authorization
   if (!$this->authorizationService->canPerformAction($user, 'delete_booking', $bookingId)) {
       return $this->forbidden();
   }
   ```

4. **Audit Trail**: Log all important authorization decisions:
   ```php
   $this->auditService->logEvent(
       'authorization',
       'Permission denied',
       [
           'user_id' => $user['id'],
           'action' => 'delete_user',
           'target_id' => $userId
       ],
       $user['id'],
       null,
       'security'
   );
   ```

5. **Centralize Logic**: Create helper methods for common authorization checks rather than duplicating logic

## Extending the Authorization System

The current authorization system is role-based. If more granular permissions are needed, consider:

1. Creating a permissions table associating roles with specific capabilities
2. Implementing a policy-based approach with dedicated authorization classes
3. Adding context-aware permission checks (e.g., resource ownership verification)
=== docs/backend/security/audit-logging.md ===
# Audit Logging

## Overview
The CarFuse platform implements a comprehensive audit logging system to track user activities, system events, and data modifications. This documentation covers how the audit system works and how developers can properly use it.

## Audit Log Architecture

The audit logging system consists of:

- **AuditService**: Main service that routes events to appropriate handlers based on category
- **Specialized Services**: Handlers for specific event types (UserAuditService, TransactionAuditService)
- **Storage Models**: AuditLog and AuditTrail models for database interaction

### Audit Categories

| Category | Description | Database Storage |
|----------|-------------|------------------|
| `system` | System-level events | General logs only |
| `auth` | Authentication events | Audit database |
| `transaction` | Payment transactions | Audit database |
| `booking` | Booking operations | Audit database |
| `user` | User profile changes | Audit database |
| `admin` | Administrative actions | Audit database |
| `document` | Document operations | Audit database |
| `api` | API requests | General logs only |
| `security` | Security-related events | Audit database |
| `payment` | Payment processing | Audit database |

### Log Levels

| Level | Description | Use Case |
|-------|-------------|----------|
| `debug` | Detailed debugging information | Development troubleshooting |
| `info` | Normal events | Regular user activities |
| `warning` | Unexpected but non-critical issues | Validation failures, retry attempts |
| `error` | Runtime errors | Failed operations, exceptions |
| `critical` | Critical failures | Security breaches, data corruption |

## Audited Events

### Authentication Events
- User login attempts (success/failure)
- Password changes
- Multi-factor authentication events
- Session management

### User Events
- Profile creation
- Profile updates
- Role changes
- Account deactivation/reactivation

### Transaction Events
- Payment processing
- Refunds
- Booking financial transactions

### Administrative Events
- Settings changes
- User management actions
- System configuration updates
- Report generation

### Security Events
- Access control violations
- Suspicious activities
- IP address changes

## Audit Log Structure

### Common Log Fields

| Field | Description |
|-------|-------------|
| `id` | Unique identifier |
| `category` | Event category (see categories table) |
| `action` | Specific event type |
| `message` | Human-readable description |
| `user_id` | Associated user (if applicable) |
| `booking_id` | Associated booking (if applicable) |
| `ip_address` | Source IP address |
| `details` | JSON-encoded context information |
| `log_level` | Severity level |
| `created_at` | Timestamp |

### Details Field Structure

The `details` JSON field typically contains:

```json
{
  "request_id": "uuid-for-request-tracking",
  "before": { "field": "original-value" },
  "after": { "field": "new-value" },
  "additional_context": "event-specific-data"
}
```

## Log Storage and Retention

### Storage
- High-priority events: Stored in the `audit_logs` database table
- System events: Stored in application log files
- Security events: Duplicated in both database and secure log files

### Retention Policy
- Production audit logs: Retained for 90 days by default
- Financial transaction logs: Retained for 7 years (legal requirement)
- Security incident logs: Retained for 1 year
- System logs: Rotated weekly with 4-week retention

### Export and Archiving
Logs can be exported to CSV format for long-term archiving using the AuditController's export functionality.

## Adding Audit Logging to New Code

### Basic Usage

```php
// Inject AuditService into your class
private AuditService $auditService;

public function __construct(AuditService $auditService) {
    $this->auditService = $auditService;
}

// Log an event
$this->auditService->logEvent(
    'user_updated',           // action
    'User profile updated',   // message
    [                         // context
        'user_id' => 123,
        'fields_updated' => ['name', 'email']
    ],
    123,                      // userId
    null,                     // bookingId (if applicable)
    '192.168.1.1',            // ipAddress (if available)
    AuditService::LOG_LEVEL_INFO // log level
);
```

### Selecting the Right Category

Choose the appropriate category from the predefined constants:

```php
// For user-related activities
$this->auditService->logEvent(
    'profile_updated',
    'User updated their profile',
    ['fields' => ['name', 'avatar']],
    $userId,
    null,
    $ipAddress,
    AuditService::LOG_LEVEL_INFO
);

// For security events
$this->auditService->logEvent(
    'password_changed',
    'User changed their password',
    ['user_agent' => $userAgent],
    $userId,
    null,
    $ipAddress,
    AuditService::LOG_LEVEL_INFO
);
```

### Controller Integration Examples

Here's how audit logging is typically implemented in controllers:

```php
public function updateProfile(Request $request, Response $response): Response
{
    // Process the update...
    $userData = $this->userModel->updateProfile($userId, $data);
    
    // Log the update
    $this->auditService->logEvent(
        'profile_updated',
        'User updated their profile',
        [
            'user_id' => $userId,
            'fields_updated' => array_keys($data)
        ],
        $userId,
        null,
        $request->getServerParams()['REMOTE_ADDR'] ?? null,
        AuditService::LOG_LEVEL_INFO
    );
    
    return $response;
}
```

## Accessing and Analyzing Logs

### Admin Interface
Administrators can access logs through the Admin Dashboard under Audit Logs.

### Filtering Capabilities
Logs can be filtered by:
- Date range
- User ID
- Event category
- Action type
- Log level

### Programmatic Access
```php
// Via the AuditController
$logs = $auditService->getLogs([
    'category' => 'security',
    'user_id' => 123,
    'start_date' => '2023-01-01',
    'end_date' => '2023-01-31',
    'page' => 1,
    'per_page' => 50
]);
```

## Best Practices

1. **Be consistent with log levels** - Use appropriate severity levels
2. **Include meaningful context** - Add relevant details that help with troubleshooting
3. **Don't log sensitive data** - Never include passwords, tokens, or PII in log details
4. **Structure the context** - Use consistent field names in the context array
5. **Log both before and after states** - For data modifications, include previous and new values

## Troubleshooting

If audit logs aren't being recorded as expected:

1. Check the log level filter settings
2. Verify the event category is in the AUDIT_CATEGORIES list
3. Ensure the database connection is working properly
4. Check for exceptions in the application error logs
=== docs/backend/security/fraud-detection.md ===
# Fraud Detection System Documentation

## Overview

The CarFuse fraud detection system is a sophisticated risk assessment engine that analyzes transactions in real-time to identify potential fraud. The system employs a multi-factor scoring approach to quantify risk and provide appropriate recommendations based on configurable thresholds.

## Fraud Detection Methodology

### Risk Assessment Model

The system uses a weighted indicator model where each potential risk factor contributes to an overall risk score. When a transaction is processed:

1. Transaction data is analyzed against multiple fraud indicators
2. Each detected indicator adds points to the risk score based on its weight
3. The final risk score determines the risk level (high, medium, low, minimal)
4. Appropriate action is recommended based on risk level

### Process Flow

```mermaid
graph TD
    A[Transaction Initiated] --> B[Collect Transaction Data]
    B --> C[Analyze Fraud Indicators]
    C --> D[Calculate Risk Score]
    D --> E[Determine Risk Level]
    E --> F{Risk Level?}
    F -->|High| G[Block Transaction]
    F -->|Medium| H[Additional Verification]
    F -->|Low| I[Flag for Review]
    F -->|Minimal| J[Proceed]
    G --> K[Audit Log]
    H --> K
    I --> K
    J --> K
```

## Risk Scoring Factors and Thresholds

### Risk Thresholds

The system classifies risk into four levels based on configurable thresholds:

| Risk Level | Default Threshold |
|------------|------------------|
| High       |  70             |
| Medium     |  50             |
| Low        |  30             |
| Minimal    | < 30             |

### Fraud Indicators and Weights

The following indicators contribute to the risk score:

| Indicator              | Weight | Description                                        |
|------------------------|--------|----------------------------------------------------|
| High amount            | 15     | Transaction amount exceeds configured threshold    |
| Multiple attempts      | 20     | User made multiple payment attempts                |
| Unusual location       | 30     | Transaction location differs from expected         |
| Address mismatch       | 25     | Billing and shipping addresses don't match         |
| Card country mismatch  | 35     | Card country differs from user's country           |
| Rapid transactions     | 18     | Multiple transactions in short time period         |
| Unusual time           | 10     | Transaction outside normal business hours          |
| IP proxy detected      | 40     | User appears to be using proxy/VPN                 |
| Device mismatch        | 28     | User using different device than previous sessions |
| Risky email domain     | 15     | Email from domain associated with temporary emails |

*Note: Weights can be configured in the system settings to adjust sensitivity.*

## Automated Actions for Suspicious Activities

### Risk-Based Recommendations

The system automatically recommends different actions based on the calculated risk level:

| Risk Level | Default Recommendation | Description                                         |
|------------|------------------------|-----------------------------------------------------|
| High       | block_transaction      | Prevent transaction from completing                 |
| Medium     | additional_verification| Request additional identity verification from user  |
| Low        | flag_for_review        | Allow transaction but mark for manual review        |
| Minimal    | proceed                | Allow transaction to complete normally              |

### Special Case Rules

Certain indicators trigger specific recommendations regardless of the overall risk score:

- IP proxy detection always triggers additional verification
- Card country mismatch triggers blocking for high risk or verification for other risk levels

## Manual Review Process

### Review Workflow

Transactions flagged for review appear in the admin dashboard with:

1. Complete transaction details
2. List of triggered fraud indicators
3. Risk score and level
4. User history summary
5. Action buttons for approve/deny/verify

### Investigation Guidelines

When manually reviewing flagged transactions:

1. **Verify user identity**: Check against known customer data
2. **Review transaction history**: Look for patterns or anomalies
3. **Assess contextual factors**: Consider time, amount, and location context
4. **Contact customer**: For medium-high risk levels, verify via secure channels
5. **Document decision**: Record justification for approval or rejection

## System Integration

### Integration with Payment Processing

The fraud detection system integrates with the payment processing pipeline:

1. `PaymentProcessingService` calls fraud detection before processing payments
2. Risk assessment results determine if payment proceeds or is rejected
3. Fraudulent transactions are logged and can trigger security alerts

### Audit Trail

All fraud detection activities are logged for security and compliance:

1. TransactionAuditService records all fraud validation results
2. High risk transactions generate security alerts
3. Detection results are stored in the audit database for reporting
4. Fraud patterns can be analyzed through the security dashboard

## Configuration and Tuning

The system is configurable through `/App/Config/fraud_detection.php` to adjust:

- Risk thresholds for different risk levels
- Indicator weights for scoring
- Rule parameters (e.g. amount thresholds, time windows)
- Risky email domain list
- Custom rules for specific business needs

*Regular review of fraud detection effectiveness is recommended to tune parameters according to evolving fraud patterns.*

## Security Considerations

- Keep fraud detection rules confidential to prevent circumvention
- Regularly review and update detection rules based on new fraud patterns
- Ensure proper access controls for manual review systems
- Monitor and audit all changes to fraud detection configuration
=== docs/backend/RoutingSystem.md ===
# CarFuse Routing System Documentation

This document provides a comprehensive overview of the routing systems used in the CarFuse application, comparing the modern FastRoute implementation with the legacy routing approach.

## 1. Route Definition and Organization

### Modern Routing (FastRoute)

The modern routing system uses FastRoute, a fast, simple router for PHP. Routes are defined in `config/routes.php` where:

- Routes are organized by functionality using route grouping
- HTTP methods are explicitly defined for each route
- Route parameters use pattern matching (e.g., `{id:\d+}`)
- Routes are mapped directly to controller methods

Example:
```php
// Route with pattern matching for ID parameter
$router->addRoute(['GET'], '/api/bookings/{id:\d+}', [$bookingController, 'viewBooking']);

// Route group for related endpoints
$router->addGroup('/api/documents', function (RouteCollector $r) use ($documentController) {
    $r->addRoute(['POST'], '/templates', [$documentController, 'uploadTemplate']);
    $r->addRoute(['GET'], '/templates', [$documentController, 'getTemplates']);
    // Additional routes...
});
```

### Legacy Routing

The legacy system in `App/api.php` uses hardcoded arrays to map URL paths to PHP files:

- Routes are defined in arrays (`$publicApiRoutes` and `$protectedApiRoutes`)
- No explicit HTTP method constraints
- Routes point directly to PHP files rather than controller methods
- Simple string matching for paths with no parameter pattern validation

Example:
```php
$publicApiRoutes = [
    'auth/login' => '/../public/api/auth/login.php',
    'auth/register' => '/../public/api/auth/register.php',
    // Additional routes...
];
```

## 2. Controller Mapping

### Modern Routing (FastRoute)

- Controllers are proper classes following object-oriented design
- Controller instances are retrieved from a dependency injection container
- Routes are mapped to specific controller methods
- Parameters can be type-hinted and automatically injected

Example:
```php
// Get controller instance from container
$bookingController = $container->get(BookingController::class);

// Map route to controller method
$router->addRoute(['GET'], '/api/bookings/{id:\d+}', [$bookingController, 'viewBooking']);
```

### Legacy Routing

- No proper controller classes
- Routes map directly to PHP files that handle the entire request
- Logic is not clearly separated from routing
- Parameters must be manually extracted from the request

Example:
```php
// Route maps to a PHP file
$publicApiRoutes = [
    'auth/login' => '/../public/api/auth/login.php',
];

// File is included directly
if (file_exists($apiFile)) {
    require_once $apiFile;
}
```

## 3. Middleware Application

### Modern Routing (FastRoute)

While not explicitly shown in the provided code, modern frameworks typically implement middleware through:

- Middleware classes that can be attached to routes or groups
- Pre and post-request processing
- Standardized request/response objects

The current implementation likely uses middleware for:
- Authentication (JWT verification)
- Rate limiting
- CORS handling
- Input validation

### Legacy Routing

Middleware concepts exist but are implemented directly within the routing script:

- JWT validation is built directly into the router
- CORS headers are applied globally
- Authentication checks are hardcoded based on route arrays
- No standardized middleware interface or chain

Example:
```php
// Authentication middleware directly in router
if (isset($protectedApiRoutes[$apiPath])) {
    validateToken(); // Acts as middleware
    $apiFile = __DIR__ . $protectedApiRoutes[$apiPath];
}

// CORS middleware directly in router
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');
```

## 4. Migration Path

To migrate from the legacy routing system to the modern FastRoute implementation:

### Step 1: Identify All Current Routes

1. Document all routes in the legacy system (`$publicApiRoutes` and `$protectedApiRoutes`)
2. Map the functionality of each PHP file to potential controller methods

### Step 2: Create Controller Classes

1. For each group of related routes, create a controller class
2. Move the logic from individual PHP files into controller methods
3. Implement dependency injection for database connections and services

Example:
```php
// Before: individual file handling login
// /public/api/auth/login.php

// After: AuthController class with login method
class AuthController {
    public function login() {
        // Login logic moved here
    }
}
```

### Step 3: Define Routes Using FastRoute

1. Add new routes to the FastRoute configuration
2. Ensure route patterns match the legacy URL structure for backward compatibility
3. Map routes to the new controller methods

### Step 4: Implement Middleware

1. Extract authentication logic into dedicated middleware classes
2. Create middleware for rate limiting, CORS, etc.
3. Apply middleware to routes or groups as needed

### Step 5: Update Client Code

1. Ensure all client-side API calls work with the new routing system
2. Test thoroughly to ensure no functionality is broken
3. Consider versioning the API to support both systems during migration

### Step 6: Deprecate Legacy Router

1. Add logging to track which legacy routes are still being used
2. Set a timeline for full migration
3. Eventually remove the legacy routing system

## Conclusion

The FastRoute implementation provides a more maintainable, structured, and scalable approach to routing compared to the legacy system. The object-oriented design with proper controller classes and method mapping makes the codebase easier to understand and extend. The migration process should be gradual to ensure minimal disruption to existing functionality.

While the legacy system served its purpose, the modern routing approach aligns better with current PHP development practices and provides a foundation for future enhancements to the CarFuse application.
=== docs/backend/architecture/booking-flow.md ===
# Booking Process Flow

## Overview
The booking process in CarFuse handles the complete flow from initial API request to database storage, including validation, business logic processing, and transaction management to ensure data integrity across multiple tables.

## Booking Process Flow Diagram

```
                  
  Client  API/BookingRoute CsrfMiddleware   AuthMiddleware    
                  
                                                                          
                                                                          
                                                                          
                                                    
                 RequireAuthMiddleware                                   
                                                    
                                                                          
                                                                          
                                                    
                 BookingController                                       
                                                    
                                                                          
                                                                          
                                                    
                 BookingService                               
                                                     
                                                                           
                                                                           
                                                     
                 Validator                                                
                                                     
                                                                           
                                                                           
                                                     
                 AvailabilityChecker                                      
                                                     
                                                                           
                                                                           
                                 
                 DatabaseHelper       Database                 
                 (Transaction)        (Multiple Tables)        
                                 
                                                                           
                                                                           
                                                     
                 NotificationService                                      
                                                     
                                                                           
                                                                           
                                                     
                 AuditService         
                 
                           
                           
      
  Client  JSON Response    
      
```

## Booking Process Stages

### 1. Request Processing and Authentication
- Client sends booking request with vehicle, dates, and options
- Request passes through middleware chain:
  - CsrfMiddleware validates CSRF token for form submission security
  - AuthMiddleware authenticates the user making the request
  - RequireAuthMiddleware ensures user is authenticated
- User identity and CSRF validation confirmed before processing

### 2. Controller and Request Validation
- BookingController receives the request
- Extracts and organizes booking parameters
- Passes data to BookingService for business logic handling
- Validator component performs comprehensive validation:
  - Required fields presence
  - Date format and logic (start before end)
  - Vehicle availability during requested period
  - User booking permissions and limits

### 3. Business Logic Processing
- BookingService performs core business operations:
  - Price calculation based on duration, vehicle, and options
  - Discount application if applicable
  - Availability confirmation via AvailabilityChecker
  - Insurance and additional options processing

### 4. Database Transaction
- DatabaseHelper initiates a transaction to ensure data integrity
- Multiple tables are updated in a single transaction:
  - `bookings`: Core booking record
  - `booking_options`: Selected add-ons and extras
  - `vehicle_availability`: Vehicle status updates
  - `user_bookings`: User-booking relationship

### 5. Post-Booking Processes
- Contract generation via DocumentService
- Confirmation notifications through NotificationService
- Audit logging via AuditService
- Payment processing through PaymentService

### 6. Response Handling
- Success response returned to client with booking details
- Error responses include validation errors or system issues

## Booking State Transitions

```mermaid
stateDiagram-v2
    [*] --> Pending: Create booking
    Pending --> Confirmed: Payment received
    Pending --> Cancelled: Timeout/Manual
    Confirmed --> InProgress: Pickup date reached
    Confirmed --> Cancelled: Cancellation request
    Cancelled --> [*]: End of lifecycle
    InProgress --> Completed: Return processed
    Completed --> [*]: End of lifecycle
```

### State Transition Rules

1. **Pending to Confirmed**
   - Triggered by successful payment
   - Requires vehicle availability confirmation
   - Generates rental contract

2. **Pending to Cancelled**
   - Triggered by user cancellation or timeout
   - No financial impact if cancelled within grace period
   - Releases vehicle availability

3. **Confirmed to Cancelled**
   - Requires cancellation request processing
   - May trigger refund calculation
   - Notification sent to user

4. **Confirmed to InProgress**
   - Automatic transition on pickup date
   - Updates vehicle status to "in use"
   - Triggers pickup notification

5. **InProgress to Completed**
   - Triggered by vehicle return processing
   - Updates vehicle status to "available"
   - May trigger additional charges if applicable

## Booking-Related Notifications

1. **Booking Confirmation**
   - Sent immediately after successful booking
   - Includes booking reference, dates, vehicle details
   - Contains payment receipt if applicable

2. **Booking Cancellation**
   - Sent when booking is cancelled
   - Includes refund information if applicable
   - May contain rebooking options

3. **Booking Modification**
   - Sent when booking details change
   - Highlights changes (dates, vehicle, options)
   - May include price adjustment details

4. **Pickup Reminder**
   - Sent before scheduled pickup date
   - Includes location, time, required documents
   - Contact information for assistance

5. **Return Reminder**
   - Sent before scheduled return date
   - Includes return location and time
   - Return process instructions
````
=== docs/backend/architecture/data-flow.md ===
# Data Flow

## Overview
The CarFuse system uses a structured data flow pattern to manage information from initial request to final response. This document outlines how data moves through the system's layers, including validation, transformation, and storage processes.

## Request-Response Flow Diagram

```
               
  Client    Middleware     Controller     Service Layer  
               
                                                                  
                                                                  
                                                                  
                                                         
                                                           Model Layer    
                                                         
                                                                  
                                                                  
                                                                  
                                                         
                                                           Database       
                                                         
                                                                  
                                                                  
     
  Client                 Response Processing                  
     
```

## Input Processing

### 1. Request Capture
- Client requests arrive via HTTP/HTTPS to the application entry point
- Request data includes:
  - URL path parameters
  - Query string parameters
  - HTTP headers (including authentication tokens)
  - Request body (form data or JSON)
  - Cookies

### 2. Middleware Processing
Request data passes through a middleware stack that:
- Validates CSRF tokens for form submissions via CsrfMiddleware
- Extracts and validates authentication tokens via AuthMiddleware
- Loads session data via SessionMiddleware
- Logs request details for audit and monitoring
- Handles HTMX-specific headers and attributes via HtmxMiddleware
- Decrypts sensitive request content via EncryptionMiddleware

### 3. Controller Input Processing
Controllers process input by:
- Extracting relevant data from the request
- Validating input format through the Validator service
- Normalizing data (ex: standardizing date formats)
- Checking permissions via service layer authorization methods
- Logging important operations through AuditService

## Data Transformations

### 1. Business Logic Transformation
Services apply domain-specific transformations:
- Converting raw input to domain models
- Applying business rules and calculations
- Implementing workflow logic via state transitions
- Handling currency conversion and price calculations
- Processing dates, times, and durations

### 2. Model-Level Transformations
The model layer handles data transformations through the BaseModel class hierarchy:

- **Type Casting**: Automatic casting between PHP and database types
  ```php
  protected $casts = [
      'user_id' => 'int',
      'vehicle_id' => 'int',
      'pickup_date' => 'datetime',
      'dropoff_date' => 'datetime'
  ];
  ```

- **Entity Relationship Handling**: Models provide methods to fetch related entities
  ```php
  public function getUser(int|string $bookingId): ?array
  {
      $query = "SELECT u.* FROM users u
                JOIN {$this->table} b ON u.id = b.user_id
                WHERE b.id = :booking_id";
      // ...query execution...
  }
  ```

- **Validation Implementation**: Models define validation rules
  ```php
  public static $rules = [
      'user_id' => 'required|exists:users,id',
      'vehicle_id' => 'required|exists:vehicles,id',
      'pickup_date' => 'required|date',
      'dropoff_date' => 'required|date|after_or_equal:pickup_date',
      'status' => 'required|string|in:pending,confirmed,cancelled,completed',
  ];
  ```

- **Computed Properties**: Derived values calculated from stored data
- **Default Value Application**: Setting defaults for new records

### 3. Security Transformations
Security-focused transformations:
- Sensitive data encryption/decryption via EncryptionService
- Password hashing/verification
- Input sanitization to prevent injection attacks
- Data masking for personally identifiable information (PII)

### 4. Database Interaction
Database operations manage:
- Query construction using DatabaseHelper
- Transaction management for multi-table operations
- Data normalization for database storage
- Database connection pooling and optimization

## Output Generation

### 1. Data Aggregation
- Services aggregate data from multiple sources
- Models are combined to create comprehensive view objects
- Related entities are fetched and linked in optimized queries
- Statistics and summaries are calculated from raw data

### 2. Response Formatting
Controllers format data for client consumption according to endpoint requirements:

- **API responses** are structured JSON following consistent patterns:
  ```php
  protected function success($message, $data = [], $status = 200): ResponseInterface
  {
      return $this->jsonResponse([
          'status' => 'success',
          'message' => $message,
          'data' => $data
      ], $status);
  }
  ```

- **Web responses** include appropriate templates with context data:
  ```php
  include BASE_PATH . '/public/views/partials/user-profile.php';
  ```

- **HTMX responses** return HTML fragments for DOM insertion:
  ```php
  echo '<div class="user-card">' . htmlspecialchars($user['name']) . '</div>';
  ```

- **File downloads** set appropriate headers and stream content:
  ```php
  header('Content-Type: application/pdf');
  header('Content-Disposition: attachment; filename="faktura-' . $invoice['invoice_number'] . '.pdf"');
  ```

### 3. Response Enhancement
- Security headers added to responses
- CSRF tokens included for form submissions
- Cache control headers set appropriately
- CORS headers applied for cross-origin requests

### 4. Error Handling
- Exceptions translated to appropriate HTTP status codes
- Structured error responses with meaningful messages
- Sensitive error details hidden in production environment
- Error logging for monitoring and debugging

## Caching Strategy

### 1. Cache Layers
- Response caching for frequent, unchanged content
- Database query result caching
- Object caching for expensive computations
- Session data caching

### 2. Cache Invalidation
- Time-based expiration for semi-static content
- Event-based invalidation when related data changes
- Manual purging capabilities for administrative tasks

## Cross-Cutting Data Concerns

### 1. Audit Trail
All data modifications are captured in the audit trail through the AuditService:

```php
$this->auditService->logEvent(
    'booking_created',
    "New booking created",
    [
        'booking_id' => $result['booking_id'],
        'user_id' => $user['id'],
        'vehicle_id' => $data['vehicle_id'],
        'pickup_date' => $data['pickup_date'], 
        'dropoff_date' => $data['dropoff_date']
    ],
    $user['id'],
    $result['booking_id'],
    'booking'
);
```

The audit system captures:
- User ID of person making the change
- Timestamp of the modification
- Type of operation performed
- Previous and new values
- Related entity information
- IP address and request context

### 2. Data Validation
Multiple validation layers ensure data integrity:
- Field-level validation (type, format, range)
- Entity-level validation (relationship integrity)
- Cross-field validation (logical dependencies)
- Business rule validation (domain-specific rules)

### 3. User Activity Tracking
The system tracks user interactions:
- Page views and API calls
- Search queries
- Feature usage
- Session duration and activity patterns

## Service Communication

### 1. Direct Method Invocation

Services communicate primarily through direct method calls:

```php
// PaymentController invoking PaymentService and NotificationService
$result = $this->paymentService->processPayment($paymentData);
$this->notificationService->sendPaymentConfirmation($user->id, $paymentData['booking_id'], $paymentData['amount']);
```

### 2. Event-Based Communication

Some operations trigger events that are handled by observers:

```php
// Audit logging triggered by events across the system
$this->auditService->logEvent('payment_processed', 'User payment processed', $eventData);
```

### 3. Transaction Boundaries

Database transactions ensure data integrity across multiple operations:

```php
$this->dbHelper->beginTransaction();
try {
    // Multiple database operations...
    $this->dbHelper->commit();
} catch (Exception $e) {
    $this->dbHelper->rollback();
    throw $e;
}
```
=== docs/backend/architecture/overview.md ===
# Architecture Overview

## Introduction
CarFuse is a comprehensive car rental management system built with a modern PHP stack, following clean architecture principles. The system features modular design with clear separation of concerns, dependency injection, and comprehensive error handling to ensure reliability and maintainability.

## System Architecture Diagram

```

                        Client Layer                          
          
    Web Browser     Mobile App      API Consumers       
          

                          
                          

                     Presentation Layer                       
          
     Views          Templates       API Responses       
          

                          
                          

                        Web Layer                             
          
     Routes         Middleware       Controllers        
          

                          
                          

                     Application Layer                        
          
     Services       Validators     Event Handlers       
          

                          
                          

                      Domain Layer                            
          
      Models      Business Rules    Domain Events       
          

                          
                          

                  Infrastructure Layer                        
          
    Database      External APIs       File Storage      
          

```

## System Component Diagram

```mermaid
graph TB
    Client[Client Browser/App]
    API[API Layer]
    Controllers[Controllers]
    Services[Service Layer]
    Models[Model Layer]
    DB[(Database)]
    Auth[Authentication]
    Payment[Payment Gateways]
    Storage[File Storage]
    Email[Email Service]
    
    Client --> API
    API --> Controllers
    Controllers --> Services
    Services --> Models
    Models --> DB
    Services --> Auth
    Services --> Payment
    Services --> Storage
    Services --> Email
    
    %% Cross-cutting concerns
    Logging[Logging & Audit]
    Security[Security Services]
    Middleware[Middleware Stack]
    
    Logging -.-> Services
    Logging -.-> Controllers
    Security -.-> Services
    Middleware -.-> Controllers

    %% Controller relationships
    subgraph Controllers
      UserC[UserController]
      PaymentC[PaymentController]
      NotificationC[NotificationController]
      DocumentC[DocumentController]
      DashboardC[DashboardController]
      BookingC[BookingController]
      ApiC[ApiController]
      AdminC[AdminController]
    end

    %% Service relationships
    subgraph Services
      PaymentS[PaymentService]
      NotificationS[NotificationService]
      DocumentS[DocumentService]
      BookingS[BookingService]
      AuditS[AuditService]
      TokenS[TokenService]
      AdminS[AdminService]
      MetricsS[MetricsService]
      UserS[UserService]
      AuthS[AuthService]
      FileS[FileStorage]
      EncryptS[EncryptionService]
    end

    %% Models
    subgraph Models
      BaseM[BaseModel]
      BookingM[Booking]
      AdminM[Admin]
      UserM[User]
      PaymentM[Payment]
      NotificationM[Notification]
      DocumentM[Document]
    end

    %% Middleware
    subgraph Middleware
      AuthMW[AuthMiddleware]
      TokenMW[TokenValidationMiddleware]
      CsrfMW[CsrfMiddleware]
      RequireAuthMW[RequireAuthMiddleware]
    end

    %% Controller to Service dependencies
    UserC --> UserS
    UserC --> AuthS
    UserC --> TokenS
    UserC --> AuditS
    PaymentC --> PaymentS
    PaymentC --> NotificationS
    NotificationC --> NotificationS
    NotificationC --> TokenS
    NotificationC --> AuditS
    DocumentC --> DocumentS
    DocumentC --> AuditS
    DashboardC --> BookingS
    DashboardC --> MetricsS
    DashboardC --> NotificationS
    DashboardC --> UserS
    DashboardC --> AuditS
    BookingC --> BookingS
    BookingC --> PaymentS
    BookingC --> NotificationS
    BookingC --> AuditS
    BookingC --> TokenS
    AdminC --> AdminS

    %% Service to Model dependencies
    PaymentS --> PaymentM
    NotificationS --> NotificationM
    BookingS --> BookingM
    AdminS --> AdminM
    UserS --> UserM
    DocumentS --> DocumentM

    %% Inheritance
    BookingM --> BaseM
    AdminM --> BaseM
    UserM --> BaseM
    PaymentM --> BaseM
    NotificationM --> BaseM
    DocumentM --> BaseM
```

## System Components

### 1. Presentation Layer
- **Views**: HTML templates for web interface
- **Templates**: Reusable UI components 
- **API Responses**: Structured JSON responses for API clients

### 2. Web Layer
- **Routes**: URL mapping to controllers using routing system
- **Middleware**: Request/response processing pipeline including:
  - Authentication (JWT, session)
  - Authorization
  - Input validation
  - CSRF protection
  - Session management
  - HTMX request handling
- **Controllers**: Handle HTTP requests, delegate to services, return responses

### 3. Application Layer
- **Services**: Core business logic implementation with specialized services for:
  - Authentication and user management
  - Booking processing
  - Payment handling
  - Reporting and analytics
  - Document generation
  - Notification delivery
- **Validators**: Input validation and sanitization
- **Event Handlers**: Process system events and trigger side effects

### 4. Domain Layer
- **Models**: Data structures representing business entities
- **Business Rules**: Domain-specific logic and constraints
- **Domain Events**: Event-driven communication within the domain

### 5. Infrastructure Layer
- **Database Access**: Database connection and query management
- **External API Clients**: Integration with third-party services
- **File Storage**: Document and image storage management
- **Caching**: Performance optimization through data caching

### 6. Cross-Cutting Concerns
- **Logging**: Comprehensive application logging
- **Error Handling**: Centralized exception management
- **Audit Trail**: Security and compliance auditing
- **Configuration**: Environment-specific settings

## Technology Stack

### Backend
- **Language**: PHP 8.1+
- **Framework**: Custom MVC framework with PSR-compatible components
- **Database**: MySQL 8.0 for relational data
- **Caching**: Redis for performance optimization
- **Session Storage**: Redis for distributed session management
- **API Format**: JSON over HTTP/HTTPS
- **Authentication**: JWT for API authentication, session-based for web interface

### Frontend
- **Template Engine**: PHP templates with HTMX for dynamic content
- **CSS Framework**: Tailwind CSS
- **JavaScript**: Alpine.js for minimal interactivity
- **AJAX**: HTMX for server-side rendering with partial page updates

### Infrastructure
- **Web Server**: Nginx serving PHP-FPM
- **Deployment**: Docker containerization
- **Monitoring**: ELK Stack (Elasticsearch, Logstash, Kibana)
- **CI/CD**: GitHub Actions for automated testing and deployment

## Design Patterns

The CarFuse architecture implements several key design patterns:

1. **Model-View-Controller (MVC)**
   - Separation of data (Models), presentation (Views), and logic (Controllers)
   - Controllers focus on request/response handling and delegate business logic to Services
   - Models represent database entities and encapsulate data access logic

2. **Service Layer**
   - Business logic encapsulated in dedicated service classes
   - Services as the primary API for controllers
   - Clear service boundaries with dedicated responsibilities (e.g., PaymentService, BookingService)
   - Service composition through constructor dependency injection

3. **Repository Pattern**
   - Data access abstracted through repositories
   - Models interact with databases via DatabaseHelper
   - Consistent database operations through BaseModel inheritance hierarchy

4. **Dependency Injection**
   - Services and dependencies injected through constructors
   - Reduced coupling between components
   - Enables easier testing through component substitution
   - Type-hinted properties with PHP 8.1 features

5. **Middleware Pipeline**
   - Request processing through sequential middleware components
   - Each middleware handles a specific cross-cutting concern
   - Authentication and authorization handled by AuthMiddleware and TokenValidationMiddleware
   - CSRF protection implemented as middleware

6. **Factory Pattern**
   - Object creation centralized in factory classes
   - Complex object initialization encapsulated
   - Used for document generation, payment processing implementations

7. **Facade Pattern**
   - Complex subsystems hidden behind simpler interfaces
   - `PaymentService` acts as facade for payment processing, refunds, and transactions
   - `DocumentService` abstracts document storage, encryption, and template rendering

8. **Observer Pattern** 
   - Event system for loose coupling between components
   - Audit logging implemented as observers to system events
   - Notification system triggered by booking and payment events

## Security Architecture

The CarFuse system implements multiple layers of security:

1. **Authentication**
   - Multi-factor authentication support
   - JWT-based API authentication
   - Session-based web authentication
   - Secure password storage with bcrypt

2. **Authorization**
   - Role-based access control
   - Resource-level permissions
   - Context-aware authorization rules

3. **Data Protection**
   - Encryption for sensitive data at rest
   - TLS for data in transit
   - PCI DSS compliance for payment processing

4. **Attack Prevention**
   - CSRF protection for state-changing operations
   - Input validation and sanitization
   - Rate limiting for authentication attempts
   - IP-based blocking for suspicious activity

5. **Audit and Compliance**
   - Comprehensive audit logging
   - User activity tracking
   - Change history for sensitive operations

## Scalability Considerations

The architecture supports horizontal scaling through:

1. **Stateless design** where possible
2. **Distributed session management**
3. **Database connection pooling**
4. **Caching at multiple levels**
5. **Asynchronous processing** for non-critical operations

## Development Workflow

1. **Local Development**
   - Docker-based local environment
   - Hot reloading for rapid iteration
   - Local database seeding

2. **Testing**
   - Unit tests for individual components
   - Integration tests for component interactions
   - End-to-end tests for critical user flows

3. **Deployment**
   - Staging environment for pre-release validation
   - Blue-green deployment for zero-downtime updates
   - Automated rollback capability

## Monitoring and Observability

The system includes comprehensive monitoring:

1. **Application Performance Monitoring**
2. **Error tracking and alerting**
3. **User experience monitoring**
4. **Security event monitoring**
5. **Business metrics dashboard**

## Documentation

System documentation is maintained in multiple formats:

1. **Architecture documentation** (this document)
2. **API documentation** with OpenAPI/Swagger
3. **Code documentation** with PHPDoc
4. **User documentation** for end-users

## Layered Architecture

CarFuse implements a layered architecture that promotes separation of concerns, maintainability, and testability:

1. **Presentation Layer**
   - Controllers handle HTTP requests and responses
   - Views (HTML templates) render UI elements
   - API endpoints expose functionality to clients
   - HTMX integration for dynamic UI updates

2. **Application Layer**
   - Services implement business logic and workflows
   - Cross-cutting concerns (logging, security) managed here
   - Transaction boundaries defined at this level
   - Services coordinate between controllers and data access

3. **Domain Layer**
   - Models represent business entities and relationships
   - Business rules and domain validation 
   - Data structure definitions
   - Entity relationships and domain events

4. **Infrastructure Layer**
   - Database access and connection management
   - External service integration (payment gateways, file storage)
   - System configuration and environment handling
   - Caching and performance optimizations

## Design Patterns Employed

The CarFuse system leverages several design patterns to maintain clean architecture:

1. **Dependency Injection**
   - Services and dependencies injected where needed
   - Reduces coupling between components
   - Improves testability through mock objects
   - Used consistently across all services and controllers

2. **Repository Pattern**
   - Models encapsulate data access logic
   - Abstract database operations behind consistent interfaces
   - Allow for database technology changes with minimal impact

3. **Factory Pattern**
   - Object creation centralized in factory classes
   - Complex object initialization encapsulated
   - Used for document generation, payment processing, etc.

4. **Facade Pattern**
   - Complex subsystems hidden behind simpler interfaces
   - `PaymentService` acts as facade for multiple payment-related services
   - `AuditService` acts as facade for different types of auditing

5. **Observer Pattern** 
   - Event system for loose coupling between components
   - Subscribers respond to system events
   - Used for notifications and logging

6. **Middleware Pipeline**
   - Request processing through sequential middleware components
   - Each middleware handles a specific cross-cutting concern
   - Clean separation of authentication, encryption, and other concerns

## System Boundaries and Integration Points

### External Boundaries

1. **Payment Gateways**
   - Integration with multiple payment providers (Stripe, PayPal, etc.)
   - Webhook handlers for asynchronous payment events
   - Secure credential management for payment APIs

2. **File Storage Systems**
   - Local filesystem and cloud storage (S3) integration
   - Secure document storage and retrieval
   - Encryption of sensitive documents

3. **Email and SMS Providers**
   - Integration with email delivery services
   - SMS notification gateways
   - Template-based message generation

4. **Authentication Providers**
   - JWT token generation and validation
   - Integration with OAuth providers (if applicable)
   - Session management and security controls

### Internal Boundaries

1. **Service Boundaries**
   - Well-defined service interfaces
   - Clear separation between service domains
   - Minimal dependencies between services

2. **Data Access Boundaries**
   - Models control access to database
   - Services do not directly access database
   - Consistent transaction management

## Scalability Considerations

The architecture supports horizontal scaling through:

1. **Stateless Design**
   - No session state stored in application memory
   - JWT tokens enable stateless authentication
   - Enables deployment across multiple servers

2. **Distributed Session Management**
   - Session data stored in shared storage
   - Supports load balancing without sticky sessions
   - Session security maintained across distributed environment

3. **Database Optimization**
   - Connection pooling for efficient resource usage
   - Query optimization and proper indexing
   - Database access abstraction for potential sharding

4. **Caching Strategy**
   - Multi-level caching (application, object, query)
   - Cache invalidation mechanisms
   - Response caching for frequently accessed content

5. **Asynchronous Processing**
   - Long-running tasks handled asynchronously
   - Background processing for reports and notifications
   - Enables better resource utilization

## Deployment Architecture

### Infrastructure Components

```mermaid
graph TB
    subgraph "Client Layer"
        Web[Web Browsers]
        Mobile[Mobile Apps]
    end
    
    subgraph "Web Tier"
        LB[Load Balancer]
        WebServer1[Web Server 1]
        WebServer2[Web Server 2]
        WebServerN[Web Server N]
    end
    
    subgraph "Application Tier"
        AppServer1[App Server 1]
        AppServer2[App Server 2]
        AppServerN[App Server N]
    end
    
    subgraph "Data Tier"
        PrimaryDB[(Primary DB)]
        ReplicaDB[(Replica DB)]
        Cache[(Cache)]
        FileStore[(File Storage)]
    end
    
    subgraph "External Services"
        PaymentGW[Payment Gateways]
        EmailSrv[Email Service]
        SMSSrv[SMS Service]
    end
    
    Web --> LB
    Mobile --> LB
    LB --> WebServer1
    LB --> WebServer2
    LB --> WebServerN
    
    WebServer1 --> AppServer1
    WebServer2 --> AppServer2
    WebServerN --> AppServerN
    
    AppServer1 --> PrimaryDB
    AppServer2 --> PrimaryDB
    AppServerN --> PrimaryDB
    
    AppServer1 -.-> ReplicaDB
    AppServer2 -.-> ReplicaDB
    AppServerN -.-> ReplicaDB
    
    AppServer1 --> Cache
    AppServer2 --> Cache
    AppServerN --> Cache
    
    AppServer1 --> FileStore
    AppServer2 --> FileStore
    AppServerN --> FileStore
    
    AppServer1 --> PaymentGW
    AppServer1 --> EmailSrv
    AppServer1 --> SMSSrv
    
    AppServer2 --> PaymentGW
    AppServer2 --> EmailSrv
    AppServer2 --> SMSSrv
    
    AppServerN --> PaymentGW
    AppServerN --> EmailSrv
    AppServerN --> SMSSrv
```

### Deployment Considerations

1. **Containerization**
   - Application components containerized for consistency
   - Orchestration with Kubernetes or similar technology
   - Container registry for versioned deployments

2. **Environment Separation**
   - Development, staging, and production environments
   - Configuration isolation between environments
   - Feature flags for controlled feature rollout

3. **Security Measures**
   - Network segmentation and security groups
   - TLS encryption for all communications
   - Regular security scans and penetration testing
   - Secrets management for sensitive configuration

4. **Monitoring and Observability**
   - Centralized logging infrastructure
   - Performance monitoring and alerting
   - Error tracking and reporting
   - Business metrics dashboards

5. **Disaster Recovery**
   - Database backups and point-in-time recovery
   - Multi-region deployment capabilities
   - Defined recovery procedures and failover mechanisms
=== docs/backend/architecture/dependency_injection_guide.md ===
# Dependency Injection System Guide

## Overview

CarFuse uses PHP-DI as its dependency injection container to manage application components. The DI system handles:

- Service instantiation and lifecycle management
- Dependency resolution and injection
- Configuration management
- Environment-specific settings

## Initialization Sequence

The DI system initializes in this order:

1. **Logger Initialization** (`logger.php`)
   - Creates category-specific loggers

2. **Bootstrap Process** (`bootstrap.php`)
   - Loads environment variables
   - Loads configuration files
   - Initializes core services (ExceptionHandler, AuditService, etc.)
   - Creates DI container
   - Registers pre-initialized services

3. **Dependencies Configuration** (`dependencies.php`)
   - Registers helpers and utilities
   - Registers middleware components
   - Loads service configurations
   - Loads controller configurations

4. **Service Registration** (`svc_dep.php`)
   - Registers models
   - Registers services with dependencies
   - Configures service relationships

5. **Controller Registration** (`ctrl_dep.php`)
   - Registers controllers with their service dependencies

## Container Configuration

### Core Container Setup

```php
// Create container
$container = new \DI\Container();
$GLOBALS['container'] = $container;

// Register core services
$container->set(LoggerInterface::class, $logger);
$container->set(ExceptionHandler::class, $exceptionHandler);
$container->set(AuditService::class, $auditService);
```

## Registering Components

### 1. Registering a Service

Services are registered in `svc_dep.php`:

```php
$container->set(UserService::class, function($c) {
    return new UserService(
        $c->get('logger.auth') ?? $c->get(LoggerInterface::class),
        $c->get(DatabaseHelper::class),
        $c->get(ExceptionHandler::class),
        $c->get(AuditService::class),
        $c->get(User::class),
        $config['encryption']['jwtSecret'] ?? ''
    );
});
```

**Example: Adding a New Service**

1. Create your service class:
```php
namespace App\Services;

class EmailService {
    private $logger;
    private $config;
    
    public function __construct(LoggerInterface $logger, array $config) {
        $this->logger = $logger;
        $this->config = $config;
    }
    
    public function sendEmail($to, $subject, $body) {
        // Implementation
    }
}
```

2. Register in `svc_dep.php`:
```php
$container->set(EmailService::class, function($c) use ($config) {
    return new EmailService(
        $c->get('logger.notification') ?? $c->get(LoggerInterface::class),
        $config['email'] ?? []
    );
});
```

### 2. Registering a Controller

Controllers are registered in `ctrl_dep.php`:

```php
$container->set(UserController::class, function($c) use ($logger, $loggers) {
    return new UserController(
        $loggers['user'] ?? $loggers['api'] ?? $logger,
        $c->get(Validator::class),
        $c->get(TokenService::class),
        $c->get(ExceptionHandler::class),
        $c->get(AuthService::class),
        $c->get(AuditService::class),
        $c->get(User::class)
    );
});
```

**Example: Adding a New Controller**

1. Create your controller class:
```php
namespace App\Controllers;

class EmailController {
    private $logger;
    private $emailService;
    private $exceptionHandler;
    
    public function __construct(
        LoggerInterface $logger,
        EmailService $emailService,
        ExceptionHandler $exceptionHandler
    ) {
        $this->logger = $logger;
        $this->emailService = $emailService;
        $this->exceptionHandler = $exceptionHandler;
    }
    
    public function sendNewsletter($request, $response) {
        // Implementation
    }
}
```

2. Register in `ctrl_dep.php`:
```php
$container->set(EmailController::class, function($c) use ($logger, $loggers) {
    return new EmailController(
        $loggers['notification'] ?? $logger,
        $c->get(EmailService::class),
        $c->get(ExceptionHandler::class)
    );
});
```

3. Add route in `routes.php`:
```php
$emailController = $container->get(EmailController::class);
$router->addRoute(['POST'], '/api/email/newsletter', [$emailController, 'sendNewsletter']);
```

### 3. Registering Middleware

Middleware components are registered in `dependencies.php`:

```php
$container->set(AuthMiddleware::class, function($c) {
    return new AuthMiddleware(
        $c->get(TokenService::class),
        $c->get('logger.auth') ?? $c->get(LoggerInterface::class),
        $c->get(DatabaseHelper::class),
        false // Default not required
    );
});
```

**Example: Adding New Middleware**

1. Create your middleware class:
```php
namespace App\Middleware;

class CacheControlMiddleware {
    private $logger;
    
    public function __construct(LoggerInterface $logger) {
        $this->logger = $logger;
    }
    
    public function __invoke($request, $handler) {
        $response = $handler->handle($request);
        return $response->withHeader('Cache-Control', 'max-age=3600');
    }
}
```

2. Register in `dependencies.php`:
```php
$container->set(CacheControlMiddleware::class, function($c) {
    return new CacheControlMiddleware(
        $c->get('logger.system') ?? $c->get(LoggerInterface::class)
    );
});
```

## Accessing Services

### 1. Constructor Injection (Preferred)

```php
class BookingController {
    private BookingService $bookingService;
    private LoggerInterface $logger;
    
    public function __construct(
        LoggerInterface $logger, 
        BookingService $bookingService
    ) {
        $this->logger = $logger;
        $this->bookingService = $bookingService;
    }
}
```

### 2. Container Access (When Necessary)

```php
global $container;
$bookingService = $container->get(BookingService::class);
```

## Best Practices

1. **Use Constructor Injection**: Always prefer constructor injection over service location

2. **Use Category-Specific Loggers**: Utilize domain loggers with fallbacks
   ```php
   $logger = $c->get('logger.user') ?? $c->get(LoggerInterface::class);
   ```

3. **Provide Default Configurations**:
   ```php
   $serviceConfig = $config['service_name'] ?? [];
   ```

4. **Use Type Hinting**: Enables IDE auto-completion and better error detection

5. **Keep Services Focused**: Follow single responsibility principle

6. **Explicitly Declare Dependencies**: Don't rely on nested dependency resolution
=== docs/backend/architecture/service-interactions.md ===
# Service Interactions

## Overview
How services interact with each other.

## Service Dependencies
Dependencies between services.

## Communication Patterns
Patterns used for service communication.

## Error Handling
How errors are handled between services.

## Service Dependency Diagram

```mermaid
graph TD
    %% Controllers
    UserC[UserController]
    PaymentC[PaymentController]
    NotificationC[NotificationController]
    DocumentC[DocumentController]
    DashboardC[DashboardController]
    BookingC[BookingController]
    AdminC[AdminController]

    %% Core Services
    PaymentS[PaymentService]
    BookingS[BookingService]
    NotificationS[NotificationService]
    DocumentS[DocumentService]
    UserS[UserService]
    AdminS[AdminService]
    MetricsS[MetricsService]
    AuditS[AuditService]

    %% Authentication Services
    AuthS[AuthService]
    TokenS[TokenService]

    %% Utility Services
    ValidatorS[Validator]
    LoggerS[LoggerInterface]
    ExHandler[ExceptionHandler]
    FileS[FileStorage]
    EncryptS[EncryptionService]
    TemplateS[TemplateService]
    
    %% Payment Subsystem
    PayProcS[PaymentProcessingService]
    RefundS[RefundService]
    PayGatewayS[PaymentGatewayService]
    TransS[TransactionService]

    %% Controller Dependencies
    UserC --> AuthS
    UserC --> TokenS
    UserC --> ValidatorS
    UserC --> UserS
    UserC --> AuditS
    UserC --> ExHandler
    UserC --> LoggerS

    PaymentC --> PaymentS
    PaymentC --> ValidatorS
    PaymentC --> NotificationS
    PaymentC --> ExHandler
    PaymentC --> LoggerS

    NotificationC --> NotificationS
    NotificationC --> TokenS
    NotificationC --> AuditS
    NotificationC --> ExHandler
    NotificationC --> LoggerS

    DocumentC --> DocumentS
    DocumentC --> ValidatorS
    DocumentC --> AuditS
    DocumentC --> ExHandler
    DocumentC --> LoggerS

    DashboardC --> BookingS
    DashboardC --> MetricsS
    DashboardC --> NotificationS
    DashboardC --> UserS
    DashboardC --> AuditS
    DashboardC --> ExHandler
    DashboardC --> LoggerS

    BookingC --> BookingS
    BookingC --> PaymentS
    BookingC --> ValidatorS
    BookingC --> AuditS
    BookingC --> NotificationS
    BookingC --> TokenS
    BookingC --> ExHandler
    BookingC --> LoggerS

    AdminC --> AdminS
    AdminC --> ExHandler
    AdminC --> LoggerS

    %% Service Dependencies
    PaymentS --> PayProcS
    PaymentS --> RefundS
    PaymentS --> PayGatewayS
    PaymentS --> TransS
    PaymentS --> AuditS

    BookingS --> ValidatorS
    BookingS --> AuditS
    BookingS --> LoggerS

    NotificationS --> LoggerS
    NotificationS --> AuditS

    DocumentS --> LoggerS
    DocumentS --> ExHandler
    DocumentS --> AuditS
    DocumentS --> FileS
    DocumentS --> EncryptS
    DocumentS --> TemplateS

    AdminS --> AuditS
    AdminS --> LoggerS
    AdminS --> TokenS
    AdminS --> ExHandler

    %% Authentication Dependencies
    AuthS --> TokenS
    AuthS --> AuditS
    AuthS --> LoggerS
```

## Service Responsibility Matrix

| Service | Primary Responsibility | Dependencies | Transaction Boundaries |
|---------|------------------------|--------------|------------------------|
| PaymentService | Payment processing facade | PaymentProcessingService, RefundService, PaymentGatewayService, TransactionService | No direct transactions |
| BookingService | Booking management | Validator, AuditService | Manages booking transactions |
| NotificationService | User notifications | EmailService, SMSService | No transactions |
| DocumentService | Document generation & management | FileStorage, EncryptionService, TemplateService | File operations transactions |
| UserService | User account management | AuthService, AuditService | User data transactions |
| AdminService | Admin operations | Admin model, AuditService | Administrative transactions |
| AuditService | Event logging | LoggerInterface | Audit log transactions |
| TokenService | JWT token management | - | No transactions |
| AuthService | Authentication logic | TokenService, UserService | No transactions |

## Service Initialization Pattern

The system uses constructor dependency injection throughout:

```php
class BookingController extends Controller
{
    private BookingService $bookingService;
    private PaymentService $paymentService;
    private Validator $validator;
    private AuditService $auditService;
    private NotificationService $notificationService;
    private ResponseFactoryInterface $responseFactory;
    protected LoggerInterface $logger;
    private TokenService $tokenService;
    protected ExceptionHandler $exceptionHandler;

    public function __construct(
        LoggerInterface $logger,
        BookingService $bookingService,
        PaymentService $paymentService,
        Validator $validator,
        AuditService $auditService,
        NotificationService $notificationService,
        ResponseFactoryInterface $responseFactory,
        TokenService $tokenService,
        ExceptionHandler $exceptionHandler
    ) {
        parent::__construct($logger, $exceptionHandler);
        $this->bookingService = $bookingService;
        $this->paymentService = $paymentService;
        $this->validator = $validator;
        $this->auditService = $auditService;
        $this->notificationService = $notificationService;
        $this->responseFactory = $responseFactory;
        $this->tokenService = $tokenService;
        $this->exceptionHandler = $exceptionHandler;
    }
    // ...
}
```

This pattern ensures:
- Clear dependency declaration through type hints
- Testability via dependency substitution
- Consistent service lifecycle management
- Separation of concerns
- Reduced coupling between components

## Service Communication Patterns

### 1. Direct Method Invocation

The primary communication pattern is direct method calls between services:

```php
// BookingController calling BookingService
$result = $this->bookingService->createBooking($data);

// BookingService calling NotificationService
$this->notificationService->sendBookingConfirmation($bookingId, $userId);
```

### 2. Event-Based Communication

Cross-cutting concerns like auditing use event-based communication:

```php
// Services trigger audit events
$this->auditService->logEvent(
    'booking_created',
    "New booking created",
    ['booking_id' => $bookingId, 'user_id' => $userId]
);
```

### 3. Facade Pattern

Complex subsystems are accessed through facade services:

```php
// PaymentService acts as a facade for payment subsystem
class PaymentService
{
    private PaymentProcessingService $paymentProcessingService;
    private RefundService $refundService;
    private PaymentGatewayService $paymentGatewayService;
    private TransactionService $transactionService;
    
    // Methods delegate to specialized services
    public function processPayment(array $data) {
        return $this->paymentProcessingService->processPayment($data);
    }
    
    public function refundPayment(array $data) {
        return $this->refundService->processRefund($data);
    }
}
```

## Transaction Boundaries

### 1. Service-Level Transactions

Transaction boundaries are typically defined at the service layer:

```php
// PaymentProcessingService transaction example
public function processPayment(array $paymentData): array
{
    // Pre-transaction validation
    $fraudCheckResult = $this->performFraudValidation($paymentData);
    if (!$fraudCheckResult['valid']) {
        // Handle fraud detection
        return ['error' => 'Payment rejected due to security concerns'];
    }
    
    // Begin transaction
    $this->dbHelper->beginTransaction();
    try {
        // Multiple database operations
        $paymentId = $this->paymentModel->create($paymentData);
        $this->bookingModel->updateStatus($paymentData['booking_id'], 'confirmed');
        $this->transactionLogModel->create([
            'payment_id' => $paymentId,
            'type' => 'payment',
            'amount' => $paymentData['amount']
        ]);
        
        // Commit if all operations succeed
        $this->dbHelper->commit();
        
        // Post-transaction operations (not part of transaction)
        $this->auditService->logEvent('payment_processed', 'Payment processed successfully');
        
        return ['success' => true, 'payment_id' => $paymentId];
    } catch (Exception $e) {
        // Rollback on error
        $this->dbHelper->rollback();
        $this->logger->error('Payment processing failed: ' . $e->getMessage());
        throw $e;
    }
}
```

### 2. Model-Level Transactions

Some complex model operations also manage transactions:

```php
public function transferFunds(int $fromAccountId, int $toAccountId, float $amount): bool
{
    $this->dbHelper->beginTransaction();
    try {
        // Debit one account
        $this->update($fromAccountId, ['balance' => new RawExpr('balance - :amount')], [':amount' => $amount]);
        
        // Credit another account
        $this->update($toAccountId, ['balance' => new RawExpr('balance + :amount')], [':amount' => $amount]);
        
        // Create transfer record
        $this->transferModel->create([
            'from_account_id' => $fromAccountId,
            'to_account_id' => $toAccountId,
            'amount' => $amount,
            'timestamp' => date('Y-m-d H:i:s')
        ]);
        
        $this->dbHelper->commit();
        return true;
    } catch (Exception $e) {
        $this->dbHelper->rollback();
        $this->logger->error('Fund transfer failed: ' . $e->getMessage());
        return false;
    }
}
```

## Error Handling and Propagation

### 1. Exception Handling Pattern

```php
try {
    // Operation that might fail
    $result = $this->someService->riskyOperation();
    
    // Process result if successful
    return $this->success('Operation completed', $result);
} catch (\Exception $e) {
    // Log and handle exception
    $this->exceptionHandler->handleException($e);
    
    // Return error response
    return $this->error('Operation failed', [], 500);
}
```

### 2. Centralized Exception Handler

The `ExceptionHandler` provides consistent exception processing:

```php
public function handleException(\Exception $e): void 
{
    // Log the exception with context
    $this->logger->error($e->getMessage(), [
        'exception' => get_class($e),
        'file' => $e->getFile(),
        'line' => $e->getLine(),
        'trace' => $e->getTraceAsString()
    ]);
    
    // Handle different exception types
    if ($e instanceof DatabaseException) {
        // Handle database errors
    } else if ($e instanceof ValidationException) {
        // Handle validation errors
    } else if ($e instanceof AuthenticationException) {
        // Handle authentication errors
    }
    
    // Record critical errors in monitoring system
    if ($this->isProductionEnvironment() && $this->isCriticalException($e)) {
        $this->alertingService->sendAlert([
            'type' => 'exception',
            'message' => $e->getMessage(),
            'severity' => 'critical'
        ]);
    }
}
```

### 3. Domain-Specific Exceptions

Services throw domain-specific exceptions for better error handling:

```php
// In a service
if (!$this->vehicleModel->isAvailable($vehicleId, $startDate, $endDate)) {
    throw new VehicleNotAvailableException(
        "Vehicle #$vehicleId is not available for the requested dates"
    );
}
```

## Service Discovery and Configuration

The system uses dependency injection for service discovery and configuration:

### 1. Service Container

A dependency injection container manages service instantiation and resolution:

```php
// Container configuration
$container->set(LoggerInterface::class, function() {
    return new Logger('app');
});

$container->set(DatabaseHelper::class, function($c) {
    return new DatabaseHelper(
        $c->get('db.host'),
        $c->get('db.name'),
        $c->get('db.user'),
        $c->get('db.pass')
    );
});

$container->set(AuditService::class, function($c) {
    return new AuditService(
        $c->get(LoggerInterface::class),
        $c->get(DatabaseHelper::class)
    );
});

// Service resolution
$auditService = $container->get(AuditService::class);
```

### 2. Configuration Management

Services access configuration through dependency injection:

```php
class DocumentService 
{
    private array $config;
    
    public function __construct(
        // ...other dependencies...
        array $config
    ) {
        // ...
        $this->config = $config;
    }
    
    public function generateContract(int $bookingId, int $userId): string
    {
        // Use configuration
        $filename = str_replace(
            ['{booking_id}', '{timestamp}'], 
            [$bookingId, time()], 
            $this->config['naming']['contract_format']
        );
        
        $filePath = $this->fileStorage->storeFile(
            $this->config['storage']['contracts'], 
            $filename,
            $encryptedContract
        );
        
        // ...
    }
}
```

## Cross-Cutting Concerns

### 1. Logging

Consistent logging throughout all services:

```php
$this->logger->info("Processing payment", [
    'payment_id' => $paymentId,
    'amount' => $paymentData['amount'],
    'user_id' => $paymentData['user_id']
]);

$this->logger->error("Payment gateway error", [
    'code' => $errorResponse['code'],
    'message' => $errorResponse['message'],
    'payment_id' => $paymentId
]);
```

### 2. Audit Logging

Standardized audit trail generation:

```php
$this->auditService->logEvent(
    'booking_rescheduled',
    "Booking #{$id} rescheduled",
    [
        'booking_id' => $id,
        'user_id' => $user['id'],
        'new_pickup' => $data['pickup_date'],
        'new_dropoff' => $data['dropoff_date']
    ],
    $user['id'],
    $id,
    'booking'
);
```

### 3. Authentication and Authorization

Consistent security checks:

```php
// In middleware
$user = $this->tokenService->validateRequest($request);
if (!$user) {
    return $response->withStatus(401);
}

// In services
if (!$this->bookingService->validateBookingAccess($bookingId, $userId)) {
    throw new AccessDeniedException("User does not have access to this booking");
}
```
=== docs/backend/architecture/payment-flow.md ===
# Payment Processing Sequence

## Overview
The payment processing system in CarFuse handles securely processing customer payments with comprehensive fraud detection, transaction logging, and error handling. The system uses a multi-layered approach to ensure payment integrity and security.

## Payment Processing Sequence Diagram

```
                 
  Client  Payment API     EncryptionMiddleware  AuthMiddleware 
                 
                                                                            
                                                                            
                                                                            
                                                         
                PaymentController                                          
                                                         
                                                                            
                                                                            
                                                         
                Validator                                                  
                                                         
                                                                            
                                                                            
                                                   
            PaymentProcessingService                          
                                                    
                                                                             
                                                                             
                                                    
            Fraud Validation                                                
                                                    
                                                                             
                                                                             
                                                                             
                            
            Payment Gateway Client  External Payment             
                                    Gateway (API)                
                            
                                                                             
                                                                             
                            
            DatabaseHelper          Database                     
            (Transaction)           (Multiple Tables)            
                            
                                                                             
                                                                             
                                                    
            NotificationService                                             
                                                    
                                                                             
                                                                             
                                                    
            AuditService            
            
                          
                          
      
  Client  Response        
      
```

## Payment Processing Stages

### 1. Request & Security Processing
- Client submits payment request with booking ID, amount, and payment method
- Request passes through security middleware:
  - EncryptionMiddleware decrypts sensitive payment data
  - AuthMiddleware authenticates the user making the payment
  - CSRF validation ensures request legitimacy
- Encrypted channel (HTTPS) ensures data security in transit

### 2. Payment Validation
- PaymentController receives the payment request
- Validator component performs validation:
  - Required fields are present (amount, booking_id, etc.)
  - Amount matches the expected booking amount
  - Payment method is valid and supported
  - User has permission to pay for this booking
  - Booking status allows payment processing

### 3. Fraud Detection
- PaymentProcessingService performs fraud checks before processing:
  - Transaction velocity checks (multiple transactions in short time)
  - Payment amount validation against booking cost
  - IP reputation analysis for suspicious sources
  - User account risk scoring based on history
  - Geolocation validation when available
  - Device fingerprint verification for repeat customers

### 4. Payment Gateway Communication
- For declined fraud checks:
  - Payment is rejected with reason code
  - Security logs are generated
  - AuditService records attempted fraud
- For approved transactions:
  - Payment Gateway Client initiates external API call
  - Payment credentials sent to gateway
  - Gateway responds with authorization/rejection
  - Payment details never stored in plaintext

### 5. Database Transaction
- For successful payments:
  - DatabaseHelper begins a transaction
  - Payment record created
  - Booking status updated
  - Transaction log entry created
  - Transaction is committed
- For failed payments:
  - Error logged
  - Failure reason recorded
  - Transaction rolled back

### 6. Post-Payment Processing
- NotificationService alerts:
  - Customer of successful payment (email receipt)
  - Admins of payment status (dashboard updates)
  - Accounting system of received payment
- AuditService creates comprehensive audit trail

## Database Tables Involved

1. **payments**: Core payment records
   - payment_id
   - booking_id
   - user_id
   - amount
   - currency
   - payment_method
   - status
   - gateway_reference
   - created_at
   - updated_at

2. **transaction_logs**: Detailed payment processing logs
   - id
   - payment_id
   - type (payment/refund/chargeback)
   - status
   - description
   - gateway_response
   - ip_address
   - created_at

3. **bookings**: Updated with payment status
   - booking_id
   - payment_status
   - last_payment_id
   - updated_at

## Error Handling & Recovery

### Error Scenarios
- Gateway timeout: Retry policy with exponential backoff
- Gateway decline: Specific reason code returned to user
- System error: Transaction rolled back, error logged
- Partial payment: Support for multiple payments against booking

### Security Measures
- Payment data encrypted both in transit and at rest
- Payment card details never stored in database
- Only last 4 digits of card stored for reference
- All payment actions require authentication and authorization
- IP-based rate limiting on payment endpoints
- Full PCI-DSS compliance for payment handling
=== docs/backend/architecture/authentication-flow.md ===
# Authentication Flow

## Overview
The CarFuse authentication system uses JWT tokens for secure API access, with refresh tokens for extended sessions. The flow is managed through multiple middleware components and services working together to validate user identity.

## Authentication Sequence Diagram

```mermaid
sequenceDiagram
    participant Client
    participant AuthController
    participant AuthService
    participant TokenService
    participant UserModel
    participant Database
    participant AuditService

    Client->>AuthController: POST /auth/login (credentials)
    AuthController->>AuthService: authenticate(email, password)
    AuthService->>UserModel: findByEmail(email)
    UserModel->>Database: SELECT query
    Database-->>UserModel: User data
    UserModel-->>AuthService: User object
    AuthService->>AuthService: verifyPassword(password, hash)
    AuthService->>TokenService: generateToken(userData)
    TokenService-->>AuthService: JWT token
    AuthService->>AuditService: logEvent('user_login')
    AuthService-->>AuthController: Authentication result + token
    AuthController-->>Client: Response with token & user data

    Note over Client,AuthController: Later access to protected resource

    Client->>AuthMiddleware: Request with token
    AuthMiddleware->>TokenService: validateToken(token)
    TokenService->>UserModel: findById(userId from token)
    UserModel->>Database: SELECT query
    Database-->>UserModel: User data
    UserModel-->>TokenService: User object
    TokenService-->>AuthMiddleware: Valid user or null
    AuthMiddleware->>RequireAuthMiddleware: If authentication required
    RequireAuthMiddleware-->>Client: 401 if not authenticated
    AuthMiddleware-->>RequestHandler: Continue if authenticated
```

## Authentication Components

### 1. Token Service (`TokenService`)

The `TokenService` class handles JWT token generation, validation, and extraction:

- **Token Generation**: Creates secure JWT tokens with user identity and expiration
- **Token Validation**: Verifies token signatures and expiration times
- **Token Extraction**: Retrieves tokens from headers, cookies, or request parameters
- **Request Validation**: Extracts and validates tokens from incoming requests

### 2. Authentication Middleware (`AuthMiddleware`)

The `AuthMiddleware` intercepts incoming requests to validate authentication:

- Extracts authentication tokens from various sources (headers, cookies)
- Uses `TokenService` to validate token authenticity
- Retrieves user data from database for valid tokens
- Attaches user information to request attributes for downstream components
- Returns 401 Unauthorized responses for invalid tokens if authentication is required

### 3. Authentication Service (`AuthService`) 

The `AuthService` implements core authentication logic:

- User authentication with email/password
- Password verification with secure hashing
- Token generation through `TokenService`
- Audit logging of authentication events
- Password reset functionality

### 4. User Model

The `User` model provides authentication-related database operations:

- Finding users by email or ID
- Verifying credentials
- Storing password reset tokens
- Managing user account status

## Authentication Flows

### 1. Login Flow

1. Client submits credentials to `AuthController`
2. `AuthController` delegates to `AuthService` for authentication
3. `AuthService` locates user by email and verifies password hash
4. On successful authentication, `TokenService` generates a JWT token
5. `AuditService` logs the successful login event
6. Token and user details returned to client for future requests

### 2. Token Validation Flow

1. `AuthMiddleware` intercepts incoming request
2. Token extracted from request (Authorization header or cookies)
3. `TokenService` verifies token authenticity and expiration
4. If token is valid, user data is fetched from database
5. User data attached to request as an attribute
6. Request continues to target controller for processing

### 3. Password Reset Flow

1. User requests password reset via `UserController`
2. `UserController` validates email and creates a reset token
3. Reset token stored in database with expiration time
4. Email notification sent to user with reset link
5. User clicks reset link and submits new password
6. `UserController` verifies token and updates password
7. `AuditService` logs the password change event

### 4. Registration Flow

1. User submits registration data to `UserController`
2. Data validation performed by `Validator` service
3. `UserController` checks if email is already in use
4. New user created through `UserModel` (handles password hashing)
5. Welcome notification sent via `NotificationService`
6. `AuditService` logs the registration event
7. User receives confirmation response

## Security Considerations

1. **Token Security**
   - JWT tokens signed with secure algorithm
   - Short expiration times (typically 1 hour)
   - Token validation on every request

2. **Password Security**
   - Passwords hashed using bcrypt with appropriate cost factor
   - Minimum password length enforced
   - Password reset tokens expire after short period

3. **Session Management**
   - Stateless authentication using JWT
   - Session data stored in Redis for web interface
   - CSRF protection for state-changing operations

4. **Access Control**
   - Role-based authorization implemented at service layer
   - Resource-level permissions enforced
   - Context-aware authorization rules
=== docs/backend/README.md ===
# CarFuse Backend Documentation

## Overview
This documentation covers the architecture, API specifications, components, security features, and development guidelines for the CarFuse backend system.

## Navigation
- [Architecture](./architecture/overview.md): System architecture and design
- [API](./api/overview.md): API specifications and endpoints
- [Components](./components/controllers.md): Backend components and their functions
- [Security](./security/overview.md): Security features and protocols
- [Development](./development/setup.md): Setup and development guidelines

## Versioning
This documentation corresponds to CarFuse Backend version X.Y.Z.
Please ensure you're referring to the appropriate documentation version for your implementation.

## Contributing
Guidelines for contributing to this documentation:
1. Follow the established folder structure
2. Maintain consistent formatting
3. Include examples where applicable
4. Submit updates via pull requests
=== docs/backend/LoggingArchitecture.md ===
# CarFuse Logging Architecture

This document provides a comprehensive overview of the logging system used throughout the CarFuse application.

## 1. Log Categories

The application uses specialized loggers for different components:

| Category       | Purpose                                           |
|----------------|---------------------------------------------------|
| `application`  | General application logs (default)                |
| `auth`         | Authentication and authorization events           |
| `user`         | User-related operations                           |
| `db`           | Database operations and queries                   |
| `api`          | API requests and responses                        |
| `security`     | Security events, warnings, and breaches           |
| `system`       | System-level events                               |
| `audit`        | Security audit trail                              |
| `dependencies` | Service dependency initialization                 |
| `payment`      | Payment processing operations                     |
| `booking`      | Booking-related operations                        |
| `file`         | File operations and storage                       |
| `admin`        | Administrative operations                         |
| `metrics`      | Performance metrics                               |
| `report`       | Report generation                                 |
| `revenue`      | Revenue tracking                                  |
| `notification` | Notification services                             |
| `document`     | Document management                               |
| `dashboard`    | Dashboard operations                              |
| `encryption`   | Encryption operations                             |
| `cache`        | Cache operations                                  |
| `session`      | Session management                                |
| `validation`   | Data validation                                   |

## 2. Obtaining and Using Loggers

### 2.1 Dependency Injection

Loggers are primarily obtained through constructor injection:

```php
class UserController extends Controller
{
    protected LoggerInterface $logger;
    
    public function __construct(
        LoggerInterface $logger,
        // other dependencies
    ) {
        parent::__construct($logger, $exceptionHandler);
        // additional initialization
    }
}
```

### 2.2 Specialized Logger Injection

Controllers can request specific category loggers:

```php
$container->set(PaymentController::class, function($c) use ($logger, $loggers) {
    return new PaymentController(
        $loggers['payment'] ?? $logger,
        // other dependencies
    );
});
```

### 2.3 Fallback Pattern

When requesting specialized loggers, always implement a fallback pattern:

```php
$logger = $c->get('logger.auth') ?? $c->get(LoggerInterface::class);
```

### 2.4 Global Access (Avoid when possible)

For legacy code or non-DI contexts:

```php
global $loggers;
$loggers['payment']->info('Processing payment');
```

## 3. Log Configuration

### 3.1 File Storage

Logs are stored in the `/logs` directory with separate files for each category:
- `/logs/application.log`
- `/logs/auth.log`
- `/logs/db.log`
- etc.

### 3.2 Log Rotation

Log files are automatically rotated using Monolog's `RotatingFileHandler`:
- 14-day retention period
- Files are named with date suffixes (e.g., `application-2023-07-08.log`)

### 3.3 Formatting

All logs use a consistent format:

```
[2023-07-08 15:42:13.123456] [auth] INFO: User login successful {"email":"user@example.com"} {"memory_usage":2097152}
```

The format includes:
- Timestamp with microsecond precision
- Logger channel (category)
- Log level
- Message
- Context array (JSON)
- Extra information (JSON)

## 4. Best Practices

### 4.1 Choosing the Right Log Level

- `DEBUG`: Development information (query parameters, detailed flow)
- `INFO`: Normal operations (user login, resource creation)
- `NOTICE`: Uncommon but expected events
- `WARNING`: Unexpected events that don't affect operations
- `ERROR`: Failures that prevent operations from completing
- `CRITICAL`: Major issues requiring immediate attention
- `ALERT`: Issues requiring action (security breach)
- `EMERGENCY`: System is unusable

### 4.2 Providing Context

Always include relevant context as a second parameter:

```php
// Good practice
$this->logger->info("User login successful", ['email' => $data['email']]);

// Avoid
$this->logger->info("User login successful for " . $data['email']);
```

### 4.3 Controller Logging

Controllers should:
- Log the beginning of important operations
- Include user IDs and request IDs when available
- Log successful completion of operations
- Use proper error handling with the ExceptionHandler

```php
public function processPayment(): ResponseInterface
{
    try {
        $this->logger->info("Processing payment request", ['user_id' => $userId]);
        
        // Process payment
        
        $this->logger->info("Payment processed successfully", [
            'user_id' => $userId,
            'amount' => $amount,
            'transaction_id' => $transactionId
        ]);
        
        return $response;
    } catch (\Exception $e) {
        $this->exceptionHandler->handleException($e);
        // The exception handler will log the error
    }
}
```

### 4.4 Sensitive Information

Never log sensitive information:
- Passwords (even hashed)
- API keys
- Personal identification information
- Credit card numbers
- Access tokens (use redacted versions)

### 4.5 Performance Considerations

- Use context arrays instead of string concatenation
- Log moderately in production (INFO level and above)
- Use DEBUG level sparingly in production
- Validate that log-heavy operations don't impact performance

## 5. Log Access and Monitoring

Log files are stored in the `/logs` directory with appropriate permissions:
- Files: 0664
- Directory: 0775

During development, logs are also output to stderr for immediate visibility.

For log analysis, use standard Linux tools or dedicated log monitoring solutions:

```bash
# View recent authentication errors
tail -f /logs/auth.log | grep ERROR

# Count errors by type
grep ERROR /logs/application.log | cut -d':' -f4 | sort | uniq -c | sort -nr
```

## 6. Error Handling Integration

The logging system integrates with the `ExceptionHandler` to ensure exceptions are:
1. Logged with appropriate context and stack traces
2. Categorized correctly based on the exception source
3. Processed at the appropriate log level

```php
try {
    // Operation that might fail
} catch (\Exception $e) {
    $this->exceptionHandler->handleException($e);
    // Additional recovery logic if needed
}
```
=== docs/backend/.gitignore ===
# Build artifacts
build/
dist/

# Temporary files
*.tmp
*.log
*.bak

# Editor-specific files
.vscode/
.idea/
*.sublime-project
*.sublime-workspace

# OS-specific files
.DS_Store
Thumbs.db
=== docs/backend/components/helpers.md ===
# Helpers

## Overview
Helper classes provide commonly used functionality that simplifies code across the application. These utilities handle cross-cutting concerns like database operations, API responses, error handling, and environment configuration.

## Available Helpers

| Helper | Purpose |
|--------|---------|
| ApiHelper | Standardizes API responses and JWT handling |
| DatabaseHelper | Provides safe database operations with comprehensive logging |
| ExceptionHandler | Centralizes exception handling with consistent logging and responses |
| LogQueryBuilder | Generates SQL queries for audit log operations |
| SetupHelper | Sets up and verifies application environment configuration |

## Helper Classes

### ApiHelper

Primary purpose: Standardize API responses and JWT extraction.

#### Key Methods

```php
// Send standardized JSON response
public function sendJsonResponse(
    $status,               // 'success' or 'error'
    $message,              // Human-readable message
    $data = [],            // Data payload
    $httpCode = 200        // HTTP status code
): void

// Extract JWT token from Authorization header or cookie
public function getJWT(): ?string

// Log API-related events
public function logApiEvent($message): void
```

#### Usage Example

```php
$apiHelper = new ApiHelper($logger);

// Log API event
$apiHelper->logApiEvent("User {$userId} requested resource");

// Send success response
$apiHelper->sendJsonResponse('success', 'User created successfully', ['user_id' => $userId], 201);

// Send error response
$apiHelper->sendJsonResponse('error', 'Invalid parameters', ['errors' => $errors], 400);

// Extract JWT
$token = $apiHelper->getJWT();
```

### DatabaseHelper

Primary purpose: Provide safe database operations with error handling and logging.

#### Key Methods

```php
// Get PDO instance
public function getPdo(): PDO

// Execute a safe database query with logging
public function safeQuery(
    callable $query,               // Function containing the query to execute
    string $queryDescription = '', // Description for logging
    array $context = []            // Additional context information
): mixed

// Insert data into a table
public function insert(
    string $table,                // Table name
    array $data,                  // Data to insert (column => value)
    array $context = []           // Additional logging context
): string                         // Returns last insert ID

// Update data in a table
public function update(
    string $table,                // Table name
    array $data,                  // Data to update (column => value)
    array $where,                 // Where conditions (column => value)
    array $context = []           // Additional logging context
): int                            // Returns number of affected rows

// Delete data from a table
public function delete(
    string $table,                // Table name 
    array $where,                 // Where conditions (column => value)
    bool $softDelete = false,     // Whether to perform a soft delete
    array $context = []           // Additional logging context
): int                            // Returns number of affected rows

// Select data from the database
public function select(
    string $query,                // SQL query
    array $params = [],           // Query parameters
    array $context = []           // Additional logging context
): array                          // Returns query results

// Execute a raw query
public function rawQuery(
    string $query,                // SQL query
    array $params = [],           // Query parameters 
    array $context = []           // Additional logging context
): mixed                          // Returns query results or affected rows
```

#### Usage Example

```php
$dbHelper = new DatabaseHelper($config, $logger, $apiHelper);

// Insert
$userId = $dbHelper->insert('users', [
    'email' => 'user@example.com',
    'name' => 'John Doe',
    'created_at' => date('Y-m-d H:i:s')
]);

// Update
$affected = $dbHelper->update('users', 
    ['name' => 'Jane Doe'],   // data to update
    ['id' => $userId]         // where condition
);

// Select with prepared statement
$users = $dbHelper->select(
    "SELECT * FROM users WHERE email LIKE ?", 
    ['%example.com']
);

// Delete
$deleted = $dbHelper->delete('temp_logs', ['created_at' => '<= DATE_SUB(NOW(), INTERVAL 30 DAY)']);

// Soft delete (if table has deleted_at column)
$softDeleted = $dbHelper->delete('users', ['id' => $userId], true);
```

### ExceptionHandler

Primary purpose: Handle exceptions centrally with consistent logging and standardized responses.

#### Key Methods

```php
// Handle exceptions with appropriate logging and responses
public function handleException(Exception $e): void
```

#### Usage Example

```php
$exceptionHandler = new ExceptionHandler($dbLogger, $authLogger, $systemLogger);

try {
    // Application code
} catch (Exception $e) {
    $exceptionHandler->handleException($e);
}

// Global exception handling in index.php
set_exception_handler([$exceptionHandler, 'handleException']);
```

### LogQueryBuilder

Primary purpose: Generate standardized SQL queries for audit log operations.

#### Key Methods

```php
// Build WHERE clause and parameters for audit log queries
public function buildWhereClause(array $filters): array  // [whereClause, params]

// Build SQL queries for log retrieval with pagination
public function buildSelectQuery(array $filters): array  // Query parts including SQL and parameters

// Build SQL query for direct export to CSV file
public function buildExportQuery(
    array $filters,               // Filters to apply
    ?string $filepath = null      // Optional file path for direct export
): array                          // Export query information

// Build SQL and params for deleting logs
public function buildDeleteQuery(
    array $filters,               // Filters to determine which logs to delete
    bool $forceBulkDelete = false // Whether to allow bulk deletion without ID restrictions
): array                          // Delete query information
```

#### Usage Example

```php
$logQueryBuilder = new LogQueryBuilder($securityHelper);

// Build and execute a filtered query
$queryInfo = $logQueryBuilder->buildSelectQuery([
    'start_date' => '2023-01-01',
    'end_date' => '2023-01-31',
    'log_level' => 'error',
    'user_id' => 123,
    'page' => 1,
    'per_page' => 20
]);

$logs = $db->select($queryInfo['mainSql'], $queryInfo['params']);
$total = $db->select($queryInfo['countSql'], $queryInfo['params'])[0]['total'];

// Export logs to CSV
$exportInfo = $logQueryBuilder->buildExportQuery([
    'log_levels' => ['error', 'critical'],
    'relative_date' => 'last_30_days'
], '/tmp/error_logs.csv');

$db->rawQuery($exportInfo['sql'], $exportInfo['params']);
```

### SetupHelper

Primary purpose: Setup and verify the application environment.

#### Key Methods

```php
// Add required indexes to database tables if they don't exist
public function ensureIndexes(): void

// Verify that the application is running in a secure environment
public function verifySecureEnvironment(): array  // Returns array of security issues
```

#### Usage Example

```php
$setupHelper = new SetupHelper($dbHelper, $logger);

// During application boot
try {
    // Ensure database indexes exist
    $setupHelper->ensureIndexes();
    
    // Check for security issues
    $securityIssues = $setupHelper->verifySecureEnvironment();
    if (!empty($securityIssues)) {
        foreach ($securityIssues as $issue) {
            $logger->warning("Security issue: {$issue}");
        }
    }
} catch (Exception $e) {
    // Handle setup errors
    $logger->critical("Setup failed: " . $e->getMessage());
}
```

## Best Practices

1. **Dependency Injection**: Always inject dependencies into helpers rather than creating them inside
2. **Error Handling**: Use try-catch blocks when calling helper methods that might throw exceptions
3. **Logging**: Provide context in logs to help with troubleshooting
4. **Security**: Never log sensitive information like passwords or tokens
5. **Configuration**: Use environment variables for configuration rather than hardcoding values

## Creating New Helpers

When creating new helpers:

1. Place them in the `App\Helpers` namespace
2. Follow single responsibility principle - each helper should have a clear purpose
3. Use dependency injection for dependencies
4. Add comprehensive PHPDoc comments
5. Log important operations and errors
6. Include type hints for parameters and return values
7. Add the new helper to this documentation
=== docs/backend/components/models.md ===
# Models

## Overview
The CarFuse application uses a collection of models that represent the core business entities and their relationships. Each model encapsulates business logic and data operations for its respective domain, following a clean separation of concerns architecture.

## Base Models

### BaseModel
**Purpose**: Serves as the parent class for all models, providing common CRUD operations and utility methods.

**Fields**:
| Field | Type | Description |
|-------|------|-------------|
| $table | string | The database table name |
| $resourceName | string | Resource name for audit logging |
| $useTimestamps | bool | Whether model uses timestamps |
| $useSoftDeletes | bool | Whether model uses soft deletes |
| $useUuid | bool | Whether model uses UUID as primary key |
| $fillable | array | Fields that can be mass assigned |
| $casts | array | Field type casting definitions |

**Key Methods**:
- `find(int|string $id)`: Retrieves a record by ID
- `findBy(string $field, $value)`: Finds records by field value
- `all(array $orderBy, ?int $limit, ?int $offset)`: Gets all records with optional pagination
- `create(array $data)`: Creates a new record
- `update(int|string $id, array $data)`: Updates an existing record
- `delete(int|string $id)`: Deletes a record (soft delete if enabled)

### BaseFinancialModel
**Purpose**: Extends BaseModel with specialized functionality for financial data handling, including encryption of sensitive information.

**Additional Fields**:
| Field | Type | Description |
|-------|------|-------------|
| $encryptedFields | array | Fields that should be encrypted in database |

**Key Methods**:
- `encryptSensitiveData(array $data)`: Encrypts sensitive fields before storage
- `decryptSensitiveData(array $data)`: Decrypts sensitive fields after retrieval
- `recordAuditEvent(string $action, array $data, ?int $userId)`: Records security events in audit log

## Core Models

### User
**Purpose**: Represents a user in the system with their associated data and relationships.

**Fields**:
| Field | Type | Description |
|-------|------|-------------|
| id | string (UUID) | Primary key |
| name | string | User's first name |
| surname | string | User's last name |
| email | string | User's email address |
| password_hash | string | Hashed password |
| role | string | User role (user, admin, super_admin) |
| phone | string | Phone number |
| address | string | Physical address |
| status | string | User status |
| created_at | DateTime | Creation timestamp |
| updated_at | DateTime | Last update timestamp |
| deleted_at | DateTime | Soft delete timestamp |

**Relationships**:
- One-to-Many with Booking
- One-to-Many with Payment
- One-to-Many with Signature
- One-to-Many with TransactionLog

**Key Methods**:
- `createWithDefaultRole(array $data)`: Creates a new user with role assignment and password hashing
- `updateWithPasswordHandling(string|int $id, array $data)`: Updates user data with password handling
- `getBookings(string $userId)`: Gets user's bookings
- `getPayments(int $userId)`: Gets user's payments
- `getTransactions(int $userId)`: Gets user's transactions

### Vehicle
**Purpose**: Represents a vehicle in the system with its details and status.

**Fields**:
| Field | Type | Description |
|-------|------|-------------|
| registration_number | string | Vehicle registration plate |
| type | string | Vehicle type |
| status | string | Vehicle status (available, unavailable, maintenance) |
| make | string | Vehicle manufacturer |
| model | string | Vehicle model |
| year | integer | Manufacturing year |

**Relationships**:
- One-to-Many with Booking

**Key Methods**:
- `findAvailable()`: Finds all available vehicles
- `findByType(string $type)`: Finds vehicles by type

### Booking
**Purpose**: Represents a booking of a vehicle by a user.

**Fields**:
| Field | Type | Description |
|-------|------|-------------|
| user_id | int | ID of the user who made the booking |
| vehicle_id | int | ID of the vehicle being booked |
| pickup_date | datetime | Date and time of vehicle pickup |
| dropoff_date | datetime | Date and time of vehicle return |
| status | string | Booking status (pending, confirmed, cancelled, completed) |
| created_at | datetime | Creation timestamp |
| updated_at | datetime | Last update timestamp |
| deleted_at | datetime | Soft delete timestamp |

**Relationships**:
- Many-to-One with User
- Many-to-One with Vehicle
- One-to-Many with Payment
- One-to-One with Contract

**Key Methods**:
- `updateStatus(int|string $id, string $newStatus)`: Updates booking status
- `getActive()`: Gets all active bookings
- `getByUser(int|string $userId)`: Gets bookings by user ID
- `getByStatus(string $status)`: Gets bookings by status
- `getByDateRange(string $start, string $end, array $filters)`: Gets bookings within a date range
- `isVehicleAvailable(int|string $vehicleId, string $startDate, string $endDate)`: Checks if vehicle is available for booking

### Payment
**Purpose**: Represents a payment transaction in the system.

**Fields**:
| Field | Type | Description |
|-------|------|-------------|
| user_id | int | ID of the user who made the payment |
| booking_id | int | ID of the associated booking |
| amount | float | Transaction amount |
| method | string | Payment method (credit_card, paypal, bank_transfer) |
| status | string | Status of payment (pending, completed, failed) |
| transaction_id | string | Unique external transaction identifier |
| type | string | Type of transaction (payment or refund) |
| refund_reason | string | Reason for refund, if applicable |
| original_payment_id | int | ID of original payment for refunds |
| created_at | datetime | Creation timestamp |
| updated_at | datetime | Last update timestamp |
| deleted_at | datetime | Soft delete timestamp |

**Relationships**:
- Many-to-One with User
- Many-to-One with Booking

**Key Methods**:
- `createPaymentRecord(array $data)`: Creates a payment record
- `createRefund(array $refundData)`: Creates a refund record
- `updatePaymentRecord(int $id, array $data)`: Updates a payment record
- `getByUser(int $userId)`: Gets payments by user ID
- `getByStatus(string $status)`: Gets payments by status
- `getByBooking(int $bookingId)`: Gets payments by booking ID
- `hasRefunds(int $paymentId)`: Checks if a payment has been refunded
- `getRefundedAmount(int $paymentId)`: Gets total refunded amount

### TransactionLog
**Purpose**: Represents financial transaction log entries with enhanced security for sensitive financial data.

**Fields**:
| Field | Type | Description |
|-------|------|-------------|
| user_id | int | User ID associated with transaction |
| amount | encrypted string | Transaction amount (encrypted) |
| card_number | encrypted string | Card number (encrypted) |
| card_last4 | encrypted string | Last 4 digits of card (encrypted) |
| transaction_type | string | Type of transaction |
| status | string | Transaction status |
| reference | string | Reference number |
| created_at | datetime | Creation timestamp |
| updated_at | datetime | Last update timestamp |
| deleted_at | datetime | Soft delete timestamp |

**Relationships**:
- Many-to-One with User

**Key Methods**:
- `encryptSensitiveData(array $data)`: Encrypts sensitive fields
- `decryptSensitiveData(array $data)`: Decrypts sensitive fields
- `logTransaction(array $transactionData)`: Logs a new financial transaction
- `updateStatus(string|int $transactionId, string $status)`: Updates transaction status
- `getForUser(int|string $userId)`: Gets transactions for a specific user
- `getByReference(string $reference)`: Gets transactions by reference number
- `getByDateRange(string $startDate, string $endDate)`: Gets transactions within a date range

### Contract
**Purpose**: Handles contract specific database operations.

**Fields**:
| Field | Type | Description |
|-------|------|-------------|
| booking_id | int | Associated booking ID |
| user_id | int | Associated user ID |
| content | text | Contract content |
| status | string | Contract status |

**Relationships**:
- One-to-One with Booking
- Many-to-One with User

**Key Methods**:
- `getByBookingId(int $bookingId)`: Gets contract by booking ID
- `getByUserId(int $userId)`: Gets contracts by user ID

### DocumentTemplate
**Purpose**: Manages templates for documents such as contracts, invoices, and Terms & Conditions.

**Fields**:
| Field | Type | Description |
|-------|------|-------------|
| name | string | Template name |
| content | text | Template content |
| description | string | Template description |
| file_path | string | Path to template file |
| created_at | datetime | Creation timestamp |
| updated_at | datetime | Last update timestamp |
| deleted_at | datetime | Soft delete timestamp |

**Key Methods**:
- `findByName(string $name)`: Finds a template by its name

### Signature
**Purpose**: Manages electronic signatures for documents and contracts.

**Fields**:
| Field | Type | Description |
|-------|------|-------------|
| user_id | int | Associated user ID |
| signature | encrypted string | Signature data (encrypted) |
| file_path | string | Path to signature file |
| encrypted | bool | Whether signature is encrypted |
| created_at | datetime | Creation timestamp |

**Relationships**:
- Many-to-One with User

**Key Methods**:
- `getSignature(int $signatureId)`: Gets the signature
- `getUser(int $signatureId)`: Gets the user associated with the signature
- `storeSignaturePath(int $userId, string $filePath, bool $encrypted)`: Stores signature file path
- `getSignaturesByUserId(int $userId)`: Gets signatures by user ID
- `getSignaturePathByUserId(int $userId)`: Gets signature path by user ID

### Admin
**Purpose**: Manages system administrators.

**Fields**:
| Field | Type | Description |
|-------|------|-------------|
| name | string | Admin name |
| email | string | Admin email |
| password | string | Admin password (hashed) |
| role | string | Admin role |
| token | string | Authentication token |
| token_expiry | datetime | Token expiration time |
| created_at | datetime | Creation timestamp |
| updated_at | datetime | Last update timestamp |
| deleted_at | datetime | Soft delete timestamp |

**Key Methods**:
- `hashPassword(string $password)`: Hashes a password
- `verifyPassword(string $plainPassword, string $hashedPassword)`: Verifies password
- `getByEmail(string $email)`: Gets admin by email
- `restore(int|string $id)`: Restores a soft-deleted admin
- `getManagedUsers(int|string $adminId)`: Gets users managed by admin
- `getPermissions(int|string $adminId)`: Gets admin permissions
- `findByToken(string $token)`: Finds admin by token
- `createAdminWithHashedPassword(array $data)`: Creates admin with password hashing
- `updateAdminWithPasswordHandling(int|string $id, array $data)`: Updates admin with password handling

### Report
**Purpose**: Represents an admin report in the system.

**Fields**:
| Field | Type | Description |
|-------|------|-------------|
| admin_id | int | ID of admin who created report |
| title | string | Report title |
| content | text | Report content |
| status | string | Report status |
| created_at | datetime | Creation timestamp |
| updated_at | datetime | Last update timestamp |
| deleted_at | datetime | Soft delete timestamp |

**Relationships**:
- Many-to-One with Admin

**Key Methods**:
- `getByDateRange(string $start, string $end)`: Gets reports within a date range
- `getAdmin(int $reportId)`: Gets the admin who created the report

### AuditLog
**Purpose**: Represents the audit_logs table and provides methods for retrieving, searching, and exporting audit data.

**Fields**:
| Field | Type | Description |
|-------|------|-------------|
| action | string | Action performed |
| message | string | Description of the event |
| log_level | string | Log level (info, warning, error) |
| details | json | Additional details |
| user_id | int | Associated user ID |
| created_at | datetime | When the event occurred |

**Key Methods**:
- `getLogs(array $filters)`: Gets logs with filtering and pagination
- `getById(int $id)`: Gets a single log by ID
- `deleteLogs(array $filters, bool $forceBulkDelete)`: Deletes logs based on criteria
- `exportLogs(array $filters)`: Exports logs to CSV
- `createLog(array $data)`: Creates a new log entry

### AuditTrail
**Purpose**: Represents the audit trails stored in the database and provides methods for accessing and filtering the logs.

**Fields**:
| Field | Type | Description |
|-------|------|-------------|
| user_id | int | User who performed the action |
| booking_id | int | Related booking if applicable |
| action | string | Action performed |
| message | string | Description of the event |
| details | json | Additional details |
| created_at | datetime | When the event occurred |

**Relationships**:
- Many-to-One with User
- Many-to-One with Booking

**Key Methods**:
- `getLogs(array $filters)`: Retrieves audit trail records based on filters

## Relationship Diagram

Below is a simplified representation of relationships between key models:

```
User > Booking < Vehicle
                         
                         
                         
     Payment              
                         
                         
TransactionLog   Contract   
                          
         > AuditTrail <
                  
                  
                  
            DocumentTemplate
                  
                  
                  
               Signature
```

## Validation

Models use validation rules defined as static properties (e.g., `$rules`) and validation is typically performed before create/update operations. The Validator service is often used in conjunction with models to enforce data integrity.
=== docs/backend/components/services.md ===
# Services

## Table of Contents
- [Overview](#overview)
- [Service Structure](#service-structure)
- [Available Services](#available-services)
  - [Core Services](#core-services)
    - [UserService](#userservice)
    - [BookingService](#bookingservice)
    - [TemplateService](#templateservice)
    - [DocumentService](#documentservice)
    - [SignatureService](#signatureservice)
    - [NotificationService](#notificationservice)
    - [ReportService](#reportservice)
    - [SettingsService](#settingsservice)
    - [RevenueService](#revenueservice)
  - [Auth Services](#auth-services)
    - [AuthService](#authservice)
    - [TokenService](#tokenservice)
  - [Payment Services](#payment-services)
    - [PaymentService](#paymentservice)
    - [PaymentProcessingService](#paymentprocessingservice)
    - [RefundService](#refundservice)
    - [TransactionService](#transactionservice)
    - [PaymentGatewayService](#paymentgatewayservice)
  - [Audit Services](#audit-services)
    - [AuditService](#auditservice)
    - [TransactionAuditService](#transactionauditservice)
    - [LogManagementService](#logmanagementservice)
    - [UserAuditService](#userauditservice)
  - [Security Services](#security-services)
    - [EncryptionService](#encryptionservice)
    - [FraudDetectionService](#frauddetectionservice)
    - [KeyManager](#keymanager)
    - [RateLimiter](#ratelimiter)
  - [Utility Services](#utility-services)
    - [FileStorage](#filestorage)
    - [MetricsService](#metricsservice)
    - [Validator](#validator)
  - [Administrative Services](#administrative-services)
    - [AdminService](#adminservice)
    - [AuditService](#auditservice)
- [Service Interactions](#service-interactions)

## Overview
The service layer forms the core business logic of the application. Services encapsulate complex operations, enforce business rules, and coordinate interactions between controllers and models. All services follow SOLID principles and use dependency injection to promote maintainability and testability.

## Service Structure
Services are organized into domains and subdomains:
- Core services (UserService, BookingService, etc.) implement primary business functionality
- Specialized services (Auth, Payment, etc.) handle specific domains
- Support services (Audit, Metrics, etc.) provide cross-cutting functionality

Each service typically:
1. Receives dependencies via constructor injection
2. Provides a focused set of public methods
3. Handles exceptions and logs appropriately
4. Uses models for data access instead of direct DB operations

## Available Services

### Core Services

#### UserService
**Purpose:** Manages user accounts including creation, authentication, profile updates, and role management.

| Method | Description |
|--------|-------------|
| `createUser(array $data): array` | Creates a new user with validation |
| `updateUser(int $id, array $data): array` | Updates user profile information |
| `updateUserRole(int $id, string $role): array` | Changes a user's role with audit logging |
| `deleteUser(int $id): array` | Soft-deletes a user account |
| `changePassword(int $id, string $currentPassword, string $newPassword): array` | Updates user password with verification |
| `authenticate(string $email, string $password): array` | Authenticates user and returns JWT token |
| `requestPasswordReset(string $email): array` | Initiates password reset process |

**Dependencies:** DatabaseHelper, LoggerInterface, ExceptionHandler, AuditService, User model

#### BookingService
**Purpose:** Manages the vehicle booking process including creation, modification, and cancellation of bookings.

| Method | Description |
|--------|-------------|
| `createBooking(array $data): array` | Creates a new booking with validation |
| `getBookingById(int $id): ?array` | Retrieves booking details by ID |
| `getUserBookings(int $userId, int $page = 1, int $perPage = 10, ?string $status = null): array` | Gets user's bookings with pagination and optional filtering |
| `cancelBooking(int $id, int $userId): array` | Cancels a booking and calculates any applicable refund |
| `rescheduleBooking(int $id, string $pickupDate, string $dropoffDate, int $userId): array` | Reschedules a booking to new dates |
| `validateBookingAccess(int $bookingId, int $userId): bool` | Verifies user has access to a booking |
| `getBookingLogs(int $bookingId): array` | Retrieves activity logs for a booking |
| `completeBooking(int $id): bool` | Marks a booking as completed |

**Dependencies:** DatabaseHelper, AuditService, LoggerInterface, ExceptionHandler, Booking model, Vehicle model, Payment model

#### TemplateService
**Purpose:** Provides functionality for managing and rendering document templates with placeholder replacement.

| Method | Description |
|--------|-------------|
| `listTemplates(): array` | Returns all available templates |
| `loadTemplate($templateId): DocumentTemplate` | Loads template content by ID or name |
| `renderTemplate($templateId, array $data): string` | Replaces placeholders with data and returns rendered content |
| `saveTemplate(string $templateName, string $content, ?int $templateId = null): DocumentTemplate` | Creates or updates a template |
| `deleteTemplate(int $templateId): bool` | Deletes a template by ID |

**Dependencies:** LoggerInterface, ExceptionHandler, AuditService, DocumentTemplate model

#### DocumentService
**Purpose:** Manages documents including templates, contracts, and T&C with encryption and secure storage.

| Method | Description |
|--------|-------------|
| `uploadTemplate(string $name, string $content): void` | Uploads an encrypted document template |
| `uploadTerms(string $content): void` | Uploads Terms & Conditions document |
| `generateContract(int $bookingId, int $userId): string` | Creates a contract document dynamically |
| `retrieveDocument(string $filePath): string` | Retrieves and decrypts a document |
| `deleteDocument(int $documentId): void` | Deletes a document securely |
| `getTemplates(): array` | Gets a list of all available templates |
| `getTemplateById(int $templateId): array` | Gets a specific template by ID |
| `getUserContracts(int $userId): array` | Gets all contracts for a specific user |
| `getBookingContract(int $bookingId): array` | Gets contract for a specific booking |
| `generateInvoice(int $bookingId): string` | Generates an invoice document |

**Dependencies:** LoggerInterface, ExceptionHandler, AuditService, FileStorage, EncryptionService, TemplateService, various models (Document, DocumentTemplate, Contract, User, Booking)

#### SignatureService
**Purpose:** Manages electronic signatures both locally and via an external AES API.

| Method | Description |
|--------|-------------|
| `uploadSignature(string $filePath, int $userId): string` | Uploads a local signature securely |
| `sendForAdvancedSignature(string $filePath, int $userId, string $callbackUrl): array` | Sends document for AES signature |
| `verifySignature(string $signedFilePath, string $originalFilePath): bool` | Verifies an AES signature |
| `getSignatures(int $userId): array` | Retrieves all stored signatures for a user |
| `getSignature(int $userId): ?string` | Gets a specific signature for a user |
| `checkAdvancedSignatureStatus(string $requestId): array` | Checks status of an AES signature request |
| `downloadSignedDocument(string $requestId, string $outputPath): bool` | Downloads a signed AES document |

**Dependencies:** LoggerInterface, Signature model, FileStorage, EncryptionService, ExceptionHandler

#### NotificationService
**Purpose:** Manages user notifications across multiple channels (email, SMS, in-app, push).

| Method | Description |
|--------|-------------|
| `sendNotification(int $userId, string $type, string $message, array $options = []): bool` | Sends notification via specified channel |
| `getUserNotifications(int $userId): array` | Gets all notifications for a user |
| `getUnreadNotifications(int $userId): array` | Gets only unread notifications for a user |
| `markAsRead(int $notificationId): bool` | Marks a notification as read |
| `deleteNotification(int $notificationId): bool` | Deletes a notification |
| `sendBookingConfirmationNotification(int $bookingId, int $userId): bool` | Sends booking confirmation |
| `sendPaymentConfirmation(int $userId, ?int $bookingId, float $amount): bool` | Sends payment confirmation |
| `sendRefundNotification(int $userId, int $bookingId, float $amount, string $reason): bool` | Sends refund notification |
| `verifyNotificationOwnership(int $notificationId, int $userId): ?array` | Verifies user owns notification |

**Dependencies:** LoggerInterface, NotificationManager, EmailService, SMSService, User model, Notification model, AuditService

#### ReportService
**Purpose:** Generates and manages various business reports with filterable criteria.

| Method | Description |
|--------|-------------|
| `generateReport(string $reportType, array $dateRange, string $format, array $filters = []): string` | Generates specified report |
| `generateUserReport(int $userId, string $reportType, array $dateRange, string $format): string` | Generates report for specific user |
| `getAvailableReportTypes(): array` | Returns all available report types |
| `scheduleReport(string $reportType, array $schedule, int $userId, array $filters = []): int` | Schedules periodic report generation |
| `cancelScheduledReport(int $scheduleId, int $userId): bool` | Cancels a scheduled report |
| `getReportHistory(int $userId): array` | Gets history of generated reports |

**Dependencies:** LoggerInterface, ExceptionHandler, AuditService, DatabaseHelper, PDFGenerator, ExcelGenerator, User model, Booking model, Payment model

#### SettingsService
**Purpose:** Manages application-wide and user-specific settings with validation rules.

| Method | Description |
|--------|-------------|
| `getAllSettings(): array` | Retrieves all system settings |
| `saveSettings(array $settings): bool` | Saves multiple settings at once |
| `getSetting(string $key, $default = null)` | Gets a specific setting with fallback default |
| `updateSetting(string $key, $value): bool` | Updates a single setting |
| `getUserSettings(int $userId): array` | Gets settings for a specific user |
| `updateUserSetting(int $userId, string $key, $value): bool` | Updates a user-specific setting |
| `saveTabSettings(string $tab, array $data): bool` | Saves settings for a specific section |
| `testEmailConnection(array $settings): bool|string` | Tests email server connection |

**Dependencies:** LoggerInterface, AuditService, ExceptionHandler, DatabaseHelper, Settings model, UserSettings model

#### RevenueService
**Purpose:** Analyzes revenue streams, forecasts, and financial performance metrics.

| Method | Description |
|--------|-------------|
| `getRevenueSummary(string $period = 'month'): array` | Gets revenue summary for specified period |
| `getRevenueByVehicleType(array $dateRange): array` | Analyzes revenue by vehicle category |
| `getRevenueByPaymentMethod(array $dateRange): array` | Breaks down revenue by payment method |
| `calculateGrowthRate(string $period = 'month'): float` | Calculates revenue growth rate |
| `getRefundMetrics(array $dateRange): array` | Gets statistics about refunds |
| `forecastRevenue(int $months = 3): array` | Forecasts future revenue |
| `exportRevenueReport(array $dateRange, string $format = 'csv'): string` | Exports revenue data |

**Dependencies:** LoggerInterface, DatabaseHelper, AuditService, ExceptionHandler, Booking model, Payment model, RefundLog model

### Auth Services

#### AuthService
**Purpose:** Handles authentication, registration, and token management for users.

| Method | Description |
|--------|-------------|
| `login(array $data): array` | Authenticates user and returns tokens |
| `register(array $data): array` | Creates new user account |
| `refresh(array $data): array` | Refreshes access token using refresh token |
| `logout(array $data): array` | Logs out a user and invalidates tokens |
| `updateProfile($userId, array $data): array` | Updates user profile information |
| `resetPasswordRequest(array $data): array` | Initiates password reset process |
| `resetPassword(array $data): array` | Completes password reset with new password |
| `validateRequest(?string $authHeader = null): ?object` | Validates token from request header |

**Dependencies:** DatabaseHelper, TokenService, ExceptionHandler, LoggerInterface, AuditService, Validator, User model

#### TokenService
**Purpose:** Manages JWT token generation, validation, and refresh token handling.

| Method | Description |
|--------|-------------|
| `generateToken($user): string` | Generates JWT access token |
| `generateRefreshToken($user): string` | Generates and stores refresh token |
| `verifyToken(string $token): array` | Verifies JWT token validity and returns payload |
| `decodeRefreshToken(string $refreshToken)` | Decodes and validates refresh token |
| `refreshToken(string $refreshToken): string` | Creates new access token using refresh token |
| `revokeToken(string $token): void` | Revokes a refresh token |
| `purgeExpiredTokens(): int` | Removes expired tokens from database |
| `getActiveTokensForUser(int $userId): array` | Gets all active tokens for a user |
| `validateRequest($request): ?array` | Validates token and returns user data |
| `extractToken($request): ?string` | Extracts token from various request formats |

**Dependencies:** LoggerInterface, ExceptionHandler, DatabaseHelper, AuditService, RefreshToken model, User model

### Payment Services

#### PaymentService
**Purpose:** Acts as a facade for payment operations, delegating to specialized payment services.

| Method | Description |
|--------|-------------|
| `processPayment(array $paymentData): array` | Processes payment and updates booking status |
| `refundPayment(array $refundData): array` | Handles payment refunds |
| `addPaymentMethod(array $methodData): array` | Adds a payment method for a user |
| `getUserPaymentMethods(int $userId): array` | Gets all payment methods for a user |
| `getTransactionDetails(int $transactionId, int $userId, bool $isAdmin = false): ?array` | Gets transaction details |
| `handlePaymentCallback(string $gatewayName, array $callbackData): array` | Processes payment gateway callbacks |
| `getTransactionHistory(int $userId): array` | Gets transaction history for a user |
| `getTransactionHistoryAdmin(array $filters): array` | Gets filtered transaction history for admins |
| `processPaymentGateway(string $gatewayName, array $paymentData): array` | Direct interaction with payment gateway |

**Dependencies:** Payment services (PaymentProcessingService, RefundService, PaymentGatewayService, TransactionService), models (Payment, PaymentMethod, TransactionLog, Booking), AuditService

#### PaymentProcessingService
**Purpose:** Handles payment initiation, validation, database transactions, and fraud detection.

| Method | Description |
|--------|-------------|
| `processPayment(array $paymentData): array` | Processes a payment with fraud validation |
| `performFraudValidation(array $paymentData): array` | Validates payment data for fraud indicators |

**Dependencies:** DatabaseHelper, models (Payment, Booking, TransactionLog), AuditService, LoggerInterface

#### RefundService
**Purpose:** Handles all refund-related operations including validation and processing.

| Method | Description |
|--------|-------------|
| `refund(array $refundData): array` | Processes a refund request |
| `isValidRefundData(array $refundData): bool` | Validates refund data completeness |
| `isRefundable(array $originalPayment, array $refundData): bool` | Checks if payment is eligible for refund |

**Dependencies:** DatabaseHelper, models (Payment, TransactionLog), AuditService, LoggerInterface

#### TransactionService
**Purpose:** Handles transaction consistency, logging, and history retrieval.

| Method | Description |
|--------|-------------|
| `logTransaction(array $transactionData): array` | Logs a transaction in the system |
| `getHistoryByUser(int $userId): array` | Gets transaction history for a user |
| `getHistoryAdmin(array $filters): array` | Gets filtered transaction history for admins |
| `getTransactionDetails(int $transactionId, int $userId, bool $isAdmin = false): ?array` | Gets transaction details |

**Dependencies:** TransactionLog model, Payment model, AuditService, LoggerInterface

#### PaymentGatewayService
**Purpose:** Interfaces with external payment providers (Stripe, PayPal, etc.).

| Method | Description |
|--------|-------------|
| `processGatewayPayment(string $gateway, array $paymentData): array` | Processes payment through specified gateway |
| `createPaymentIntent(string $gateway, array $paymentData): array` | Creates payment intent for client-side processing |
| `verifyPayment(string $gateway, array $verificationData): bool` | Verifies a payment was successful |
| `refundGatewayPayment(string $gateway, array $refundData): array` | Issues refund through gateway |
| `getGatewayConfig(string $gateway): array` | Retrieves configuration for specified gateway |
| `validateWebhook(string $gateway, array $data, string $signature): bool` | Validates incoming webhook signature |

**Dependencies:** LoggerInterface, TransactionLog model, Payment model, AuditService, gateway-specific libraries (Stripe, PayPal SDKs)

### Audit Services

#### AuditService
**Purpose:** Provides centralized event logging with security-sensitive events stored in audit database.

| Method | Description |
|--------|-------------|
| `logEvent(string $category, string $message, array $context = [], ?int $userId = null, ?int $bookingId = null, ?string $ipAddress = null, string $logLevel = self::LOG_LEVEL_INFO): ?int` | Main entry point for logging events |
| `recordEvent(string $category, string $action, string $message, array $context = [], ?int $userId = null, ?int $objectId = null, string $logLevel = self::LOG_LEVEL_INFO): ?int` | Legacy method for event recording |
| `recordPaymentSuccess(array $paymentData): ?int` | Records successful payment events |
| `getLogs(array $filters = []): array` | Gets filtered logs |
| `deleteLogs(array $filters, bool $forceBulkDelete = false): int` | Deletes logs matching filters |
| `exportLogs(array $filters): array` | Exports logs for reporting |
| `getLogById(int $logId): ?array` | Gets specific log entry |

**Dependencies:** LoggerInterface, ExceptionHandler, LogManagementService, UserAuditService, TransactionAuditService, LogLevelFilter, AuditLog model

#### TransactionAuditService
**Purpose:** Handles audit logging for financial transactions with fraud detection capabilities.

| Method | Description |
|--------|-------------|
| `logEvent(string $category, string $message, array $context, ?int $userId = null, ?int $bookingId = null, string $logLevel = 'info'): ?int` | Logs transaction events |
| `recordPaymentSuccess(array $paymentData): ?int` | Records successful payment transactions |
| `recordFraudValidationFailure(array $paymentData, array $fraudIndicators = []): ?int` | Records fraud validation failures |
| `recordTransaction(string $transactionType, array $transactionData, string $status, ?string $message = null): ?int` | Records transaction with status |
| `recordRefund(array $refundData, string $status): ?int` | Records refund events |

**Dependencies:** LogManagementService, FraudDetectionService, ExceptionHandler, LoggerInterface

#### LogManagementService
**Purpose:** Manages storage, retrieval, and maintenance of application logs and audit records.

| Method | Description |
|--------|-------------|
| `createLogEntry(string $category, string $message, array $context, ?int $userId, ?int $bookingId, ?string $ipAddress, string $logLevel): ?int` | Creates a new log entry |
| `getLogs(array $filters = []): array` | Retrieves logs with pagination and filtering |
| `exportLogs(array $filters): array` | Exports logs in specified format (CSV, JSON) |
| `getLogById(int $logId): ?array` | Gets a specific log entry by ID |
| `deleteLogs(array $filters, bool $forceBulkDelete = false): int` | Deletes logs matching criteria |
| `purgeOldLogs(int $days = 90, array $excludeCategories = []): int` | Purges logs older than specified days |
| `getLogger(): LoggerInterface` | Gets the logger instance |

**Dependencies:** LoggerInterface, ExceptionHandler, DatabaseHelper, AuditLog model

#### UserAuditService
**Purpose:** Specializes in user-related audit trail logging with enhanced privacy protection.

| Method | Description |
|--------|-------------|
| `logUserEvent(string $category, string $action, string $message, array $context, ?int $userId, string $logLevel = 'info'): ?int` | Logs user events |
| `logAuthEvent(string $action, string $message, array $context, ?int $userId, string $logLevel): ?int` | Logs authentication events |
| `recordProfileChange(int $userId, array $changes, string $source): ?int` | Records profile data changes |
| `recordPermissionChange(int $userId, array $permissionChanges, int $adminId): ?int` | Records permission changes |
| `getUserAuditLog(int $userId, array $filters = []): array` | Gets audit log for specific user |

**Dependencies:** LogManagementService, ExceptionHandler, LoggerInterface

### Security Services

#### EncryptionService
**Purpose:** Provides secure encryption and decryption for sensitive data using industry standards.

| Method | Description |
|--------|-------------|
| `encrypt(string $data): string` | Encrypts data using application key |
| `decrypt(string $encryptedData): string` | Decrypts previously encrypted data |
| `generateKey(int $length = 32): string` | Generates a secure random key |
| `hashPassword(string $password): string` | Securely hashes passwords |
| `verifyPassword(string $password, string $hash): bool` | Verifies password against hash |
| `encryptFile(string $inputPath, string $outputPath): bool` | Encrypts a file |
| `decryptFile(string $inputPath, string $outputPath): bool` | Decrypts a file |

**Dependencies:** LoggerInterface, KeyManager, ExceptionHandler

#### FraudDetectionService
**Purpose:** Detects and prevents fraudulent transactions using pattern analysis and risk scoring.

| Method | Description |
|--------|-------------|
| `analyzeTransaction(array $paymentData): array` | Analyzes transaction for fraud indicators |
| `validateIPAddress(string $ipAddress): array` | Validates IP address against known fraud sources |
| `validateUserBehavior(int $userId, array $currentAction): array` | Analyzes user behavior patterns |
| `getRiskScore(array $indicators): int` | Calculates overall risk score (0-100) |
| `getFraudRules(): array` | Gets all fraud detection rules |
| `updateFraudRule(int $ruleId, array $ruleData): bool` | Updates a fraud detection rule |
| `recordSuspiciousActivity(array $activityData): int` | Records suspicious activity |

**Dependencies:** LoggerInterface, AuditService, ExceptionHandler, DatabaseHelper, User model, IP geolocation service

#### KeyManager
**Purpose:** Manages cryptographic keys with secure storage, rotation, and access control.

| Method | Description |
|--------|-------------|
| `getKey(string $keyName): string` | Retrieves a key by name |
| `rotateKey(string $keyName): bool` | Rotates a key (generates new key while preserving old) |
| `generateKey(string $keyName, int $length = 32): string` | Generates and stores a new key |
| `deleteKey(string $keyName): bool` | Deletes a key |
| `backupKeys(): string` | Creates encrypted backup of all keys |
| `importKeys(string $backupData, string $password): bool` | Imports keys from backup |
| `validateKeyStrength(string $keyName): bool` | Validates key strength |

**Dependencies:** LoggerInterface, ExceptionHandler, secure storage mechanism (file/database), AuditService

#### RateLimiter
**Purpose:** Prevents abuse by limiting request frequency for APIs and sensitive operations.

| Method | Description |
|--------|-------------|
| `attempt(string $key, int $maxAttempts, int $decaySeconds = 60): bool` | Checks if attempt should be allowed |
| `hit(string $key, int $decaySeconds = 60): int` | Records an attempt and returns total attempts |
| `clear(string $key): bool` | Resets attempts for a key |
| `remaining(string $key, int $maxAttempts): int` | Gets remaining attempts |
| `availableIn(string $key): int` | Gets seconds until attempts reset |
| `tooManyAttempts(string $key, int $maxAttempts): bool` | Checks if max attempts exceeded |

**Dependencies:** CacheInterface or DatabaseHelper, LoggerInterface

### Utility Services

#### FileStorage
**Purpose:** Handles secure file operations with support for various storage backends (local, S3, etc.).

| Method | Description |
|--------|-------------|
| `storeFile(string $directory, string $filename, string $content, bool $public = false): string` | Stores a file and returns path |
| `retrieveFile(string $path, bool $public = false): string` | Retrieves file content |
| `deleteFile(string $path, bool $public = false): bool` | Deletes a file |
| `fileExists(string $path, bool $public = false): bool` | Checks if file exists |
| `getPublicUrl(string $path): string` | Gets public URL for a file |
| `moveFile(string $source, string $destination): bool` | Moves a file |
| `getStorageDriver(string $driver = null)` | Gets storage driver instance |

**Dependencies:** LoggerInterface, ExceptionHandler, storage drivers (local filesystem, S3, etc.)

#### MetricsService
**Purpose:** Collects, analyzes, and provides application performance and business metrics.

| Method | Description |
|--------|-------------|
| `recordMetric(string $name, $value, array $tags = []): bool` | Records a metric data point |
| `incrementCounter(string $name, int $value = 1, array $tags = []): int` | Increments a counter metric |
| `recordTiming(string $name, float $milliseconds, array $tags = []): bool` | Records timing information |
| `getMetric(string $name, array $filter = [], string $aggregation = 'avg'): array` | Gets metric data |
| `getSystemMetrics(): array` | Gets system performance metrics |
| `getBusinessMetrics(string $period = 'day'): array` | Gets business performance metrics |
| `exportMetrics(array $filter = []): array` | Exports metrics data |

**Dependencies:** LoggerInterface, DatabaseHelper, CacheInterface, various models

#### Validator
**Purpose:** Provides data validation with customizable rules and error messages.

| Method | Description |
|--------|-------------|
| `validate(array $data, array $rules): bool` | Validates data against rules |
| `errors(): array` | Returns validation errors |
| `failed(): bool` | Checks if validation failed |
| `passes(): bool` | Checks if validation passed |
| `addRule(string $ruleName, callable $validator): void` | Adds custom validation rule |
| `getRule(string $ruleName): ?callable` | Gets a validation rule |
| `setErrorMessages(array $messages): void` | Sets custom error messages |

**Dependencies:** None (standalone utility)

### Administrative Services

#### AdminService
**Purpose:** Provides administrative functionality for user management and system monitoring.

| Method | Description |
|--------|-------------|
| `validateAdmin(ServerRequestInterface $request): ?array` | Validates admin token and returns admin data |
| `getAllUsers(int $page, int $adminId): array` | Gets all users with pagination |
| `updateUserRole(int $userId, string $role, int $adminId): bool` | Updates a user's role |
| `deleteUser(int $userId, int $adminId): ?array` | Soft-deletes a user |
| `getDashboardData(int $adminId): array` | Gets dashboard statistics |
| `createAdmin(array $data, int $adminId): ?array` | Creates a new admin user |

**Dependencies:** Admin model, AuditService, LoggerInterface, TokenService, ExceptionHandler

#### AuditService
**Purpose:** Provides audit logging functionality for security, compliance, and operational monitoring across the application.

| Method | Description |
|--------|-------------|
| `logEvent(string $eventType, string $message, array $context, ?int $userId, ?int $resourceId, string $category = 'system'): void` | Records an audit event with detailed context |
| `getLogs(array $filters): array` | Retrieves audit logs with comprehensive filtering and pagination |
| `getLogById(int $id): ?array` | Retrieves a specific audit log entry by ID |
| `exportLogs(array $filters): array` | Exports filtered logs to CSV format |
| `deleteLogs(array $filters, bool $forceBulkDelete = false): bool` | Deletes logs based on specified criteria |

**Dependencies:** AuditLog model, LoggerInterface, ExceptionHandler

## Service Interactions

Services interact with each other through their public interfaces:

1. **Auth Flow**:
   - Controllers  AuthService  TokenService  User model
   - TokenService   AuditService (logs authentication events)

2. **Document Flow**:
   - DocumentService  TemplateService  FileStorage  EncryptionService
   - DocumentService  AuditService (logs document operations)

3. **Payment Flow**:
   - PaymentService  PaymentProcessingService  Payment models
   - PaymentService  RefundService  TransactionService
   - All payment operations  AuditService/TransactionAuditService (logs events)

4. **Booking Flow**:
   - BookingService  PaymentService  NotificationService
   - BookingService  DocumentService (for contracts)
   - BookingService  AuditService (logs booking events)

5. **Admin Operations**:
   - AdminService  TokenService (for validation)
   - AdminService  AuditService (logs admin activities)
   - AdminService  UserService (for user management)

6. **Security Layers**:
   - Most services  EncryptionService (for sensitive data)
   - API endpoints  RateLimiter (for abuse prevention)
   - PaymentService  FraudDetectionService (for transaction validation)

7. **Cross-cutting Concerns**:
   - All services  LoggerInterface (for application logging)
   - All services  ExceptionHandler (for standardized exception handling)
   - Most services  Validator (for input validation)

This service architecture ensures separation of concerns while maintaining cohesion within service domains.
=== docs/backend/components/queues.md ===
# Queues

## Overview
The CarFuse queueing system provides persistent storage for operations that may fail and require retries. Each queue is implemented as a JSON file storage system that maintains state across application restarts. The system supports operation retries with configurable attempt limits and comprehensive logging.

## Queue Configuration

Each queue type has its own configuration:

- **NotificationQueue**: Uses a fixed retry limit (3 attempts)
- **DocumentQueue**: More configurable with:
  - Custom queue file location 
  - Configurable retry attempts
  - Default fallback values if configuration is missing

## Available Queues

### Notification Queue

**Purpose:** Manages outgoing notifications to users with guaranteed delivery through retry mechanisms.

**Message Structure:**
```php
[
    'user_id'  => int,    // Target user identifier
    'type'     => string, // Notification type
    'message'  => string, // Notification content
    'options'  => array,  // Additional parameters
    'attempts' => int     // Retry counter (managed internally)
]
```

**Producer Implementation:**
- Add notifications to queue using `push()` method
- Automatically initializes retry counter to 0

```php
$notificationQueue->push([
    'user_id' => 123,
    'type' => 'appointment_reminder',
    'message' => 'Your appointment is tomorrow',
    'options' => ['priority' => 'high']
]);
```

**Consumer Implementation:**
- Process queue with `process()` method
- Internally uses NotificationService to send notifications
- Removes successful messages from queue
- Increments attempt counter for failed messages

**Error Handling:**
- Failed notifications are retried up to 3 times
- Comprehensive logging of queue operations and failures
- Notifications exceeding retry limits are removed and logged as errors

### Document Queue

**Purpose:** Manages document storage operations with configurable retry capability for handling storage service outages.

**Message Structure:**
```php
[
    'destination_path' => string, // Storage location path
    'file_name'        => string, // Name of the file
    'content'          => mixed,  // Content to be stored
    'attempts'         => int     // Retry counter (managed internally)
]
```

**Producer Implementation:**
- Add documents to queue using `push()` method
- Automatically initializes retry counter to 0

```php
$documentQueue->push([
    'destination_path' => '/user/123/documents/',
    'file_name' => 'contract.pdf',
    'content' => $pdfContent
]);
```

**Consumer Implementation:**
- Process queue with `process()` method
- Uses FileStorage service to store documents
- Removes successful operations from queue
- Increments attempt counter for failed operations

**Error Handling:**
- Failed storage operations are retried based on configured max attempts
- Comprehensive logging of queue operations and failures
- Document operations exceeding retry limits are removed and logged as errors

## Integration with Other Components

```
          
   Services             Queues            Consumers    
  (Producers)                                          
                                                       
 User Service   Notification   Notification  
 Admin Panel            Queue              Service     
                                                       
 Upload Service   Document     File Storage  
 Import Module          Queue              Service     
          
```

### Integration Points

- **NotificationQueue**:
  - Integrates with `NotificationService` for sending notifications
  - Can be used by any component that needs to notify users
  - Provides asynchronous notification capabilities to synchronous operations

- **DocumentQueue**:
  - Integrates with `FileStorage` for storing documents
  - Used by file upload features and document generators
  - Handles temporary outages in storage services

## Processing Jobs

Queue processing should be triggered regularly through a scheduled task:

```php
// Example cron job or scheduled task
function processQueuedJobs() {
    $notificationQueue->process();
    $documentQueue->process();
}
```

Best practices:
- Process queues at regular intervals (e.g., every minute)
- Implement monitoring to detect growing queue sizes
- Handle processing exceptions to prevent job processor failures
=== docs/backend/components/controllers.md ===
# Controllers

## Overview
Controllers handle HTTP requests, process input data, interact with services, and return appropriate responses. They act as the bridge between the client-facing routes and the business logic contained within services.

## Controller Structure
All controllers in the CarFuse application extend a base `Controller` class that provides common functionality such as:

- Standardized JSON response formatting
- Error handling and exception management
- Basic input validation
- Logging capabilities

Controllers should follow these principles:
- Keep controllers thin - business logic belongs in services
- Use dependency injection for all service dependencies
- Log important events using the injected logger
- Handle exceptions properly using the ExceptionHandler
- Return consistent response formats

## Available Controllers

### AuthController
Handles user authentication including login, registration, token refresh, and password reset.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| POST | /auth/login | No | Authenticate a user and provide access tokens |
| POST | /auth/register | No | Register a new user account |
| POST | /auth/refresh | Refresh Token | Refresh an expired JWT token |
| POST | /auth/logout | Yes | Invalidate current user tokens |
| GET | /auth/user | Yes | Get authenticated user details |
| POST | /auth/password/reset-request | No | Request a password reset link |
| POST | /auth/password/reset | No | Reset password using token |

#### Login Endpoint
**Required Parameters:**
- `email` (string): User's email address
- `password` (string): User's password

**Response Format:**
```json
{
  "message": "Login successful",
  "user_id": 123,
  "name": "John Doe"
}
```

**Notes:**
- JWT and refresh tokens are sent as secure, HttpOnly cookies
- Implements rate limiting to prevent brute force attacks
- Logs login attempts for security monitoring

**Error Codes:**
- 400: Missing required fields
- 401: Invalid credentials
- 429: Too many login attempts

**Dependencies:**
- AuthService, TokenService, RateLimiter, LoggerInterface

### BookingController
Manages vehicle booking operations such as creating bookings, rescheduling, cancellation, and retrieval of booking information.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| GET | /bookings/{id} | Yes | View booking details |
| GET | /bookings | Yes | List user's bookings |
| POST | /bookings | Yes | Create a new booking |
| PUT | /bookings/{id}/reschedule | Yes | Reschedule a booking |
| POST | /bookings/{id}/cancel | Yes | Cancel a booking and process refund |
| GET | /bookings/{id}/logs | Yes | Get booking activity logs |
| GET | /bookings/list | Yes | Get bookings in HTML format for HTMX |

#### Create Booking Endpoint
**Required Parameters:**
- `vehicle_id` (integer): ID of the vehicle to book
- `pickup_date` (string, date format): Date and time of pickup
- `dropoff_date` (string, date format): Date and time of dropoff
- `pickup_location` (string): Location for pickup
- `dropoff_location` (string): Location for dropoff
- `payment_method_id` (integer): ID of the payment method to use

**Response Format:**
```json
{
  "status": "success",
  "message": "Booking created successfully",
  "data": {
    "booking_id": 456
  }
}
```

**Error Codes:**
- 400: Validation error or business rule violation
- 401: Unauthorized access
- 500: Server error

**Notes:**
- Creates audit log entries for booking creation
- Sends notification after successful booking
- Validates available vehicle inventory

**Dependencies:**
- BookingService, PaymentService, Validator, AuditService, NotificationService, ResponseFactoryInterface

### PaymentController
Handles payment processing, refunds, and retrieval of transaction history.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| POST | /payments/process | Yes | Process a payment |
| POST | /payments/refund | Yes (Admin) | Process a refund |
| GET | /payments/user | Yes | Get user's transaction history |
| GET | /payments/{id} | Yes | Get payment details |
| POST | /payments/methods | Yes | Add a payment method |
| GET | /payments/methods | Yes | Get user's payment methods |
| DELETE | /payments/methods/{id} | Yes | Delete a payment method |
| POST | /payments/gateway | Yes | Process payment via gateway |
| POST | /payments/gateway/{gateway}/callback | No | Handle gateway callback |
| GET | /payments/history | Yes | Get payment history (HTMX) |
| GET | /payments/methods/details/{id} | Yes | Get payment method details (HTMX) |
| GET | /payments/details/{id} | Yes | Get payment details (HTMX) |
| GET | /payments/invoice/{id} | Yes | Download payment invoice |

#### Process Payment Endpoint
**Required Parameters:**
- `booking_id` (integer): ID of the booking
- `amount` (numeric): Payment amount
- `payment_method_id` (integer): ID of the payment method
- `currency` (string, optional): 3-letter currency code (default: system default)

**Response Format:**
```json
{
  "status": "success",
  "message": "Payment processed",
  "data": {
    "payment": {
      "id": 789,
      "amount": 199.99,
      "status": "completed",
      "created_at": "2023-05-01T14:30:00Z"
    }
  }
}
```

**Error Codes:**
- 400: Validation error
- 401: Unauthorized access
- 500: Payment processing failed

**Notes:**
- Sends payment confirmation notification
- Records transaction in system
- Validates payment method ownership

**Dependencies:**
- PaymentService, Validator, NotificationService, ExceptionHandler

### UserController
Manages user profiles, account settings, and user-specific operations.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| POST | /users/register | No | Register a new user |
| GET | /users/profile | Yes | Get user profile |
| PUT | /users/profile | Yes | Update user profile |
| POST | /users/password/reset-request | No | Request password reset |
| POST | /users/password/reset | No | Reset password with token |
| GET | /users/dashboard | Yes | Get user dashboard data |
| GET | /users/profile/page | Yes | Show profile page (HTML) |
| POST | /users/profile/update | Yes | Handle profile update |
| POST | /users/password/change | Yes | Change user password |

#### Update User Profile Endpoint
**Required Parameters:**
- `name` (string, optional): User's name
- `bio` (string, optional): User biography
- `location` (string, optional): User location
- `avatar_url` (string, optional): URL to user avatar

**Response Format:**
```json
{
  "status": "success",
  "message": "Profile updated successfully",
  "data": {
    "id": 123,
    "name": "John Doe",
    "email": "john@example.com",
    "bio": "Software developer",
    "location": "New York",
    "avatar_url": "/uploads/avatars/user_123.jpg"
  }
}
```

**Error Codes:**
- 400: Validation error
- 401: User not authenticated
- 500: Failed to update profile

**Notes:**
- Supports file upload for profile picture
- Creates audit log of profile changes
- Validates input data

**Dependencies:**
- User model, Validator, TokenService, AuditService, AuthService, ExceptionHandler

### DocumentController
Handles document generation, management, and template processing for contracts, invoices, and terms & conditions.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| POST | /documents/templates | Yes (Admin) | Upload document template |
| POST | /documents/contracts/{bookingId}/{userId} | Yes | Generate contract for booking |
| POST | /documents/terms | Yes (Admin) | Upload terms & conditions |
| POST | /documents/invoices/{bookingId} | Yes | Generate invoice for booking |
| DELETE | /documents/{id} | Yes (Admin) | Delete a document |
| GET | /documents/templates | Yes (Admin) | Get all templates |
| GET | /documents/templates/{id} | Yes (Admin) | Get specific template |

#### Generate Contract Endpoint
**Required Parameters:**
- `bookingId` (integer): ID of the booking
- `userId` (integer): ID of the user

**Response Format:**
```json
{
  "status": "success",
  "message": "Contract generated successfully",
  "contract_path": "/documents/contracts/booking_456_user_123.pdf"
}
```

**Error Codes:**
- 400: Invalid booking or user ID
- 401: Unauthorized access
- 500: Failed to generate contract

**Notes:**
- Securely generates contract using booking and user data
- Validates user has access to requested booking
- Stores contract in secure location

**Dependencies:**
- DocumentService, Validator, AuditService, ExceptionHandler

### SignatureController
Manages electronic signatures for documents including uploading, verifying, and retrieving signatures.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| POST | /signatures/upload | Yes | Upload a signature |
| POST | /signatures/verify | Yes | Verify a signature against document hash |
| GET | /signatures/user/{userId} | Yes | Retrieve a user's signature |

#### Upload Signature Endpoint
**Required Parameters:**
- `user_id` (integer): ID of the user
- `file` (file): Signature image file (PNG, JPG, JPEG, max 2MB)

**Response Format:**
```json
{
  "status": "success", 
  "message": "Signature uploaded successfully", 
  "data": "/uploads/signatures/user_123_timestamp.png"
}
```

**Error Codes:**
- 400: Invalid file format or size
- 401: Unauthorized access
- 500: Upload failed

**Notes:**
- Validates file type and size
- Logs upload in audit trail
- Secure file storage with user-specific naming

**Dependencies:**
- SignatureService, AuditService, TokenService, ExceptionHandler

### NotificationController
Handles user notification management including sending, reading, and deleting notifications.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| GET | /notifications | Yes | View user notifications |
| GET | /notifications/user | Yes | Get user notifications via API |
| GET | /notifications/unread | Yes | Fetch unread notifications |
| POST | /notifications/mark-read | Yes | Mark notification as read |
| POST | /notifications/delete | Yes | Delete a notification |
| POST | /notifications/send | Yes | Send a notification |

#### Send Notification Endpoint
**Required Parameters:**
- `user_id` (integer): ID of the recipient user
- `type` (string): Notification type (email, sms, webhook, push)
- `message` (string): Notification message content
- `options` (array, optional): Additional configuration options

**Response Format:**
```json
{
  "status": "success",
  "message": "Notification sent successfully",
  "data": {
    "notification": {
      "id": 456,
      "user_id": 123,
      "type": "email",
      "message": "Your booking has been confirmed",
      "read": false,
      "created_at": "2023-05-01T12:30:00Z"
    }
  }
}
```

**Error Codes:**
- 400: Validation failed
- 401: Unauthorized access
- 500: Failed to send notification

**Notes:**
- Supports multiple notification channels
- Creates audit log of notification sending
- Validates recipient access permissions

**Dependencies:**
- NotificationService, TokenService, AuditService, ExceptionHandler

### ReportController
Manages report generation and viewing for both users and administrators.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| GET | /reports | Yes (Admin) | Admin report dashboard |
| POST | /reports/generate | Yes (Admin) | Generate admin report |
| GET | /reports/user | Yes | User report dashboard |
| POST | /reports/user/generate | Yes | Generate user report |

#### Generate Report Endpoint
**Required Parameters:**
- `date_range` (object): Report date range with `start` and `end` dates
- `format` (string): Output format (pdf, csv, excel)
- `report_type` (string): Type of report to generate
- `filters` (array, optional): Custom report filters

**Response Format:**
File download with appropriate headers

**Error Codes:**
- 400: Missing required parameters
- 401: Unauthorized access
- 500: Report generation failed

**Notes:**
- Logs report generation in audit trail
- Supports multiple export formats
- Includes comprehensive filtering options

**Dependencies:**
- ReportService, NotificationService, AuditService, ExceptionHandler

### DashboardController
Handles dashboard data and components for the user interface.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| GET | /dashboard | Yes | User dashboard view |
| GET | /dashboard/statistics | Yes | Get user statistics (HTMX) |
| GET | /dashboard/bookings | Yes | Get user bookings (HTMX) |
| GET | /dashboard/profile | Yes | Get user profile (HTMX) |
| GET | /dashboard/notifications | Yes | Get user notifications (HTMX) |

#### User Dashboard Statistics Endpoint
**Required Parameters:**
- None (Uses session for authentication)

**Response Format:**
HTML component for HTMX integration showing:
- Total bookings count
- Completed bookings count
- Total payments amount

**Error Codes:**
- HTML error message on failure

**Notes:**
- Uses HTMX partial rendering
- Implements caching for performance
- Creates audit log of dashboard access

**Dependencies:**
- BookingService, MetricsService, NotificationService, UserService, AuditService, ExceptionHandler

### AdminController
Manages admin operations for user management and system oversight.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| GET | /admin/users | Yes (Admin) | Get all users |
| GET | /admin/users/{id} | Yes (Admin) | Get user by ID |
| POST | /admin/users | Yes (Admin) | Create a new user |
| PUT | /admin/users/{id} | Yes (Admin) | Update user details |
| POST | /admin/users/{id}/status | Yes (Admin) | Toggle user active status |
| POST | /admin/users/{id}/role | Yes (Admin) | Update user role |
| DELETE | /admin/users/{id} | Yes (Admin) | Delete a user |
| GET | /admin/dashboard/data | Yes (Admin) | Get admin dashboard data |
| POST | /admin/users/admin | Yes (Admin) | Create a new admin user |
| GET | /admin/users/page | Yes (Admin) | Users management page (HTML) |

#### Get All Users Endpoint
**Required Parameters:**
- `page` (integer, optional): Pagination page number (default: 1)
- `per_page` (integer, optional): Items per page (default: 10)
- `role` (string, optional): Filter by user role
- `status` (string, optional): Filter by user status
- `search` (string, optional): Search term for filtering

**Response Format:**
```json
{
  "status": "success",
  "message": "User list retrieved successfully",
  "data": [
    {
      "id": 123,
      "name": "John Doe",
      "email": "john@example.com",
      "role": "user",
      "active": true,
      "created_at": "2023-04-01T10:20:30Z"
    }
  ],
  "meta": {
    "current_page": 1,
    "total_pages": 5,
    "total": 45,
    "per_page": 10
  }
}
```

**Error Codes:**
- 401: Unauthorized or insufficient permissions
- 500: Failed to retrieve users

**Notes:**
- Supports HTMX partial rendering for UI
- Implements pagination headers
- Provides search and filtering capabilities

**Dependencies:**
- AdminService, ResponseFactoryInterface, ExceptionHandler

### AdminDashboardController
Provides data visualization and statistics for the administrative dashboard.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| GET | /admin/dashboard | Yes (Admin) | Admin dashboard main view |
| GET | /admin/dashboard/data | Yes (Admin) | Get admin dashboard statistics via API |

#### Dashboard Data Endpoint
**Required Parameters:**
- None (Uses session for authentication)

**Response Format:**
```json
{
  "status": "success",
  "message": "Dashboard data fetched",
  "data": {
    "metrics": {
      "total_users": 250,
      "active_users": 185,
      "total_bookings": 450,
      "completed_bookings": 375,
      "canceled_bookings": 25,
      "total_revenue": 12500.75,
      "total_refunds": 450.50,
      "net_revenue": 12050.25
    },
    "recent_bookings": [
      {
        "id": 1001,
        "user_id": 123,
        "vehicle_id": 45,
        "status": "completed",
        "amount": 249.99,
        "created_at": "2023-05-15T14:30:22Z"
      }
    ]
  }
}
```

**Error Codes:**
- 401: Unauthorized access
- 500: Failed to retrieve dashboard data

**Notes:**
- Uses caching for performance optimization
- Creates audit logs for dashboard access
- Provides real-time business metrics

**Dependencies:**
- User/Booking/Payment models, Cache, AuditService, ExceptionHandler

### AdminSettingsController
Manages system configuration and settings for the administrative panel.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| GET | /admin/settings | Yes (Admin) | Show settings page |
| GET | /admin/settings/all | Yes (Admin) | Retrieve all system settings |
| POST | /admin/settings | Yes (Admin) | Save all settings at once |
| POST | /admin/settings/{tab} | Yes (Admin) | Save tab-specific settings |
| POST | /admin/settings/email/test | Yes (Admin) | Test email connection |

#### Save All Settings Endpoint
**Required Parameters:**
- Configuration settings as JSON object

**Response Format:**
```json
{
  "status": "success",
  "message": "Settings saved successfully"
}
```

**Error Codes:**
- 400: Invalid settings data format
- 401: Unauthorized access
- 500: Failed to save settings

**Notes:**
- Creates audit log of settings changes
- Validates settings before saving
- Supports modular settings by tab

**Dependencies:**
- SettingsService, AuditService, ExceptionHandler

### ApiController
Base controller for API operations providing standardized response formats and error handling.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| N/A | N/A | N/A | Base controller - not directly routable |

**Notes:**
- Provides standardized success/error response formats
- Implements common exception handling
- Manages audit logging for API operations

**Dependencies:**
- AuditService, ExceptionHandler

### AuditController
Manages system audit log viewing and retrieval for security and compliance purposes.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| GET | /admin/audit | Yes (Admin) | View audit logs dashboard |
| POST | /admin/audit/logs | Yes (Admin) | Fetch filtered audit logs |
| GET | /admin/audit/logs/{id} | Yes (Admin) | Get detailed log entry |
| POST | /admin/audit/export | Yes (Admin) | Export audit logs |

#### Fetch Logs Endpoint
**Required Parameters:**
- `category` (string, optional): Filter by log category
- `action` (string, optional): Filter by action type
- `user_id` (integer, optional): Filter by user ID
- `booking_id` (integer, optional): Filter by booking ID
- `start_date` (string, optional): Start date for date range filter
- `end_date` (string, optional): End date for date range filter
- `page` (integer, optional): Page number for pagination
- `per_page` (integer, optional): Items per page
- `log_level` (string, optional): Filter by log level

**Response Format:**
```json
{
  "status": "success",
  "data": {
    "logs": [
      {
        "id": 12345,
        "event_type": "booking_created",
        "message": "User created a new booking",
        "context": {"booking_id": 789, "amount": 149.99},
        "user_id": 123,
        "resource_id": 789,
        "category": "booking",
        "created_at": "2023-05-15T10:30:45Z",
        "ip_address": "192.168.1.1"
      }
    ],
    "pagination": {
      "current_page": 1,
      "total_pages": 10,
      "total_items": 250,
      "per_page": 25
    }
  }
}
```

**Error Codes:**
- 403: Admin access required
- 500: Failed to retrieve logs

**Notes:**
- Comprehensive filtering options
- Access control based on admin role
- Efficient query optimization

**Dependencies:**
- AuditService, ExceptionHandler

### BaseController
Abstract base controller providing common functionality for HTMX-specific controllers.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| N/A | N/A | N/A | Abstract base class - not directly routable |

**Notes:**
- Handles HTMX-specific response headers
- Provides methods for toast notifications
- Manages view rendering and redirects
- Abstracts request handling

**Dependencies:**
- LoggerInterface, ExceptionHandler

### Controller
Base controller providing core functionality for all controllers in the system.

| Method | Path | Auth Required | Purpose |
|--------|------|--------------|---------|
| N/A | N/A | N/A | Base class - not directly routable |

**Notes:**
- Standardized JSON response generation
- Common error response handling
- Exception management
- Input validation helpers

**Dependencies:**
- LoggerInterface, ExceptionHandler

## Best Practices
1. **Thin Controllers**: Keep controllers focused on handling HTTP requests and delegating business logic to services.

2. **Consistent Response Format**: Always return consistent JSON response structures using helper methods.

3. **Proper Error Handling**: Use ExceptionHandler to handle exceptions and return appropriate HTTP status codes.

4. **Audit Logging**: Log important user actions using AuditService for security and compliance.

5. **Input Validation**: Always validate input data using the Validator service before processing.

6. **Authentication & Authorization**: Always check for proper authentication and authorization before processing requests.

7. **Service Dependency Injection**: Inject all required services via constructor to ensure testability.

8. **Appropriate HTTP Methods**: Use the correct HTTP methods (GET, POST, PUT, DELETE) for each endpoint.
=== docs/backend/components/middleware.md ===
# Middleware

## Overview
Middleware components in Carfuse handle cross-cutting concerns like authentication, session management, and CSRF protection. They process requests before they reach route handlers and can modify both requests and responses.

## Middleware Components

### SessionMiddleware

- **Purpose**: Manages session initialization, security, and persistence. Configures secure session parameters and adds session data to request attributes.
- **Execution Priority**: Should be executed very early in the middleware stack (typically first or second) as other middleware components depend on session data.
- **Configuration Options**:
  - `name`: Session name (default: 'carfuse_session')
  - `lifetime`: Session lifetime in seconds (default: 7200 - 2 hours)
  - `path`: Cookie path (default: '/')
  - `domain`: Cookie domain (default: '')
  - `secure`: Cookie secure flag (default: true)
  - `httponly`: Cookie httpOnly flag (default: true)
  - `samesite`: Cookie SameSite policy (default: 'Lax')
  - `regenerate_interval`: Session regeneration interval (default: 1800 - 30 minutes)
- **Interactions**:
  - Provides session data for UserDataMiddleware
  - Provides CSRF token storage for CsrfMiddleware
  - Exposes helper methods `getSession()` and `setSession()` for other components

### AuthMiddleware

- **Purpose**: Authenticates users via JWT tokens from either Authorization headers or cookies. Fetches and attaches user data to request.
- **Execution Priority**: After SessionMiddleware but before protected route handlers.
- **Configuration Options**:
  - `required`: Boolean flag to specify if authentication is mandatory (returns 401 if true and auth fails)
- **Interactions**:
  - Works with TokenService to verify JWT tokens
  - Accesses database to fetch user data
  - Attaches user data to request for RequireAuthMiddleware

### UserDataMiddleware

- **Purpose**: Loads user data from session into request attributes. Ensures consistent user data access pattern.
- **Execution Priority**: After SessionMiddleware but before route handlers that need user data.
- **Configuration Options**:
  - `required`: Boolean flag indicating if user data is required (returns 401 if missing when true)
- **Interactions**:
  - Uses session data stored by SessionMiddleware
  - Provides helper methods `setUserData()` and `clearUserData()`
  - Works alongside AuthMiddleware as an alternative authentication method

### TokenValidationMiddleware

- **Purpose**: Validates authentication tokens for API requests, offering a stateless authentication option.
- **Execution Priority**: Early in API route middleware stack.
- **Configuration Options**: No specific configuration parameters.
- **Interactions**:
  - Works with TokenService for token validation
  - Works with AuthService for authentication logic
  - Returns 401 if token validation fails

### RequireAuthMiddleware

- **Purpose**: Ensures a user is authenticated before allowing access to protected routes.
- **Execution Priority**: After authentication middleware (AuthMiddleware or TokenValidationMiddleware).
- **Configuration Options**: No specific configuration parameters.
- **Interactions**:
  - Depends on user attribute being set by auth middleware
  - Returns 401 if user attribute is not present

### CsrfMiddleware

- **Purpose**: Prevents CSRF attacks by generating and validating tokens for state-changing operations.
- **Execution Priority**: After SessionMiddleware but before form-handling route handlers.
- **Configuration Options**:
  - `excludedPaths`: Array of path prefixes to exclude from CSRF validation
- **Interactions**:
  - Uses session from SessionMiddleware to store tokens
  - Provides special handling for HTMX requests

### EncryptionMiddleware

- **Purpose**: Encrypts sensitive data in requests and responses for endpoints handling confidential information.
- **Execution Priority**: Typically after parsing middleware but before business logic.
- **Configuration Options**:
  - Uses configuration files (`sensitive_fields.json`, `sensitive_endpoints.json`) to determine what to encrypt
- **Interactions**:
  - Works with EncryptionService to perform encryption/decryption
  - Can be selectively applied to specific routes

### HtmxMiddleware

- **Purpose**: Handles HTMX-specific request processing and response formatting for enhanced frontend interactions.
- **Execution Priority**: After core middleware but before route handlers.
- **Configuration Options**: No specific configuration parameters.
- **Interactions**:
  - Adds HTMX-specific attributes to request
  - Sets appropriate headers for HTMX responses
  - May interact with session for CSRF tokens

## Implementation and Usage

### Middleware Registration

Middleware can be registered globally or per-route:

```php
// Global middleware (applied to all routes)
$app->add(new SessionMiddleware($logger, $config));

// Route-specific middleware
$app->get('/protected', function ($request, $response) {
    // Handler code
})->add(new RequireAuthMiddleware($logger));

// Group middleware
$app->group('/admin', function (RouteCollectorProxy $group) {
    // Admin routes
})->add(new RequireAuthMiddleware($logger));
```

### Recommended Middleware Order

For most applications, the following order is recommended:

1. ErrorMiddleware (built-in Slim)
2. SessionMiddleware
3. CsrfMiddleware
4. AuthMiddleware / TokenValidationMiddleware
5. UserDataMiddleware
6. RequireAuthMiddleware (on protected routes)
7. HtmxMiddleware
8. EncryptionMiddleware (on sensitive endpoints)

### Helper Methods

Some middleware expose static helper methods that can be used in route handlers:

```php
// Managing session
$session = SessionMiddleware::getSession($request);
$request = SessionMiddleware::setSession($request, $updatedSession);

// Managing user data
$request = UserDataMiddleware::setUserData($request, $userData);
$request = UserDataMiddleware::clearUserData($request);
=== docs/backend/components/exceptions.md ===
# Exceptions

## Overview
The CarFuse exception system provides standardized error handling across the application. Custom exception types ensure consistency in error reporting, logging, and API responses. Each exception type can include contextual data to aid in troubleshooting while maintaining clean separation between business logic and error handling.

## Custom Exception Types

### PaymentException
A specialized exception for handling payment-related errors. Includes detailed context data and standardized error codes.

```php
// Example of throwing a payment validation exception
throw new PaymentException(
    "Invalid credit card number", 
    PaymentException::PAYMENT_VALIDATION_ERROR,
    ['cardNumber' => $maskedCardNumber]
);
```

**Error Code Constants:**
| Constant | Code | Purpose |
|----------|------|---------|
| PAYMENT_VALIDATION_ERROR | 100 | Input validation failures (invalid card, expired dates) |
| PAYMENT_PROCESSING_ERROR | 200 | Errors during payment processing |
| PAYMENT_GATEWAY_ERROR | 300 | External payment gateway communication issues |
| REFUND_ERROR | 400 | Problems during refund operations |
| FRAUD_DETECTION_ERROR | 500 | Potential fraudulent activity detected |
| DATA_ERROR | 600 | Payment data inconsistencies |

### Other Common Exception Types

| Exception Class | Purpose | When to Use |
|-----------------|---------|-------------|
| ValidationException | Data validation errors | When user input fails validation rules |
| AuthorizationException | Permission errors | When a user lacks required permissions |
| NotFoundException | Resource not found | When requested data doesn't exist |
| ServiceException | External service errors | When integrated services fail |
| DatabaseException | Database operation errors | When database operations fail |

## Exception Handling Patterns

### Try/Catch Blocks
Use try/catch blocks to handle exceptions at the appropriate level:

```php
try {
    // Payment processing code
    $paymentProcessor->processPayment($paymentData);
} catch (PaymentException $e) {
    // Handle payment-specific exceptions
    $logger->error('Payment failed', [
        'message' => $e->getMessage(),
        'code' => $e->getCode(),
        'context' => $e->getContext() // Using the custom context method
    ]);
    
    // Take recovery action or re-throw
} catch (\Exception $e) {
    // Handle other exceptions
    $logger->error('Unexpected error', [
        'message' => $e->getMessage(),
        'code' => $e->getCode()
    ]);
}
```

### Exception Middleware
In web applications, use middleware to catch unhandled exceptions and convert them to appropriate responses:

```php
// Example exception middleware pseudocode
public function handle($request, $next)
{
    try {
        return $next($request);
    } catch (ValidationException $e) {
        return response()->json(['errors' => $e->getErrors()], 422);
    } catch (PaymentException $e) {
        if ($e->getCode() == PaymentException::PAYMENT_VALIDATION_ERROR) {
            return response()->json(['error' => $e->getMessage()], 400);
        }
        return response()->json(['error' => 'Payment processing error'], 500);
    } catch (\Exception $e) {
        // Log and return generic error
        return response()->json(['error' => 'An unexpected error occurred'], 500);
    }
}
```

## Mapping Exceptions to API Responses

The following table shows how exception types should map to HTTP status codes:

| Exception Type | HTTP Status | Response Format |
|----------------|-------------|-----------------|
| ValidationException | 422 | `{"errors": {"field": ["error messages"]}}` |
| AuthorizationException | 403 | `{"error": "Permission denied message"}` |
| NotFoundException | 404 | `{"error": "Resource not found message"}` |
| PaymentException (validation) | 400 | `{"error": "Payment validation message"}` |
| PaymentException (processing/gateway) | 502 | `{"error": "Payment processing error"}` |
| PaymentException (fraud) | 400 | `{"error": "Payment declined message"}` |
| Unhandled exceptions | 500 | `{"error": "Internal server error"}` |

## Best Practices

### Throwing Exceptions

1. **Use specific exception types** that match the error domain
   ```php
   // Good
   throw new PaymentException("Card declined", PaymentException::PAYMENT_GATEWAY_ERROR);
   
   // Avoid
   throw new \Exception("Card declined");
   ```

2. **Include contextual information** that aids troubleshooting
   ```php
   throw new PaymentException(
       "Payment declined", 
       PaymentException::PAYMENT_GATEWAY_ERROR,
       [
           'transactionId' => $transaction->id,
           'gateway' => $gateway->name,
           'response' => $gatewayResponse
       ]
   );
   ```

3. **Use consistent error codes** defined as constants

4. **Write clear error messages** that describe the problem
   ```php
   // Good
   throw new ValidationException("Card expiration date must be in the future");
   
   // Avoid
   throw new ValidationException("Invalid input");
   ```

### Catching Exceptions

1. **Catch exceptions at the appropriate level** - don't catch too early or too late
   
2. **Catch specific exceptions before general ones**
   ```php
   try {
       // Code that might throw exceptions
   } catch (PaymentException $e) {
       // Handle payment exceptions specifically
   } catch (ValidationException $e) {
       // Handle validation exceptions
   } catch (\Exception $e) {
       // Handle other exceptions
   }
   ```

3. **Log exceptions with context** to aid troubleshooting
   ```php
   try {
       // Code that might throw exceptions
   } catch (PaymentException $e) {
       $logger->error('Payment processing failed', [
           'message' => $e->getMessage(),
           'code' => $e->getCode(),
           'context' => $e->getContext(),
           // Don't include sensitive data like full card numbers
       ]);
   }
   ```

4. **Don't catch exceptions you can't handle** - let them bubble up
   
5. **Avoid empty catch blocks** that silently swallow errors

6. **Re-throw with context** when appropriate
   ```php
   try {
       $gateway->processPayment($payment);
   } catch (\Exception $e) {
       throw new PaymentException(
           "Payment gateway error", 
           PaymentException::PAYMENT_GATEWAY_ERROR,
           ['originalError' => $e->getMessage()],
           $e  // Pass original exception as previous
       );
   }
   ```
=== docs/backend/development/testing.md ===
# Testing

## Overview
Overview of testing strategy.

## Unit Testing
Guidelines for unit testing.

## Integration Testing
Guidelines for integration testing.

## API Testing
Guidelines for API testing.

## Test Coverage
Requirements for test coverage.
=== docs/backend/development/setup.md ===
# Development Setup

## Prerequisites
Required software and tools.

## Installation
Step-by-step installation guide.

## Configuration
Configuration options and environment variables.

## Running the Application
How to run the application for development.
=== docs/backend/development/debugging.md ===
# Debugging

## Tools
Tools for debugging the application.

## Common Issues
Common issues and their solutions.

## Logging
How to use logging for debugging.

## Performance Profiling
How to profile application performance.
=== docs/backend/development/conventions.md ===
# Development Conventions

## Coding Standards

### General Guidelines
- Follow the principle of Clean Code - readable, maintainable, and testable
- Use consistent indentation (2 spaces)
- Keep functions small and focused on a single responsibility
- Limit line length to 100 characters
- Use meaningful variable and function names

### Language-Specific Standards

| Language | Style Guide | Linter | Formatter |
|----------|-------------|--------|-----------|
| JavaScript/TypeScript | [Airbnb Style Guide](https://github.com/airbnb/javascript) | ESLint | Prettier |
| Python | [PEP 8](https://www.python.org/dev/peps/pep-0008/) | Pylint | Black |
| SQL | [SQL Style Guide](https://www.sqlstyle.guide/) | SQLFluff | - |

### Security Considerations
- Never store sensitive information in code
- Validate all input data
- Follow the principle of least privilege
- Use prepared statements for database queries

## Naming Conventions
- **Files**: lowercase with hyphens (kebab-case) for separation
- **Variables**: camelCase for JavaScript/TypeScript, snake_case for Python
- **Classes**: PascalCase
- **Constants**: UPPER_SNAKE_CASE
- **Database**: snake_case for table and column names
- **API Routes**: lowercase with hyphens (kebab-case)

## Documentation

### Documentation Standards
Documentation should be clear, concise, and focused on helping the reader understand the system quickly.

#### Code Documentation
- Document all public APIs, classes, and methods
- Include type information and expected parameters/return values
- Document exceptions that might be thrown
- Add examples for complex operations

#### Technical Documentation

| Document Type | Format | Location | Purpose |
|---------------|--------|----------|---------|
| API Reference | Markdown/OpenAPI | `/docs/backend/api/` | Endpoint details |
| Architecture | Markdown/Diagrams | `/docs/backend/architecture/` | System design |
| Setup Guide | Markdown | `/docs/backend/development/setup.md` | Environment setup |
| How-to Guides | Markdown | `/docs/backend/guides/` | Task-specific instructions |

#### Documentation Maintenance
- Update documentation when corresponding code changes
- Review documentation for accuracy quarterly
- Use relative links between documents (`[Link text](../relative/path.md)`)
- Add "Since version X.Y.Z" tags for features added after initial release
- Include a "Last updated" date in each document

#### Markdown Formatting Guidelines
- Use ATX headings (`#` style)
- Tables for structured data
- Code blocks with language specification
- Bulleted lists for unordered items
- Numbered lists for sequential instructions

## Version Control
- Use feature branches for development
- Branch names should follow the pattern: `type/description` (e.g., `feature/user-authentication`)
- Commit messages should follow [Conventional Commits](https://www.conventionalcommits.org/) specification
- Squash commits before merging to main branch
- Delete branches after merging

## Error Handling Standards

### Error Categories

| Category | HTTP Code Range | Description |
|----------|----------------|-------------|
| Validation Errors | 400 | Invalid input data |
| Authentication Errors | 401, 403 | Access/permission issues |
| Resource Errors | 404 | Resource not found |
| Conflict Errors | 409 | Resource state conflicts |
| Server Errors | 500 | Internal errors |

### Error Response Format

All error responses should follow this JSON format:

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "Human readable message",
    "details": {} // Optional additional context
  }
}
```

### Error Handling Guidelines
- Be specific but don't expose system details
- Log errors with appropriate severity
- Don't swallow exceptions without handling
- Centralize error handling when possible
- Include correlation IDs for tracking issues across services

### Security Considerations
- Never expose stack traces to clients
- Sanitize error messages to prevent information leakage
- Use generic error messages for sensitive operations
- Log detailed error information server-side only

## Logging Standards

### Log Levels

| Level | Description | Example Use Case |
|-------|-------------|-----------------|
| ERROR | Critical failures | Database connection failures |
| WARN | Unexpected but recoverable | Retry attempts |
| INFO | Normal but significant | System startup, user actions |
| DEBUG | Detailed troubleshooting | Function entry/exit points |
| TRACE | Very detailed diagnostics | Request/response bodies |

### Log Format
All log entries should include:
- Timestamp (ISO 8601 format)
- Log level
- Service name
- Correlation ID
- Message context
- Message content

### Logging Guidelines
- Don't log sensitive information (PII, credentials, tokens)
- Use structured logging (JSON format)
- Include correlation IDs for request tracing
- Log at appropriate levels
- Enable DEBUG/TRACE only in non-production environments

### Security Considerations
- Implement log rotation and retention policies
- Secure log storage and transmission
- Implement access controls for log data
- Have a log review process for security events

_Since: v1.0.0_
_Last updated: Current date_
=== docs/backend/system_architecture_overview.md ===
# System Architecture Overview

This document provides a comprehensive overview of how CarFuse's core architectural components interact, focusing on the request routing system, dependency injection container, and logging infrastructure.

## Core Components

### 1. FastRoute Router (routes.php)
The routing system uses [FastRoute](https://github.com/nikic/FastRoute) to map HTTP requests to the appropriate controller actions.

### 2. Dependency Injection Container
The DI container is initialized and configured across several files:
- **bootstrap.php**: Application initialization and core service setup
- **dependencies.php**: Registration of helpers and middleware components
- **svc_dep.php**: Service class registration and configuration
- **ctrl_dep.php**: Controller registration with required dependencies

### 3. Logger System (logger.php)
A centralized logging system using Monolog that provides category-specific loggers for different parts of the application.

## Request Flow Diagram

```
            
 HTTP               index.php          bootstrap.php       
 Request      Entry Point  Load Config & Init  
             Core Services       
                                          
                                                     
                                                     
            
 HTTP               Controller         FastRoute (routes.php)
 Response     Action       Determine Handler   
            
                                                   
                                                   
                                                   
         
 Middleware       Services            DI Container        
 Processing       Business Logic Resolve Dependencies
         
                                                  
                                                  
                                                  
         
 Logger           Models              dependencies.php    
 (logger.php) Data Access    svc_dep.php        
          ctrl_dep.php       
                                          
```

## Initialization Sequence

1. **Application Bootstrap**:
   - `bootstrap.php` is loaded first
   - Environment variables are configured
   - Configuration files are loaded
   - Logger system is initialized from `logger.php`
   - Core services are set up in correct dependency order
   - Database connections are verified

2. **DI Container Configuration**:
   - `dependencies.php` registers helpers, middleware components
   - `svc_dep.php` registers service classes with their dependencies
   - `ctrl_dep.php` registers controllers with their service dependencies
   - Required dependencies are validated

3. **Request Routing**:
   - FastRoute processes the incoming URL path
   - The router (configured in `routes.php`) determines which controller and method should handle it
   - The DI container resolves the controller and all its dependencies

## Component Interactions

### Router and DI Container Interaction

The router (`routes.php`) uses the DI container to resolve controller instances:

```php
return simpleDispatcher(function (RouteCollector $router) use ($container) {
    // Get controller instances from the container
    $authController = $container->get(AuthController::class);
    $userController = $container->get(UserController::class);
    
    // Define routes with resolved controllers
    $router->addRoute(['POST'], '/api/auth/login', [$authController, 'login']);
    $router->addRoute(['GET'], '/api/users/profile', [$userController, 'getUserProfile']);
    // ...
});
```

When a route is matched, the pre-resolved controller instance (with all its dependencies injected) handles the request.

### DI Container and Logger Integration

The logger system is integrated with the DI container in `dependencies.php`:

```php
// Register loggers in the container
$container->set(LoggerInterface::class, function() use ($logger) {
    return $logger;
});

// Register category-specific loggers
foreach ($loggers as $category => $categoryLogger) {
    $container->set("logger.{$category}", function() use ($categoryLogger) {
        return $categoryLogger;
    });
}
```

This makes loggers available as dependencies for any service or controller:

```php
$container->set(UserController::class, function($c) use ($logger, $loggers) {
    return new UserController(
        $loggers['user'] ?? $loggers['api'] ?? $logger,
        // other dependencies...
    );
});
```

### Service Dependency Resolution

The DI container resolves nested dependencies automatically. For example, when a controller requires multiple services:

```php
$container->set(BookingController::class, function($c) {
    return new BookingController(
        $c->get('logger.booking'),
        $c->get(BookingService::class),    // BookingService and its dependencies are resolved
        $c->get(PaymentService::class),    // PaymentService and its dependencies are resolved
        $c->get(Validator::class),
        $c->get(AuditService::class),
        // other dependencies...
    );
});
```

## Logger System Details

The logging system (`logger.php`) provides specialized loggers for different application areas:

1. **Initialization**:
   ```php
   $logDir = __DIR__ . '/logs';
   $formatter = new LineFormatter($output, $dateFormat, true, true);
   ```

2. **Category-Specific Loggers**:
   ```php
   $logCategories = ['application', 'auth', 'user', 'db', 'api', /* ... */];
   
   foreach ($logCategories as $category) {
       $logFile = "{$logDir}/{$category}.log";
       $loggers[$category] = createLogger($category, $logFile);
   }
   ```

3. **Global Access**:
   ```php
   $GLOBALS['logger'] = $logger;
   $GLOBALS['loggers'] = $loggers;
   ```

Each component can use the appropriate logger for its domain, ensuring that logs are properly categorized and searchable.

## Bootstrap Process

The bootstrap process (`bootstrap.php`) initializes the application in a specific sequence:

1. Load the logger configuration first
2. Initialize environment variables from `.env`
3. Load configuration files dynamically
4. Initialize exception handler
5. Configure database connections
6. Initialize core services in correct dependency order
7. Set up the DI container
8. Verify database connection
9. Validate encryption key
10. Check required dependencies
11. Run initial setup tasks

This careful orchestration ensures that dependencies are available when needed and services are initialized in the correct order.

## Relationship Between Configuration Files

```
bootstrap.php
   
    logger.php (Initialize logging)
   
    Load .env variables
   
    Load config/* files
   
    Initialize core services
       
        AuditService, LogManagementService, etc.
   
    Initialize DI container
       
        dependencies.php (Register helpers, middleware)
           
            svc_dep.php (Register services)
           
            ctrl_dep.php (Register controllers)
       
        routes.php (Configure routing)
   
    Validate critical components
```

## Middleware Pipeline

Requests pass through a middleware pipeline before reaching the controller:

1. **Security Headers**: Adds security-related HTTP headers
2. **Session Middleware**: Handles session creation/validation
3. **Auth Middleware**: Extracts and validates authentication tokens
4. **CSRF Protection**: Validates CSRF tokens for state-changing requests
5. **Rate Limiting**: Prevents abuse of sensitive endpoints
6. **Encryption**: Handles encryption/decryption of sensitive data
7. **Logging**: Records request information for audit and debugging

Each middleware component is registered in the DI container and can be assigned to specific routes or applied globally.

## Error Handling

The ExceptionHandler provides centralized error handling:

```php
$exceptionHandler = new ExceptionHandler(
    $loggers['db'],
    $loggers['auth'],
    $logger
);
```

Controllers and services use this handler to ensure consistent error responses and logging:

```php
try {
    // Operation that might fail
    $result = $this->someService->riskyOperation();
} catch (Exception $e) {
    $this->exceptionHandler->handleException($e);
    return $this->error('Operation failed', [], 500);
}
```

## Conclusion

The CarFuse architecture employs a well-structured approach to handling HTTP requests through the integration of FastRoute for routing, a robust dependency injection container for service management, and a comprehensive logging system. This architecture ensures clean separation of concerns, maintainability, and improved testability while providing detailed insights into system operation through categorized logging.
